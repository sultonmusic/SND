<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SND Partner Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #F3F4F6; }
        .sidebar-link { transition: background-color 0.2s, color 0.2s; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #ef4444; color: #ffffff; }
        .sidebar-link.active i, .sidebar-link:hover i { color: #ffffff; }
        #loading-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px); }
        #toast-notification { transition: opacity 0.3s, transform 0.3s; z-index: 9999; }
        #toast-notification.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        #toast-notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .movie-card { transition: transform 0.3s, box-shadow 0.3s; }
        .movie-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .form-input, .modal-input { background-color: #374151; border: 1px solid #4b5563; }
        .form-input:focus, .modal-input:focus { outline: none; border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5); }
        #modal-overlay { background-color: rgba(0, 0, 0, 0.8); }
        #sidebar { max-height: 100vh; overflow-y: auto; }
        #sidebar::-webkit-scrollbar { width: 6px; }
        #sidebar::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 999px; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @media (max-width: 768px) {
            #sidebar { width: min(18rem, 80vw); transform: translateX(-100%); position: fixed; z-index: 40; }
            #sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div id="app-container"></div>
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"></div>
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 text-white px-4 py-2 rounded-lg shadow-lg opacity-0"></div>
    <div id="loading-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center">
        <div class="text-center">
            <div class="relative inline-block">
                <div class="w-20 h-20 border-4 border-gray-600 border-t-red-600 rounded-full animate-spin"></div>
                <i class="fas fa-film absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white text-2xl"></i>
            </div>
            <p id="loading-text" class="text-white mt-4 font-semibold">Loading...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, addDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBeYmiy_FX22I4--UnNTRxjWiAh--sX9Ug",
            authDomain: "soundora-music.firebaseapp.com",
            projectId: "soundora-music",
            storageBucket: "soundora-music.appspot.com",
            messagingSenderId: "92363153683",
            appId: "1:92363153683:web:16feda8fb9607d8da97ae6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUserData = null;
        let currentPartnerId = null;
        let movies = [];
        let settings = { royaltyPerView: 0.05 };
        let notifications = [];
        let supportChats = [];
        let activeSupportChatId = null;
        let supportMessagesListener = null;
        let currentLanguage = localStorage.getItem('partnerLanguage') || 'en';
        const loadingOverlay = document.getElementById('loading-overlay');

        // Language translations
        const translations = {
            en: {
                title: 'Partner Panel',
                content: 'Content',
                royalty: 'Revenue',
                stats: 'Statistics',
                support: 'Support',
                faq: 'FAQ',
                privacy: 'Privacy',
                settings: 'Settings',
                logout: 'Logout',
                loading: 'Loading...',
                addMovie: 'Add Movie',
                myMovies: 'My Movies',
                totalMovies: 'Total Movies',
                totalViews: 'Total Views',
                avgRating: 'Avg Rating',
                pending: 'Pending',
                forApproval: 'For approval',
                edit: 'Edit',
                delete: 'Delete',
                noMovies: 'No movies uploaded yet',
                clickToAdd: 'Click the button above to add a new movie',
                save: 'Save',
                cancel: 'Cancel',
                movieTitle: 'Movie Title',
                year: 'Year',
                duration: 'Duration (min)',
                description: 'Description',
                videoUrl: 'Video URL',
                posterUrl: 'Poster URL',
                totalRevenue: 'Total Revenue',
                thisMonth: 'This Month',
                perView: 'Per View',
                revenueByMovie: 'Revenue by Movie',
                views: 'Views',
                rating: 'Rating',
                noStats: 'No statistics yet',
                categoryDist: 'Category Distribution',
                perView: 'Per View',
                revenueByMovie: 'Revenue by Movie',
                paymentInfo: 'Payment Information',
                paymentDate: 'Payment Date',
                minPayment: 'Minimum Payment',
                paymentMethod: 'Payment Method',
                contactUs: 'Contact Us',
                sendMessage: 'Send Message',
                subject: 'Subject',
                message: 'Message',
                send: 'Send',
                myRequests: 'My Requests',
                noRequests: 'No requests yet',
                topMovie: 'Top Viewed Movie',
                // FAQ
                faqTitle: 'Frequently Asked Questions',
                faqSubtitle: 'Can\'t find an answer? Ask in the support panel',
                faqGeneral: 'General',
                faqContent: 'Content Upload',
                faqPayment: 'Payment & Revenue',
                faqTechnical: 'Technical',
                faqNoAnswer: 'Can\'t find an answer?',
                faqContactUs: 'Contact us and we\'ll help you',
                faqContactButton: 'Contact Support',
                // Privacy
                privacyTitle: 'Privacy Policy',
                privacyData: 'Data Collection',
                privacyDataText: 'We collect your personal information only to provide services.',
                privacyUse: 'Data Usage',
                privacyUseText: 'Your information is not sold to third parties and is not used for other purposes.',
                privacySecurity: 'Security',
                privacySecurityText: 'All data is encrypted and stored on secure servers.',
                privacyRights: 'Your Rights',
                privacyRightsText: 'You have the right to view, edit or delete your information at any time.',
                // Settings
                settingsProfile: 'Profile Information',
                settingsPermissions: 'Allowed Categories and Regions',
                settingsStats: 'Account Statistics',
                settingsSecurity: 'Security',
                settingsLanguage: 'Language and Region Settings',
                settingsNotifications: 'Notification Settings',
                settingsMovies: 'Movies',
                settingsViews: 'Views',
                settingsRating: 'Rating',
                settingsRevenue: 'Revenue',
                settingsChangePassword: 'Change Password',
                settingsChangePasswordText: 'Change your password regularly for security',
                settingsChangePasswordButton: 'Change Password',
                settingsChangeEmail: 'Change Email',
                settingsChangeEmailText: 'Contact admin to update your email address',
                settingsContactSupportButton: 'Contact Support',
                settingsTimeZone: 'Time Zone',
                settingsEmailNotifications: 'Email Notifications',
                settingsEmailNotificationsText: 'Receive important news',
                settingsRevenueNotifications: 'Revenue Notifications',
                settingsRevenueNotificationsText: 'Payment and revenue updates',
                settingsApprovalNotifications: 'Approval Notifications',
                settingsApprovalNotificationsText: 'Get notified when movie is approved',
                settingsNoCategory: 'No category set',
                settingsNoRegion: 'No region set',
                langEnglish: 'English',
                langUzbek: 'O\'zbekcha',
                langRussian: 'Русский',
                langTajik: 'Тоҷикӣ',
                topMovies: 'Top Movies',
                categoryDist: 'Category Distribution',
                profile: 'Profile Information',
                name: 'Name',
                email: 'Email',
                role: 'Role',
                partner: 'Partner',
                status: 'Status',
                active: 'Active',
                blocked: 'Blocked',
                permissions: 'Permissions',
                categories: 'Categories',
                regions: 'Regions',
                accountStats: 'Account Statistics',
                security: 'Security',
                changePassword: 'Change Password',
                changeEmail: 'Change Email',
                language: 'Language',
                notifications: 'Notifications',
                emailNotif: 'Email Notifications',
                revenueNotif: 'Revenue Notifications',
                approvalNotif: 'Approval Notifications',
                newRequest: 'Send New Request',
                phone: 'Phone',
                telegram: 'Telegram',
                quickHelp: 'Quick Help',
                goToFaq: 'Go to FAQ',
                open: 'Open',
                closed: 'Closed',
                noDate: 'No date',
                deleteConfirm: 'Are you sure you want to delete',
                allTime: 'All time',
                views: 'views',
                rating: 'rating',
                revenue: 'revenue'
            },
            uz: {
                title: 'Hamkor Paneli',
                content: 'Kontent',
                royalty: 'Daromad',
                stats: 'Statistika',
                support: 'Yordam',
                faq: 'Savol-Javob',
                privacy: 'Maxfiylik',
                settings: 'Sozlamalar',
                logout: 'Chiqish',
                loading: 'Yuklanmoqda...',
                addMovie: 'Film Qo\'shish',
                myMovies: 'Mening Filmlarim',
                totalMovies: 'Jami Filmlar',
                totalViews: 'Jami Ko\'rishlar',
                avgRating: 'O\'rtacha Reyting',
                pending: 'Kutilmoqda',
                forApproval: 'Tasdiqlash uchun',
                edit: 'Tahrirlash',
                delete: 'O\'chirish',
                noMovies: 'Hali filmlar yuklanmagan',
                clickToAdd: 'Yangi film qo\'shish uchun yuqoridagi tugmani bosing',
                save: 'Saqlash',
                cancel: 'Bekor qilish',
                movieTitle: 'Film Nomi',
                year: 'Yil',
                duration: 'Davomiyligi (daqiqa)',
                description: 'Tavsif',
                videoUrl: 'Video URL',
                posterUrl: 'Poster URL',
                totalRevenue: 'Jami Daromad',
                thisMonth: 'Bu Oy',
                perView: 'Ko\'rish uchun',
                revenueByMovie: 'Film bo\'yicha daromad',
                paymentInfo: 'To\'lov haqida ma\'lumot',
                paymentDate: 'To\'lov sanasi',
                minPayment: 'Minimal to\'lov',
                paymentMethod: 'To\'lov usuli',
                contactUs: 'Biz bilan bog\'laning',
                sendMessage: 'Xabar yuborish',
                subject: 'Mavzu',
                message: 'Xabar',
                send: 'Yuborish',
                myRequests: 'Mening Murojaatlarim',
                noRequests: 'Hali murojaatlar yo\'q',
                topMovie: 'Eng Ko\'p Ko\'rilgan Film',
                topMovies: 'Eng Mashhur Filmlar',
                categoryDist: 'Kategoriyalar bo\'yicha',
                profile: 'Profil Ma\'lumotlari',
                name: 'Ism',
                email: 'Email',
                role: 'Rol',
                partner: 'Hamkor',
                status: 'Holat',
                active: 'Aktiv',
                blocked: 'Bloklangan',
                permissions: 'Ruxsatlar',
                categories: 'Kategoriyalar',
                regions: 'Hududlar',
                accountStats: 'Hisob Statistikasi',
                security: 'Xavfsizlik',
                changePassword: 'Parolni o\'zgartirish',
                changeEmail: 'Email o\'zgartirish',
                language: 'Til',
                notifications: 'Bildirishnomalar',
                emailNotif: 'Email bildirishnomalar',
                revenueNotif: 'Daromad haqida xabarlar',
                approvalNotif: 'Tasdiqlash xabarlari',
                newRequest: 'Yangi Murojaat Yuborish',
                phone: 'Telefon',
                telegram: 'Telegram',
                quickHelp: 'Tez Yordam',
                goToFaq: 'FAQ ga o\'tish',
                open: 'Ochiq',
                closed: 'Yopilgan',
                noDate: 'Sana yo\'q',
                deleteConfirm: 'Haqiqatan o\'chirmoqchimisiz',
                allTime: 'Barcha vaqt',
                views: 'ko\'rishlar',
                rating: 'reyting',
                revenue: 'daromad',
                ofTotal: 'jami daromaddan',
                noRevenue: 'Hali daromad yo\'q',
                paymentDay: 'Har oyning 5-kunida',
                minPaymentAmount: '$50.00 (Kam bo\'lsa keyingi oyga o\'tadi)',
                paymentMethods: 'Bank o\'tkazmasi, PayPal, Stripe',
                // FAQ
                faqTitle: 'Tez-tez so\'raladigan savollar',
                faqSubtitle: 'Javob topolmadingizmi? Yordam panelidan savol bering',
                faqGeneral: 'Umumiy',
                faqContent: 'Kontent Yuklash',
                faqPayment: 'To\'lov va Daromad',
                faqTechnical: 'Texnik',
                faqNoAnswer: 'Javob topa olmadingizmi?',
                faqContactUs: 'Biz bilan bog\'laning va sizga yordam beramiz',
                faqContactButton: 'Yordam xizmatiga murojaat',
                // Privacy
                privacyTitle: 'Maxfiylik Siyosati',
                privacyData: 'Ma\'lumotlar to\'plash',
                privacyDataText: 'Biz sizning shaxsiy ma\'lumotlaringizni faqat xizmatlarni taqdim etish uchun to\'playmiz.',
                privacyUse: 'Ma\'lumotlardan foydalanish',
                privacyUseText: 'Sizning ma\'lumotlaringiz uchinchi shaxslarga sotilmaydi va boshqa maqsadlarda ishlatilmaydi.',
                privacySecurity: 'Xavfsizlik',
                privacySecurityText: 'Barcha ma\'lumotlar shifrlangan va xavfsiz serverda saqlanadi.',
                privacyRights: 'Sizning huquqlaringiz',
                privacyRightsText: 'Siz istalgan vaqt ma\'lumotlaringizni ko\'rish, tahrirlash yoki o\'chirish huquqiga egasiz.',
                // Settings
                settingsProfile: 'Profil Ma\'lumotlari',
                settingsPermissions: 'Ruxsat Berilgan Kategoriyalar va Hududlar',
                settingsStats: 'Hisob Statistikasi',
                settingsSecurity: 'Xavfsizlik',
                settingsLanguage: 'Til va Hudud Sozlamalari',
                settingsNotifications: 'Bildirishnoma Sozlamalari',
                settingsMovies: 'Filmlar',
                settingsViews: 'Ko\'rishlar',
                settingsRating: 'Reyting',
                settingsRevenue: 'Daromad',
                settingsChangePassword: 'Parolni o\'zgartirish',
                settingsChangePasswordText: 'Xavfsizlik uchun parolingizni muntazam o\'zgartiring',
                settingsChangePasswordButton: 'Parolni o\'zgartirish',
                settingsChangeEmail: 'Email o\'zgartirish',
                settingsChangeEmailText: 'Email manzilingizni yangilash uchun admin bilan bog\'laning',
                settingsContactSupportButton: 'Yordam xizmatiga murojaat',
                settingsTimeZone: 'Vaqt zonasi',
                settingsEmailNotifications: 'Email bildirishnomalar',
                settingsEmailNotificationsText: 'Muhim yangiliklar haqida xabar olish',
                settingsRevenueNotifications: 'Daromad haqida xabarlar',
                settingsRevenueNotificationsText: 'To\'lovlar va daromad yangilanishlari',
                settingsApprovalNotifications: 'Tasdiqlash xabarlari',
                settingsApprovalNotificationsText: 'Film tasdiqlanganda xabar olish',
                settingsNoCategory: 'Kategoriya belgilanmagan',
                settingsNoRegion: 'Hudud belgilanmagan',
                langEnglish: 'English',
                langUzbek: 'O\'zbekcha',
                langRussian: 'Русский',
                langTajik: 'Тоҷикӣ',
                noRequests: 'Hali murojaatlar yo\'q',
                topMovie: 'Eng Ko\'p Ko\'rilgan Film',
                topMovies: 'Eng Mashhur Filmlar',
                categoryDist: 'Kategoriyalar bo\'yicha',
                profile: 'Profil Ma\'lumotlari',
                name: 'Ism',
                email: 'Email',
                role: 'Rol',
                partner: 'Hamkor',
                status: 'Holat',
                active: 'Aktiv',
                blocked: 'Bloklangan',
                permissions: 'Ruxsatlar',
                categories: 'Kategoriyalar',
                regions: 'Hududlar',
                accountStats: 'Hisob Statistikasi',
                security: 'Xavfsizlik',
                changePassword: 'Parolni o\'zgartirish',
                changeEmail: 'Email o\'zgartirish',
                language: 'Til',
                notifications: 'Bildirishnomalar',
                emailNotif: 'Email bildirishnomalar',
                revenueNotif: 'Daromad haqida xabarlar',
                approvalNotif: 'Tasdiqlash xabarlari',
                newRequest: 'Yangi Murojaat Yuborish',
                phone: 'Telefon',
                telegram: 'Telegram',
                quickHelp: 'Tez Yordam',
                goToFaq: 'FAQ ga o\'tish',
                open: 'Ochiq',
                closed: 'Yopilgan',
                noDate: 'Sana yo\'q',
                deleteConfirm: 'Haqiqatan o\'chirmoqchimisiz',
                allTime: 'Barcha vaqt',
                views: 'ko\'rishlar',
                rating: 'reyting',
                revenue: 'daromad'
            },
            ru: {
                title: 'Панель Партнера',
                content: 'Контент',
                royalty: 'Доход',
                stats: 'Статистика',
                support: 'Поддержка',
                faq: 'FAQ',
                privacy: 'Конфиденциальность',
                settings: 'Настройки',
                logout: 'Выход',
                loading: 'Загрузка...',
                addMovie: 'Добавить Фильм',
                myMovies: 'Мои Фильмы',
                totalMovies: 'Всего Фильмов',
                totalViews: 'Всего Просмотров',
                avgRating: 'Средний Рейтинг',
                pending: 'Ожидание',
                forApproval: 'На утверждении',
                edit: 'Редактировать',
                delete: 'Удалить',
                noMovies: 'Фильмы еще не загружены',
                clickToAdd: 'Нажмите кнопку выше, чтобы добавить новый фильм',
                save: 'Сохранить',
                cancel: 'Отмена',
                movieTitle: 'Название фильма',
                year: 'Год',
                duration: 'Продолжительность (мин)',
                description: 'Описание',
                videoUrl: 'URL видео',
                posterUrl: 'URL постера',
                totalRevenue: 'Общий Доход',
                thisMonth: 'В Этом Месяце',
                perView: 'За просмотр',
                revenueByMovie: 'Доход по фильмам',
                paymentInfo: 'Информация о платеже',
                paymentDate: 'Дата платежа',
                minPayment: 'Минимальный платеж',
                paymentMethod: 'Способ оплаты',
                contactUs: 'Свяжитесь с нами',
                sendMessage: 'Отправить сообщение',
                subject: 'Тема',
                message: 'Сообщение',
                send: 'Отправить',
                myRequests: 'Мои Обращения',
                noRequests: 'Обращений пока нет',
                topMovie: 'Самый Просматриваемый Фильм',
                topMovies: 'Популярные Фильмы',
                categoryDist: 'Распределение по категориям',
                profile: 'Информация о профиле',
                name: 'Имя',
                email: 'Email',
                role: 'Роль',
                partner: 'Партнер',
                status: 'Статус',
                active: 'Активен',
                blocked: 'Заблокирован',
                permissions: 'Разрешения',
                categories: 'Категории',
                regions: 'Регионы',
                accountStats: 'Статистика аккаунта',
                security: 'Безопасность',
                changePassword: 'Изменить пароль',
                changeEmail: 'Изменить email',
                language: 'Язык',
                notifications: 'Уведомления',
                emailNotif: 'Email уведомления',
                revenueNotif: 'Уведомления о доходе',
                approvalNotif: 'Уведомления об утверждении',
                newRequest: 'Отправить Новое Обращение',
                phone: 'Телефон',
                telegram: 'Telegram',
                quickHelp: 'Быстрая Помощь',
                goToFaq: 'Перейти в FAQ',
                open: 'Открыто',
                closed: 'Закрыто',
                noDate: 'Нет даты',
                deleteConfirm: 'Вы уверены, что хотите удалить',
                allTime: 'Все время',
                views: 'просмотров',
                rating: 'рейтинг',
                revenue: 'доход',
                ofTotal: 'от общего дохода',
                noRevenue: 'Дохода пока нет',
                paymentDay: 'Каждого 5-го числа месяца',
                minPaymentAmount: '$50.00 (Если меньше, переносится на следующий месяц)',
                paymentMethods: 'Банковский перевод, PayPal, Stripe',
                // FAQ
                faqTitle: 'Часто задаваемые вопросы',
                faqSubtitle: 'Не нашли ответ? Задайте вопрос на панели поддержки',
                faqGeneral: 'Общие',
                faqContent: 'Загрузка Контента',
                faqPayment: 'Оплата и Доход',
                faqTechnical: 'Технические',
                faqNoAnswer: 'Не нашли ответ?',
                faqContactUs: 'Свяжитесь с нами, и мы вам поможем',
                faqContactButton: 'Связаться с поддержкой',
                // Privacy
                privacyTitle: 'Политика Конфиденциальности',
                privacyData: 'Сбор данных',
                privacyDataText: 'Мы собираем вашу личную информацию только для предоставления услуг.',
                privacyUse: 'Использование данных',
                privacyUseText: 'Ваша информация не продается третьим лицам и не используется для других целей.',
                privacySecurity: 'Безопасность',
                privacySecurityText: 'Все данные зашифрованы и хранятся на защищенных серверах.',
                privacyRights: 'Ваши права',
                privacyRightsText: 'Вы имеете право просматривать, редактировать или удалять свою информацию в любое время.',
                // Settings
                settingsProfile: 'Информация о профиле',
                settingsPermissions: 'Разрешенные Категории и Регионы',
                settingsStats: 'Статистика аккаунта',
                settingsSecurity: 'Безопасность',
                settingsLanguage: 'Язык и Региональные настройки',
                settingsNotifications: 'Настройки уведомлений',
                settingsMovies: 'Фильмы',
                settingsViews: 'Просмотры',
                settingsRating: 'Рейтинг',
                settingsRevenue: 'Доход',
                settingsChangePassword: 'Изменить пароль',
                settingsChangePasswordText: 'Регулярно меняйте пароль для безопасности',
                settingsChangePasswordButton: 'Изменить пароль',
                settingsChangeEmail: 'Изменить Email',
                settingsChangeEmailText: 'Свяжитесь с администратором для обновления email адреса',
                settingsContactSupportButton: 'Связаться с поддержкой',
                settingsTimeZone: 'Часовой пояс',
                settingsEmailNotifications: 'Email уведомления',
                settingsEmailNotificationsText: 'Получать важные новости',
                settingsRevenueNotifications: 'Уведомления о доходе',
                settingsRevenueNotificationsText: 'Обновления платежей и дохода',
                settingsApprovalNotifications: 'Уведомления об утверждении',
                settingsApprovalNotificationsText: 'Получать уведомление при утверждении фильма',
                settingsNoCategory: 'Категория не установлена',
                settingsNoRegion: 'Регион не установлен',
                langEnglish: 'English',
                langUzbek: 'O\'zbekcha',
                langRussian: 'Русский',
                langTajik: 'Тоҷикӣ'
            },
            tj: {
                title: 'Панели Шарик',
                content: 'Мундариҷа',
                royalty: 'Даромад',
                stats: 'Омор',
                support: 'Дастгирӣ',
                faq: 'Саволҳо',
                privacy: 'Махфият',
                settings: 'Танзимот',
                logout: 'Баромад',
                loading: 'Бор мешавад...',
                addMovie: 'Илова кардани филм',
                myMovies: 'Филмҳои ман',
                totalMovies: 'Ҳамаи Филмҳо',
                totalViews: 'Ҳамаи Тамошо',
                avgRating: 'Рейтинги миёна',
                pending: 'Дар интизор',
                forApproval: 'Барои тасдиқ',
                edit: 'Таҳрир',
                delete: 'Нест кардан',
                noMovies: 'Филмҳо то ҳол бор нашудаанд',
                clickToAdd: 'Барои илова кардани филми нав тугмаро зер кунед',
                save: 'Захира',
                cancel: 'Бекор',
                movieTitle: 'Номи филм',
                year: 'Сол',
                duration: 'Давомнокӣ (дақиқа)',
                description: 'Тавсиф',
                videoUrl: 'URL видео',
                posterUrl: 'URL постер',
                totalRevenue: 'Даромади умумӣ',
                thisMonth: 'Ин Моҳ',
                perView: 'Барои тамошо',
                revenueByMovie: 'Даромад аз филмҳо',
                paymentInfo: 'Маълумот дар бораи пардохт',
                paymentDate: 'Санаи пардохт',
                minPayment: 'Пардохти минималӣ',
                paymentMethod: 'Усули пардохт',
                contactUs: 'Бо мо тамос гиред',
                sendMessage: 'Фиристодани паём',
                subject: 'Мавзӯъ',
                message: 'Паём',
                send: 'Фиристодан',
                myRequests: 'Мурочиатҳои ман',
                noRequests: 'Мурочиатҳо то ҳол нестанд',
                topMovie: 'Филми Машҳур',
                topMovies: 'Филмҳои Машҳур',
                categoryDist: 'Тақсимот аз рӯи категорияҳо',
                profile: 'Маълумоти профил',
                name: 'Ном',
                email: 'Email',
                role: 'Нақш',
                partner: 'Шарик',
                status: 'Ҳолат',
                active: 'Фаъол',
                blocked: 'Манъ шуд',
                permissions: 'Иҷозатҳо',
                categories: 'Категорияҳо',
                regions: 'Минтақаҳо',
                accountStats: 'Омори ҳисоб',
                security: 'Амният',
                changePassword: 'Тағйир додани парол',
                changeEmail: 'Тағйир додани email',
                language: 'Забон',
                notifications: 'Огоҳиҳо',
                emailNotif: 'Огоҳиҳои Email',
                revenueNotif: 'Огоҳиҳо дар бораи даромад',
                approvalNotif: 'Огоҳиҳои тасдиқ',
                newRequest: 'Фиристодани Мурочиати Нав',
                phone: 'Телефон',
                telegram: 'Telegram',
                quickHelp: 'Кӯмаки Тез',
                goToFaq: 'Ба FAQ гузаред',
                open: 'Кушода',
                closed: 'Пӯшида',
                noDate: 'Сана нест',
                deleteConfirm: 'Шумо мутмаин ҳастед, ки мехоҳед нест кунед',
                allTime: 'Ҳама вақт',
                views: 'тамошо',
                rating: 'рейтинг',
                revenue: 'даромад',
                ofTotal: 'аз даромади умумӣ',
                noRevenue: 'Даромад то ҳол нест',
                paymentDay: 'Ҳар моҳ 5-уми',
                minPaymentAmount: '$50.00 (Агар камтар бошад, ба моҳи оянда мегузарад)',
                paymentMethods: 'Интиқоли бонкӣ, PayPal, Stripe',
                // FAQ
                faqTitle: 'Саволҳои зуд-зуд пурсида мешаванда',
                faqSubtitle: 'Ҷавоб наёфтед? Дар панели дастгирӣ савол пурсед',
                faqGeneral: 'Умумӣ',
                faqContent: 'Боргузории Мундариҷа',
                faqPayment: 'Пардохт ва Даромад',
                faqTechnical: 'Техникӣ',
                faqNoAnswer: 'Ҷавоб наёфтед?',
                faqContactUs: 'Бо мо тамос гиред ва мо ба шумо кӯмак мекунем',
                faqContactButton: 'Тамос бо дастгирӣ',
                // Privacy
                privacyTitle: 'Сиёсати Махфият',
                privacyData: 'Ҷамъоварии маълумот',
                privacyDataText: 'Мо маълумоти шахсии шуморо танҳо барои пешниҳоди хидматҳо ҷамъ мекунем.',
                privacyUse: 'Истифодаи маълумот',
                privacyUseText: 'Маълумоти шумо ба шахсони сеюм фурӯхта намешавад ва барои мақсадҳои дигар истифода намешавад.',
                privacySecurity: 'Амният',
                privacySecurityText: 'Ҳамаи маълумот рамзгузорӣ шудааст ва дар серверҳои муҳофизатшуда нигоҳ дошта мешавад.',
                privacyRights: 'Ҳуқуқҳои шумо',
                privacyRightsText: 'Шумо ҳуқуқ доред, ки маълумоти худро дар ҳар вақт бинед, таҳрир кунед ё нест кунед.',
                // Settings
                settingsProfile: 'Маълумоти профил',
                settingsPermissions: 'Категорияҳо ва Минтақаҳои иҷозатдодашуда',
                settingsStats: 'Омори ҳисоб',
                settingsSecurity: 'Амният',
                settingsLanguage: 'Танзимоти Забон ва Минтақа',
                settingsNotifications: 'Танзимоти огоҳиҳо',
                settingsMovies: 'Филмҳо',
                settingsViews: 'Тамошо',
                settingsRating: 'Рейтинг',
                settingsRevenue: 'Даромад',
                settingsChangePassword: 'Тағйир додани парол',
                settingsChangePasswordText: 'Барои амният паролро мунтазам тағйир диҳед',
                settingsChangePasswordButton: 'Тағйир додани парол',
                settingsChangeEmail: 'Тағйир додани Email',
                settingsChangeEmailText: 'Барои навсозии суроғаи email бо администратор тамос гиред',
                settingsContactSupportButton: 'Тамос бо дастгирӣ',
                settingsTimeZone: 'Минтақаи вақт',
                settingsEmailNotifications: 'Огоҳиҳои Email',
                settingsEmailNotificationsText: 'Хабарҳои муҳимро гирифтан',
                settingsRevenueNotifications: 'Огоҳиҳо дар бораи даромад',
                settingsRevenueNotificationsText: 'Навсозиҳои пардохт ва даромад',
                settingsApprovalNotifications: 'Огоҳиҳои тасдиқ',
                settingsApprovalNotificationsText: 'Вақте ки филм тасдиқ мешавад, огоҳӣ гиред',
                settingsNoCategory: 'Категория муқаррар нашудааст',
                settingsNoRegion: 'Минтақа муқаррар нашудааст',
                langEnglish: 'English',
                langUzbek: 'O\'zbekcha',
                langRussian: 'Русский',
                langTajik: 'Тоҷикӣ'
            }
        };

        function t(key) {
            return translations[currentLanguage][key] || translations['en'][key] || key;
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('partnerLanguage', lang);
            document.documentElement.lang = lang;
            renderPartnerDashboard();
            // Re-render current panel
            const activePanel = document.querySelector('.sidebar-link.active')?.dataset.panel;
            if (activePanel) {
                switch(activePanel) {
                    case 'content-panel': renderContentPanel(); break;
                    case 'royalty-panel': renderRoyaltyPanel(); break;
                    case 'stats-panel': renderStatsPanel(); break;
                    case 'support-panel': renderSupportPanel(); break;
                    case 'faq-panel': renderFaqPanel(); break;
                    case 'privacy-panel': renderPrivacyPanel(); break;
                    case 'settings-panel': renderSettingsPanel(); break;
                }
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transition-all ${isError ? 'error' : 'success'}`;
            toast.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('modal-overlay').innerHTML = '';
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loadingOverlay.classList.remove('hidden');
                document.getElementById('loading-text').textContent = t('loading');
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        currentUserData = userDoc.data();
                        currentPartnerId = user.uid;
                        if (currentUserData.role === 'partner') {
                            renderPartnerDashboard();
                            loadPartnerData(user.uid);
                        } else {
                            window.location.href = 'admin.html';
                        }
                    } else {
                        throw new Error("Foydalanuvchi topilmadi");
                    }
                } catch (error) {
                    showToast(error.message, true);
                    await signOut(auth);
                    window.location.href = 'admin.html';
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            } else {
                window.location.href = 'admin.html';
            }
        });

        async function loadPartnerData(partnerId) {
            // Load movies
            const moviesQuery = query(collection(db, "movies"), where("partnerId", "==", partnerId));
            onSnapshot(moviesQuery, (snapshot) => {
                movies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Update panels after data loads
                const currentPanel = document.querySelector('.sidebar-link.active')?.dataset.panel;
                if (currentPanel === 'content-panel') renderContentPanel();
                if (currentPanel === 'royalty-panel') renderRoyaltyPanel();
                if (currentPanel === 'stats-panel') renderStatsPanel();
            });

            // Load settings
            const settingsDoc = await getDoc(doc(db, "settings", "royalty"));
            if (settingsDoc.exists()) {
                settings = settingsDoc.data();
            }

            // Load notifications
            const notifQuery = query(
                collection(db, "partner_notifications"),
                where("partnerId", "==", partnerId),
                where("read", "==", false),
                orderBy("createdAt", "desc")
            );
            onSnapshot(notifQuery, (snapshot) => {
                notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateNotificationBadge();
            });

            // Load support chats
            const chatsQuery = query(
                collection(db, "supportChats"),
                where("partnerId", "==", partnerId),
                orderBy("lastMessageAt", "desc")
            );
            onSnapshot(chatsQuery, (snapshot) => {
                supportChats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentPanel = document.querySelector('.sidebar-link.active')?.dataset.panel;
                if (currentPanel === 'support-panel') renderSupportPanel();
            });
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (badge) {
                if (notifications.length > 0) {
                    badge.textContent = notifications.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function renderPartnerDashboard() {
            document.getElementById('app-container').innerHTML = `
                <div class="flex min-h-screen bg-gray-900">
                    <aside id="sidebar" class="w-64 bg-gradient-to-b from-gray-900 to-black text-gray-300 flex flex-col border-r border-gray-800">
                        <div class="h-16 flex items-center justify-center border-b border-gray-800 bg-gradient-to-r from-red-900 to-red-700">
                            <h1 class="text-lg font-bold text-white">
                                <i class="fas fa-film mr-2"></i>SOUNDORA <span class="text-yellow-400">PARTNER</span>
                            </h1>
                        </div>
                        <nav class="flex-grow mt-4">
                            <a href="#" data-panel="content-panel" class="sidebar-link active flex items-center py-3 px-6">
                                <i class="fas fa-video w-6 text-gray-400"></i><span class="ml-3">${t('content')}</span>
                            </a>
                            <a href="#" data-panel="royalty-panel" class="sidebar-link flex items-center py-3 px-6">
                                <i class="fas fa-hand-holding-usd w-6 text-gray-400"></i><span class="ml-3">${t('royalty')}</span>
                            </a>
                            <a href="#" data-panel="stats-panel" class="sidebar-link flex items-center py-3 px-6">
                                <i class="fas fa-chart-bar w-6 text-gray-400"></i><span class="ml-3">${t('stats')}</span>
                            </a>
                            <a href="#" data-panel="support-panel" class="sidebar-link flex items-center py-3 px-6">
                                <i class="fas fa-headset w-6 text-gray-400"></i><span class="ml-3">${t('support')}</span>
                            </a>
                            <a href="#" data-panel="faq-panel" class="sidebar-link flex items-center py-3 px-6">
                                <i class="fas fa-question-circle w-6 text-gray-400"></i><span class="ml-3">${t('faq')}</span>
                            </a>
                            <a href="#" data-panel="privacy-panel" class="sidebar-link flex items-center py-3 px-6">
                                <i class="fas fa-shield-alt w-6 text-gray-400"></i><span class="ml-3">${t('privacy')}</span>
                            </a>
                            <a href="#" data-panel="settings-panel" class="sidebar-link flex items-center py-3 px-6">
                                <i class="fas fa-cog w-6 text-gray-400"></i><span class="ml-3">${t('settings')}</span>
                            </a>
                        </nav>
                        <div class="p-4 border-t border-gray-800">
                            <button id="logout-btn" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg">
                                <i class="fas fa-sign-out-alt mr-2"></i>${t('logout')}
                            </button>
                        </div>
                    </aside>
                    <div class="flex-1 flex flex-col">
                        <header class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 shadow-xl border-b border-gray-700 h-16 flex items-center justify-between px-6">
                            <div class="flex items-center gap-3">
                                <button id="mobile-menu-btn" class="md:hidden text-2xl text-gray-300 hover:text-white">
                                    <i class="fas fa-bars"></i>
                                </button>
                                <h2 id="page-title" class="text-xl md:text-2xl font-bold text-white">${t('content')}</h2>
                            </div>
                            <div class="flex items-center gap-4">
                                <!-- Language Selector -->
                                <div class="relative" id="lang-selector">
                                    <button id="lang-btn" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg transition">
                                        <i class="fas fa-language text-gray-300"></i>
                                        <span class="text-sm text-gray-300 uppercase">${currentLanguage}</span>
                                        <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                                    </button>
                                    <div id="lang-dropdown" class="hidden absolute right-0 mt-2 w-40 bg-gray-800 rounded-lg shadow-xl border border-gray-700 z-50">
                                        <button onclick="changeLanguage('en')" class="w-full text-left px-4 py-2 hover:bg-gray-700 text-white rounded-t-lg flex items-center gap-2">
                                            <span class="text-lg">🇬🇧</span> English
                                        </button>
                                        <button onclick="changeLanguage('uz')" class="w-full text-left px-4 py-2 hover:bg-gray-700 text-white flex items-center gap-2">
                                            <span class="text-lg">🇺🇿</span> O'zbekcha
                                        </button>
                                        <button onclick="changeLanguage('ru')" class="w-full text-left px-4 py-2 hover:bg-gray-700 text-white flex items-center gap-2">
                                            <span class="text-lg">🇷🇺</span> Русский
                                        </button>
                                        <button onclick="changeLanguage('tj')" class="w-full text-left px-4 py-2 hover:bg-gray-700 text-white rounded-b-lg flex items-center gap-2">
                                            <span class="text-lg">🇹🇯</span> Тоҷикӣ
                                        </button>
                                    </div>
                                </div>
                                <button id="notifications-btn" class="relative text-gray-300 hover:text-white transition-colors">
                                    <i class="fas fa-bell text-xl md:text-2xl"></i>
                                    <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold"></span>
                                </button>
                                <div class="hidden md:flex items-center gap-2 bg-gray-800 px-3 py-2 rounded-lg">
                                    <i class="fas fa-user-circle text-gray-400"></i>
                                    <span class="text-sm text-gray-300">${currentUserData?.displayName || 'Partner'}</span>
                                </div>
                            </div>
                        </header>
                        <main id="main-content" class="flex-1 p-4 md:p-6 overflow-y-auto bg-gray-950">
                            <div id="content-panel"></div>
                            <div id="royalty-panel" class="hidden"></div>
                            <div id="stats-panel" class="hidden"></div>
                            <div id="support-panel" class="hidden"></div>
                            <div id="faq-panel" class="hidden"></div>
                            <div id="privacy-panel" class="hidden"></div>
                            <div id="settings-panel" class="hidden"></div>
                        </main>
                    </div>
                </div>
            `;

            document.getElementById('logout-btn').addEventListener('click', async () => {
                if (confirm('Chiqishni xohlaysizmi?')) {
                    await signOut(auth);
                    window.location.href = 'admin.html';
                }
            });

            // Mobile menu toggle
            document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('open');
            });

            // Language dropdown toggle
            document.getElementById('lang-btn')?.addEventListener('click', () => {
                document.getElementById('lang-dropdown').classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const langSelector = document.getElementById('lang-selector');
                if (langSelector && !langSelector.contains(e.target)) {
                    document.getElementById('lang-dropdown')?.classList.add('hidden');
                }
            });

            // Notifications dropdown
            document.getElementById('notifications-btn')?.addEventListener('click', showNotifications);

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    
                    const panelId = e.currentTarget.dataset.panel;
                    document.querySelectorAll('#main-content > div').forEach(p => p.classList.add('hidden'));
                    document.getElementById(panelId).classList.remove('hidden');
                    
                    const titles = {
                        'content-panel': t('content'),
                        'royalty-panel': t('royalty'),
                        'stats-panel': t('stats'),
                        'support-panel': t('support'),
                        'faq-panel': t('faq'),
                        'privacy-panel': t('privacy'),
                        'settings-panel': t('settings')
                    };
                    document.getElementById('page-title').textContent = titles[panelId] || 'Panel';
                    
                    // Close mobile menu
                    document.getElementById('sidebar').classList.remove('open');
                    
                    localStorage.setItem('lastActivePanel', panelId);
                    
                    // Render specific panel
                    switch(panelId) {
                        case 'faq-panel': renderFaqPanel(); break;
                        case 'privacy-panel': renderPrivacyPanel(); break;
                        case 'settings-panel': renderSettingsPanel(); break;
                        case 'support-panel': renderSupportPanel(); break;
                    }
                });
            });

            // Restore last panel
            const lastPanel = localStorage.getItem('lastActivePanel');
            if (lastPanel && document.getElementById(lastPanel)) {
                document.querySelector(`[data-panel="${lastPanel}"]`)?.click();
            }
            
            // Initial render of panels
            renderContentPanel();
            renderRoyaltyPanel();
            renderStatsPanel();
            
            // Make changeLanguage global
            window.changeLanguage = changeLanguage;
        }

        function showNotifications() {
            if (notifications.length === 0) {
                showToast('Bildirishnomalar yo\'q');
                return;
            }
            
            const modal = document.getElementById('modal-overlay');
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white">Bildirishnomalar</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${notifications.map(n => `
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p class="text-white font-semibold">${n.title || 'Bildirishnoma'}</p>
                                <p class="text-gray-300 text-sm mt-1">${n.message}</p>
                                <p class="text-gray-500 text-xs mt-2">${n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleString('uz-UZ') : ''}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            window.closeModal = closeModal;
        }

        function renderContentPanel() {
            try {
                const panel = document.getElementById('content-panel');
                if (!panel) {
                    console.error('content-panel not found');
                    return;
                }
                const totalMovies = movies.length;
                const totalViews = movies.reduce((acc, m) => acc + (m.views || 0), 0);
                const avgRating = movies.length > 0 ? (movies.reduce((acc, m) => acc + (Number(m.rating) || 0), 0) / movies.length).toFixed(1) : 0;
                const pendingReview = movies.filter(m => m.needsReview).length;
            
            panel.innerHTML = `
                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-200 text-sm font-medium">${t('totalMovies')}</p>
                                <p class="text-4xl font-bold text-white mt-2">${totalMovies}</p>
                            </div>
                            <div class="bg-purple-800/50 p-4 rounded-xl">
                                <i class="fas fa-film text-3xl text-purple-200"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-200 text-sm font-medium">${t('totalViews')}</p>
                                <p class="text-4xl font-bold text-white mt-2">${totalViews.toLocaleString()}</p>
                            </div>
                            <div class="bg-blue-800/50 p-4 rounded-xl">
                                <i class="fas fa-eye text-3xl text-blue-200"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-200 text-sm font-medium">${t('avgRating')}</p>
                                <p class="text-4xl font-bold text-white mt-2">${avgRating}</p>
                            </div>
                            <div class="bg-yellow-800/50 p-4 rounded-xl">
                                <i class="fas fa-star text-3xl text-yellow-200"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-900 to-orange-700 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-200 text-sm font-medium">${t('pending')}</p>
                                <p class="text-4xl font-bold text-white mt-2">${pendingReview}</p>
                                <p class="text-orange-300 text-xs mt-1">${t('forApproval')}</p>
                            </div>
                            <div class="bg-orange-800/50 p-4 rounded-xl">
                                <i class="fas fa-clock text-3xl text-orange-200"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h3 class="text-2xl font-bold text-white">${t('myMovies')}</h3>
                        <button id="add-movie-btn" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center gap-2 transition-all transform hover:scale-105">
                            <i class="fas fa-plus-circle"></i>
                            <span>${t('addMovie')}</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        ${movies.length > 0 ? movies.map(m => `
                            <div class="movie-card bg-gray-700 rounded-lg overflow-hidden">
                                <div class="relative">
                                    <img src="${m.posterUrl || 'https://via.placeholder.com/300x450?text=No+Poster'}" 
                                         alt="${m.title}" 
                                         class="w-full h-64 object-cover">
                                    ${m.needsReview ? `<div class="absolute top-2 right-2 bg-orange-500 text-white px-2 py-1 rounded text-xs font-bold">${t('pending')}</div>` : ''}
                                    ${m.suspended ? `<div class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">${t('blocked')}</div>` : ''}
                                </div>
                                <div class="p-4">
                                    <h4 class="text-white font-bold text-lg truncate">${m.title}</h4>
                                    <p class="text-gray-400 text-sm mt-1">${m.year || 'N/A'} • ${m.primaryCategory || 'general'}</p>
                                    <div class="flex items-center justify-between mt-3">
                                        <span class="text-yellow-400 flex items-center gap-1">
                                            <i class="fas fa-star"></i> ${(Number(m.rating) || 0).toFixed(1)}
                                        </span>
                                        <span class="text-gray-400 text-sm flex items-center gap-1">
                                            <i class="fas fa-eye"></i> ${(m.views || 0).toLocaleString()}
                                        </span>
                                    </div>
                                    <div class="mt-4 flex gap-2">
                                        <button onclick="editMovie('${m.id}')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm py-2 px-3 rounded transition">
                                            <i class="fas fa-edit mr-1"></i>${t('edit')}
                                        </button>
                                        <button onclick="deleteMovie('${m.id}', '${m.title}')" class="bg-red-600 hover:bg-red-500 text-white text-sm py-2 px-3 rounded transition">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="col-span-full text-center py-12">
                                <div class="inline-block p-6 bg-gray-700 rounded-full mb-4">
                                    <i class="fas fa-film text-6xl text-gray-500"></i>
                                </div>
                                <p class="text-xl text-gray-400 font-semibold">${t('noMovies')}</p>
                                <p class="text-gray-500 mt-2">${t('clickToAdd')}</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('add-movie-btn')?.addEventListener('click', () => openMovieModal());
            
            // Global functions for movie actions
            window.editMovie = (movieId) => openMovieModal(movieId);
            window.deleteMovie = async (movieId, title) => {
                if (confirm(`"${title}" ${t('deleteConfirm')}?`)) {
                    try {
                        loadingOverlay.classList.remove('hidden');
                        await deleteDoc(doc(db, "movies", movieId));
                        showToast(t('save'));
                    } catch (error) {
                        showToast('Error: ' + error.message, true);
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            };
            } catch (error) {
                console.error('Error in renderContentPanel:', error);
                const panel = document.getElementById('content-panel');
                if (panel) {
                    panel.innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`;
                }
            }
        }

        async function openMovieModal(movieId = null) {
            const isEdit = !!movieId;
            let movieData = {};
            
            if (isEdit) {
                const movie = movies.find(m => m.id === movieId);
                if (!movie) {
                    showToast('Film topilmadi', true);
                    return;
                }
                movieData = movie;
            }
            
            // Temporary form data storage
            window.movieFormData = window.movieFormData || {
                step1: {}, step2: {}, step3: {}, step4: {},
                completedSteps: new Set()
            };
            
            const modal = document.getElementById('modal-overlay');
            const selectedType = movieData.type || 'movie';
            const existingSources = movieData.sources || {};

            modal.innerHTML = `
            <div class="fixed inset-0 bg-gray-900 z-50 flex">
                <!-- Left Sidebar - Steps -->
                <div class="w-64 bg-gray-800 border-r border-gray-700 p-6">
                    <h3 class="text-xl font-bold mb-8 text-white">${isEdit ? 'Kontentni tahrirlash' : 'Yangi kontent qo\'shish'}</h3>
                    <nav class="space-y-2">
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors" data-step="1">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">1</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">Asosiy ma'lumotlar</span>
                        </button>
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors opacity-50" data-step="2">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">2</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">Tavsif</span>
                        </button>
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors opacity-50" data-step="3">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">3</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">Aktyorlar</span>
                        </button>
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors opacity-50" data-step="4">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">4</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">Video manbalar</span>
                        </button>
                    </nav>
                    <button id="close-modal-btn" class="w-full mt-8 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-times mr-2"></i>Bekor qilish
                    </button>
                </div>
                
                <!-- Right Content Area -->
                <div class="flex-1 flex flex-col bg-gray-900">
                    <div class="flex-1 overflow-y-auto p-8">
                        <form id="movie-form">
                            <input type="hidden" id="movie-id" value="${movieId || ''}">
                            
                            <!-- Step 1: Basic Info -->
                            <div class="step-content" data-step="1">
                                <h4 class="text-2xl font-bold mb-6 text-white">Asosiy ma'lumotlar</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">Nom *</label>
                                        <input type="text" id="movie-title" class="modal-input w-full p-3 rounded-md" placeholder="Film nomi" value="${movieData.title || ''}" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">Kontent turi *</label>
                                        <select id="movie-type" class="modal-input w-full p-3 rounded-md">
                                            <option value="movie" ${selectedType === 'movie' ? 'selected' : ''}>Film</option>
                                            <option value="series" ${selectedType === 'series' ? 'selected' : ''}>Serial</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">Yil *</label>
                                        <input type="number" id="movie-year" class="modal-input w-full p-3 rounded-md" placeholder="2024" value="${movieData.year || new Date().getFullYear()}" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">Davomiyligi (daqiqada)</label>
                                        <input type="number" id="movie-duration" class="modal-input w-full p-3 rounded-md" placeholder="120" value="${movieData.duration || ''}">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-400 mb-1">Poster URL *</label>
                                        <input type="url" id="movie-poster-url" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${movieData.poster || movieData.posterUrl || ''}" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Description -->
                            <div class="step-content hidden" data-step="2">
                                <h4 class="text-2xl font-bold mb-6 text-white">Tavsif</h4>
                                <div class="mb-6">
                                    <label for="movie-description" class="block text-sm font-medium text-gray-400 mb-2">Kontent haqida</label>
                                    <textarea id="movie-description" class="modal-input w-full p-3 rounded-md" rows="8" placeholder="Kontent haqida batafsil yozing...">${movieData.description || ''}</textarea>
                                    <p class="text-xs text-gray-500 mt-2">Tomoshabinlar uchun qiziqarli va tushunarli tavsif yozing</p>
                                </div>
                                
                                <!-- Screenshots Section -->
                                <div class="border-t border-gray-700 pt-6">
                                    <h5 class="text-xl font-semibold mb-4 text-white">Kinodan lavhalar / Скриншоты (1/5)</h5>
                                    <p class="text-sm text-gray-400 mb-4">Kontent uchun surat havolalarini qo'shing (maksimum 5 ta)</p>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="screenshot-1" class="block text-sm font-medium text-gray-400 mb-1">Surat 1</label>
                                            <input type="url" id="screenshot-1" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${movieData.screenshots && movieData.screenshots[0] ? movieData.screenshots[0] : ''}">
                                        </div>
                                        <div>
                                            <label for="screenshot-2" class="block text-sm font-medium text-gray-400 mb-1">Surat 2</label>
                                            <input type="url" id="screenshot-2" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${movieData.screenshots && movieData.screenshots[1] ? movieData.screenshots[1] : ''}">
                                        </div>
                                        <div>
                                            <label for="screenshot-3" class="block text-sm font-medium text-gray-400 mb-1">Surat 3</label>
                                            <input type="url" id="screenshot-3" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${movieData.screenshots && movieData.screenshots[2] ? movieData.screenshots[2] : ''}">
                                        </div>
                                        <div>
                                            <label for="screenshot-4" class="block text-sm font-medium text-gray-400 mb-1">Surat 4</label>
                                            <input type="url" id="screenshot-4" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${movieData.screenshots && movieData.screenshots[3] ? movieData.screenshots[3] : ''}">
                                        </div>
                                        <div>
                                            <label for="screenshot-5" class="block text-sm font-medium text-gray-400 mb-1">Surat 5</label>
                                            <input type="url" id="screenshot-5" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${movieData.screenshots && movieData.screenshots[4] ? movieData.screenshots[4] : ''}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Cast -->
                            <div class="step-content hidden" data-step="3">
                                <h4 class="text-2xl font-bold mb-6 text-white">Aktyorlar</h4>
                                <div id="cast-container" class="space-y-4 mb-4"></div>
                                <button type="button" id="add-cast-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 px-6 rounded-md">
                                    <i class="fas fa-plus mr-2"></i>Aktyor qo'shish
                                </button>
                            </div>
                            
                            <!-- Step 4: Video Sources -->
                            <div class="step-content hidden" data-step="4">
                                <h4 class="text-2xl font-bold mb-6 text-white">Video manbalar</h4>
                                
                                <!-- Single movie sources -->
                                <div id="movie-sources-section" class="${selectedType === 'series' ? 'hidden' : ''}">
                                    <p class="text-sm text-gray-400 mb-4">Turli sifatlardagi video havolalarini qo'shing</p>
                                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                                        <div>
                                            <label for="source-480p" class="block text-sm font-medium text-gray-400 mb-1">480p</label>
                                            <input type="url" id="source-480p" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${existingSources['480p'] || ''}">
                                        </div>
                                        <div>
                                            <label for="source-720p" class="block text-sm font-medium text-gray-400 mb-1">720p</label>
                                            <input type="url" id="source-720p" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${existingSources['720p'] || ''}">
                                        </div>
                                        <div>
                                            <label for="source-1080p" class="block text-sm font-medium text-gray-400 mb-1">1080p</label>
                                            <input type="url" id="source-1080p" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${existingSources['1080p'] || ''}">
                                        </div>
                                        <div>
                                            <label for="source-4k" class="block text-sm font-medium text-gray-400 mb-1">4K</label>
                                            <input type="url" id="source-4k" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${existingSources['4K'] || ''}">
                                        </div>
                                    </div>
                                    
                                    <!-- Embed Code Section -->
                                    <div class="border-t border-gray-700 pt-6">
                                        <h5 class="text-lg font-semibold mb-3 text-white">Embed код orqali</h5>
                                        <p class="text-xs text-gray-400 mb-3">Agar video xostingdan iframe kodni ko'chirsangiz, URL avtomatik ajratib olinadi</p>
                                        <div>
                                            <label for="embed-code-input" class="block text-sm font-medium text-gray-400 mb-1">Embed код (iframe)</label>
                                            <textarea id="embed-code-input" class="modal-input w-full p-3 rounded-md font-mono text-xs" rows="4" placeholder='<iframe src="https://myvidplay.com/e/xyz123" width="600" height="480" allowfullscreen></iframe>'></textarea>
                                            <button type="button" id="parse-embed-btn" class="mt-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-medium py-2 px-4 rounded-md">
                                                <i class="fas fa-magic mr-2"></i>URL ni ajratib olish
                                            </button>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                                
                                <!-- Episodes section (for series) -->
                                <div id="series-section" class="${selectedType === 'series' ? '' : 'hidden'}">
                                    <p class="text-sm text-gray-400 mb-4">Fasllar va epizodlarni qo'shing</p>
                                    <div id="partner-seasons-container" class="space-y-6 mb-4"></div>
                                    <button type="button" id="partner-add-season-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 px-6 rounded-md">
                                        <i class="fas fa-plus mr-2"></i>Fasl qo'shish
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Footer with navigation buttons -->
                    <div class="border-t border-gray-700 p-6 bg-gray-800 flex justify-between items-center">
                        <button type="button" id="prev-step-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hidden">
                            <i class="fas fa-arrow-left mr-2"></i>Orqaga
                        </button>
                        <div class="flex-1"></div>
                        <button type="button" id="next-step-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg">
                            Keyingi <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                        <button type="button" id="save-movie-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg hidden">
                            <i class="fas fa-save mr-2"></i>${isEdit ? 'Saqlash' : 'Qo\'shish'}
                        </button>
                    </div>
                </div>
            </div>`;
                            <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3 px-6 rounded-lg">
                                <i class="fas ${isEdit ? 'fa-save' : 'fa-plus-circle'} mr-2"></i>${isEdit ? 'Saqlash' : 'Qo\'shish'}
                            </button>
                            <button type="button" onclick="closeModal()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg">Bekor qilish</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');

            // Stepper Variables
            let currentStep = 1;
            const totalSteps = 4;

            // Get stepper elements
            const stepNavBtns = modal.querySelectorAll('.step-nav-btn');
            const stepContents = modal.querySelectorAll('.step-content');
            const prevBtn = modal.querySelector('#prev-step-btn');
            const nextBtn = modal.querySelector('#next-step-btn');
            const saveBtn = modal.querySelector('#save-movie-btn');
            const closeBtn = modal.querySelector('#close-modal-btn');
            
            const typeSelect = document.getElementById('movie-type');
            const movieSourcesSection = document.getElementById('movie-sources-section');
            const seriesSection = document.getElementById('series-section');
            const seasonsContainer = document.getElementById('partner-seasons-container');
            const addSeasonBtn = document.getElementById('partner-add-season-btn');
            const castContainer = document.getElementById('cast-container');
            const addCastBtn = document.getElementById('add-cast-btn');

            // Stepper Functions
            function showStep(stepNum) {
                currentStep = stepNum;
                
                // Update content visibility
                stepContents.forEach(content => {
                    content.classList.add('hidden');
                });
                const activeContent = modal.querySelector(`.step-content[data-step="${stepNum}"]`);
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }
                
                // Update sidebar navigation
                stepNavBtns.forEach((btn, idx) => {
                    const step = idx + 1;
                    btn.classList.remove('bg-blue-600', 'opacity-50');
                    if (step === stepNum) {
                        btn.classList.add('bg-blue-600');
                    } else if (step < stepNum || window.movieFormData.completedSteps.has(step)) {
                        btn.classList.remove('opacity-50');
                    } else {
                        btn.classList.add('opacity-50');
                    }
                    
                    const indicator = btn.querySelector('.step-indicator');
                    const stepNumber = indicator.querySelector('.step-number');
                    const stepCheck = indicator.querySelector('.step-check');
                    
                    if (window.movieFormData.completedSteps.has(step)) {
                        stepNumber.classList.add('hidden');
                        stepCheck.classList.remove('hidden');
                        indicator.classList.remove('border-gray-600');
                        indicator.classList.add('border-green-400');
                    } else {
                        stepNumber.classList.remove('hidden');
                        stepCheck.classList.add('hidden');
                        indicator.classList.remove('border-green-400');
                        indicator.classList.add('border-gray-600');
                    }
                });
                
                // Update navigation buttons
                prevBtn.classList.toggle('hidden', stepNum === 1);
                nextBtn.classList.toggle('hidden', stepNum === totalSteps);
                saveBtn.classList.toggle('hidden', stepNum !== totalSteps);
            }

            function validateStep(stepNum) {
                if (stepNum === 1) {
                    const title = document.getElementById('movie-title').value.trim();
                    const poster = document.getElementById('movie-poster-url').value.trim();
                    if (!title) {
                        showToast('Kontent nomini kiriting', true);
                        return false;
                    }
                    if (!poster) {
                        showToast('Poster URL kiriting', true);
                        return false;
                    }
                    window.movieFormData.step1 = {
                        title, poster,
                        type: typeSelect.value,
                        year: document.getElementById('movie-year').value,
                        duration: document.getElementById('movie-duration').value
                    };
                }
                
                if (stepNum === 2) {
                    window.movieFormData.step2 = {
                        description: document.getElementById('movie-description').value.trim()
                    };
                }
                
                if (stepNum === 3) {
                    // Cast is optional
                    window.movieFormData.step3 = { cast: 'ok' };
                }
                
                if (stepNum === 4) {
                    const type = typeSelect.value;
                    if (type === 'movie') {
                        const sources = ['480p', '720p', '1080p', '4k'].map(q => 
                            document.getElementById(`source-${q}`)?.value.trim()
                        );
                        if (sources.every(s => !s)) {
                            showToast('Kamida bitta video URL kiriting', true);
                            return false;
                        }
                    } else {
                        const seasons = seasonsContainer.querySelectorAll('.season-block');
                        if (seasons.length === 0) {
                            showToast('Kamida bitta fasl qo\'shing', true);
                            return false;
                        }
                    }
                    window.movieFormData.step4 = { sources: 'ok' };
                }
                
                window.movieFormData.completedSteps.add(stepNum);
                return true;
            }

            // Navigation event listeners
            stepNavBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetStep = parseInt(btn.dataset.step);
                    if (targetStep < currentStep || window.movieFormData.completedSteps.has(targetStep - 1)) {
                        if (validateStep(currentStep)) {
                            showStep(targetStep);
                        }
                    }
                });
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 1) {
                    if (validateStep(currentStep)) {
                        showStep(currentStep - 1);
                    }
                }
            });

            nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    showStep(currentStep + 1);
                }
            });

            closeBtn.addEventListener('click', () => {
                closeModal();
            });
            
            saveBtn.addEventListener('click', async () => {
                if (validateStep(currentStep)) {
                    await saveMovie(movieId);
                }
            });
            
            // Cast Management
            function addCastMember(castData = {}) {
                const castIndex = castContainer.children.length;
                const castBlock = document.createElement('div');
                castBlock.className = 'cast-block bg-gray-700 p-4 rounded-lg border border-gray-600';
                castBlock.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h5 class="font-semibold text-white">Aktyor ${castIndex + 1}</h5>
                        <button type="button" class="remove-cast-btn text-red-400 hover:text-red-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Ismi</label>
                            <input type="text" class="cast-name modal-input w-full p-2 rounded-md" placeholder="John Doe" value="${castData.name || ''}">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Roli</label>
                            <input type="text" class="cast-character modal-input w-full p-2 rounded-md" placeholder="Main Character" value="${castData.character || ''}">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs text-gray-400 mb-1">Rasm URL</label>
                            <input type="url" class="cast-image modal-input w-full p-2 rounded-md" placeholder="https://..." value="${castData.image || ''}">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs text-gray-400 mb-1">Biografiya</label>
                            <textarea class="cast-bio modal-input w-full p-2 rounded-md" rows="2" placeholder="Aktyor haqida qisqacha...">${castData.bio || ''}</textarea>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-600">
                        <p class="text-xs text-gray-400 mb-2">Ijtimoiy tarmoqlar:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1"><i class="fab fa-instagram text-pink-400"></i> Instagram</label>
                                <input type="text" class="cast-social-instagram modal-input w-full p-2 rounded-md text-sm" placeholder="@username" value="${castData.social?.instagram || ''}">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1"><i class="fab fa-facebook text-blue-400"></i> Facebook</label>
                                <input type="text" class="cast-social-facebook modal-input w-full p-2 rounded-md text-sm" placeholder="username" value="${castData.social?.facebook || ''}">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1"><i class="fab fa-twitter text-blue-300"></i> Twitter</label>
                                <input type="text" class="cast-social-twitter modal-input w-full p-2 rounded-md text-sm" placeholder="@username" value="${castData.social?.twitter || ''}">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1"><i class="fab fa-wikipedia-w text-gray-300"></i> Wikipedia</label>
                                <input type="text" class="cast-social-wikipedia modal-input w-full p-2 rounded-md text-sm" placeholder="Page name" value="${castData.social?.wikipedia || ''}">
                            </div>
                        </div>
                    </div>
                `;
                
                castBlock.querySelector('.remove-cast-btn').addEventListener('click', () => {
                    castBlock.remove();
                    updateCastTitles();
                });
                
                castContainer.appendChild(castBlock);
                updateCastTitles();
            }
            
            function updateCastTitles() {
                const castBlocks = castContainer.querySelectorAll('.cast-block');
                castBlocks.forEach((block, idx) => {
                    const titleEl = block.querySelector('h5');
                    if (titleEl) {
                        titleEl.textContent = `Aktyor ${idx + 1}`;
                    }
                });
            }
            
            addCastBtn.addEventListener('click', () => addCastMember());
            
            // Load existing cast data
            if (Array.isArray(movieData.cast) && movieData.cast.length > 0) {
                movieData.cast.forEach(castMember => {
                    if (typeof castMember === 'object') {
                        addCastMember(castMember);
                    } else if (typeof castMember === 'string') {
                        addCastMember({ name: castMember, character: '', image: '', bio: '' });
                    }
                });
            }
            
            // Initialize stepper
            showStep(1);

            function ensureSeasonExists() {
                if (!seasonsContainer) return;
                if (seasonsContainer.children.length === 0) {
                    addSeasonBlock();
                }
            }

            function updateSeasonTitles() {
                if (!seasonsContainer) return;
                seasonsContainer.querySelectorAll('.season-block').forEach((block, idx) => {
                    const titleEl = block.querySelector('.season-title');
                    if (!titleEl) return;
                    const number = parseInt(block.querySelector('.season-number-input')?.value, 10);
                    const name = block.querySelector('.season-name-input')?.value.trim();
                    const labelNumber = !isNaN(number) && number > 0 ? number : (idx + 1);
                    titleEl.textContent = name ? `Fasl ${labelNumber} — ${name}` : `Fasl ${labelNumber}`;
                });
            }

            function updateEpisodeTitles(seasonBlock) {
                seasonBlock.querySelectorAll('.episode-block').forEach((block, idx) => {
                    const titleEl = block.querySelector('.episode-title');
                    if (titleEl) {
                        titleEl.textContent = `Qism ${idx + 1}`;
                    }
                });
            }

            function addEpisodeBlock(seasonBlock, initialValues = {}) {
                const episodesWrapper = seasonBlock.querySelector('.season-episodes');
                if (!episodesWrapper) return;
                const block = document.createElement('div');
                block.className = 'episode-block bg-gray-700 p-4 rounded-md relative';
                const initialTitle = initialValues.title || initialValues.name || initialValues.episodeTitle || '';
                const initialNumber = initialValues.episodeNumber || initialValues.number || initialValues.ep || '';
                const initialDuration = initialValues.durationMinutes || initialValues.duration || initialValues.length || '';
                const initialThumbnail = initialValues.thumbnail || initialValues.thumb || initialValues.image || initialValues.still || initialValues.poster || initialValues.cover || initialValues.artwork || initialValues.img || initialValues.imgUrl || initialValues.imageUrl || '';
                const sources = initialValues.sources || {};
                block.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h6 class="episode-title font-semibold">Qism ${episodesWrapper.children.length + 1}</h6>
                        <button type="button" class="remove-episode-btn text-red-400 hover:text-red-200 text-xl leading-none">&times;</button>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Qism nomi</label>
                            <input type="text" class="episode-title-input modal-input w-full p-2 rounded-md" placeholder="Masalan, Final" value="${initialTitle || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Qism raqami</label>
                            <input type="number" min="1" class="episode-number-input modal-input w-full p-2 rounded-md" placeholder="1" value="${initialNumber || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Davomiyligi (daqiqada)</label>
                            <input type="number" min="1" class="episode-duration-input modal-input w-full p-2 rounded-md" placeholder="45" value="${initialDuration || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Rasm (URL)</label>
                            <input type="url" class="episode-thumbnail-input modal-input w-full p-2 rounded-md" placeholder="https://..." value="${initialThumbnail || ''}">
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">480p</label><input type="url" class="ep-source-480p modal-input w-full p-2 rounded-md" placeholder="https://..." value="${sources['480p'] || ''}"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">720p</label><input type="url" class="ep-source-720p modal-input w-full p-2 rounded-md" placeholder="https://..." value="${sources['720p'] || ''}"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">1080p</label><input type="url" class="ep-source-1080p modal-input w-full p-2 rounded-md" placeholder="https://..." value="${sources['1080p'] || ''}"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">4K</label><input type="url" class="ep-source-4k modal-input w-full p-2 rounded-md" placeholder="https://..." value="${sources['4K'] || ''}"></div>
                    </div>
                `;
                episodesWrapper.appendChild(block);
                block.querySelector('.remove-episode-btn')?.addEventListener('click', () => {
                    block.remove();
                    updateEpisodeTitles(seasonBlock);
                });
                updateEpisodeTitles(seasonBlock);
            }

            function addSeasonBlock(initialValues = {}) {
                if (!seasonsContainer) return;
                const block = document.createElement('div');
                block.className = 'season-block bg-gray-800 border border-gray-700 rounded-lg p-4';
                const resolvedNumber = initialValues.number ?? initialValues.seasonNumber ?? null;
                const resolvedName = initialValues.name ?? initialValues.seasonName ?? initialValues.originalName ?? initialValues.seasonTitle ?? '';
                const resolvedStart = initialValues.startEpisodeNumber ?? initialValues.seasonEpisodeStart ?? initialValues.seasonEpisodeOffset ?? initialValues.seasonStartEpisode ?? '';
                block.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h5 class="season-title text-lg font-semibold">Fasl ${seasonsContainer.children.length + 1}</h5>
                            <p class="text-xs text-gray-400 mt-1">Fasl raqami va nomini kiriting.</p>
                        </div>
                        <button type="button" class="remove-season-btn text-red-400 hover:text-red-200 text-2xl leading-none">&times;</button>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Fasl raqami</label>
                            <input type="number" min="1" class="season-number-input modal-input w-full p-2 rounded-md" placeholder="1" value="${resolvedNumber ?? ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Fasl nomi</label>
                            <input type="text" class="season-name-input modal-input w-full p-2 rounded-md" placeholder="Masalan, Yangi mavsum" value="${resolvedName || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Boshlanish raqami</label>
                            <input type="number" min="1" class="season-start-input modal-input w-full p-2 rounded-md" placeholder="1" value="${resolvedStart || ''}">
                        </div>
                    </div>
                    <div class="season-episodes space-y-4"></div>
                    <button type="button" class="add-season-episode-btn bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-4 rounded-md mt-4">Qism qo\'shish</button>
                `;
                seasonsContainer.appendChild(block);

                block.querySelector('.remove-season-btn')?.addEventListener('click', () => {
                    block.remove();
                    updateSeasonTitles();
                    ensureSeasonExists();
                });

                [block.querySelector('.season-number-input'), block.querySelector('.season-name-input')].forEach(input => {
                    input?.addEventListener('input', updateSeasonTitles);
                });

                block.querySelector('.add-season-episode-btn')?.addEventListener('click', () => addEpisodeBlock(block));

                const resolvedEpisodes = Array.isArray(initialValues.episodes) ? initialValues.episodes : [];
                if (resolvedEpisodes.length > 0) {
                    resolvedEpisodes.forEach(ep => addEpisodeBlock(block, ep));
                } else {
                    addEpisodeBlock(block);
                }

                updateSeasonTitles();
            }

            function populateExistingSeriesStructure() {
                if (!seasonsContainer) return;
                seasonsContainer.innerHTML = '';
                if (selectedType === 'series' && Array.isArray(movieData.episodes) && movieData.episodes.length > 0) {
                    const seasonGroups = new Map();
                    movieData.episodes.forEach(ep => {
                        const number = ep.seasonNumber ?? ep.season ?? ep.seasonNo ?? null;
                        const name = ep.seasonName ?? ep.seasonTitle ?? ep.season_label ?? ep.seasonLabel ?? '';
                        const key = number != null ? `num:${number}` : (name ? `name:${name}` : 'default');
                        if (!seasonGroups.has(key)) {
                            seasonGroups.set(key, {
                                seasonNumber: number,
                                seasonName: name,
                                episodes: [],
                                seasonEpisodeStart: ep.seasonEpisodeStart ?? ep.seasonEpisodeOffset ?? ep.seasonStartEpisode ?? ep.startEpisodeNumber ?? null
                            });
                        }
                        const group = seasonGroups.get(key);
                        if (!group.seasonEpisodeStart) {
                            const startOverride = ep.seasonEpisodeStart ?? ep.seasonEpisodeOffset ?? ep.seasonStartEpisode ?? ep.startEpisodeNumber;
                            if (startOverride) {
                                group.seasonEpisodeStart = startOverride;
                            }
                        }
                        group.episodes.push(ep);
                    });
                    seasonGroups.forEach(group => addSeasonBlock(group));
                } else if (selectedType === 'series') {
                    ensureSeasonExists();
                }
            }

            typeSelect?.addEventListener('change', () => {
                if (typeSelect.value === 'series') {
                    movieSourcesSection?.classList.add('hidden');
                    seriesSection?.classList.remove('hidden');
                    ensureSeasonExists();
                } else {
                    movieSourcesSection?.classList.remove('hidden');
                    seriesSection?.classList.add('hidden');
                }
            });

            addSeasonBtn?.addEventListener('click', () => addSeasonBlock());
            
            // Embed code parser
            const parseEmbedBtn = document.getElementById('parse-embed-btn');
            const embedCodeInput = document.getElementById('embed-code-input');
            
            if (parseEmbedBtn && embedCodeInput) {
                parseEmbedBtn.addEventListener('click', () => {
                    const embedCode = embedCodeInput.value.trim();
                    if (!embedCode) {
                        showToast('Embed kodni kiriting', true);
                        return;
                    }
                    
                    // Extract URL from iframe src
                    const srcMatch = embedCode.match(/src=["']([^"']+)["']/);
                    if (srcMatch && srcMatch[1]) {
                        const extractedUrl = srcMatch[1];
                        // Put URL in 720p field by default
                        const source720p = document.getElementById('source-720p');
                        if (source720p) {
                            source720p.value = extractedUrl;
                            showToast('URL ajratib olindi va 720p maydoniga joylandi!');
                            embedCodeInput.value = '';
                        }
                    } else {
                        showToast('Iframe src topilmadi. To\'g\'ri iframe kodni kiriting.', true);
                    }
                });
            }
            
            populateExistingSeriesStructure();

            window.closeModal = closeModal;
        }

        async function saveMovie(movieId) {
            const title = document.getElementById('movie-title').value.trim();
            const type = document.getElementById('movie-type').value;
            const year = parseInt(document.getElementById('movie-year').value, 10);
            const duration = parseInt(document.getElementById('movie-duration').value, 10) || null;
            const description = document.getElementById('movie-description').value.trim();
            const posterUrl = document.getElementById('movie-poster-url').value.trim();

            if (!title) {
                showToast('Nom maydoni to\'ldirilishi kerak', true);
                return;
            }
            
            // Collect cast data
            const castBlocks = document.querySelectorAll('.cast-block');
            const castData = [];
            castBlocks.forEach(block => {
                const name = block.querySelector('.cast-name')?.value.trim();
                const character = block.querySelector('.cast-character')?.value.trim();
                const image = block.querySelector('.cast-image')?.value.trim();
                const bio = block.querySelector('.cast-bio')?.value.trim();
                
                const social = {
                    instagram: block.querySelector('.cast-social-instagram')?.value.trim() || '',
                    facebook: block.querySelector('.cast-social-facebook')?.value.trim() || '',
                    twitter: block.querySelector('.cast-social-twitter')?.value.trim() || '',
                    wikipedia: block.querySelector('.cast-social-wikipedia')?.value.trim() || ''
                };
                
                if (name) {
                    castData.push({
                        name: name,
                        character: character || '',
                        image: image || '',
                        bio: bio || '',
                        social: social
                    });
                }
            });

            let sources = {};
            let episodes = null;
            let primaryVideoUrl = '';

            if (type === 'series') {
                episodes = [];
                const seasonBlocks = document.querySelectorAll('#partner-seasons-container .season-block');
                if (seasonBlocks.length === 0) {
                    showToast('Kamida bitta fasl qo\'shing', true);
                    return;
                }
                let hasEmptySeason = false;
                seasonBlocks.forEach((seasonBlock, seasonIdx) => {
                    const seasonNumberInput = seasonBlock.querySelector('.season-number-input');
                    const seasonNameInput = seasonBlock.querySelector('.season-name-input');
                    const seasonStartInput = seasonBlock.querySelector('.season-start-input');
                    const episodeBlocks = seasonBlock.querySelectorAll('.episode-block');
                    if (episodeBlocks.length === 0) {
                        hasEmptySeason = true;
                        return;
                    }
                    const parsedSeasonNumber = parseInt(seasonNumberInput?.value, 10);
                    const seasonNumber = !isNaN(parsedSeasonNumber) && parsedSeasonNumber > 0 ? parsedSeasonNumber : (seasonIdx + 1);
                    const seasonName = seasonNameInput?.value.trim() || '';
                    const startFromRaw = seasonStartInput?.value || '';
                    const startFrom = startFromRaw ? parseInt(startFromRaw, 10) : null;

                    episodeBlocks.forEach((block, idx) => {
                        const epTitle = block.querySelector('.episode-title-input')?.value.trim();
                        const epNumberRaw = block.querySelector('.episode-number-input')?.value;
                        const epNumber = epNumberRaw ? parseInt(epNumberRaw, 10) : null;
                        const durationRaw = block.querySelector('.episode-duration-input')?.value;
                        const durationMinutes = durationRaw ? parseFloat(durationRaw) : null;
                        const thumbnail = block.querySelector('.episode-thumbnail-input')?.value.trim();
                        const epSources = {
                            '480p': block.querySelector('.ep-source-480p')?.value || '',
                            '720p': block.querySelector('.ep-source-720p')?.value || '',
                            '1080p': block.querySelector('.ep-source-1080p')?.value || '',
                            '4K': block.querySelector('.ep-source-4k')?.value || '',
                        };

                        if (!primaryVideoUrl) {
                            primaryVideoUrl = epSources['1080p'] || epSources['720p'] || epSources['480p'] || epSources['4K'] || primaryVideoUrl;
                        }

                        const episodePayload = {
                            seasonNumber,
                            seasonName: seasonName || undefined,
                            seasonTitle: seasonName || undefined,
                            episodeNumber: !isNaN(epNumber) && epNumber > 0 ? epNumber : undefined,
                            title: epTitle || undefined,
                            durationMinutes: !isNaN(durationMinutes) && durationMinutes > 0 ? durationMinutes : undefined,
                            thumbnail: thumbnail || undefined,
                            sources: epSources,
                        };

                        if (idx === 0 && startFrom && !isNaN(startFrom) && startFrom > 0) {
                            episodePayload.seasonEpisodeStart = startFrom;
                        }

                        Object.keys(episodePayload).forEach(key => {
                            if (episodePayload[key] === undefined || episodePayload[key] === '') {
                                delete episodePayload[key];
                            }
                        });

                        episodes.push(episodePayload);
                    });
                });

                if (hasEmptySeason || episodes.length === 0) {
                    showToast('Har bir faslda kamida bitta qism bo\'lishi kerak', true);
                    return;
                }

                sources = episodes[0]?.sources || {};
            } else {
                sources = {
                    '480p': document.getElementById('source-480p').value.trim(),
                    '720p': document.getElementById('source-720p').value.trim(),
                    '1080p': document.getElementById('source-1080p').value.trim(),
                    '4K': document.getElementById('source-4k').value.trim(),
                };
                primaryVideoUrl = sources['1080p'] || sources['720p'] || sources['480p'] || sources['4K'] || '';
                if (!primaryVideoUrl) {
                    showToast('Kamida bitta video URL kiriting', true);
                    return;
                }
            }

            loadingOverlay.classList.remove('hidden');

            try {
                const movieData = {
                    title,
                    type,
                    year,
                    duration,
                    description,
                    poster: posterUrl || undefined,
                    posterUrl: posterUrl || undefined,
                    videoUrl: primaryVideoUrl,
                    sources,
                    cast: castData,
                    // Screenshots
                    screenshots: [
                        document.getElementById('screenshot-1')?.value.trim(),
                        document.getElementById('screenshot-2')?.value.trim(),
                        document.getElementById('screenshot-3')?.value.trim(),
                        document.getElementById('screenshot-4')?.value.trim(),
                        document.getElementById('screenshot-5')?.value.trim()
                    ].filter(url => url !== ''),
                    partnerId: currentPartnerId,
                    needsReview: true,
                    suspended: false,
                    views: movieId ? undefined : 0,
                    rating: movieId ? undefined : 0,
                    updatedAt: serverTimestamp(),
                    allowedCategories: currentUserData?.allowedCategories || [],
                    allowedRegions: currentUserData?.allowedRegions || []
                };

                if (episodes !== null) {
                    movieData.episodes = episodes;
                }

                if (movieId) {
                    await updateDoc(doc(db, "movies", movieId), movieData);
                    showToast('Kontent yangilandi. Admin tasdig\'ini kutmoqda.');
                } else {
                    movieData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "movies"), movieData);
                    showToast('Kontent qo\'shildi. Admin tasdig\'ini kutmoqda.');
                }

                closeModal();
            } catch (error) {
                console.error('Error saving movie:', error);
                showToast('Xatolik: ' + error.message, true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function renderRoyaltyPanel() {
            try {
                const panel = document.getElementById('royalty-panel');
                if (!panel) return;
                const totalRevenue = movies.reduce((acc, m) => acc + ((m.views || 0) * (settings.royaltyPerView || 0.05)), 0);
                const thisMonthRevenue = movies.reduce((acc, m) => {
                    const movieDate = m.uploadedAt ? new Date(m.uploadedAt.seconds * 1000) : new Date();
                    const thisMonth = new Date().getMonth() === movieDate.getMonth();
                    return acc + (thisMonth ? ((m.views || 0) * (settings.royaltyPerView || 0.05)) : 0);
                }, 0);
            
            panel.innerHTML = `
                <div class="space-y-6">
                    <!-- Daromad Kartalari -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-green-900 to-green-700 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-200 text-sm font-medium">${t('totalRevenue')}</p>
                                    <p class="text-4xl font-bold text-white mt-2">$${totalRevenue.toFixed(2)}</p>
                                    <p class="text-green-300 text-xs mt-1">${t('allTime')}</p>
                                </div>
                                <div class="bg-green-800/50 p-4 rounded-xl">
                                    <i class="fas fa-dollar-sign text-3xl text-green-200"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-200 text-sm font-medium">${t('thisMonth')}</p>
                                    <p class="text-4xl font-bold text-white mt-2">$${thisMonthRevenue.toFixed(2)}</p>
                                    <p class="text-blue-300 text-xs mt-1">${new Date().toLocaleDateString(currentLanguage === 'en' ? 'en-US' : currentLanguage === 'ru' ? 'ru-RU' : currentLanguage === 'tj' ? 'tg-TJ' : 'uz-UZ', { month: 'long' })}</p>
                                </div>
                                <div class="bg-blue-800/50 p-4 rounded-xl">
                                    <i class="fas fa-calendar-alt text-3xl text-blue-200"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-yellow-200 text-sm font-medium">${t('perView')}</p>
                                    <p class="text-4xl font-bold text-white mt-2">$${(settings.royaltyPerView || 0.05).toFixed(3)}</p>
                                    <p class="text-yellow-300 text-xs mt-1">Per view</p>
                                </div>
                                <div class="bg-yellow-800/50 p-4 rounded-xl">
                                    <i class="fas fa-eye text-3xl text-yellow-200"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Film bo'yicha daromad -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-line text-blue-400"></i>
                            ${t('revenueByMovie')}
                        </h4>
                        ${movies.length > 0 ? `
                            <div class="space-y-3">
                                ${movies.sort((a, b) => ((b.views || 0) * settings.royaltyPerView) - ((a.views || 0) * settings.royaltyPerView))
                                    .map(m => {
                                        const revenue = (m.views || 0) * (settings.royaltyPerView || 0.05);
                                        const percentage = totalRevenue > 0 ? (revenue / totalRevenue * 100) : 0;
                                        return `
                                            <div class="bg-gray-700 p-4 rounded-lg">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div class="flex-1">
                                                        <h5 class="text-white font-semibold">${m.title}</h5>
                                                        <p class="text-gray-400 text-sm">${(m.views || 0).toLocaleString()} ${t('views')}</p>
                                                    </div>
                                                    <span class="text-green-400 font-bold text-lg">$${revenue.toFixed(2)}</span>
                                                </div>
                                                <div class="bg-gray-600 rounded-full h-2 overflow-hidden">
                                                    <div class="bg-gradient-to-r from-green-500 to-green-400 h-full transition-all" 
                                                         style="width: ${percentage}%"></div>
                                                </div>
                                                <p class="text-gray-500 text-xs mt-1">${percentage.toFixed(1)}% ${t('ofTotal')}</p>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-8">
                                <i class="fas fa-chart-line text-6xl text-gray-600 mb-3"></i>
                                <p class="text-gray-400">${t('noRevenue')}</p>
                            </div>
                        `}
                    </div>
                    
                    <!-- To'lov ma'lumotlari -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-info-circle text-purple-400"></i>
                            ${t('paymentInfo')}
                        </h4>
                        <div class="space-y-4">
                            <div class="flex items-start gap-3 bg-gray-700 p-4 rounded-lg">
                                <i class="fas fa-calendar text-blue-400 text-xl mt-1"></i>
                                <div>
                                    <p class="text-white font-semibold">${t('paymentDate')}</p>
                                    <p class="text-gray-400 text-sm">${t('paymentDay')}</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 bg-gray-700 p-4 rounded-lg">
                                <i class="fas fa-money-check text-green-400 text-xl mt-1"></i>
                                <div>
                                    <p class="text-white font-semibold">${t('minPayment')}</p>
                                    <p class="text-gray-400 text-sm">${t('minPaymentAmount')}</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 bg-gray-700 p-4 rounded-lg">
                                <i class="fas fa-university text-yellow-400 text-xl mt-1"></i>
                                <div>
                                    <p class="text-white font-semibold">${t('paymentMethod')}</p>
                                    <p class="text-gray-400 text-sm">${t('paymentMethods')}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            } catch (error) {
                console.error('Error in renderRoyaltyPanel:', error);
                const panel = document.getElementById('royalty-panel');
                if (panel) {
                    panel.innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`;
                }
            }
        }

        function renderStatsPanel() {
            try {
                const panel = document.getElementById('stats-panel');
                if (!panel) return;
            const totalRevenue = movies.reduce((acc, m) => acc + ((m.views || 0) * (settings.royaltyPerView || 0.05)), 0);
            const totalViews = movies.reduce((acc, m) => acc + (m.views || 0), 0);
            const avgRating = movies.length > 0 ? (movies.reduce((acc, m) => acc + (Number(m.rating) || 0), 0) / movies.length).toFixed(1) : 0;
            const topMovie = movies.sort((a, b) => (b.views || 0) - (a.views || 0))[0];
            
            panel.innerHTML = `
                <div class="space-y-6">
                    <!-- Asosiy Statistika -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-200 text-sm font-medium">Jami Filmlar</p>
                                    <p class="text-4xl font-bold text-white mt-2">${movies.length}</p>
                                    <p class="text-purple-300 text-xs mt-1">Aktiv kontent</p>
                                </div>
                                <div class="bg-purple-800/50 p-4 rounded-xl">
                                    <i class="fas fa-film text-3xl text-purple-200"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-200 text-sm font-medium">Jami Ko'rishlar</p>
                                    <p class="text-4xl font-bold text-white mt-2">${totalViews.toLocaleString()}</p>
                                    <p class="text-blue-300 text-xs mt-1">Barcha filmlar</p>
                                </div>
                                <div class="bg-blue-800/50 p-4 rounded-xl">
                                    <i class="fas fa-eye text-3xl text-blue-200"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-yellow-200 text-sm font-medium">O'rtacha Reyting</p>
                                    <p class="text-4xl font-bold text-white mt-2">${avgRating}</p>
                                    <p class="text-yellow-300 text-xs mt-1">5 dan</p>
                                </div>
                                <div class="bg-yellow-800/50 p-4 rounded-xl">
                                    <i class="fas fa-star text-3xl text-yellow-200"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-900 to-green-700 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-200 text-sm font-medium">Jami Daromad</p>
                                    <p class="text-4xl font-bold text-white mt-2">$${totalRevenue.toFixed(2)}</p>
                                    <p class="text-green-300 text-xs mt-1">Umumiy</p>
                                </div>
                                <div class="bg-green-800/50 p-4 rounded-xl">
                                    <i class="fas fa-dollar-sign text-3xl text-green-200"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Eng Ko'p Ko'rilgan Film -->
                    ${topMovie ? `
                        <div class="bg-gradient-to-r from-orange-900 to-red-900 rounded-xl p-6 shadow-xl">
                            <h4 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fas fa-trophy text-yellow-400"></i>
                                ${t('topMovie')}
                            </h4>
                            <div class="flex items-center gap-4">
                                <img src="${topMovie.posterUrl || 'https://via.placeholder.com/100x150'}" 
                                     alt="${topMovie.title}" 
                                     class="w-24 h-36 object-cover rounded-lg shadow-lg">
                                <div class="flex-1">
                                    <h5 class="text-2xl font-bold text-white">${topMovie.title}</h5>
                                    <p class="text-orange-200 mt-1">${topMovie.year || 'N/A'}</p>
                                    <div class="flex gap-4 mt-3">
                                        <div class="bg-orange-800/50 px-4 py-2 rounded-lg">
                                            <p class="text-orange-200 text-xs">${currentLanguage === 'en' ? 'Views' : currentLanguage === 'ru' ? 'Просмотры' : currentLanguage === 'tj' ? 'Тамошо' : 'Ko\'rishlar'}</p>
                                            <p class="text-white font-bold text-lg">${(topMovie.views || 0).toLocaleString()}</p>
                                        </div>
                                        <div class="bg-orange-800/50 px-4 py-2 rounded-lg">
                                            <p class="text-orange-200 text-xs">${currentLanguage === 'en' ? 'Rating' : currentLanguage === 'ru' ? 'Рейтинг' : currentLanguage === 'tj' ? 'Рейтинг' : 'Reyting'}</p>
                                            <p class="text-white font-bold text-lg">${(Number(topMovie.rating) || 0).toFixed(1)} ⭐</p>
                                        </div>
                                        <div class="bg-orange-800/50 px-4 py-2 rounded-lg">
                                            <p class="text-orange-200 text-xs">${currentLanguage === 'en' ? 'Revenue' : currentLanguage === 'ru' ? 'Доход' : currentLanguage === 'tj' ? 'Даромад' : 'Daromad'}</p>
                                            <p class="text-white font-bold text-lg">$${((topMovie.views || 0) * (settings.royaltyPerView || 0.05)).toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Top 5 Filmlar -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-fire text-red-400"></i>
                            ${t('topMovies')}
                        </h4>
                        ${movies.length > 0 ? `
                            <div class="space-y-3">
                                ${movies.sort((a, b) => (b.views || 0) - (a.views || 0))
                                    .slice(0, 5)
                                    .map((m, i) => `
                                        <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
                                            <div class="text-3xl font-bold ${i === 0 ? 'text-yellow-400' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-orange-600' : 'text-gray-500'}">
                                                ${i + 1}
                                            </div>
                                            <img src="${m.posterUrl || 'https://via.placeholder.com/50x75'}" 
                                                 alt="${m.title}" 
                                                 class="w-12 h-18 object-cover rounded">
                                            <div class="flex-1">
                                                <h5 class="text-white font-semibold">${m.title}</h5>
                                                <p class="text-gray-400 text-sm">${m.year || 'N/A'} • ${m.primaryCategory || 'general'}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-blue-400 font-bold">${(m.views || 0).toLocaleString()}</p>
                                                <p class="text-gray-500 text-xs">${t('views')}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-yellow-400 font-bold">${(Number(m.rating) || 0).toFixed(1)} ⭐</p>
                                                <p class="text-gray-500 text-xs">${t('rating')}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-8">
                                <i class="fas fa-chart-bar text-6xl text-gray-600 mb-3"></i>
                                <p class="text-gray-400">${t('noStats')}</p>
                            </div>
                        `}
                    </div>
                    
                    <!-- Kategoriyalar bo'yicha -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-layer-group text-green-400"></i>
                            ${t('categoryDist')}
                        </h4>
                        ${movies.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${Object.entries(movies.reduce((acc, m) => {
                                    const cat = m.primaryCategory || 'general';
                                    acc[cat] = (acc[cat] || 0) + 1;
                                    return acc;
                                }, {})).map(([cat, count]) => {
                                    const percentage = (count / movies.length * 100).toFixed(1);
                                    return `
                                        <div class="bg-gray-700 p-4 rounded-lg">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-white font-semibold capitalize">${cat}</span>
                                                <span class="text-blue-400 font-bold">${count} ta</span>
                                            </div>
                                            <div class="bg-gray-600 rounded-full h-2 overflow-hidden">
                                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full" 
                                                     style="width: ${percentage}%"></div>
                                            </div>
                                            <p class="text-gray-500 text-xs mt-1">${percentage}%</p>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-8">
                                <i class="fas fa-layer-group text-6xl text-gray-600 mb-3"></i>
                                <p class="text-gray-400">Ma'lumot yo'q</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            } catch (error) {
                console.error('Error in renderStatsPanel:', error);
                const panel = document.getElementById('stats-panel');
                if (panel) {
                    panel.innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`;
                }
            }
        }

        function renderSupportPanel() {
            const panel = document.getElementById('support-panel');
            panel.innerHTML = `
                <div class="flex h-[calc(100vh-150px)] bg-gray-900 rounded-xl overflow-hidden shadow-2xl border border-gray-800">
                    <!-- Left Sidebar - Chat List -->
                    <div class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
                        <!-- Search and Header -->
                        <div class="p-4 border-b border-gray-700">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                    <i class="fas fa-comments text-blue-400"></i>
                                    ${currentLanguage === 'en' ? 'Support' : currentLanguage === 'ru' ? 'Поддержка' : currentLanguage === 'tj' ? 'Дастгирӣ' : 'Yordam'}
                                </h3>
                                <button onclick="createNewSupportChat()" 
                                        class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-600 text-white w-10 h-10 rounded-full transition-all transform hover:scale-110 shadow-lg flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="chat-search" 
                                       placeholder="${currentLanguage === 'en' ? 'Search chats...' : currentLanguage === 'ru' ? 'Поиск чатов...' : currentLanguage === 'tj' ? 'Ҷустуҷӯи чатҳо...' : 'Chatlarni qidirish...'}"
                                       class="w-full bg-gray-700 border border-gray-600 text-white pl-10 pr-4 py-2.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition-all">
                            </div>
                        </div>
                        
                        <!-- Chats List -->
                        <div id="support-chats-list" class="flex-1 overflow-y-auto">
                            ${renderSupportChatsList()}
                        </div>
                        
                        <!-- Footer Info -->
                        <div class="p-3 border-t border-gray-700 bg-gray-850">
                            <div class="flex items-center gap-2 text-xs text-gray-400">
                                <i class="fas fa-shield-check text-green-400"></i>
                                <span>${currentLanguage === 'en' ? 'Secure & Encrypted' : currentLanguage === 'ru' ? 'Безопасно и зашифровано' : currentLanguage === 'tj' ? 'Бехатар ва рамзгузоришуда' : 'Xavfsiz va shifrlangan'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right - Chat Area -->
                    <div class="flex-1 flex flex-col bg-gray-900">
                        <div id="support-chat-area" class="flex-1 flex flex-col h-full">
                            ${activeSupportChatId ? renderActiveSupportChat() : renderNoSupportChatSelected()}
                        </div>
                    </div>
                </div>
            `;
            
            // Load support chats
            loadSupportChats();
            
            // Setup search functionality
            const searchInput = document.getElementById('chat-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredChats = supportChats.filter(chat => 
                        (chat.subject || '').toLowerCase().includes(searchTerm) ||
                        (chat.lastMessage || '').toLowerCase().includes(searchTerm)
                    );
                    const listContainer = document.getElementById('support-chats-list');
                    if (listContainer) {
                        listContainer.innerHTML = filteredChats.length > 0 ? 
                            filteredChats.map(chat => renderSingleChat(chat)).join('') :
                            `<div class="text-center py-8 px-4">
                                <i class="fas fa-search text-4xl text-gray-600 mb-3"></i>
                                <p class="text-gray-500 text-sm">${currentLanguage === 'en' ? 'No chats found' : currentLanguage === 'ru' ? 'Чаты не найдены' : currentLanguage === 'tj' ? 'Чатҳо ёфт нашуданд' : 'Chatlar topilmadi'}</p>
                            </div>`;
                    }
                });
            }
        }
        
        function renderSingleChat(chat) {
            const isActive = chat.id === activeSupportChatId;
            const statusColors = {
                'open': 'bg-green-500',
                'pending': 'bg-yellow-500',
                'closed': 'bg-gray-500',
                'resolved': 'bg-blue-500'
            };
            
            const statusIcons = {
                'open': 'fa-circle-check',
                'pending': 'fa-clock',
                'closed': 'fa-circle-xmark',
                'resolved': 'fa-check-double'
            };
            
            return `
                <div onclick="selectSupportChat('${chat.id}')" 
                     class="p-4 cursor-pointer transition-all border-b border-gray-700 ${isActive ? 'bg-gradient-to-r from-blue-900/40 to-blue-800/20 border-l-4 border-l-blue-500' : 'hover:bg-gray-750'} relative group">
                    <div class="flex items-start gap-3">
                        <div class="relative flex-shrink-0">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-lg ring-2 ring-gray-700">
                                <i class="fas fa-user-tie text-white text-lg"></i>
                            </div>
                            <span class="${statusColors[chat.status] || 'bg-gray-500'} w-3.5 h-3.5 rounded-full absolute -bottom-0.5 -right-0.5 border-2 border-gray-800 shadow-md flex items-center justify-center">
                                <i class="fas ${statusIcons[chat.status] || 'fa-circle'} text-white" style="font-size: 8px;"></i>
                            </span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <h5 class="text-white font-semibold text-sm truncate flex items-center gap-2">
                                    <i class="fas fa-headset text-red-400 text-xs"></i>
                                    ${chat.subject || (currentLanguage === 'en' ? 'Admin Support' : currentLanguage === 'ru' ? 'Поддержка админа' : currentLanguage === 'tj' ? 'Дастгирии админ' : 'Admin yordami')}
                                </h5>
                                ${chat.lastMessageAt ? `<span class="text-xs text-gray-500 flex-shrink-0">${formatMessageTime(chat.lastMessageAt)}</span>` : ''}
                            </div>
                            <p class="text-gray-400 text-xs truncate">${chat.lastMessage || (currentLanguage === 'en' ? 'No messages yet' : currentLanguage === 'ru' ? 'Нет сообщений' : currentLanguage === 'tj' ? 'Паёмҳо нест' : 'Xabarlar yo\'q')}</p>
                            ${chat.unreadCount > 0 ? `
                                <div class="mt-2">
                                    <span class="inline-flex items-center justify-center bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">
                                        ${chat.unreadCount} ${currentLanguage === 'en' ? 'new' : currentLanguage === 'ru' ? 'новых' : currentLanguage === 'tj' ? 'нав' : 'yangi'}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderSupportChatsList() {
            if (!supportChats || supportChats.length === 0) {
                return `
                    <div class="text-center py-16 px-6">
                        <div class="bg-gradient-to-br from-gray-700/50 to-gray-800/50 rounded-2xl w-24 h-24 flex items-center justify-center mx-auto mb-6 shadow-xl">
                            <i class="fas fa-comments text-5xl text-gray-500"></i>
                        </div>
                        <h4 class="text-lg font-bold text-white mb-2">
                            ${currentLanguage === 'en' ? 'No Support Chats' : currentLanguage === 'ru' ? 'Нет чатов поддержки' : currentLanguage === 'tj' ? 'Чатҳои дастгирӣ нест' : 'Yordam chatlari yo\'q'}
                        </h4>
                        <p class="text-gray-400 text-sm mb-6 max-w-xs mx-auto">
                            ${currentLanguage === 'en' ? 'Start a conversation with admin support team' : currentLanguage === 'ru' ? 'Начните разговор с командой поддержки админа' : currentLanguage === 'tj' ? 'Бо дастаи дастгирии админ гуфтугӯ оғоз кунед' : 'Admin yordam jamoasi bilan suhbat boshlang'}
                        </p>
                        <button onclick="createNewSupportChat()" 
                                class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg inline-flex items-center gap-2">
                            <i class="fas fa-plus-circle"></i>
                            ${currentLanguage === 'en' ? 'New Chat' : currentLanguage === 'ru' ? 'Новый чат' : currentLanguage === 'tj' ? 'Чати нав' : 'Yangi chat'}
                        </button>
                    </div>
                `;
            }
            
            return supportChats.map(chat => renderSingleChat(chat)).join('');
        }
        
        function formatMessageTime(timestamp) {
            if (!timestamp || !timestamp.seconds) return '';
            const date = new Date(timestamp.seconds * 1000);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } else if (diffDays === 1) {
                return currentLanguage === 'en' ? 'Yesterday' : currentLanguage === 'ru' ? 'Вчера' : currentLanguage === 'tj' ? 'Дирӯз' : 'Kecha';
            } else if (diffDays < 7) {
                return date.toLocaleDateString([], {weekday: 'short'});
            } else {
                return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
            }
        }
        
        function renderNoSupportChatSelected() {
            return `
                <div class="flex-1 flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-850 to-gray-900">
                    <div class="text-center px-8 max-w-lg">
                        <div class="relative inline-block mb-8">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-red-600 rounded-full blur-2xl opacity-30 animate-pulse"></div>
                            <div class="relative bg-gradient-to-br from-blue-600 via-red-600 to-red-500 w-32 h-32 rounded-full flex items-center justify-center shadow-2xl">
                                <i class="fas fa-headset text-6xl text-white"></i>
                            </div>
                        </div>
                        <h3 class="text-4xl font-bold text-white mb-4 bg-gradient-to-r from-blue-400 to-red-400 bg-clip-text text-transparent">
                            ${currentLanguage === 'en' ? 'Admin Support Center' : 
                              currentLanguage === 'ru' ? 'Центр поддержки админа' : 
                              currentLanguage === 'tj' ? 'Маркази дастгирии админ' : 
                              'Admin yordam markazi'}
                        </h3>
                        <p class="text-gray-300 mb-3 text-lg leading-relaxed">
                            ${currentLanguage === 'en' ? 'Connect directly with our admin team' : 
                              currentLanguage === 'ru' ? 'Свяжитесь напрямую с нашей командой админов' : 
                              currentLanguage === 'tj' ? 'Бевосита бо дастаи админи мо пайваст шавед' : 
                              'Admin jamoamiz bilan bevosita bog\'laning'}
                        </p>
                        <p class="text-gray-400 text-sm mb-8">
                            ${currentLanguage === 'en' ? 'Get help with uploads, payments, technical issues and more' : 
                              currentLanguage === 'ru' ? 'Получите помощь с загрузками, платежами, техническими проблемами и многим другим' : 
                              currentLanguage === 'tj' ? 'Кӯмак дар боркунӣ, пардохтҳо, масъалаҳои техникӣ ва гайра' : 
                              'Yuklash, to\'lovlar, texnik muammolar va boshqalar bo\'yicha yordam oling'}
                        </p>
                        
                        <!-- Features -->
                        <div class="grid grid-cols-3 gap-4 mb-8">
                            <div class="bg-gray-800/50 backdrop-blur rounded-xl p-4 border border-gray-700">
                                <i class="fas fa-bolt text-yellow-400 text-2xl mb-2"></i>
                                <p class="text-white text-xs font-semibold">
                                    ${currentLanguage === 'en' ? 'Fast Response' : currentLanguage === 'ru' ? 'Быстрый ответ' : currentLanguage === 'tj' ? 'Ҷавоби тез' : 'Tez javob'}
                                </p>
                            </div>
                            <div class="bg-gray-800/50 backdrop-blur rounded-xl p-4 border border-gray-700">
                                <i class="fas fa-shield-check text-green-400 text-2xl mb-2"></i>
                                <p class="text-white text-xs font-semibold">
                                    ${currentLanguage === 'en' ? 'Secure Chat' : currentLanguage === 'ru' ? 'Безопасный чат' : currentLanguage === 'tj' ? 'Чати бехатар' : 'Xavfsiz chat'}
                                </p>
                            </div>
                            <div class="bg-gray-800/50 backdrop-blur rounded-xl p-4 border border-gray-700">
                                <i class="fas fa-clock text-blue-400 text-2xl mb-2"></i>
                                <p class="text-white text-xs font-semibold">
                                    ${currentLanguage === 'en' ? '24/7 Available' : currentLanguage === 'ru' ? 'Доступно 24/7' : currentLanguage === 'tj' ? 'Дастрас 24/7' : '24/7 mavjud'}
                                </p>
                            </div>
                        </div>
                        
                        <button onclick="createNewSupportChat()" 
                                class="bg-gradient-to-r from-blue-600 to-red-600 hover:from-blue-500 hover:to-red-500 text-white font-bold py-4 px-8 rounded-2xl transition-all transform hover:scale-105 shadow-2xl inline-flex items-center gap-3 text-lg">
                            <i class="fas fa-comment-dots"></i>
                            ${currentLanguage === 'en' ? 'Start Conversation' : 
                              currentLanguage === 'ru' ? 'Начать разговор' : 
                              currentLanguage === 'tj' ? 'Гуфтугӯ оғоз кунед' : 
                              'Suhbat boshlash'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderActiveSupportChat() {
            const chat = supportChats.find(c => c.id === activeSupportChatId);
            if (!chat) return renderNoSupportChatSelected();
            
            return `
                <!-- Chat Header - Premium Style -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-850 border-b border-gray-700 p-4 shadow-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-xl ring-4 ring-gray-700/50">
                                    <i class="fas fa-user-tie text-white text-xl"></i>
                                </div>
                                <span class="w-4 h-4 bg-green-500 rounded-full absolute bottom-0 right-0 border-3 border-gray-800 shadow-lg animate-pulse"></span>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                    <i class="fas fa-shield-check text-blue-400"></i>
                                    ${currentLanguage === 'en' ? 'Admin Support Team' : currentLanguage === 'ru' ? 'Команда поддержки админа' : currentLanguage === 'tj' ? 'Дастаи дастгирии админ' : 'Admin yordam jamoasi'}
                                </h4>
                                <p class="text-xs text-green-400 flex items-center gap-1.5 font-semibold">
                                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                    ${currentLanguage === 'en' ? 'Online - Ready to help' : currentLanguage === 'ru' ? 'Онлайн - Готовы помочь' : currentLanguage === 'tj' ? 'Онлайн - Омодаи кӯмак' : 'Onlayn - Yordam berishga tayyor'}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="bg-gray-700/50 px-3 py-1.5 rounded-lg">
                                <span class="text-xs font-semibold ${chat.status === 'open' ? 'text-green-400' : chat.status === 'pending' ? 'text-yellow-400' : 'text-gray-400'}">
                                    <i class="fas fa-circle text-xs mr-1"></i>
                                    ${chat.status === 'open' ? (currentLanguage === 'en' ? 'Active' : currentLanguage === 'ru' ? 'Активно' : currentLanguage === 'tj' ? 'Фаъол' : 'Faol') : 
                                      chat.status === 'pending' ? (currentLanguage === 'en' ? 'Pending' : currentLanguage === 'ru' ? 'В ожидании' : currentLanguage === 'tj' ? 'Дар интизорӣ' : 'Kutilmoqda') : 
                                      (currentLanguage === 'en' ? 'Closed' : currentLanguage === 'ru' ? 'Закрыто' : currentLanguage === 'tj' ? 'Пӯшида' : 'Yopilgan')}
                                </span>
                            </div>
                            <div class="relative">
                                <button data-chat-menu="${chat.id}" id="chat-menu-btn-${chat.id}" 
                                        class="text-gray-300 hover:text-white p-2.5 rounded-lg hover:bg-gray-700 transition-all border border-gray-600 hover:border-gray-500">
                                    <i class="fas fa-ellipsis-v text-lg"></i>
                                </button>
                                <div id="chat-menu-${chat.id}" class="hidden absolute right-0 top-full mt-2 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl z-50 min-w-[200px] overflow-hidden">
                                    ${!chat.adminOpened ? `
                                        <button data-delete-chat="${chat.id}" class="w-full text-left px-4 py-3 hover:bg-red-600/20 text-red-400 transition-all flex items-center gap-3 border-b border-gray-700">
                                            <i class="fas fa-trash-alt"></i>
                                            <span class="font-semibold">${currentLanguage === 'en' ? 'Delete Chat' : currentLanguage === 'ru' ? 'Удалить чат' : currentLanguage === 'tj' ? 'Чатро нест кунед' : 'Chatni o\'chirish'}</span>
                                        </button>
                                    ` : ''}
                                    <button data-close-chat="${chat.id}" class="w-full text-left px-4 py-3 hover:bg-gray-700 text-gray-300 transition-all flex items-center gap-3 ${!chat.adminOpened ? 'border-b border-gray-700' : ''}">
                                        <i class="fas fa-check-circle"></i>
                                        <span class="font-semibold">${currentLanguage === 'en' ? 'Mark as Resolved' : currentLanguage === 'ru' ? 'Отметить как решено' : currentLanguage === 'tj' ? 'Ҳалшуда нишон диҳед' : 'Hal qilindi deb belgilash'}</span>
                                    </button>
                                    ${chat.adminOpened ? `
                                        <div class="px-4 py-3 bg-yellow-900/20 text-yellow-400 text-xs flex items-start gap-2">
                                            <i class="fas fa-info-circle mt-0.5"></i>
                                            <span>${currentLanguage === 'en' ? 'Admin has opened this chat. You cannot delete it.' : currentLanguage === 'ru' ? 'Админ открыл этот чат. Вы не можете его удалить.' : currentLanguage === 'tj' ? 'Админ ин чатро кушодааст. Шумо наметавонед онро нест кунед.' : 'Admin bu chatni ochgan. Siz uni o\'chira olmaysiz.'}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Messages - Enhanced Telegram Style -->
                <div id="support-messages-container" class="flex-1 overflow-y-auto p-6" 
                     style="background: linear-gradient(to bottom, #0a0e14 0%, #0f1419 100%); background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.01) 2px, rgba(255,255,255,0.01) 4px);">
                    <div id="support-messages">
                        <div class="flex justify-center py-12">
                            <div class="text-gray-500 text-sm flex items-center gap-3 bg-gray-800/50 backdrop-blur px-4 py-2 rounded-full">
                                <i class="fas fa-spinner fa-spin text-blue-400"></i>
                                ${currentLanguage === 'en' ? 'Loading messages...' : currentLanguage === 'ru' ? 'Загрузка сообщений...' : currentLanguage === 'tj' ? 'Паёмҳо бор мешаванд...' : 'Xabarlar yuklanmoqda...'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Message Input - Premium Style -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-850 border-t border-gray-700 p-4 shadow-2xl">
                    <form id="support-message-form" class="flex gap-3 items-end">
                        <button type="button" class="text-gray-400 hover:text-blue-400 transition-all p-3 hover:bg-gray-700/50 rounded-xl">
                            <i class="fas fa-paperclip text-xl"></i>
                        </button>
                        <div class="flex-1 relative">
                            <textarea id="support-message-input" required rows="1"
                                   class="w-full bg-gray-700/70 backdrop-blur border-2 border-gray-600 focus:border-blue-500 text-white p-4 pr-12 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 placeholder-gray-400 resize-none transition-all"
                                   placeholder="${currentLanguage === 'en' ? 'Type your message...' : currentLanguage === 'ru' ? 'Введите сообщение...' : currentLanguage === 'tj' ? 'Паёми худро нависед...' : 'Xabaringizni yozing...'}"
                                   style="min-height: 52px; max-height: 120px;"></textarea>
                            <button type="button" class="absolute right-3 bottom-3 text-gray-400 hover:text-yellow-400 transition-all">
                                <i class="fas fa-smile text-xl"></i>
                            </button>
                        </div>
                        <button type="submit" 
                                class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-600 text-white w-14 h-14 rounded-2xl transition-all transform hover:scale-110 shadow-2xl flex items-center justify-center flex-shrink-0 group">
                            <i class="fas fa-paper-plane text-lg transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform"></i>
                        </button>
                    </form>
                </div>
            `;
        }
        
        async function loadSupportChats() {
            try {
                if (!currentPartnerId) {
                    console.log('No partner ID available');
                    return;
                }

                console.log('Loading support chats for partner:', currentPartnerId);
                
                // Use real-time listener instead of one-time query
                const chatsQuery = query(
                    collection(db, 'supportChats'),
                    where('partnerId', '==', currentPartnerId)
                );
                
                onSnapshot(chatsQuery, (snapshot) => {
                    supportChats = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // Sort by lastMessageAt in JavaScript
                    supportChats.sort((a, b) => {
                        const timeA = a.lastMessageAt?.seconds || a.createdAt?.seconds || 0;
                        const timeB = b.lastMessageAt?.seconds || b.createdAt?.seconds || 0;
                        return timeB - timeA;
                    });
                    
                    console.log('Loaded chats:', supportChats.length);
                    
                    const listContainer = document.getElementById('support-chats-list');
                    if (listContainer) {
                        listContainer.innerHTML = renderSupportChatsList();
                    }
                }, (error) => {
                    console.error('Error loading support chats:', error);
                    showToast(
                        currentLanguage === 'en' ? 'Error loading chats' : 
                        currentLanguage === 'ru' ? 'Ошибка загрузки чатов' : 
                        currentLanguage === 'tj' ? 'Хатогӣ ҳангоми боркунии чатҳо' : 
                        'Chatlarni yuklashda xatolik', 
                        true
                    );
                });
            } catch (error) {
                console.error('Error in loadSupportChats:', error);
            }
        }
        
        window.selectSupportChat = async function(chatId) {
            console.log('=== Selecting support chat:', chatId);
            
            // Clean up previous listener first
            if (supportMessagesListener) {
                console.log('Cleaning up previous message listener');
                supportMessagesListener();
                supportMessagesListener = null;
            }
            
            activeSupportChatId = chatId;
            
            // Update UI
            const chatArea = document.getElementById('support-chat-area');
            if (chatArea) {
                chatArea.innerHTML = renderActiveSupportChat();
                console.log('Chat area rendered');
            }
            
            // Update chat list
            const listContainer = document.getElementById('support-chats-list');
            if (listContainer) {
                listContainer.innerHTML = renderSupportChatsList();
            }
            
            // Small delay to ensure DOM is ready
            setTimeout(() => {
                // Load messages - this will create a new listener
                loadSupportMessages(chatId);
                
                // Setup message form
                const messageForm = document.getElementById('support-message-form');
                const messageInput = document.getElementById('support-message-input');
                
                if (messageForm) {
                    messageForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await sendSupportMessage();
                    });
                }
                
                // Auto-resize textarea (Telegram style)
                if (messageInput) {
                    messageInput.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 128) + 'px';
                    });
                    
                    // Focus input
                    messageInput.focus();
                }
                
                // Setup event delegation for dynamically rendered buttons
                if (chatArea) {
                    // Menu toggle button
                    const menuBtn = chatArea.querySelector(`[data-chat-menu="${chatId}"]`);
                    if (menuBtn) {
                        menuBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            window.toggleChatMenu(chatId);
                        });
                    }
                    
                    // Delete chat button
                    const deleteBtn = chatArea.querySelector(`[data-delete-chat="${chatId}"]`);
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            window.deleteChat(chatId);
                        });
                    }
                    
                    // Close chat button
                    const closeBtn = chatArea.querySelector(`[data-close-chat="${chatId}"]`);
                    if (closeBtn) {
                        closeBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            window.closeChat(chatId);
                        });
                    }
                    
                    // Close menu when clicking outside
                    document.addEventListener('click', (e) => {
                        const menu = document.getElementById(`chat-menu-${chatId}`);
                        const menuBtn = chatArea.querySelector(`[data-chat-menu="${chatId}"]`);
                        if (menu && !menu.contains(e.target) && !menuBtn?.contains(e.target)) {
                            menu.classList.add('hidden');
                        }
                    });
                }
            }, 100);
        }
        
        async function loadSupportMessages(chatId) {
            try {
                console.log('Loading messages for chat:', chatId);
                
                // Remove old listener
                if (supportMessagesListener) {
                    supportMessagesListener();
                }
                
                // Listen to the chat document itself (not subcollection)
                const chatDocRef = doc(db, 'supportChats', chatId);
                
                supportMessagesListener = onSnapshot(chatDocRef, (docSnapshot) => {
                    if (!docSnapshot.exists()) {
                        console.log('Chat document does not exist');
                        renderSupportMessages([]);
                        return;
                    }
                    
                    const chatData = docSnapshot.data();
                    let messages = chatData.messages || [];
                    
                    console.log('Messages snapshot received:', messages.length, 'messages');
                    
                    // Process messages - convert Firestore Timestamps if needed
                    messages = messages.map(msg => {
                        console.log('Message:', {id: msg.id, senderRole: msg.senderRole, message: msg.message});
                        return {
                            ...msg,
                            timestamp: msg.timestamp || { seconds: Date.now() / 1000 }
                        };
                    });
                    
                    // Sort by timestamp
                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.seconds || 0;
                        const timeB = b.timestamp?.seconds || 0;
                        return timeA - timeB;
                    });
                    
                    console.log('Rendering messages:', messages.length);
                    renderSupportMessages(messages);
                    
                    // Mark admin's unread messages as read
                    markAdminMessagesAsRead(chatId, messages);
                });
            } catch (error) {
                console.error('Error loading support messages:', error);
            }
        }
        
        async function markAdminMessagesAsRead(chatId, messages) {
            try {
                // Find unread admin messages
                const unreadAdminMessages = messages.filter(msg => 
                    msg.senderRole === 'admin' && msg.isRead === false
                );
                
                if (unreadAdminMessages.length === 0) return;
                
                console.log('Marking', unreadAdminMessages.length, 'admin messages as read');
                
                // Get current messages array
                const chatDocRef = doc(db, 'supportChats', chatId);
                const chatDoc = await getDoc(chatDocRef);
                
                if (!chatDoc.exists()) return;
                
                const chatData = chatDoc.data();
                const updatedMessages = (chatData.messages || []).map(msg => {
                    if (msg.senderRole === 'admin' && msg.isRead === false) {
                        return { ...msg, isRead: true };
                    }
                    return msg;
                });
                
                // Update the messages array
                await updateDoc(chatDocRef, {
                    messages: updatedMessages,
                    userLastRead: serverTimestamp()
                });
                
            } catch (error) {
                console.error('Failed to mark admin messages as read:', error);
            }
        }
        
        function renderSupportMessages(messages) {
            const container = document.getElementById('support-messages');
            if (!container) return;
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full py-20">
                        <div class="text-center max-w-md">
                            <div class="relative inline-block mb-8">
                                <div class="bg-gradient-to-br from-gray-800/80 to-gray-700/80 backdrop-blur w-32 h-32 rounded-3xl flex items-center justify-center mx-auto shadow-2xl transform rotate-3">
                                    <i class="fas fa-comment-dots text-6xl text-gray-500 transform -rotate-3"></i>
                                </div>
                                <div class="absolute -top-2 -right-2 bg-blue-600 w-10 h-10 rounded-full flex items-center justify-center shadow-xl">
                                    <i class="fas fa-bolt text-white"></i>
                                </div>
                            </div>
                            <h4 class="text-2xl font-bold text-white mb-3">
                                ${currentLanguage === 'en' ? 'Start Your Conversation' : 
                                  currentLanguage === 'ru' ? 'Начните ваш разговор' : 
                                  currentLanguage === 'tj' ? 'Гуфтугӯи худро оғоз кунед' : 
                                  'Suhbatingizni boshlang'}
                            </h4>
                            <p class="text-gray-400 text-sm mb-8 leading-relaxed">
                                ${currentLanguage === 'en' ? 'Our admin team is ready to help you with any questions about uploads, payments, or technical issues' : 
                                  currentLanguage === 'ru' ? 'Наша команда админов готова помочь вам с любыми вопросами о загрузках, платежах или технических проблемах' : 
                                  currentLanguage === 'tj' ? 'Дастаи админи мо омодаи кӯмак ба шумо дар бораи боркунӣ, пардохтҳо ё масъалаҳои техникӣ' : 
                                  'Admin jamoamiz yuklash, to\'lovlar yoki texnik muammolar bo\'yicha sizga yordam berishga tayyor'}
                            </p>
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <div class="bg-gray-800/50 backdrop-blur p-4 rounded-xl border border-gray-700">
                                    <i class="fas fa-clock text-2xl text-green-400 mb-2"></i>
                                    <p class="text-white text-xs font-semibold">${currentLanguage === 'en' ? 'Available 24/7' : currentLanguage === 'ru' ? 'Доступно 24/7' : currentLanguage === 'tj' ? 'Дастрас 24/7' : 'Mavjud 24/7'}</p>
                                </div>
                                <div class="bg-gray-800/50 backdrop-blur p-4 rounded-xl border border-gray-700">
                                    <i class="fas fa-bolt text-2xl text-yellow-400 mb-2"></i>
                                    <p class="text-white text-xs font-semibold">${currentLanguage === 'en' ? 'Fast Response' : currentLanguage === 'ru' ? 'Быстрый ответ' : currentLanguage === 'tj' ? 'Ҷавоби тез' : 'Tez javob'}</p>
                                </div>
                            </div>
                            <p class="text-gray-500 text-xs">
                                <i class="fas fa-lock mr-1"></i>
                                ${currentLanguage === 'en' ? 'Your messages are encrypted and secure' : currentLanguage === 'ru' ? 'Ваши сообщения зашифрованы и безопасны' : currentLanguage === 'tj' ? 'Паёмҳои шумо рамзгузорӣ ва бехатаранд' : 'Xabarlaringiz shifrlangan va xavfsiz'}
                            </p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map((msg, index) => {
                const isPartner = msg.senderId === currentPartnerId;
                const isAdmin = msg.senderRole === 'admin';
                
                console.log('Rendering message:', {
                    message: msg.message,
                    senderRole: msg.senderRole,
                    senderId: msg.senderId,
                    isPartner: isPartner,
                    isAdmin: isAdmin
                });
                
                const showDate = index === 0 || (messages[index - 1] && 
                    new Date(msg.timestamp?.seconds * 1000).toDateString() !== 
                    new Date(messages[index - 1].timestamp?.seconds * 1000).toDateString());
                
                return `
                    ${showDate ? `
                        <div class="flex justify-center my-8">
                            <div class="bg-gray-800/80 backdrop-blur text-gray-300 text-xs px-4 py-2 rounded-full shadow-lg border border-gray-700">
                                <i class="fas fa-calendar-day mr-2"></i>
                                ${msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleDateString([], {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'}) : ''}
                            </div>
                        </div>
                    ` : ''}
                    <div class="flex ${isPartner ? 'justify-end' : 'justify-start'} mb-3 animate-fadeIn group">
                        ${isAdmin ? `
                            <div class="flex gap-3 max-w-[75%]">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-lg ring-2 ring-red-500/30">
                                        <i class="fas fa-user-shield text-white text-sm"></i>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-semibold text-red-400">${msg.senderName || 'Admin'}</span>
                                        <span class="bg-red-600/20 text-red-400 text-xs px-2 py-0.5 rounded-full font-bold border border-red-500/30">
                                            <i class="fas fa-shield-check mr-1"></i>ADMIN
                                        </span>
                                    </div>
                                    <div class="bg-gradient-to-br from-gray-800 to-gray-850 text-white px-5 py-3 rounded-2xl rounded-tl-md shadow-xl border border-gray-700/70 relative">
                                        <p class="text-sm leading-relaxed whitespace-pre-wrap break-words">${msg.message || msg.content || ''}</p>
                                        <div class="flex items-center gap-2 mt-2">
                                            <span class="text-xs text-gray-400 font-medium">
                                                ${msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                                            </span>
                                            ${msg.isRead ? '<i class="fas fa-eye text-xs text-blue-400"></i>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : isPartner ? `
                            <div class="max-w-[75%] flex flex-col items-end gap-1">
                                <div class="bg-gradient-to-br from-blue-600 to-blue-500 text-white px-5 py-3 rounded-2xl rounded-tr-md shadow-xl relative">
                                    <p class="text-sm leading-relaxed whitespace-pre-wrap break-words">${msg.message || msg.content || ''}</p>
                                    <div class="flex items-center justify-end gap-2 mt-2">
                                        <span class="text-xs text-blue-100 font-medium">
                                            ${msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                                        </span>
                                        <i class="fas fa-check-double text-xs ${msg.isRead ? 'text-blue-200' : 'text-blue-300/50'}"></i>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="flex gap-3 max-w-[75%]">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg ring-2 ring-purple-500/30">
                                        <i class="fas fa-headset text-white text-sm"></i>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <span class="text-xs font-semibold text-purple-400">${msg.senderName || 'Support'}</span>
                                    <div class="bg-gradient-to-br from-gray-800 to-gray-850 text-white px-5 py-3 rounded-2xl rounded-tl-md shadow-xl border border-gray-700/70 relative">
                                        <p class="text-sm leading-relaxed whitespace-pre-wrap break-words">${msg.message || msg.content || ''}</p>
                                        <div class="flex items-center gap-2 mt-2">
                                            <span class="text-xs text-gray-400 font-medium">
                                                ${msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom smoothly
            setTimeout(() => {
                const messagesContainer = document.getElementById('support-messages-container');
                if (messagesContainer) {
                    messagesContainer.scrollTo({
                        top: messagesContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, 100);
        }
        
        async function sendSupportMessage() {
            const input = document.getElementById('support-message-input');
            const message = input.value.trim();
            
            if (!message || !activeSupportChatId) {
                console.log('Cannot send message:', {message, activeSupportChatId});
                return;
            }
            
            console.log('Partner sending message:', message, 'to chat:', activeSupportChatId);
            
            // Store the message before clearing
            const messageBackup = message;
            
            try {
                // Clear input and reset height immediately
                input.value = '';
                input.style.height = 'auto';
                
                // Create message object with client timestamp
                const now = new Date();
                const newMessage = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    senderId: currentPartnerId,
                    senderName: currentUserData?.displayName || currentUserData?.email?.split('@')[0] || 'Partner',
                    senderRole: 'partner',
                    message: message,
                    timestamp: { seconds: Math.floor(now.getTime() / 1000) },
                    isRead: false
                };
                
                console.log('Adding message to messages array:', newMessage.id, 'Message:', message);
                
                // Update chat document with new message in array
                await updateDoc(doc(db, 'supportChats', activeSupportChatId), {
                    messages: arrayUnion(newMessage),
                    lastMessage: message,
                    lastMessageAt: serverTimestamp(),
                    status: 'pending',
                    userLastRead: serverTimestamp()
                });
                
                console.log('Message sent successfully');
                
            } catch (error) {
                console.error('Error sending message:', error);
                console.error('Error details:', error.code, error.message);
                showToast(
                    currentLanguage === 'en' ? '✗ Error sending message' : 
                    currentLanguage === 'ru' ? '✗ Ошибка отправки сообщения' : 
                    currentLanguage === 'tj' ? '✗ Хатогӣ ҳангоми фиристодани паём' : 
                    '✗ Xabar yuborishda xatolik', 
                    true
                );
                // Restore message on error
                input.value = messageBackup;
                input.style.height = 'auto';
            }
        }
        
        window.createNewSupportChat = async function() {
            // Create modal for chat subject input
            const modalOverlay = document.getElementById('modal-overlay');
            modalOverlay.innerHTML = `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all border border-gray-700">
                    <div class="text-center mb-6">
                        <div class="relative inline-block mb-4">
                            <div class="bg-gradient-to-br from-blue-600 to-red-600 w-20 h-20 rounded-2xl flex items-center justify-center shadow-2xl transform rotate-3">
                                <i class="fas fa-comment-medical text-white text-3xl transform -rotate-3"></i>
                            </div>
                            <div class="absolute -top-2 -right-2 bg-green-500 w-8 h-8 rounded-full flex items-center justify-center shadow-xl animate-pulse">
                                <i class="fas fa-check text-white text-sm"></i>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-white mb-2">
                            ${currentLanguage === 'en' ? 'Contact Admin Support' : 
                              currentLanguage === 'ru' ? 'Связаться с поддержкой админа' : 
                              currentLanguage === 'tj' ? 'Бо дастгирии админ тамос гиред' : 
                              'Admin yordam bilan bog\'lanish'}
                        </h3>
                        <p class="text-gray-400 text-sm">
                            ${currentLanguage === 'en' ? 'We\'re here to help you 24/7' : 
                              currentLanguage === 'ru' ? 'Мы здесь, чтобы помочь вам 24/7' : 
                              currentLanguage === 'tj' ? 'Мо дар ин ҷо ҳастем то ба шумо 24/7 кӯмак кунем' : 
                              'Biz sizga 24/7 yordam beramiz'}
                        </p>
                    </div>
                    
                    <form id="new-chat-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-3 flex items-center gap-2">
                                <i class="fas fa-tag text-blue-400"></i>
                                ${currentLanguage === 'en' ? 'What do you need help with?' : 
                                  currentLanguage === 'ru' ? 'В чем вам нужна помощь?' : 
                                  currentLanguage === 'tj' ? 'Дар чӣ ба шумо кӯмак лозим аст?' : 
                                  'Sizga qanday yordam kerak?'}
                            </label>
                            <input type="text" id="chat-subject-input" required
                                   class="w-full bg-gray-700/70 backdrop-blur border-2 border-gray-600 focus:border-blue-500 text-white p-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 placeholder-gray-400 transition-all"
                                   placeholder="${currentLanguage === 'en' ? 'e.g., Upload issue, Payment question, Technical problem...' : 
                                     currentLanguage === 'ru' ? 'напр., Проблема загрузки, Вопрос оплаты, Техническая проблема...' : 
                                     currentLanguage === 'tj' ? 'масалан, Мушкилии боркунӣ, Савол дар бораи пардохт, Мушкилии техникӣ...' : 
                                     'mas., Yuklash muammosi, To\'lov savoli, Texnik muammo...'}">
                        </div>
                        
                        <!-- Quick Topics -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-2">
                                ${currentLanguage === 'en' ? 'Or choose a quick topic:' : 
                                  currentLanguage === 'ru' ? 'Или выберите быструю тему:' : 
                                  currentLanguage === 'tj' ? 'Ё мавзӯи тезро интихоб кунед:' : 
                                  'Yoki tez mavzuni tanlang:'}
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="document.getElementById('chat-subject-input').value='${currentLanguage === 'en' ? 'Upload Issue' : currentLanguage === 'ru' ? 'Проблема загрузки' : currentLanguage === 'tj' ? 'Мушкилии боркунӣ' : 'Yuklash muammosi'}'" 
                                        class="bg-gray-700/50 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded-lg transition-all transform hover:scale-105 border border-gray-600 hover:border-blue-500">
                                    <i class="fas fa-upload mr-1"></i>${currentLanguage === 'en' ? 'Upload' : currentLanguage === 'ru' ? 'Загрузка' : currentLanguage === 'tj' ? 'Боркунӣ' : 'Yuklash'}
                                </button>
                                <button type="button" onclick="document.getElementById('chat-subject-input').value='${currentLanguage === 'en' ? 'Payment Question' : currentLanguage === 'ru' ? 'Вопрос оплаты' : currentLanguage === 'tj' ? 'Савол дар бораи пардохт' : 'To\'lov savoli'}'" 
                                        class="bg-gray-700/50 hover:bg-green-600 text-white text-xs py-2 px-3 rounded-lg transition-all transform hover:scale-105 border border-gray-600 hover:border-green-500">
                                    <i class="fas fa-dollar-sign mr-1"></i>${currentLanguage === 'en' ? 'Payment' : currentLanguage === 'ru' ? 'Оплата' : currentLanguage === 'tj' ? 'Пардохт' : 'To\'lov'}
                                </button>
                                <button type="button" onclick="document.getElementById('chat-subject-input').value='${currentLanguage === 'en' ? 'Technical Problem' : currentLanguage === 'ru' ? 'Техническая проблема' : currentLanguage === 'tj' ? 'Мушкилии техникӣ' : 'Texnik muammo'}'" 
                                        class="bg-gray-700/50 hover:bg-red-600 text-white text-xs py-2 px-3 rounded-lg transition-all transform hover:scale-105 border border-gray-600 hover:border-red-500">
                                    <i class="fas fa-cog mr-1"></i>${currentLanguage === 'en' ? 'Technical' : currentLanguage === 'ru' ? 'Техническое' : currentLanguage === 'tj' ? 'Техникӣ' : 'Texnik'}
                                </button>
                                <button type="button" onclick="document.getElementById('chat-subject-input').value='${currentLanguage === 'en' ? 'General Question' : currentLanguage === 'ru' ? 'Общий вопрос' : currentLanguage === 'tj' ? 'Савол дар бораи умумӣ' : 'Umumiy savol'}'" 
                                        class="bg-gray-700/50 hover:bg-purple-600 text-white text-xs py-2 px-3 rounded-lg transition-all transform hover:scale-105 border border-gray-600 hover:border-purple-500">
                                    <i class="fas fa-question-circle mr-1"></i>${currentLanguage === 'en' ? 'Other' : currentLanguage === 'ru' ? 'Другое' : currentLanguage === 'tj' ? 'Дигар' : 'Boshqa'}
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 pt-4">
                            <button type="button" onclick="document.getElementById('modal-overlay').classList.add('hidden')"
                                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 border border-gray-600">
                                <i class="fas fa-times mr-2"></i>${currentLanguage === 'en' ? 'Cancel' : currentLanguage === 'ru' ? 'Отмена' : currentLanguage === 'tj' ? 'Бекор кардан' : 'Bekor qilish'}
                            </button>
                            <button type="submit"
                                    class="flex-1 bg-gradient-to-r from-blue-600 to-red-600 hover:from-blue-500 hover:to-red-500 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-2xl">
                                <i class="fas fa-paper-plane mr-2"></i>${currentLanguage === 'en' ? 'Start Chat' : currentLanguage === 'ru' ? 'Начать чат' : currentLanguage === 'tj' ? 'Чатро оғоз кунед' : 'Chatni boshlash'}
                            </button>
                        </div>
                    </form>
                    
                    <!-- Info Footer -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div>
                                <i class="fas fa-clock text-green-400 text-lg mb-1"></i>
                                <p class="text-xs text-gray-400">${currentLanguage === 'en' ? 'Fast Reply' : currentLanguage === 'ru' ? 'Быстрый ответ' : currentLanguage === 'tj' ? 'Ҷавоби тез' : 'Tez javob'}</p>
                            </div>
                            <div>
                                <i class="fas fa-shield-check text-blue-400 text-lg mb-1"></i>
                                <p class="text-xs text-gray-400">${currentLanguage === 'en' ? 'Secure' : currentLanguage === 'ru' ? 'Безопасно' : currentLanguage === 'tj' ? 'Бехатар' : 'Xavfsiz'}</p>
                            </div>
                            <div>
                                <i class="fas fa-user-tie text-red-400 text-lg mb-1"></i>
                                <p class="text-xs text-gray-400">${currentLanguage === 'en' ? 'Expert Help' : currentLanguage === 'ru' ? 'Помощь эксперта' : currentLanguage === 'tj' ? 'Кӯмаки мутахассис' : 'Mutaxassis yordami'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modalOverlay.classList.remove('hidden');
            
            // Focus on input with delay
            setTimeout(() => {
                const input = document.getElementById('chat-subject-input');
                if (input) input.focus();
            }, 100);
            
            // Handle form submission
            document.getElementById('new-chat-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const subject = document.getElementById('chat-subject-input').value.trim();
                
                if (!subject) return;
                
                modalOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('hidden');
                document.getElementById('loading-text').textContent = currentLanguage === 'en' ? 'Creating support chat...' : currentLanguage === 'ru' ? 'Создание чата поддержки...' : currentLanguage === 'tj' ? 'Чати дастгирӣ сохта мешавад...' : 'Yordam chati yaratilmoqda...';
                
                try {
                    // Check if user is authenticated
                    if (!currentPartnerId) {
                        throw new Error('You must be logged in to create a chat');
                    }
                    
                    const chatRef = await addDoc(collection(db, 'supportChats'), {
                        partnerId: currentPartnerId,
                        partnerName: currentUserData?.displayName || currentUserData?.email?.split('@')[0] || 'Partner',
                        partnerEmail: currentUserData?.email || '',
                        subject: subject,
                        messages: [],
                        lastMessage: '',
                        lastMessageAt: serverTimestamp(),
                        status: 'open',
                        createdAt: serverTimestamp(),
                        unreadCount: 0,
                        audience: 'partners',
                        adminOpened: false
                    });
                    
                    await loadSupportChats();
                    await window.selectSupportChat(chatRef.id);
                    
                    loadingOverlay.classList.add('hidden');
                    showToast(
                        currentLanguage === 'en' ? '✓ Chat created! Send your first message.' : 
                        currentLanguage === 'ru' ? '✓ Чат создан! Отправьте первое сообщение.' : 
                        currentLanguage === 'tj' ? '✓ Чат сохта шуд! Паёми якумро фиристед.' : 
                        '✓ Chat yaratildi! Birinchi xabaringizni yuboring.'
                    );
                } catch (error) {
                    console.error('Error creating chat:', error);
                    loadingOverlay.classList.add('hidden');
                    
                    let errorMessage = 'Chat yaratishda xatolik';
                    if (error.code === 'permission-denied') {
                        errorMessage = currentLanguage === 'en' ? 'Permission denied. Please contact admin.' : 
                                     currentLanguage === 'ru' ? 'Доступ запрещен. Свяжитесь с администратором.' : 
                                     currentLanguage === 'tj' ? 'Дастрасӣ рад шуд. Бо маъмур тамос гиред.' : 
                                     'Ruxsat rad etildi. Admin bilan bog\'laning.';
                    } else {
                        errorMessage = currentLanguage === 'en' ? `Error: ${error.message}` : 
                                     currentLanguage === 'ru' ? `Ошибка: ${error.message}` : 
                                     currentLanguage === 'tj' ? `Хатогӣ: ${error.message}` : 
                                     `Xatolik: ${error.message}`;
                    }
                    
                    showToast(errorMessage, true);
                }
            });
        }
        
        // Toggle chat menu (3 dots)
        window.toggleChatMenu = function(chatId) {
            const menu = document.getElementById(`chat-menu-${chatId}`);
            if (!menu) return;
            
            // Close all other menus
            document.querySelectorAll('[id^="chat-menu-"]').forEach(m => {
                if (m.id !== `chat-menu-${chatId}`) {
                    m.classList.add('hidden');
                }
            });
            
            menu.classList.toggle('hidden');
        }
        
        // Close chat menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[id^="chat-menu-btn-"]') && !e.target.closest('[id^="chat-menu-"]')) {
                document.querySelectorAll('[id^="chat-menu-"]').forEach(m => {
                    m.classList.add('hidden');
                });
            }
        });
        
        // Delete chat
        window.deleteChat = async function(chatId) {
            const chat = supportChats.find(c => c.id === chatId);
            
            if (!chat) {
                showToast(currentLanguage === 'en' ? 'Chat not found' : currentLanguage === 'ru' ? 'Чат не найден' : currentLanguage === 'tj' ? 'Чат ёфт нашуд' : 'Chat topilmadi', true);
                return;
            }
            
            if (chat.adminOpened) {
                showToast(
                    currentLanguage === 'en' ? 'Cannot delete: Admin has opened this chat' : 
                    currentLanguage === 'ru' ? 'Невозможно удалить: Админ открыл этот чат' : 
                    currentLanguage === 'tj' ? 'Нест карда намешавад: Админ ин чатро кушодааст' : 
                    'O\'chirib bo\'lmaydi: Admin bu chatni ochgan', 
                    true
                );
                return;
            }
            
            // Confirm deletion
            const confirmed = confirm(
                currentLanguage === 'en' ? 'Are you sure you want to delete this chat? This action cannot be undone.' :
                currentLanguage === 'ru' ? 'Вы уверены, что хотите удалить этот чат? Это действие нельзя отменить.' :
                currentLanguage === 'tj' ? 'Оё шумо мутмаин ҳастед, ки мехоҳед ин чатро нест кунед? Ин амалро бекор карда намешавад.' :
                'Bu chatni o\'chirishga ishonchingiz komilmi? Bu amalni bekor qilib bo\'lmaydi.'
            );
            
            if (!confirmed) return;
            
            try {
                loadingOverlay.classList.remove('hidden');
                document.getElementById('loading-text').textContent = currentLanguage === 'en' ? 'Deleting chat...' : currentLanguage === 'ru' ? 'Удаление чата...' : currentLanguage === 'tj' ? 'Чат нест карда мешавад...' : 'Chat o\'chirilmoqda...';
                
                // Delete chat document
                await deleteDoc(doc(db, 'supportChats', chatId));
                
                // Clear active chat if it was deleted
                if (activeSupportChatId === chatId) {
                    activeSupportChatId = null;
                    const chatArea = document.getElementById('support-chat-area');
                    if (chatArea) {
                        chatArea.innerHTML = renderNoSupportChatSelected();
                    }
                }
                
                loadingOverlay.classList.add('hidden');
                showToast(
                    currentLanguage === 'en' ? '✓ Chat deleted successfully' : 
                    currentLanguage === 'ru' ? '✓ Чат успешно удален' : 
                    currentLanguage === 'tj' ? '✓ Чат бомуваффақият нест карда шуд' : 
                    '✓ Chat muvaffaqiyatli o\'chirildi'
                );
            } catch (error) {
                console.error('Error deleting chat:', error);
                loadingOverlay.classList.add('hidden');
                showToast(
                    currentLanguage === 'en' ? '✗ Error deleting chat' : 
                    currentLanguage === 'ru' ? '✗ Ошибка удаления чата' : 
                    currentLanguage === 'tj' ? '✗ Хатогӣ ҳангоми нест кардани чат' : 
                    '✗ Chat o\'chirishda xatolik', 
                    true
                );
            }
        }
        
        // Close/Resolve chat
        window.closeChat = async function(chatId) {
            try {
                loadingOverlay.classList.remove('hidden');
                document.getElementById('loading-text').textContent = currentLanguage === 'en' ? 'Updating chat...' : currentLanguage === 'ru' ? 'Обновление чата...' : currentLanguage === 'tj' ? 'Чат нав карда мешавад...' : 'Chat yangilanmoqda...';
                
                await updateDoc(doc(db, 'supportChats', chatId), {
                    status: 'resolved',
                    resolvedAt: serverTimestamp(),
                    resolvedBy: currentPartnerId
                });
                
                // Close menu
                const menu = document.getElementById(`chat-menu-${chatId}`);
                if (menu) menu.classList.add('hidden');
                
                loadingOverlay.classList.add('hidden');
                showToast(
                    currentLanguage === 'en' ? '✓ Chat marked as resolved' : 
                    currentLanguage === 'ru' ? '✓ Чат отмечен как решенный' : 
                    currentLanguage === 'tj' ? '✓ Чат ҳалшуда нишон дода шуд' : 
                    '✓ Chat hal qilindi deb belgilandi'
                );
            } catch (error) {
                console.error('Error closing chat:', error);
                loadingOverlay.classList.add('hidden');
                showToast(
                    currentLanguage === 'en' ? '✗ Error updating chat' : 
                    currentLanguage === 'ru' ? '✗ Ошибка обновления чата' : 
                    currentLanguage === 'tj' ? '✗ Хатогӣ ҳангоми навсозии чат' : 
                    '✗ Chat yangilashda xatolik', 
                    true
                );
            }
        }

        function renderFaqPanel() {
            const panel = document.getElementById('faq-panel');
            
            // FAQ data for each language
            const faqData = {
                uz: {
                    general: [
                        { q: "Qanday qilib hamkor bo'lish mumkin?", a: "Admin sizga kirish huquqi berganidan keyin partnyor paneliga kirishingiz mumkin. Elektron pochtangizga tasdiqlov xabari keladi." },
                        { q: "Daromad qanday hisoblanadi?", a: "Har bir ko'rish uchun belgilangan narx ($0.05) filmingizning ko'rishlar soniga ko'paytiriladi. Masalan: 1000 ko'rish = $50 daromad." },
                        { q: "To'lov qachon amalga oshiriladi?", a: "To'lovlar har oyning 5-kunida amalga oshiriladi. Minimal to'lov summasi $50. Agar kamroq bo'lsa, keyingi oyga o'tkaziladi." }
                    ],
                    content: [
                        { q: "Qanday qilib film qo'shishim mumkin?", a: "Kontent panelida 'Film Qo'shish' tugmasini bosing. Film nomi, yili, video URL va boshqa ma'lumotlarni kiriting. Admin tasdig'idan keyin film platformaga qo'shiladi." },
                        { q: "Qanday formatda video yuklash mumkin?", a: "MP4, MKV, AVI formatidagi videolarni yuklash mumkin. Tavsiya etiladigan sifat: Full HD (1080p) yoki 4K." },
                        { q: "Film tasdiqlash qancha vaqt oladi?", a: "Odatda 24-48 soat ichida admin tomonidan ko'rib chiqiladi. Murakkab holatlarda 72 soatgacha cho'zilishi mumkin." },
                        { q: "Filmimni qanday tahrirlashim mumkin?", a: "Film kartasida 'Tahrirlash' tugmasini bosing va kerakli o'zgarishlarni kiriting. Har qanday o'zgarish yana admin tomonidan tasdiqlanishi kerak." }
                    ],
                    payment: [
                        { q: "To'lovlarni qanday olaman?", a: "To'lovlar bank o'tkazmasi yoki PayPal orqali amalga oshiriladi. Hisob raqamingizni Sozlamalar panelida kiritishingiz mumkin." },
                        { q: "Minimal to'lov summasi qancha?", a: "Minimal to'lov summasi $50. Agar oylik daromadingiz bundan kam bo'lsa, keyingi oyga o'tkaziladi va yig'iladi." },
                        { q: "Daromad hisob-kitobini qayerdan ko'raman?", a: "Daromad panelida batafsil hisobot, har bir film bo'yicha daromad va umumiy summani ko'rishingiz mumkin." },
                        { q: "Soliq to'lanadimi?", a: "Ha, daromaddan tegishli soliqlar ushlab qolinadi. Aniq ma'lumot uchun moliya bo'limiga murojaat qiling." }
                    ],
                    technical: [
                        { q: "Parolimni unutdim, nima qilishim kerak?", a: "Kirish sahifasida 'Parolni unutdim?' tugmasini bosing yoki admin bilan bog'laning." },
                        { q: "Filmim bloklangan, nima qilish kerak?", a: "Agar film qoidalarni buzgan bo'lsa bloklanishi mumkin. Sababi haqida admin bilan bog'laning." },
                        { q: "Statistika yangilanish vaqti qancha?", a: "Statistika har 15 daqiqada yangilanadi. Real-time ko'rishlar hisobi 1 soatdan keyin ko'rinadi." }
                    ]
                },
                en: {
                    general: [
                        { q: "How can I become a partner?", a: "After admin grants you access, you can login to partner panel. A confirmation email will be sent to your email address." },
                        { q: "How is revenue calculated?", a: "The set price per view ($0.05) is multiplied by your movie's view count. Example: 1000 views = $50 revenue." },
                        { q: "When are payments made?", a: "Payments are made on the 5th of each month. Minimum payment is $50. If less, it will be carried over to next month." }
                    ],
                    content: [
                        { q: "How can I add a movie?", a: "Click 'Add Movie' button in Content panel. Enter movie title, year, video URL and other details. After admin approval, movie will be added to platform." },
                        { q: "What video format can I upload?", a: "You can upload videos in MP4, MKV, AVI formats. Recommended quality: Full HD (1080p) or 4K." },
                        { q: "How long does movie approval take?", a: "Usually reviewed by admin within 24-48 hours. In complex cases may take up to 72 hours." },
                        { q: "How can I edit my movie?", a: "Click 'Edit' button on movie card and enter required changes. Any change must be approved by admin again." }
                    ],
                    payment: [
                        { q: "How do I receive payments?", a: "Payments are made via bank transfer or PayPal. You can enter your account number in Settings panel." },
                        { q: "What is the minimum payment amount?", a: "Minimum payment is $50. If your monthly revenue is less, it will be carried over and accumulated to next month." },
                        { q: "Where can I see revenue reports?", a: "In Revenue panel you can see detailed reports, revenue per movie and total amount." },
                        { q: "Are taxes deducted?", a: "Yes, applicable taxes are withheld from revenue. Contact finance department for exact information." }
                    ],
                    technical: [
                        { q: "I forgot my password, what should I do?", a: "Click 'Forgot password?' button on login page or contact admin." },
                        { q: "My movie is blocked, what should I do?", a: "Movie may be blocked if it violated rules. Contact admin about the reason." },
                        { q: "How often is statistics updated?", a: "Statistics are updated every 15 minutes. Real-time view count appears after 1 hour." }
                    ]
                },
                ru: {
                    general: [
                        { q: "Как я могу стать партнером?", a: "После того как администратор предоставит вам доступ, вы сможете войти в панель партнера. На вашу электронную почту будет отправлено письмо с подтверждением." },
                        { q: "Как рассчитывается доход?", a: "Установленная цена за просмотр ($0.05) умножается на количество просмотров вашего фильма. Пример: 1000 просмотров = $50 дохода." },
                        { q: "Когда производятся выплаты?", a: "Выплаты производятся 5-го числа каждого месяца. Минимальная сумма выплаты $50. Если меньше, она переносится на следующий месяц." }
                    ],
                    content: [
                        { q: "Как я могу добавить фильм?", a: "Нажмите кнопку 'Добавить фильм' на панели контента. Введите название фильма, год, URL видео и другие данные. После утверждения администратором фильм будет добавлен на платформу." },
                        { q: "В каком формате можно загружать видео?", a: "Вы можете загружать видео в форматах MP4, MKV, AVI. Рекомендуемое качество: Full HD (1080p) или 4K." },
                        { q: "Сколько времени занимает утверждение фильма?", a: "Обычно рассматривается администратором в течение 24-48 часов. В сложных случаях может занять до 72 часов." },
                        { q: "Как я могу отредактировать свой фильм?", a: "Нажмите кнопку 'Редактировать' на карточке фильма и внесите необходимые изменения. Любое изменение должно быть снова утверждено администратором." }
                    ],
                    payment: [
                        { q: "Как я получу выплаты?", a: "Выплаты производятся банковским переводом или через PayPal. Вы можете ввести номер счета в панели настроек." },
                        { q: "Какая минимальная сумма выплаты?", a: "Минимальная сумма выплаты $50. Если ваш месячный доход меньше, он будет перенесен и накоплен на следующий месяц." },
                        { q: "Где я могу посмотреть отчеты о доходах?", a: "На панели доходов вы можете видеть подробные отчеты, доход по фильмам и общую сумму." },
                        { q: "Удерживаются ли налоги?", a: "Да, соответствующие налоги удерживаются из дохода. Свяжитесь с финансовым отделом для точной информации." }
                    ],
                    technical: [
                        { q: "Я забыл пароль, что делать?", a: "Нажмите кнопку 'Забыли пароль?' на странице входа или свяжитесь с администратором." },
                        { q: "Мой фильм заблокирован, что делать?", a: "Фильм может быть заблокирован, если нарушил правила. Свяжитесь с администратором о причине." },
                        { q: "Как часто обновляется статистика?", a: "Статистика обновляется каждые 15 минут. Счетчик просмотров в реальном времени появляется через 1 час." }
                    ]
                },
                tj: {
                    general: [
                        { q: "Чӣ тавр метавон шарик шуд?", a: "Пас аз он ки администратор ба шумо дастрасӣ дод, шумо метавонед ба панели шарик ворид шавед. Ба суроғаи почтаи электронии шумо паёми тасдиқ фиристода мешавад." },
                        { q: "Даромад чӣ тавр ҳисоб карда мешавад?", a: "Нархи муқарраршуда барои тамошо ($0.05) ба шумораи тамошои филми шумо зарб карда мешавад. Мисол: 1000 тамошо = $50 даромад." },
                        { q: "Пардохтҳо кай анҷом дода мешаванд?", a: "Пардохтҳо дар 5-уми ҳар моҳ анҷом дода мешаванд. Пардохти минималӣ $50. Агар камтар бошад, ба моҳи оянда гузаронида мешавад." }
                    ],
                    content: [
                        { q: "Чӣ тавр метавон филм илова кард?", a: "Тугмаи 'Илова кардани филм'-ро дар панели мундариҷа зер кунед. Номи филм, сол, URL видео ва дигар маълумотро ворид кунед. Пас аз тасдиқи администратор филм ба платформа илова карда мешавад." },
                        { q: "Дар кадом формат метавон видео бор кард?", a: "Шумо метавонед видеоҳоро дар форматҳои MP4, MKV, AVI бор кунед. Сифати тавсияшуда: Full HD (1080p) ё 4K." },
                        { q: "Тасдиқи филм чанд вақт мегирад?", a: "Одатан дар давоми 24-48 соат аз ҷониби администратор баррасӣ карда мешавад. Дар ҳолатҳои мураккаб то 72 соат дарозида метавонад." },
                        { q: "Чӣ тавр метавон филми худро таҳрир кард?", a: "Тугмаи 'Таҳрир'-ро дар корти филм зер кунед ва тағйироти зарурӣ ворид кунед. Ҳама гуна тағйирот бояд аз нав аз ҷониби администратор тасдиқ карда шавад." }
                    ],
                    payment: [
                        { q: "Чӣ тавр пардохтҳоро қабул мекунам?", a: "Пардохтҳо тавассути интиқоли бонкӣ ё PayPal анҷом дода мешаванд. Шумо метавонед рақами ҳисоби худро дар панели танзимот ворид кунед." },
                        { q: "Маблағи минималии пардохт чист?", a: "Маблағи минималии пардохт $50. Агар даромади моҳонаи шумо камтар бошад, он ба моҳи оянда гузаронида мешавад ва ҷамъ карда мешавад." },
                        { q: "Аз куҷо метавон ҳисоботи даромадро дид?", a: "Дар панели даромад шумо метавонед ҳисоботи муфассал, даромад аз ҳар филм ва маблағи умумӣ-ро бинед." },
                        { q: "Оё андозҳо нигоҳ дошта мешаванд?", a: "Ҳа, андозҳои мувофиқ аз даромад нигоҳ дошта мешаванд. Барои маълумоти дақиқ бо шӯъбаи молия тамос гиред." }
                    ],
                    technical: [
                        { q: "Паролро фаромӯш кардам, чӣ кор кунам?", a: "Тугмаи 'Паролро фаромӯш кардед?'-ро дар саҳифаи воридшавӣ зер кунед ё бо администратор тамос гиред." },
                        { q: "Филми ман манъ шудааст, чӣ кор кунам?", a: "Филм метавонад манъ шавад, агар қоидаҳоро вайрон кунад. Дар бораи сабаб бо администратор тамос гиред." },
                        { q: "Омор чанд вақт як бор нав мешавад?", a: "Омор ҳар 15 дақиқа нав карда мешавад. Ҳисобгари тамошо дар вақти воқеӣ пас аз 1 соат пайдо мешавад." }
                    ]
                }
            };
            
            const lang = currentLanguage === 'en' ? 'en' : currentLanguage === 'ru' ? 'ru' : currentLanguage === 'tj' ? 'tj' : 'uz';
            const faqs = faqData[lang];
            
            const faqCategories = {
                [t('faqGeneral')]: faqs.general,
                [t('faqContent')]: faqs.content,
                [t('faqPayment')]: faqs.payment,
                [t('faqTechnical')]: faqs.technical
            };
            
            panel.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                    <div class="mb-6">
                        <h3 class="text-3xl font-bold text-white mb-2">${t('faqTitle')}</h3>
                        <p class="text-gray-400">${t('faqSubtitle')}</p>
                    </div>
                    
                    <div class="space-y-6">
                        ${Object.entries(faqCategories).map(([category, faqs]) => `
                            <div class="bg-gray-700 rounded-xl p-5">
                                <h4 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="fas fa-folder-open text-blue-400"></i>
                                    ${category}
                                </h4>
                                <div class="space-y-2">
                                    ${faqs.map((faq, i) => `
                                        <div class="bg-gray-800 rounded-lg overflow-hidden">
                                            <button class="w-full text-left p-4 flex items-start justify-between hover:bg-gray-750 transition group" 
                                                    onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.chevron').classList.toggle('rotate-180')">
                                                <div class="flex items-start gap-3 flex-1">
                                                    <i class="fas fa-question-circle text-blue-400 mt-1"></i>
                                                    <span class="text-white font-semibold">${faq.q}</span>
                                                </div>
                                                <i class="fas fa-chevron-down text-gray-400 group-hover:text-white transition chevron mt-1"></i>
                                            </button>
                                            <div class="hidden bg-gray-900 border-t border-gray-700">
                                                <div class="p-4 flex items-start gap-3">
                                                    <i class="fas fa-check-circle text-green-400 mt-1"></i>
                                                    <p class="text-gray-300">${faq.a}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Qo'shimcha yordam -->
                    <div class="mt-6 bg-gradient-to-r from-blue-900 to-purple-900 rounded-xl p-6">
                        <h4 class="text-lg font-bold text-white mb-2">${t('faqNoAnswer')}</h4>
                        <p class="text-blue-200 mb-4">${t('faqContactUs')}</p>
                        <button onclick="document.querySelector('[data-panel=support-panel]').click()" 
                                class="bg-white text-blue-900 hover:bg-blue-50 font-bold py-3 px-6 rounded-lg transition shadow-lg">
                            <i class="fas fa-headset mr-2"></i>${t('faqContactButton')}
                        </button>
                    </div>
                </div>
                
                <style>
                    .chevron { transition: transform 0.3s; }
                    .rotate-180 { transform: rotate(180deg); }
                    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
                </style>
            `;
        }

        function renderPrivacyPanel() {
            const panel = document.getElementById('privacy-panel');
            panel.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                    <h3 class="text-2xl font-bold text-white mb-6">${t('privacyTitle')}</h3>
                    <div class="prose prose-invert max-w-none">
                        <div class="bg-gray-700 p-6 rounded-lg mb-4">
                            <h4 class="text-lg font-bold text-white mb-3">1. ${t('privacyData')}</h4>
                            <p class="text-gray-300">${t('privacyDataText')}</p>
                        </div>
                        <div class="bg-gray-700 p-6 rounded-lg mb-4">
                            <h4 class="text-lg font-bold text-white mb-3">2. ${t('privacyUse')}</h4>
                            <p class="text-gray-300">${t('privacyUseText')}</p>
                        </div>
                        <div class="bg-gray-700 p-6 rounded-lg mb-4">
                            <h4 class="text-lg font-bold text-white mb-3">3. ${t('privacySecurity')}</h4>
                            <p class="text-gray-300">${t('privacySecurityText')}</p>
                        </div>
                        <div class="bg-gray-700 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-3">4. ${t('privacyRights')}</h4>
                            <p class="text-gray-300">${t('privacyRightsText')}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSettingsPanel() {
            const panel = document.getElementById('settings-panel');
            panel.innerHTML = `
                <div class="space-y-6">
                    <!-- Profil Ma'lumotlari -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-user-circle text-blue-400"></i>
                            ${t('settingsProfile')}
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-400 mb-2">${t('name')}</label>
                                <p class="text-white text-lg font-semibold">${currentUserData?.displayName || 'N/A'}</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-400 mb-2">${t('email')}</label>
                                <p class="text-white text-lg font-semibold">${currentUserData?.email || 'N/A'}</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-400 mb-2">${t('role')}</label>
                                <span class="inline-block bg-purple-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                    <i class="fas fa-crown mr-1"></i>${t('partner')}
                                </span>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-400 mb-2">${t('status')}</label>
                                <span class="inline-block ${currentUserData?.suspended ? 'bg-red-600' : 'bg-green-600'} text-white px-3 py-1 rounded-full text-sm font-bold">
                                    <i class="fas ${currentUserData?.suspended ? 'fa-ban' : 'fa-check-circle'} mr-1"></i>
                                    ${currentUserData?.suspended ? t('blocked') : t('active')}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ruxsatlar -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-shield-alt text-green-400"></i>
                            ${t('settingsPermissions')}
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-400 mb-3">${t('categories')}</label>
                                <div class="flex flex-wrap gap-2">
                                    ${(currentUserData?.allowedCategories || []).length > 0 ? 
                                        (currentUserData?.allowedCategories || []).map(cat => 
                                            `<span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                                <i class="fas fa-tag mr-1"></i>${cat}
                                            </span>`
                                        ).join('') : 
                                        `<span class="text-gray-500">${t('settingsNoCategory')}</span>`
                                    }
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-400 mb-3">${t('regions')}</label>
                                <div class="flex flex-wrap gap-2">
                                    ${(currentUserData?.allowedRegions || []).length > 0 ?
                                        (currentUserData?.allowedRegions || []).map(reg => 
                                            `<span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                                <i class="fas fa-globe mr-1"></i>${reg}
                                            </span>`
                                        ).join('') :
                                        `<span class="text-gray-500">${t('settingsNoRegion')}</span>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistika -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-chart-pie text-yellow-400"></i>
                            ${t('settingsStats')}
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-4 rounded-lg text-center">
                                <i class="fas fa-film text-3xl text-purple-200 mb-2"></i>
                                <p class="text-purple-200 text-xs">${t('settingsMovies')}</p>
                                <p class="text-2xl font-bold text-white mt-1">${movies.length}</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-4 rounded-lg text-center">
                                <i class="fas fa-eye text-3xl text-blue-200 mb-2"></i>
                                <p class="text-blue-200 text-xs">${t('settingsViews')}</p>
                                <p class="text-2xl font-bold text-white mt-1">${movies.reduce((acc, m) => acc + (m.views || 0), 0).toLocaleString()}</p>
                            </div>
                            <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-4 rounded-lg text-center">
                                <i class="fas fa-star text-3xl text-yellow-200 mb-2"></i>
                                <p class="text-yellow-200 text-xs">${t('settingsRating')}</p>
                                <p class="text-2xl font-bold text-white mt-1">${movies.length > 0 ? (movies.reduce((acc, m) => acc + (Number(m.rating) || 0), 0) / movies.length).toFixed(1) : 0}</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-900 to-green-700 p-4 rounded-lg text-center">
                                <i class="fas fa-dollar-sign text-3xl text-green-200 mb-2"></i>
                                <p class="text-green-200 text-xs">${t('settingsRevenue')}</p>
                                <p class="text-2xl font-bold text-white mt-1">$${movies.reduce((acc, m) => acc + ((m.views || 0) * 0.05), 0).toFixed(0)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Xavfsizlik -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-lock text-red-400"></i>
                            ${t('settingsSecurity')}
                        </h4>
                        <div class="space-y-4">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p class="text-white font-semibold mb-2">
                                    <i class="fas fa-key text-yellow-400 mr-2"></i>${t('settingsChangePassword')}
                                </p>
                                <p class="text-gray-400 text-sm mb-3">
                                    ${t('settingsChangePasswordText')}
                                </p>
                                <button onclick="showToast('Parol o\\'zgartirish uchun admin bilan bog\\'laning', true)" 
                                        class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition">
                                    <i class="fas fa-edit mr-2"></i>${t('settingsChangePasswordButton')}
                                </button>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p class="text-white font-semibold mb-2">
                                    <i class="fas fa-envelope text-blue-400 mr-2"></i>${t('settingsChangeEmail')}
                                </p>
                                <p class="text-gray-400 text-sm mb-3">
                                    ${t('settingsChangeEmailText')}
                                </p>
                                <button onclick="document.querySelector('[data-panel=support-panel]').click()" 
                                        class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg transition">
                                    <i class="fas fa-headset mr-2"></i>${t('settingsContactSupportButton')}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Til va Hudud -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-language text-purple-400"></i>
                            ${t('settingsLanguage')}
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-400 mb-2">${t('language')}</label>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-language text-2xl text-purple-400"></i>
                                    <span class="text-white font-semibold">${currentLanguage === 'en' ? 'English' : currentLanguage === 'ru' ? 'Русский' : currentLanguage === 'tj' ? 'Тоҷикӣ' : 'O\'zbekcha'}</span>
                                </div>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-400 mb-2">${t('settingsTimeZone')}</label>
                                <p class="text-white font-semibold">UTC+5 (${currentLanguage === 'en' ? 'Tashkent' : currentLanguage === 'ru' ? 'Ташкент' : currentLanguage === 'tj' ? 'Душанбе' : 'Toshkent'})</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bildirishnomalar -->
                    <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-bell text-orange-400"></i>
                            ${t('settingsNotifications')}
                        </h4>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-650 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-envelope text-blue-400"></i>
                                    <div>
                                        <p class="text-white font-semibold">${t('settingsEmailNotifications')}</p>
                                        <p class="text-gray-400 text-xs">${t('settingsEmailNotificationsText')}</p>
                                    </div>
                                </div>
                                <input type="checkbox" checked class="w-5 h-5 rounded">
                            </label>
                            <label class="flex items-center justify-between bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-650 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-dollar-sign text-green-400"></i>
                                    <div>
                                        <p class="text-white font-semibold">${t('settingsRevenueNotifications')}</p>
                                        <p class="text-gray-400 text-xs">${t('settingsRevenueNotificationsText')}</p>
                                    </div>
                                </div>
                                <input type="checkbox" checked class="w-5 h-5 rounded">
                            </label>
                            <label class="flex items-center justify-between bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-650 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-check-circle text-yellow-400"></i>
                                    <div>
                                        <p class="text-white font-semibold">${t('settingsApprovalNotifications')}</p>
                                        <p class="text-gray-400 text-xs">${t('settingsApprovalNotificationsText')}</p>
                                    </div>
                                </div>
                                <input type="checkbox" checked class="w-5 h-5 rounded">
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>

