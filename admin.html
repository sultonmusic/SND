<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SND Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Code generatsiyasi uchun kutubxona -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #F3F4F6; }
        .login-container { background-color: #111827; }
        .form-panel { background-color: #1f2937; border: 1px solid #374151; }
        .form-input, .modal-input, .settings-input { background-color: #374151; border: 1px solid #4b5563; }
        .form-input:focus, .modal-input:focus, .settings-input:focus { outline: none; border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5); }
        .submit-btn, .action-btn { background-color: #DC2626; transition: background-color 0.3s; }
        .submit-btn:hover, .action-btn:hover { background-color: #ef4444; }
        .table-header { background-color: #374151; }
        .table-row:nth-child(even) { background-color: #1f2937; }
        .table-row:nth-child(odd) { background-color: #2c3646; }
        #modal-overlay { background-color: rgba(0, 0, 0, 0.8); }
        .sidebar-link { transition: background-color 0.2s, color 0.2s; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #ef4444; color: #ffffff; }
        .sidebar-link.active i, .sidebar-link:hover i { color: #ffffff; }
        .movie-card { background-color: #1f2937; transition: transform 0.3s, box-shadow 0.3s; }
        .movie-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .lang-btn.active { background-color: #DC2626; color: #FFFFFF; font-weight: bold; }
        /* Type selector button styles */
        #type-text.active, #type-movie.active { 
            background-color: #2563eb !important; 
            color: #ffffff !important; 
            font-weight: 600;
        }
        #toast-notification { 
            transition: opacity 0.3s, transform 0.3s; 
            z-index: 9999;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        #toast-notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        #toast-notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .policy-tab {
            transition: all 0.3s ease;
        }
        .policy-card {
            transition: all 0.3s ease;
        }
        .policy-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .login-tab {
            width: 50%;
            padding: 1rem;
            background-color: #374151;
            color: #9CA3AF;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 600;
        }
        .login-tab.active {
            background-color: #1f2937;
            color: #FFFFFF;
        }
        #loading-overlay {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }
        #qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            width: 200px;
            height: 200px;
            margin: 1rem auto 0;
        }
        .dashboard-shell { min-height: 100vh; }
        body.sidebar-locked { overflow: hidden; }
        #sidebar { max-height: 100vh; }
        #sidebar::-webkit-scrollbar { width: 6px; }
        #sidebar::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 999px; }
        #sidebar-overlay { backdrop-filter: blur(2px); }
        .panel-scroll { overflow-x: auto; }
        .mobile-section-title { font-size: 1.125rem; }
        
        /* Partners Page Enhancements */
        .partners-stats-card { 
            animation: fadeInUp 0.5s ease-out; 
            animation-fill-mode: both;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .partners-stats-card:nth-child(1) { animation-delay: 0.1s; }
        .partners-stats-card:nth-child(2) { animation-delay: 0.2s; }
        
        /* Upload Tab Styles */
        .upload-tab-btn {
            color: #9CA3AF;
        }
        .upload-tab-btn.active {
            color: #FFFFFF;
            border-bottom-color: #3B82F6 !important;
        }
        .upload-tab-content {
            display: block;
        }
        .upload-tab-content.hidden {
            display: none;
        }
        .partners-stats-card:nth-child(3) { animation-delay: 0.3s; }
        .partners-stats-card:nth-child(4) { animation-delay: 0.4s; }
        .partners-stats-card:nth-child(5) { animation-delay: 0.5s; }
        .partners-stats-card:nth-child(6) { animation-delay: 0.6s; }
        
        @media (max-width: 1024px) {
            #main-content { padding: 1.5rem; }
        }
        @media (max-width: 768px) {
            #main-content { padding: 1.25rem; }
            #sidebar { width: min(18rem, 80vw); }
            .dashboard-shell { flex-direction: column; }
            header .text-2xl { font-size: 1.25rem; }
            /* Partners page mobile optimizations */
            .partners-table-container table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        @media (max-width: 640px) {
            #main-content { padding: 1rem; }
            .movie-card { padding: 0.75rem; }
            .movie-card h3 { font-size: 1rem; }
            .movie-card p { font-size: 0.85rem; }
            .panel-scroll { margin: 0 -0.5rem; padding: 0 0.5rem; }
        }
        
        /* Chat animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Scrollbar styling for chat messages */
        #admin-chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        #admin-chat-messages::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 10px;
        }
        
        #admin-chat-messages::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        
        #admin-chat-messages::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-container">
        <!-- Dastur shu yerda ishga tushadi -->
    </div>
    
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"></div>
    
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transform translate-y-4"></div>

    <div id="loading-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center">
        <div class="text-center">
            <div class="relative inline-block">
                <div class="w-20 h-20 border-4 border-gray-600 border-t-red-600 rounded-full animate-spin"></div>
                <i class="fas fa-film absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white text-2xl"></i>
            </div>
            <p class="text-white mt-4 font-semibold">Yuklanmoqda... / –ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential, EmailAuthProvider, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc, onSnapshot, query, where, orderBy, getDoc, getDocs, runTransaction, writeBatch, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBeYmiy_FX22I4--UnNTRxjWiAh--sX9Ug",
            authDomain: "soundora-music.firebaseapp.com",
            projectId: "soundora-music",
            storageBucket: "soundora-music.appspot.com",
            messagingSenderId: "92363153683",
            appId: "1:92363153683:web:16feda8fb9607d8da97ae6",
            measurementId: "G-KP08NSCRD6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL HOLAT ---
        let allUsers = [], movies = [], partners = [], users = [], archivedUsers = [], paymentHistory = [], terminationRequests = [];
        // Support chats management
        let supportChats = [];
        let filteredSupportChats = [];
        let unsubSupportChatsList = null;
        let adminChatUnsub = null;
        let activeAdminChatId = null;
        let settings = { royaltyPerView: 0.05 };
        let currentDashboardLanguage = 'ru', currentPartnerId = null, currentUserRole = null, currentUserData = null;
        const PARTNER_CATEGORY_OPTIONS = [
            { value: 'general', label: 'Movies & Series' },
            { value: 'sports', label: 'Sports' },
            { value: 'challenge', label: 'Challenge' },
            { value: 'snd', label: 'SND Originals', adminOnly: true }
        ];
        const SPORTS_SUBCATEGORY_OPTIONS = [
            { value: 'all', label: 'All Sports' },
            { value: 'football', label: 'Football' },
            { value: 'basketball', label: 'Basketball' },
            { value: 'volleyball', label: 'Volleyball' },
            { value: 'mma', label: 'MMA & Boxing' },
            { value: 'motorsport', label: 'Motorsport' }
        ];
        
        // Markaziy Osiyo hududlari
        const centralAsiaRegions = [
            { name: "O'zbekiston", code: 'UZ', flag: 'üá∫üáø' },
            { name: "Tojikiston", code: 'TJ', flag: 'üáπüáØ' },
            { name: "Qozog'iston", code: 'KZ', flag: 'üá∞üáø' },
            { name: "Qirg'iziston", code: 'KG', flag: 'üá∞üá¨' },
            { name: "Turkmaniston", code: 'TM', flag: 'üáπüá≤' }
        ];
        
        let unsubMovies, unsubAllUsers, unsubArchivedUsers, unsubRequests, unsubPayments, unsubSettings, unsubNotifications;
        let partnerNotifications = [];
        let statsChart = null;
        const loadingOverlay = document.getElementById('loading-overlay');
        let tempCodeInterval = null; // Vaqtinchalik kod uchun interval

        // Colors used to highlight different states of support chats. Administrators can
        // customise these colours via a simple UI in the Support Chats panel. The
        // defaults correspond to new chats (yellow), long waiting chats (red) and
        // solved chats (green). When modified, these values are persisted in
        // localStorage under the key 'supportChatColors'.
        let supportChatColors = { pending: '#fde047', longWait: '#f87171', solved: '#4ade80' };
        let activeSupportAudience = 'users';
        let unsubAlerts = null;
        let heroConfigFetched = false;
        let policyConfigFetched = false;

        // List of all countries (ISO 3166-1 alpha-2 codes and names). This
        // array is used by the region restrictions panel to allow admins to
        // select which countries should be permitted or blocked. Codes are
        // provided in uppercase but the values stored in Firestore will be
        // normalized to lowercase. The list is sorted alphabetically when
        // displayed.
        const worldCountries = [
            { name: 'Afghanistan', code: 'AF' },
            { name: '√Öland Islands', code: 'AX' },
            { name: 'Albania', code: 'AL' },
            { name: 'Algeria', code: 'DZ' },
            { name: 'American Samoa', code: 'AS' },
            { name: 'AndorrA', code: 'AD' },
            { name: 'Angola', code: 'AO' },
            { name: 'Anguilla', code: 'AI' },
            { name: 'Antarctica', code: 'AQ' },
            { name: 'Antigua and Barbuda', code: 'AG' },
            { name: 'Argentina', code: 'AR' },
            { name: 'Armenia', code: 'AM' },
            { name: 'Aruba', code: 'AW' },
            { name: 'Australia', code: 'AU' },
            { name: 'Austria', code: 'AT' },
            { name: 'Azerbaijan', code: 'AZ' },
            { name: 'Bahamas', code: 'BS' },
            { name: 'Bahrain', code: 'BH' },
            { name: 'Bangladesh', code: 'BD' },
            { name: 'Barbados', code: 'BB' },
            { name: 'Belarus', code: 'BY' },
            { name: 'Belgium', code: 'BE' },
            { name: 'Belize', code: 'BZ' },
            { name: 'Benin', code: 'BJ' },
            { name: 'Bermuda', code: 'BM' },
            { name: 'Bhutan', code: 'BT' },
            { name: 'Bolivia', code: 'BO' },
            { name: 'Bosnia and Herzegovina', code: 'BA' },
            { name: 'Botswana', code: 'BW' },
            { name: 'Bouvet Island', code: 'BV' },
            { name: 'Brazil', code: 'BR' },
            { name: 'British Indian Ocean Territory', code: 'IO' },
            { name: 'Brunei Darussalam', code: 'BN' },
            { name: 'Bulgaria', code: 'BG' },
            { name: 'Burkina Faso', code: 'BF' },
            { name: 'Burundi', code: 'BI' },
            { name: 'Cambodia', code: 'KH' },
            { name: 'Cameroon', code: 'CM' },
            { name: 'Canada', code: 'CA' },
            { name: 'Cape Verde', code: 'CV' },
            { name: 'Cayman Islands', code: 'KY' },
            { name: 'Central African Republic', code: 'CF' },
            { name: 'Chad', code: 'TD' },
            { name: 'Chile', code: 'CL' },
            { name: 'China', code: 'CN' },
            { name: 'Christmas Island', code: 'CX' },
            { name: 'Cocos (Keeling) Islands', code: 'CC' },
            { name: 'Colombia', code: 'CO' },
            { name: 'Comoros', code: 'KM' },
            { name: 'Congo', code: 'CG' },
            { name: 'Congo, The Democratic Republic of the', code: 'CD' },
            { name: 'Cook Islands', code: 'CK' },
            { name: 'Costa Rica', code: 'CR' },
            { name: 'Cote D\'Ivoire', code: 'CI' },
            { name: 'Croatia', code: 'HR' },
            { name: 'Cuba', code: 'CU' },
            { name: 'Cyprus', code: 'CY' },
            { name: 'Czech Republic', code: 'CZ' },
            { name: 'Denmark', code: 'DK' },
            { name: 'Djibouti', code: 'DJ' },
            { name: 'Dominica', code: 'DM' },
            { name: 'Dominican Republic', code: 'DO' },
            { name: 'Ecuador', code: 'EC' },
            { name: 'Egypt', code: 'EG' },
            { name: 'El Salvador', code: 'SV' },
            { name: 'Equatorial Guinea', code: 'GQ' },
            { name: 'Eritrea', code: 'ER' },
            { name: 'Estonia', code: 'EE' },
            { name: 'Ethiopia', code: 'ET' },
            { name: 'Falkland Islands (Malvinas)', code: 'FK' },
            { name: 'Faroe Islands', code: 'FO' },
            { name: 'Fiji', code: 'FJ' },
            { name: 'Finland', code: 'FI' },
            { name: 'France', code: 'FR' },
            { name: 'French Guiana', code: 'GF' },
            { name: 'French Polynesia', code: 'PF' },
            { name: 'French Southern Territories', code: 'TF' },
            { name: 'Gabon', code: 'GA' },
            { name: 'Gambia', code: 'GM' },
            { name: 'Georgia', code: 'GE' },
            { name: 'Germany', code: 'DE' },
            { name: 'Ghana', code: 'GH' },
            { name: 'Gibraltar', code: 'GI' },
            { name: 'Greece', code: 'GR' },
            { name: 'Greenland', code: 'GL' },
            { name: 'Grenada', code: 'GD' },
            { name: 'Guadeloupe', code: 'GP' },
            { name: 'Guam', code: 'GU' },
            { name: 'Guatemala', code: 'GT' },
            { name: 'Guernsey', code: 'GG' },
            { name: 'Guinea', code: 'GN' },
            { name: 'Guinea-Bissau', code: 'GW' },
            { name: 'Guyana', code: 'GY' },
            { name: 'Haiti', code: 'HT' },
            { name: 'Heard Island and Mcdonald Islands', code: 'HM' },
            { name: 'Holy See (Vatican City State)', code: 'VA' },
            { name: 'Honduras', code: 'HN' },
            { name: 'Hong Kong', code: 'HK' },
            { name: 'Hungary', code: 'HU' },
            { name: 'Iceland', code: 'IS' },
            { name: 'India', code: 'IN' },
            { name: 'Indonesia', code: 'ID' },
            { name: 'Iran, Islamic Republic Of', code: 'IR' },
            { name: 'Iraq', code: 'IQ' },
            { name: 'Ireland', code: 'IE' },
            { name: 'Isle of Man', code: 'IM' },
            { name: 'Israel', code: 'IL' },
            { name: 'Italy', code: 'IT' },
            { name: 'Jamaica', code: 'JM' },
            { name: 'Japan', code: 'JP' },
            { name: 'Jersey', code: 'JE' },
            { name: 'Jordan', code: 'JO' },
            { name: 'Kazakhstan', code: 'KZ' },
            { name: 'Kenya', code: 'KE' },
            { name: 'Kiribati', code: 'KI' },
            { name: 'Korea, Democratic People\'S Republic of', code: 'KP' },
            { name: 'Korea, Republic of', code: 'KR' },
            { name: 'Kuwait', code: 'KW' },
            { name: 'Kyrgyzstan', code: 'KG' },
            { name: 'Lao People\'S Democratic Republic', code: 'LA' },
            { name: 'Latvia', code: 'LV' },
            { name: 'Lebanon', code: 'LB' },
            { name: 'Lesotho', code: 'LS' },
            { name: 'Liberia', code: 'LR' },
            { name: 'Libyan Arab Jamahiriya', code: 'LY' },
            { name: 'Liechtenstein', code: 'LI' },
            { name: 'Lithuania', code: 'LT' },
            { name: 'Luxembourg', code: 'LU' },
            { name: 'Macao', code: 'MO' },
            { name: 'Macedonia, The Former Yugoslav Republic of', code: 'MK' },
            { name: 'Madagascar', code: 'MG' },
            { name: 'Malawi', code: 'MW' },
            { name: 'Malaysia', code: 'MY' },
            { name: 'Maldives', code: 'MV' },
            { name: 'Mali', code: 'ML' },
            { name: 'Malta', code: 'MT' },
            { name: 'Marshall Islands', code: 'MH' },
            { name: 'Martinique', code: 'MQ' },
            { name: 'Mauritania', code: 'MR' },
            { name: 'Mauritius', code: 'MU' },
            { name: 'Mayotte', code: 'YT' },
            { name: 'Mexico', code: 'MX' },
            { name: 'Micronesia, Federated States of', code: 'FM' },
            { name: 'Moldova, Republic of', code: 'MD' },
            { name: 'Monaco', code: 'MC' },
            { name: 'Mongolia', code: 'MN' },
            { name: 'Montserrat', code: 'MS' },
            { name: 'Morocco', code: 'MA' },
            { name: 'Mozambique', code: 'MZ' },
            { name: 'Myanmar', code: 'MM' },
            { name: 'Namibia', code: 'NA' },
            { name: 'Nauru', code: 'NR' },
            { name: 'Nepal', code: 'NP' },
            { name: 'Netherlands', code: 'NL' },
            { name: 'Netherlands Antilles', code: 'AN' },
            { name: 'New Caledonia', code: 'NC' },
            { name: 'New Zealand', code: 'NZ' },
            { name: 'Nicaragua', code: 'NI' },
            { name: 'Niger', code: 'NE' },
            { name: 'Nigeria', code: 'NG' },
            { name: 'Niue', code: 'NU' },
            { name: 'Norfolk Island', code: 'NF' },
            { name: 'Northern Mariana Islands', code: 'MP' },
            { name: 'Norway', code: 'NO' },
            { name: 'Oman', code: 'OM' },
            { name: 'Pakistan', code: 'PK' },
            { name: 'Palau', code: 'PW' },
            { name: 'Palestinian Territory, Occupied', code: 'PS' },
            { name: 'Panama', code: 'PA' },
            { name: 'Papua New Guinea', code: 'PG' },
            { name: 'Paraguay', code: 'PY' },
            { name: 'Peru', code: 'PE' },
            { name: 'Philippines', code: 'PH' },
            { name: 'Pitcairn', code: 'PN' },
            { name: 'Poland', code: 'PL' },
            { name: 'Portugal', code: 'PT' },
            { name: 'Puerto Rico', code: 'PR' },
            { name: 'Qatar', code: 'QA' },
            { name: 'Reunion', code: 'RE' },
            { name: 'Romania', code: 'RO' },
            { name: 'Russian Federation', code: 'RU' },
            { name: 'RWANDA', code: 'RW' },
            { name: 'Saint Helena', code: 'SH' },
            { name: 'Saint Kitts and Nevis', code: 'KN' },
            { name: 'Saint Lucia', code: 'LC' },
            { name: 'Saint Pierre and Miquelon', code: 'PM' },
            { name: 'Saint Vincent and the Grenadines', code: 'VC' },
            { name: 'Samoa', code: 'WS' },
            { name: 'San Marino', code: 'SM' },
            { name: 'Sao Tome and Principe', code: 'ST' },
            { name: 'Saudi Arabia', code: 'SA' },
            { name: 'Senegal', code: 'SN' },
            { name: 'Serbia and Montenegro', code: 'CS' },
            { name: 'Seychelles', code: 'SC' },
            { name: 'Sierra Leone', code: 'SL' },
            { name: 'Singapore', code: 'SG' },
            { name: 'Slovakia', code: 'SK' },
            { name: 'Slovenia', code: 'SI' },
            { name: 'Solomon Islands', code: 'SB' },
            { name: 'Somalia', code: 'SO' },
            { name: 'South Africa', code: 'ZA' },
            { name: 'South Georgia and the South Sandwich Islands', code: 'GS' },
            { name: 'Spain', code: 'ES' },
            { name: 'Sri Lanka', code: 'LK' },
            { name: 'Sudan', code: 'SD' },
            { name: 'Suriname', code: 'SR' },
            { name: 'Svalbard and Jan Mayen', code: 'SJ' },
            { name: 'Swaziland', code: 'SZ' },
            { name: 'Sweden', code: 'SE' },
            { name: 'Switzerland', code: 'CH' },
            { name: 'Syrian Arab Republic', code: 'SY' },
            { name: 'Taiwan, Province of China', code: 'TW' },
            { name: 'Tajikistan', code: 'TJ' },
            { name: 'Tanzania, United Republic of', code: 'TZ' },
            { name: 'Thailand', code: 'TH' },
            { name: 'Timor-Leste', code: 'TL' },
            { name: 'Togo', code: 'TG' },
            { name: 'Tokelau', code: 'TK' },
            { name: 'Tonga', code: 'TO' },
            { name: 'Trinidad and Tobago', code: 'TT' },
            { name: 'Tunisia', code: 'TN' },
            { name: 'Turkey', code: 'TR' },
            { name: 'Turkmenistan', code: 'TM' },
            { name: 'Turks and Caicos Islands', code: 'TC' },
            { name: 'Tuvalu', code: 'TV' },
            { name: 'Uganda', code: 'UG' },
            { name: 'Ukraine', code: 'UA' },
            { name: 'United Arab Emirates', code: 'AE' },
            { name: 'United Kingdom', code: 'GB' },
            { name: 'United States', code: 'US' },
            { name: 'United States Minor Outlying Islands', code: 'UM' },
            { name: 'Uruguay', code: 'UY' },
            { name: 'Uzbekistan', code: 'UZ' },
            { name: 'Vanuatu', code: 'VU' },
            { name: 'Venezuela', code: 'VE' },
            { name: 'Viet Nam', code: 'VN' },
            { name: 'Virgin Islands, British', code: 'VG' },
            { name: 'Virgin Islands, U.S.', code: 'VI' },
            { name: 'Wallis and Futuna', code: 'WF' },
            { name: 'Western Sahara', code: 'EH' },
            { name: 'Yemen', code: 'YE' },
            { name: 'Zambia', code: 'ZM' },
            { name: 'Zimbabwe', code: 'ZW' }
        ];

        function loadSupportChatColors() {
            try {
                const stored = localStorage.getItem('supportChatColors');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    // Only assign known keys to prevent injection of unexpected properties
                    if (parsed.pending) supportChatColors.pending = parsed.pending;
                    if (parsed.longWait) supportChatColors.longWait = parsed.longWait;
                    if (parsed.solved) supportChatColors.solved = parsed.solved;
                }
            } catch (e) {
                console.warn('Failed to load support chat colours', e);
            }
        }

        function saveSupportChatColors() {
            try {
                localStorage.setItem('supportChatColors', JSON.stringify(supportChatColors));
            } catch (e) {
                console.warn('Failed to save support chat colours', e);
            }
        }

        function classifySupportAudience(chat) {
            if (chat?.audience) return chat.audience;
            const uid = chat?.userId;
            if (uid && Array.isArray(allUsers)) {
                const matched = allUsers.find(u => u.uid === uid);
                if (matched?.role === 'partner') return 'partners';
                if (matched?.role === 'admin' || matched?.role === 'agent') return 'admins';
            }
            return 'users';
        }
        
        const dashboardTranslations = {
            ru: {
                content: "–ö–æ–Ω—Ç–µ–Ω—Ç", royalty: "–†–æ—è–ª—Ç–∏", statistics: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", settings: "–ü—Ä–æ—Ñ–∏–ª—å –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
                partners: "–ü–∞—Ä—Ç–Ω–µ—Ä—ã", users: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
                addMovie: "–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º", addPartner: "–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞",
                royaltyReport: "–û—Ç—á–µ—Ç –ø–æ —Ä–æ—è–ª—Ç–∏", totalIncome: "–û–±—â–∏–π –¥–æ—Ö–æ–¥", lastPayment: "–ü–æ—Å–ª–µ–¥–Ω—è—è –≤—ã–ø–ª–∞—Ç–∞",
                nextPayment: "–°–ª–µ–¥—É—é—â–∞—è –≤—ã–ø–ª–∞—Ç–∞", contentDetails: "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É",
                title: "–ù–∞–∑–≤–∞–Ω–∏–µ", views: "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã", income: "–î–æ—Ö–æ–¥",
                viewStats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤", totalViews: "–í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤", watchTime: "–í—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (—á–∞—Å—ã)",
                topContent: "–¢–æ–ø –∫–æ–Ω—Ç–µ–Ω—Ç", viewsLast30Days: "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π",
                partnerAccountSettings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞", profileInfo: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–∏–ª–µ",
                name: "–ò–º—è", contactEmail: "–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π Email", paymentInfo: "–ü–ª–∞—Ç–µ–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
                saveSettings: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", languageSettings: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
                country: "–°—Ç—Ä–∞–Ω–∞", recipientName: "–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è", cardNumber: "–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã", phoneNumber: "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
                paymentHistory: "–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç", date: "–î–∞—Ç–∞", amount: "–°—É–º–º–∞", status: "–°—Ç–∞—Ç—É—Å",
                pendingPayments: "–û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–ø–ª–∞—Ç—ã", pay: "–í—ã–ø–ª–∞—Ç–∏—Ç—å", paymentSuccessful: "–í—ã–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!",
                uploadedMovies: "–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã", royaltyPerMovie: "–†–æ—è–ª—Ç–∏ –∑–∞ —Ñ–∏–ª—å–º",
                confirmDelete: "–í—ã —É–≤–µ—Ä–µ–Ω—ã?", messageDelete: "–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.",
                cancel: "–û—Ç–º–µ–Ω–∞", delete: "–£–¥–∞–ª–∏—Ç—å",
                faq: "FAQ", privacyPolicy: "–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏", requests: "–ó–∞–ø—Ä–æ—Å—ã",
                agreementTitle: "–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", agreeAndContinue: "–Ø –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é",
                requestTermination: "–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ", terminationRequest: "–ó–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ",
                sendRequest: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å",
                studioName: "–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—É–¥–∏–∏", partnerId: "ID –ü–∞—Ä—Ç–Ω–µ—Ä–∞", copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
                changePassword: "–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å", currentPassword: "–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å", newPassword: "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å",
                customId: "–ö–∞—Å—Ç–æ–º–Ω—ã–π ID", actions: "–î–µ–π—Å—Ç–≤–∏—è", editUser: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                userUpdateSuccess: "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!", userUpdateError: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
                userSearchPlaceholder: "–ü–æ–∏—Å–∫ –ø–æ ID, –∏–º–µ–Ω–∏ –∏–ª–∏ email...", userDetails: "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", back: "–ù–∞–∑–∞–¥",
                accountStatus: "–°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞", registrationDate: "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏", assignedId: "–ü—Ä–∏—Å–≤–æ–µ–Ω–Ω—ã–π ID",
                noPaymentHistory: "–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ø—É—Å—Ç–∞.", userNotFound: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                archiveUser: "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", 
                archiveUserConfirmTitle: "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?",
                archiveUserConfirmMessage: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –ï–≥–æ –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∞ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤.",
                userArchivedSuccess: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω.",
                archive: "–ê—Ä—Ö–∏–≤",
                restoreUser: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
                restoreUserConfirmTitle: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?",
                restoreUserConfirmMessage: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –ï–≥–æ –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏ –æ–Ω —Å–Ω–æ–≤–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ.",
                userRestoredSuccess: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.",
                archiveEmpty: "–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.",
                archivedDate: "–î–∞—Ç–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏",
                premiumStatus: "–°—Ç–∞—Ç—É—Å Premium",
                premiumEnabled: "Premium —Å—Ç–∞—Ç—É—Å –≤–∫–ª—é—á–µ–Ω.",
                premiumDisabled: "Premium —Å—Ç–∞—Ç—É—Å –≤—ã–∫–ª—é—á–µ–Ω.",
                idUpdated: "ID —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω.",
                selectTariff: "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ",
                editPremium: "–ò–∑–º–µ–Ω–∏—Ç—å Premium",
                partnerDetails: "–î–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞",
                partnerSearchPlaceholder: "–ü–æ–∏—Å–∫ –ø–æ ID, –∏–º–µ–Ω–∏ –∏–ª–∏ email...",
                partnerCreatedSuccess: "–ü–∞—Ä—Ç–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",
                password: "–ü–∞—Ä–æ–ª—å",
                deletePartner: "–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞",
                deletePartnerConfirmTitle: "–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞?",
                deletePartnerConfirmMessage: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ —É–¥–∞–ª–∏—Ç –µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã.",
                partnerDeletedSuccess: "–ü–∞—Ä—Ç–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.",
                partnerCategoriesLabel: "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞",
                partnerCategoryHint: "–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é",
                categoryMoviesSeries: "–§–∏–ª—å–º—ã –∏ —Å–µ—Ä–∏–∞–ª—ã",
                categorySports: "–°–ø–æ—Ä—Ç",
                categoryChallenge: "–ß–µ–ª–ª–µ–Ω–¥–∂",
                categorySnd: "SND (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)",
                partnerCategoryRequired: "–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–∞—Ä—Ç–Ω–µ—Ä–∞.",
                primaryCategory: "–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è",
                sportCategory: "–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è",
                sportCategoryPlaceholder: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Ä—Ç–∏–≤–Ω—É—é –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é",
                supportUsersTab: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
                supportPartnersTab: "–ü–∞—Ä—Ç–Ω–µ—Ä—ã",
                supportUsersHeading: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
                supportPartnersHeading: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤",
                partnerSupportDescription: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ Soundora. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç.",
                userSupportDescription: "–û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.",
                contactOperator: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
                openSupportPortal: "–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç–∞–ª –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
                supportEmptyUsers: "–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",
                supportEmptyPartners: "–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –æ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤.",
                heroEmptyState: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª–∞–π–¥–æ–≤ Hero ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≥–ª–∞–≤–Ω—É—é.",
                policyEmptyState: "–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –î–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ.",
                noNewRequests: "–ù–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç.",
                requestDate: "–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞",
                accept: "–ü—Ä–∏–Ω—è—Ç—å",
                decline: "–û—Ç–∫–ª–æ–Ω–∏—Ç—å",
                acceptRequestTitle: "–ü—Ä–∏–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å?",
                acceptRequestMessage: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ —Å —ç—Ç–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º? –ï–≥–æ –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω.",
                declineRequestTitle: "–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å?",
                declineRequestMessage: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å?",
                requestAccepted: "–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç. –ü–∞—Ä—Ç–Ω–µ—Ä —É–¥–∞–ª–µ–Ω.",
                requestDeclined: "–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω.",
                totalRoyalty: "–û–±—â–µ–µ —Ä–æ—è–ª—Ç–∏",
                totalPaid: "–í—Å–µ–≥–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ",
                balance: "–ë–∞–ª–∞–Ω—Å",
                royaltyDetails: "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ—è–ª—Ç–∏",
                moviesOfPartner: "–§–∏–ª—å–º—ã –ø–∞—Ä—Ç–Ω–µ—Ä–∞",
                registerPayment: "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É",
                paymentAmount: "–°—É–º–º–∞ –≤—ã–ø–ª–∞—Ç—ã",
                noPartnersForRoyalty: "–ù–µ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–æ—è–ª—Ç–∏.",
                totalMovies: "–í—Å–µ–≥–æ —Ñ–∏–ª—å–º–æ–≤",
                newUsersLast7Days: "–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ 7 –¥–Ω–µ–π",
                top10MoviesByViews: "–¢–æ–ø-10 —Ñ–∏–ª—å–º–æ–≤ –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º",
                royaltySettings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ—è–ª—Ç–∏",
                royaltyPerView: "–°—Ç–∞–≤–∫–∞ –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä ($)",
                settingsUpdateSuccess: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!",
                passwordUpdateSuccess: "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!",
                passwordUpdateError: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å.",
                accountRecovery: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞",
                enterSecretWord: "–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞",
                secretWord: "–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ",
                confirm: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
                wrongSecretWord: "–ù–µ–≤–µ—Ä–Ω–æ–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ!",
                tempCodeForLogin: "–í—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞",
                codeWillUpdateIn: "–ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑:",
                seconds: "—Å–µ–∫—É–Ω–¥",
                qrCodeForLogin: "QR-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞",
                promoCodes: "–ü—Ä–æ–º–æ–∫–æ–¥—ã",
                supportChats: "–ß–∞—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
                createPromoCode: "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥",
                duration: "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
                generateCode: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",
                codeGenerated: "–ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!",
                durationDays: "–¥–Ω–µ–π",
                // Region restrictions translations
                regionRestrictions: "–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è",
                blockInstruction: "–°–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏–æ–Ω",
                blockedMessage: "–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ",
                blockedCode: "–ö–æ–¥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏",
                regionSettingsSaved: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–≥–∏–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!",
                toggleAllRegions: "–í—Å–µ",
                blockAll: "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ",
                unblockAll: "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ",
                durationMonths: "–º–µ—Å—è—Ü–µ–≤",
                deleteChat: "–£–¥–∞–ª–∏—Ç—å —á–∞—Ç",
                deleteChatConfirmTitle: "–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?",
                deleteChatConfirmMessage: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.",
                chatDeletedSuccess: "–ß–∞—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.",
                admins: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã",
                addAdmin: "–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
                editAdmin: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
                permissions: "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞",
                role: "–†–æ–ª—å",
                agent: "–ê–≥–µ–Ω—Ç",
                admin: "–ê–¥–º–∏–Ω",
                manageContent: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º",
                manageUsers: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏",
                managePartners: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏",
                manageAdmins: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏",
                accessSupport: "–î–æ—Å—Ç—É–ø –∫ —á–∞—Ç–∞–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
                adminCreatedSuccess: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",
                adminUpdatedSuccess: "–î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!",
                position: "–ü–æ–∑–∏—Ü–∏—è",
                profileUpdateSuccess: "–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!",
                profileUpdateError: "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è"
            },
            uz: {
                content: "Kontent", royalty: "Royalti", statistics: "Statistika", settings: "Profil va Sozlamalar",
                partners: "Hamkorlar", users: "Foydalanuvchilar", welcome: "Xush kelibsiz",
                addMovie: "Kino qo'shish", addPartner: "Hamkor qo'shish",
                royaltyReport: "Royalti hisoboti", totalIncome: "Umumiy daromad", lastPayment: "Oxirgi to'lov",
                nextPayment: "Keyingi to'lov", contentDetails: "Kontent bo'yicha tafsilotlar",
                title: "Nomi", views: "Ko'rishlar", income: "Daromad",
                viewStats: "Ko'rishlar statistikasi", totalViews: "Jami ko'rishlar", watchTime: "Ko'rish vaqti (soat)",
                topContent: "Top kontent", viewsLast30Days: "Oxirgi 30 kundagi ko'rishlar",
                partnerAccountSettings: "Hamkor akkaunti sozlamalari", profileInfo: "Profil ma'lumotlari",
                name: "Ism", contactEmail: "Aloqa uchun Email", paymentInfo: "To'lov ma'lumotlari",
                saveSettings: "Sozlamalarni saqlash", languageSettings: "Interfeys tili",
                country: "Davlat", recipientName: "Qabul qiluvchi ismi", cardNumber: "Karta raqami", phoneNumber: "Telefon raqami",
                paymentHistory: "To'lovlar tarixi", date: "Sana", amount: "Summa", status: "Holat",
                pendingPayments: "Kutilayotgan to'lovlar", pay: "To'lash", paymentSuccessful: "To'lov muvaffaqiyatli qayd etildi!",
                uploadedMovies: "Yuklangan kinolar", royaltyPerMovie: "Har bir kino uchun royalti",
                confirmDelete: "Ishonchingiz komilmi?", messageDelete: "Haqiqatan ham bu elementni o ªchirib tashlamoqchimisiz? Bu amalni bekor qilib bo ªlmaydi.",
                cancel: "Bekor qilish", delete: "O'chirish",
                faq: "FAQ", privacyPolicy: "Maxfiylik siyosati", requests: "So'rovlar",
                agreementTitle: "Hamkorlik shartnomasi", agreeAndContinue: "Shartlarni qabul qilaman va davom etaman",
                requestTermination: "Hamkorlikni bekor qilish", terminationRequest: "Bekor qilish so'rovi",
                sendRequest: "So'rov yuborish",
                studioName: "Studiya nomi", partnerId: "Hamkor IDsi", copy: "Nusxalash",
                changePassword: "Parolni o'zgartirish", currentPassword: "Joriy parol", newPassword: "Yangi parol",
                customId: "Maxsus ID", actions: "Harakatlar", editUser: "Foydalanuvchini tahrirlash", save: "Saqlash",
                userUpdateSuccess: "Foydalanuvchi ma'lumotlari muvaffaqiyatli yangilandi!", userUpdateError: "Foydalanuvchi ma'lumotlarini yangilashda xatolik.",
                userSearchPlaceholder: "ID, ism yoki email bo'yicha qidirish...", userDetails: "Foydalanuvchi ma'lumotlari", back: "Orqaga",
                accountStatus: "Hisob holati", registrationDate: "Ro'yxatdan o'tgan sana", assignedId: "Biriktirilgan ID",
                noPaymentHistory: "To'lovlar tarixi mavjud emas.", userNotFound: "Foydalanuvchi topilmadi.",
                archiveUser: "Foydalanuvchini arxivlash",
                archiveUserConfirmTitle: "Foydalanuvchini arxivlash?",
                archiveUserConfirmMessage: "Haqiqatan ham bu foydalanuvchini arxivlamoqchimisiz? Uning hisobi bloklanadi va ma'lumotlari arxivga ko'chiriladi.",
                userArchivedSuccess: "Foydalanuvchi muvaffaqiyatli bloklandi va arxivlandi.",
                archive: "Arxiv",
                restoreUser: "Qayta tiklash",
                restoreUserConfirmTitle: "Foydalanuvchini tiklash?",
                restoreUserConfirmMessage: "Haqiqatan ham bu foydalanuvchini qayta tiklamoqchimisiz? Uning hisobi blokdan chiqariladi va u yana umumiy ro'yxatda paydo bo'ladi.",
                userRestoredSuccess: "Foydalanuvchi muvaffaqiyatli qayta tiklandi.",
                archiveEmpty: "Arxiv bo'sh.",
                archivedDate: "Arxivlangan sana",
                premiumStatus: "Premium Holati",
                premiumEnabled: "Premium holati yoqildi.",
                premiumDisabled: "Premium holati o'chirildi.",
                idUpdated: "ID muvaffaqiyatli yangilandi.",
                selectTariff: "Tarifni tanlang",
                editPremium: "Premium'ni o'zgartirish",
                partnerDetails: "Hamkor ma'lumotlari",
                partnerSearchPlaceholder: "ID, ism yoki email bo'yicha qidirish...",
                partnerCreatedSuccess: "Hamkor muvaffaqiyatli yaratildi!",
                password: "Parol",
                deletePartner: "Hamkorni o'chirish",
                deletePartnerConfirmTitle: "Hamkorni o'chirish?",
                deletePartnerConfirmMessage: "Haqiqatan ham bu hamkorni o'chirib tashlamoqchimisiz? Bu amal qaytarib bo'lmaydi va uning hisobini tizimdan o'chiradi.",
                partnerDeletedSuccess: "Hamkor muvaffaqiyatli o'chirildi.",
                partnerCategoriesLabel: "Hamkor toifalari",
                partnerCategoryHint: "Kamida bitta toifani tanlang",
                categoryMoviesSeries: "Kino va seriallar",
                categorySports: "Sport",
                categoryChallenge: "Challengelar",
                categorySnd: "SND (faqat adminlar)",
                partnerCategoryRequired: "Hamkor uchun kamida bitta toifa tanlanishi kerak.",
                primaryCategory: "Asosiy toifa",
                sportCategory: "Sport past toifa",
                sportCategoryPlaceholder: "Sport past toifasini tanlang",
                supportUsersTab: "Foydalanuvchilar",
                supportPartnersTab: "Hamkorlar",
                supportUsersHeading: "Foydalanuvchi yordami",
                supportPartnersHeading: "Hamkorlar yordami",
                partnerSupportDescription: "Soundora hamkorlari uchun qo'llab-quvvatlash. Operatorlarga savol bering yoki chatni oching.",
                userSupportDescription: "Platforma foydalanuvchilari yuborgan murojaatlar navbati.",
                contactOperator: "Operator bilan bog'lanish",
                openSupportPortal: "Qo'llab-quvvatlash portalini ochish",
                supportEmptyUsers: "Foydalanuvchilardan hali murojaatlar yo'q.",
                supportEmptyPartners: "Hamkordan hali murojaat kelmadi.",
                heroPanelLoading: "Hero bo'limi yuklanmoqda...",
                heroSaveSuccess: "Hero sozlamalari saqlandi.",
                heroSaveError: "Hero sozlamalarini saqlab bo'lmadi.",
                policyPanelLoading: "Policy bo'limi yuklanmoqda...",
                policySaveSuccess: "Policy ma'lumotlari saqlandi.",
                policySaveError: "Policy ma'lumotlarini saqlashda xatolik.",
                alertsHeading: "E'lon yuborish",
                alertsSubheading: "Xabar barcha foydalanuvchilarga ko'rinadi.",
                alertsEmpty: "Hozircha e'lonlar yo'q.",
                alertsSendSuccess: "E'lon yuborildi.",
                alertsSendError: "E'lon yuborilmadi.",
                audienceRegistered: "Ro'yxatdan o'tgan foydalanuvchilar",
                audienceUnregistered: "Ro'yxatdan o'tmagan mehmonlar",
                audienceAll: "Barcha foydalanuvchilar",
                audienceDescRegistered: "Akkauntga ega bo'lgan foydalanuvchilarga yuboriladi",
                audienceDescUnregistered: "Akkauntga ega bo'lmagan mehmonlarga yuboriladi",
                audienceDescAll: "Barcha foydalanuvchilarga (akkaunti bor va yo'q) yuboriladi",
                heroEmptyState: "Hero slaydlari mavjud emas. Bosh sahifani to'ldirish uchun slayd qo'shing.",
                policyEmptyState: "Siyosat bo'limi bo'sh. Quyida bo'lim qo'shing.",
                noNewRequests: "Yangi so'rovlar yo'q.",
                requestDate: "So'rov sanasi",
                accept: "Qabul qilish",
                decline: "Rad etish",
                acceptRequestTitle: "So'rovni qabul qilish?",
                acceptRequestMessage: "Haqiqatan ham ushbu hamkor bilan shartnomani bekor qilmoqchimisiz? Uning hisobi o'chiriladi.",
                declineRequestTitle: "So'rovni rad etish?",
                declineRequestMessage: "Haqiqatan ham ushbu so'rovni rad etmoqchimisiz?",
                requestAccepted: "So'rov qabul qilindi. Hamkor o'chirildi.",
                requestDeclined: "So'rov rad etildi.",
                totalRoyalty: "Jami royalti",
                totalPaid: "Jami to'langan",
                balance: "Balans",
                royaltyDetails: "Royalti tafsilotlari",
                moviesOfPartner: "Hamkor filmlari",
                registerPayment: "To'lovni qayd etish",
                paymentAmount: "To'lov miqdori",
                noPartnersForRoyalty: "Royalti hisoblash uchun hamkorlar yo'q.",
                totalMovies: "Jami filmlar",
                newUsersLast7Days: "Oxirgi 7 kundagi yangi foydalanuvchilar",
                top10MoviesByViews: "Ko'rishlar soni bo'yicha top 10 film",
                royaltySettings: "Royalti sozlamalari",
                royaltyPerView: "Har bir ko'rish uchun stavka ($)",
                settingsUpdateSuccess: "Sozlamalar muvaffaqiyatli yangilandi!",
                passwordUpdateSuccess: "Parol muvaffaqiyatli o'zgartirildi!",
                passwordUpdateError: "Parolni o'zgartirishda xatolik. Joriy parolni tekshiring.",
                accountRecovery: "Hisobni tiklash",
                enterSecretWord: "Kirish uchun foydalanuvchining maxfiy so'zini kiriting",
                secretWord: "Maxfiy so'z",
                confirm: "Tasdiqlash",
                wrongSecretWord: "Maxfiy so'z noto'g'ri!",
                tempCodeForLogin: "Kirish uchun vaqtinchalik kod",
                codeWillUpdateIn: "Kod quyidagi vaqtdan so'ng yangilanadi:",
                seconds: "soniya",
                qrCodeForLogin: "Kirish uchun QR-kod",
                promoCodes: "Promokodlar",
                supportChats: "Qo'llab-quvvatlash chatlari",
                createPromoCode: "Promokod yaratish",
                duration: "Davomiyligi",
                generateCode: "Kod yaratish",
                codeGenerated: "Kod yaratildi!",
                durationDays: "kun",
                // Region restrictions translations
                regionRestrictions: "Hudud cheklovlari",
                blockInstruction: "Mamlakatlardan belgilashni olib tashlab ruxsat bering",
                blockedMessage: "Bloklash xabari",
                blockedCode: "Blok kodi",
                regionSettingsSaved: "Hudud cheklovlari saqlandi!",
                toggleAllRegions: "Hammasi",
                blockAll: "Hammasini bloklash",
                unblockAll: "Hammasini ochish",
                durationMonths: "oy",
                deleteChat: "Chatni o'chirish",
                deleteChatConfirmTitle: "Chatni o'chirish?",
                deleteChatConfirmMessage: "Haqiqatan ham bu chatni o ªchirib tashlamoqchimisiz? Bu amalni bekor qilib bo ªlmaydi.",
                chatDeletedSuccess: "Chat muvaffaqiyatli o ªchirildi.",
                admins: "Adminlar",
                addAdmin: "Admin qo'shish",
                editAdmin: "Adminni tahrirlash",
                permissions: "Ruxsatlar",
                role: "Rol",
                agent: "Agent",
                admin: "Admin",
                manageContent: "Kontentni boshqarish",
                manageUsers: "Foydalanuvchilarni boshqarish",
                managePartners: "Hamkorlarni boshqarish",
                manageAdmins: "Adminlarni boshqarish",
                accessSupport: "Qo'llab-quvvatlash chatlariga kirish",
                adminCreatedSuccess: "Admin muvaffaqiyatli yaratildi!",
                adminUpdatedSuccess: "Admin ma'lumotlari yangilandi!",
                position: "Pozitsiya",
                profileUpdateSuccess: "Profil muvaffaqiyatli yangilandi!",
                profileUpdateError: "Profilni yangilashda xatolik"
            }
        };

        // --- YORDAMCHI FUNKSIYALAR ---
        Object.assign(dashboardTranslations.ru, {
            heroPanelLoading: "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–Ω–µ–ª–∏ Hero...",
            heroSaveSuccess: "Hero –æ–±–Ω–æ–≤–ª–µ–Ω.",
            heroSaveError: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å Hero.",
            policyPanelLoading: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ Policy...",
            policySaveSuccess: "–ü–æ–ª–∏—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.",
            policySaveError: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É.",
            alertsHeading: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ",
            alertsSubheading: "–°–æ–æ–±—â–µ–Ω–∏–µ —É–≤–∏–¥—è—Ç –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.",
            alertsEmpty: "–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.",
            alertsSendSuccess: "–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.",
            alertsSendError: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ.",
            audienceTargetLabel: "–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:",
            audienceRegistered: "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            audienceUnregistered: "–ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏",
            audienceAll: "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            audienceDescRegistered: "–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏",
            audienceDescUnregistered: "–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º –±–µ–∑ –∞–∫–∫–∞—É–Ω—Ç–æ–≤",
            audienceDescAll: "–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (—Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –∏ –±–µ–∑)"
        });
        Object.assign(dashboardTranslations.uz, {
            heroPanelLoading: "Hero bo'limi yuklanmoqda...",
            heroSaveSuccess: "Hero sozlamalari saqlandi.",
            heroSaveError: "Hero sozlamalarini saqlab bo'lmadi.",
            policyPanelLoading: "Policy bo'limi yuklanmoqda...",
            policySaveSuccess: "Policy ma'lumotlari saqlandi.",
            policySaveError: "Policy ma'lumotlarini saqlashda xatolik.",
            alertsHeading: "E'lon yuborish",
            alertsSubheading: "Xabar barcha foydalanuvchilarga ko'rinadi.",
            alertsEmpty: "Hozircha e'lonlar yo'q.",
            alertsSendSuccess: "E'lon yuborildi.",
            alertsSendError: "E'lon yuborilmadi.",
            audienceTargetLabel: "Maqsadli auditoriya:",
            audienceRegistered: "Ro'yxatdan o'tgan foydalanuvchilar",
            audienceUnregistered: "Ro'yxatdan o'tmagan mehmonlar",
            audienceAll: "Barcha foydalanuvchilar",
            audienceDescRegistered: "Akkauntga ega bo'lgan foydalanuvchilarga yuboriladi",
            audienceDescUnregistered: "Akkauntga ega bo'lmagan mehmonlarga yuboriladi",
            audienceDescAll: "Barcha foydalanuvchilarga (akkaunti bor va yo'q) yuboriladi"
        });

        async function fetchHeroConfig() {
            const heroRef = doc(db, 'config', 'hero');
            let data = {};
            try {
                const snap = await getDoc(heroRef);
                if (snap.exists()) data = snap.data() || {};
            } catch (err) {
                console.warn('Failed to fetch hero config:', err);
            }
            const heroCount = Number.isFinite(data.heroCount) ? data.heroCount : 5;
            const maxHeroCount = Number.isFinite(data.maxHeroCount) ? data.maxHeroCount : Math.max(heroCount, 5);
            const slides = Array.isArray(data.slides) ? data.slides : [];
            return { heroRef, heroCount, maxHeroCount, slides };
        }

        async function persistHeroConfig(heroRef, payload) {
            try {
                await setDoc(heroRef, { ...payload, updatedAt: serverTimestamp() }, { merge: true });
                return true;
            } catch (err) {
                console.error('persistHeroConfig error', err);
                return false;
            }
        }

        async function fetchPolicyConfig() {
            const policyRef = doc(db, 'config', 'policy');
            let policyText = '';
            let heroMax = 5;
            try {
                const snap = await getDoc(policyRef);
                if (snap.exists()) {
                    const data = snap.data() || {};
                    policyText = data.body || '';
                    heroMax = Number.isFinite(data.maxHeroCount) ? data.maxHeroCount : heroMax;
                }
            } catch (err) {
                console.warn('Failed to fetch policy config:', err);
            }
            return { policyRef, policyText, heroMax };
        }

        async function persistPolicyConfig(policyRef, payload) {
            try {
                await setDoc(policyRef, payload, { merge: true });
                return true;
            } catch (err) {
                console.error('persistPolicyConfig error', err);
                return false;
            }
        }

        // Policy helpers: change limit options and utilities
        const POLICY_CHANGE_LIMIT_OPTIONS = [
            { key: '10y', ms: 10 * 365 * 24 * 60 * 60 * 1000, label: '10 years' },
            { key: '5y', ms: 5 * 365 * 24 * 60 * 60 * 1000, label: '5 years' },
            { key: '1y', ms: 1 * 365 * 24 * 60 * 60 * 1000, label: '1 year' },
            { key: '1m', ms: 30 * 24 * 60 * 60 * 1000, label: '1 month' },
            { key: '20d', ms: 20 * 24 * 60 * 60 * 1000, label: '20 days' },
            { key: '10d', ms: 10 * 24 * 60 * 60 * 1000, label: '10 days' },
            { key: '5d', ms: 5 * 24 * 60 * 60 * 1000, label: '5 days' },
            { key: '1d', ms: 1 * 24 * 60 * 60 * 1000, label: '1 day' }
        ];

        function findChangeLimitOptionByMs(ms) {
            return POLICY_CHANGE_LIMIT_OPTIONS.find(o => o.ms === ms) || null;
        }

        function humanizeMs(ms) {
            const opt = findChangeLimitOptionByMs(ms);
            if (opt) return opt.label;
            if (!ms || ms <= 0) return 'No limit';
            const days = Math.round(ms / (24 * 60 * 60 * 1000));
            return `${days} days`;
        }

        function generateChapterId() {
            return `ch_${Date.now().toString(36)}_${Math.floor(Math.random() * 10000)}`;
        }

        function canModifyChapter(chapter, changeLimitMs) {
            // test chapters are always editable
            if (chapter && chapter.test) return { allowed: true };
            const last = chapter?.lastModifiedAt ? (chapter.lastModifiedAt.toMillis ? chapter.lastModifiedAt.toMillis() : new Date(chapter.lastModifiedAt).getTime()) : 0;
            if (!changeLimitMs || changeLimitMs <= 0) return { allowed: true };
            const nextAllowedAt = last + changeLimitMs;
            const now = Date.now();
            if (now >= nextAllowedAt) return { allowed: true };
            return { allowed: false, retryAt: nextAllowedAt };
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const icon = isError ? '<i class="fas fa-exclamation-circle mr-2"></i>' : '<i class="fas fa-check-circle mr-2"></i>';
            toast.innerHTML = `
                <div class="flex items-center">
                    ${icon}
                    <span>${message}</span>
                </div>
            `;
            toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-4 flex items-center ${isError ? 'error' : 'success'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('opacity-0', 'translate-y-4'), 10);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function closeModal() {
            const modal = document.getElementById('modal-overlay');
            modal.classList.add('hidden');
            modal.innerHTML = '';
        }
        
        function showModal(htmlContent, onMountCallback) {
            const modal = document.getElementById('modal-overlay');
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-75" onclick="closeModal()"></div>
                ${htmlContent}
            `;
            modal.classList.remove('hidden');
            
            // Execute callback after modal is rendered
            if (typeof onMountCallback === 'function') {
                setTimeout(onMountCallback, 0);
            }
        }

        function setDashboardLanguage(lang) {
            currentDashboardLanguage = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                const translation = dashboardTranslations[lang]?.[key];
                if (translation) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translation;
                    } else if (el.id === 'welcome-message') {
                        const name = currentUserData?.displayName || (currentUserRole === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–∞—Ä—Ç–Ω–µ—Ä');
                        el.textContent = `${translation}, ${name}!`;
                    } else {
                        el.textContent = translation;
                    }
                }
            });
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
        }
        
        // --- MODAL OYNA FUNKSIYALARI ---
        function openMovieModal(movie = null) {
            const isEditing = movie !== null;
            const modalTitle = isEditing ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å–º' : '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∏–ª—å–º';
            const m = isEditing ? movie : {};
            
            // Temporary form data storage
            window.movieFormData = window.movieFormData || {
                step1: {}, step2: {}, step3: {}, step4: {}, step5: {},
                completedSteps: new Set()
            };
            
            const userAllowedCategories = (currentUserRole === 'partner' && Array.isArray(currentUserData?.allowedCategories) && currentUserData.allowedCategories.length > 0)
                ? currentUserData.allowedCategories
                : PARTNER_CATEGORY_OPTIONS.map(opt => opt.value);
            let categoryOptions = PARTNER_CATEGORY_OPTIONS.filter(opt => {
                if (opt.adminOnly) {
                    return currentUserRole === 'admin' || currentUserRole === 'agent';
                }
                return userAllowedCategories.includes(opt.value);
            });
            if (m.primaryCategory && !categoryOptions.some(opt => opt.value === m.primaryCategory)) {
                const fallback = PARTNER_CATEGORY_OPTIONS.find(opt => opt.value === m.primaryCategory);
                if (fallback) {
                    categoryOptions = [...categoryOptions, fallback];
                }
            }
            if (categoryOptions.length === 0) {
                categoryOptions.push(PARTNER_CATEGORY_OPTIONS[0]);
            }
            const derivedPrimaryCategory = categoryOptions.some(opt => opt.value === m.primaryCategory)
                ? m.primaryCategory
                : (categoryOptions.find(opt => opt.value === 'general')?.value || categoryOptions[0].value);
            const derivedSportCategory = m.sportCategory || 'all';
            const primaryCategoryOptionsHtml = categoryOptions.map(opt => `<option value="${opt.value}" ${derivedPrimaryCategory === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('');
            const sportOptions = SPORTS_SUBCATEGORY_OPTIONS.some(opt => opt.value === derivedSportCategory)
                ? SPORTS_SUBCATEGORY_OPTIONS
                : [...SPORTS_SUBCATEGORY_OPTIONS, { value: derivedSportCategory, label: derivedSportCategory }];
            const sportCategoryOptionsHtml = sportOptions.map(opt => `<option value="${opt.value}" ${derivedSportCategory === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('');
            
            // Hudud checkboxlari uchun HTML
            const movieRegions = Array.isArray(m.availableRegions) ? m.availableRegions : (currentUserData?.allowedRegions || centralAsiaRegions.map(r => r.code));
            const regionCheckboxes = centralAsiaRegions.map(r => {
                const isChecked = movieRegions.includes(r.code);
                const isDisabled = currentUserRole === 'partner' && !currentUserData?.allowedRegions?.includes(r.code);
                return `
                    <label class="flex items-center gap-2 text-sm ${isDisabled ? 'text-gray-500' : 'text-gray-300'}">
                        <input type="checkbox" class="movie-region-checkbox h-4 w-4 text-blue-500" value="${r.code}" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                        <span>${r.flag} ${r.name}</span>
                    </label>`;
            }).join('');
            
            const modalHTML = `
            <div class="fixed inset-0 bg-gray-900 z-50 flex">
                <!-- Left Sidebar - Steps -->
                <div class="w-64 bg-gray-800 border-r border-gray-700 p-6">
                    <h3 class="text-xl font-bold mb-8 text-white">${modalTitle}</h3>
                    <nav class="space-y-2">
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors" data-step="1">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">1</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                        </button>
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors opacity-50" data-step="2">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">2</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">–û–ø–∏—Å–∞–Ω–∏–µ</span>
                        </button>
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors opacity-50" data-step="3">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">3</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">Hududlar / –†–µ–≥–∏–æ–Ω—ã</span>
                        </button>
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors opacity-50" data-step="4">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">4</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">–ü—Ä–æ–¥—é—Å–µ—Ä –∏ –ê–∫—Ç—ë—Ä—ã</span>
                        </button>
                        <button type="button" class="step-nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-700 transition-colors opacity-50" data-step="5">
                            <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center text-xs font-bold">
                                <span class="step-number">5</span>
                                <i class="fas fa-check step-check hidden text-green-400"></i>
                            </div>
                            <span class="text-sm">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–∏–¥–µ–æ</span>
                        </button>
                    </nav>
                    <button id="close-modal-btn" class="w-full mt-8 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-times mr-2"></i>–û—Ç–º–µ–Ω–∞
                    </button>
                </div>
                
                <!-- Right Content Area -->
                <div class="flex-1 flex flex-col bg-gray-900">
                    <div class="flex-1 overflow-y-auto p-8">
                        <form id="movie-form">
                            <input type="hidden" id="movie-id" value="${m.id || ''}">
                            
                            <!-- Step 1: Basic Info -->
                            <div class="step-content" data-step="1">
                                <h4 class="text-2xl font-bold mb-6 text-white">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                                        <input type="text" id="movie-title" class="modal-input w-full p-3 rounded-md" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞" value="${m.title || ''}" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                                        <input type="text" id="movie-original-title" class="modal-input w-full p-3 rounded-md" placeholder="Original Title" value="${m.originalTitle || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–ì–æ–¥ *</label>
                                        <input type="number" id="movie-year" class="modal-input w-full p-3 rounded-md" placeholder="2024" value="${m.year || ''}" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–ñ–∞–Ω—Ä *</label>
                                        <input type="text" id="movie-genre" class="modal-input w-full p-3 rounded-md" placeholder="–ë–æ–µ–≤–∏–∫, –î—Ä–∞–º–∞" value="${m.genre || ''}" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–°—Ç—Ä–∞–Ω–∞</label>
                                        <input type="text" id="movie-country" class="modal-input w-full p-3 rounded-md" placeholder="–°–®–ê" value="${m.country || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                                        <input type="text" id="movie-duration" class="modal-input w-full p-3 rounded-md" placeholder="120 –º–∏–Ω" value="${m.duration || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–†–µ–π—Ç–∏–Ω–≥ IMDB</label>
                                        <input type="text" id="movie-rating" class="modal-input w-full p-3 rounded-md" placeholder="7.5/10" value="${m.rating || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">URL –ø–æ—Å—Ç–µ—Ä–∞ *</label>
                                        <input type="url" id="movie-poster" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.poster || ''}" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–°—Ç—É–¥–∏—è</label>
                                        <input type="text" id="movie-studio" class="modal-input w-full p-3 rounded-md" placeholder="Warner Bros" value="${m.studio || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ *</label>
                                        <select id="movie-type" class="modal-input w-full p-3 rounded-md">
                                            <option value="movie" ${m.type === 'movie' ? 'selected' : ''}>–§–∏–ª—å–º</option>
                                            <option value="series" ${m.type === 'series' ? 'selected' : ''}>–°–µ—Ä–∏–∞–ª</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="movie-primary-category" class="block text-sm font-medium text-gray-400 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                                        <select id="movie-primary-category" class="modal-input w-full p-3 rounded-md">
                                            ${primaryCategoryOptionsHtml}
                                        </select>
                                    </div>
                                    <div id="sport-category-wrapper" class="${derivedPrimaryCategory === 'sports' ? '' : 'hidden'}">
                                        <label for="movie-sport-category" class="block text-sm font-medium text-gray-400 mb-1">–°–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                        <select id="movie-sport-category" class="modal-input w-full p-3 rounded-md">
                                            ${sportCategoryOptionsHtml}
                                        </select>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="movie-premium" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500" ${m.isPremium ? 'checked' : ''}>
                                        <label for="movie-premium" class="ml-3 block text-sm text-gray-300">–ü—Ä–µ–º–∏—É–º –∫–æ–Ω—Ç–µ–Ω—Ç</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Description -->
                            <div class="step-content hidden" data-step="2">
                                <h4 class="text-2xl font-bold mb-6 text-white">–û–ø–∏—Å–∞–Ω–∏–µ</h4>
                                <div class="mb-6">
                                    <label for="movie-description" class="block text-sm font-medium text-gray-400 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞</label>
                                    <textarea id="movie-description" class="modal-input w-full p-3 rounded-md" rows="8" placeholder="–û–ø–∏—à–∏—Ç–µ —Å—é–∂–µ—Ç —Ñ–∏–ª—å–º–∞...">${m.description || ''}</textarea>
                                    <p class="text-xs text-gray-500 mt-2">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç –∑—Ä–∏—Ç–µ–ª—è–º –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –æ —á–µ–º —Ñ–∏–ª—å–º</p>
                                </div>
                                
                                <!-- Screenshots Section -->
                                <div class="border-t border-gray-700 pt-6">
                                    <h5 class="text-xl font-semibold mb-4 text-white">Kinodan lavhalar / –°–∫—Ä–∏–Ω—à–æ—Ç—ã (1/5)</h5>
                                    <p class="text-sm text-gray-400 mb-4">–î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∏–∑ —Ñ–∏–ª—å–º–∞ (–º–∞–∫—Å–∏–º—É–º 5 —à—Ç—É–∫)</p>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="screenshot-1" class="block text-sm font-medium text-gray-400 mb-1">–°–∫—Ä–∏–Ω—à–æ—Ç 1</label>
                                            <input type="url" id="screenshot-1" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.screenshots && m.screenshots[0] ? m.screenshots[0] : ''}">
                                        </div>
                                        <div>
                                            <label for="screenshot-2" class="block text-sm font-medium text-gray-400 mb-1">–°–∫—Ä–∏–Ω—à–æ—Ç 2</label>
                                            <input type="url" id="screenshot-2" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.screenshots && m.screenshots[1] ? m.screenshots[1] : ''}">
                                        </div>
                                        <div>
                                            <label for="screenshot-3" class="block text-sm font-medium text-gray-400 mb-1">–°–∫—Ä–∏–Ω—à–æ—Ç 3</label>
                                            <input type="url" id="screenshot-3" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.screenshots && m.screenshots[2] ? m.screenshots[2] : ''}">
                                        </div>
                                        <div>
                                            <label for="screenshot-4" class="block text-sm font-medium text-gray-400 mb-1">–°–∫—Ä–∏–Ω—à–æ—Ç 4</label>
                                            <input type="url" id="screenshot-4" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.screenshots && m.screenshots[3] ? m.screenshots[3] : ''}">
                                        </div>
                                        <div>
                                            <label for="screenshot-5" class="block text-sm font-medium text-gray-400 mb-1">–°–∫—Ä–∏–Ω—à–æ—Ç 5</label>
                                            <input type="url" id="screenshot-5" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.screenshots && m.screenshots[4] ? m.screenshots[4] : ''}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Regions -->
                            <div class="step-content hidden" data-step="3">
                                <h4 class="text-2xl font-bold mb-6 text-white">Hududlar / –†–µ–≥–∏–æ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏</h4>
                                <p class="text-sm text-gray-400 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç</p>
                                <div class="flex flex-wrap gap-4 bg-gray-800/60 p-6 rounded-lg">
                                    ${regionCheckboxes}
                                </div>
                            </div>
                            
                            <!-- Step 4: Producer & Cast -->
                            <div class="step-content hidden" data-step="4">
                                <h4 class="text-2xl font-bold mb-6 text-white">–ü—Ä–æ–¥—é—Å–µ—Ä –∏ –ê–∫—Ç—ë—Ä—ã</h4>
                                
                                <!-- Producer Section -->
                                <div class="mb-8 bg-gray-800 p-5 rounded-lg border border-gray-700">
                                    <h5 class="text-xl font-semibold mb-4 text-white">–ü—Ä–æ–¥—é—Å–µ—Ä</h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="movie-producer" class="block text-sm font-medium text-gray-400 mb-1">–ò–º—è –ø—Ä–æ–¥—é—Å–µ—Ä–∞</label>
                                            <input type="text" id="movie-producer" class="modal-input w-full p-3 rounded-md" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" value="${m.producer || ''}">
                                        </div>
                                        <div>
                                            <label for="producer-image" class="block text-sm font-medium text-gray-400 mb-1">URL —Ñ–æ—Ç–æ</label>
                                            <input type="url" id="producer-image" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.producerImage || ''}">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label for="producer-bio" class="block text-sm font-medium text-gray-400 mb-1">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</label>
                                            <textarea id="producer-bio" class="modal-input w-full p-3 rounded-md" rows="3" placeholder="–ö—Ä–∞—Ç–∫–∞—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –ø—Ä–æ–¥—é—Å–µ—Ä–∞...">${m.producerBio || ''}</textarea>
                                        </div>
                                        <div class="md:col-span-2 bg-gray-900/60 p-4 rounded-lg">
                                            <h6 class="text-sm font-semibold text-gray-300 mb-3">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</h6>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block text-xs text-gray-400 mb-1"><i class="fab fa-instagram mr-1"></i> Instagram</label>
                                                    <input type="url" id="producer-instagram" class="modal-input w-full p-2 rounded-md text-sm" placeholder="https://instagram.com/..." value="${m.producerSocial?.instagram || ''}">
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-400 mb-1"><i class="fab fa-facebook mr-1"></i> Facebook</label>
                                                    <input type="url" id="producer-facebook" class="modal-input w-full p-2 rounded-md text-sm" placeholder="https://facebook.com/..." value="${m.producerSocial?.facebook || ''}">
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-400 mb-1"><i class="fab fa-twitter mr-1"></i> Twitter</label>
                                                    <input type="url" id="producer-twitter" class="modal-input w-full p-2 rounded-md text-sm" placeholder="https://twitter.com/..." value="${m.producerSocial?.twitter || ''}">
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-400 mb-1"><i class="fab fa-wikipedia-w mr-1"></i> Wikipedia</label>
                                                    <input type="url" id="producer-wikipedia" class="modal-input w-full p-2 rounded-md text-sm" placeholder="https://wikipedia.org/..." value="${m.producerSocial?.wikipedia || ''}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cast Section -->
                                <div class="border-t border-gray-700 pt-6">
                                    <h5 class="text-xl font-semibold mb-4 text-white">Aktyorlar / –ê–∫—Ç—ë—Ä—ã</h5>
                                    <div id="cast-container" class="space-y-4 mb-4"></div>
                                    <button type="button" id="add-cast-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 px-6 rounded-md">
                                        <i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç—ë—Ä–∞
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Step 5: Video Sources -->
                            <div class="step-content hidden" data-step="5">
                                <h4 class="text-2xl font-bold mb-6 text-white">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–∏–¥–µ–æ</h4>
                                
                                <!-- Tab Toggle for Upload Method -->
                                <div class="flex gap-2 mb-6 border-b border-gray-700">
                                    <button type="button" id="tab-device-upload" class="upload-tab-btn px-6 py-3 font-semibold text-sm transition-all border-b-2 border-transparent hover:text-blue-400 active">
                                        <i class="fas fa-link mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –ø–æ URL
                                    </button>
                                    <button type="button" id="tab-url-upload" class="upload-tab-btn px-6 py-3 font-semibold text-sm transition-all border-b-2 border-transparent hover:text-blue-400">
                                        <i class="fas fa-upload mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                                    </button>
                                </div>
                                
                                <!-- Single movie sources -->
                                <div id="single-sources-section" class="${m.type === 'series' ? 'hidden' : ''}">
                                    
                                    <!-- Device Upload Tab Content -->
                                    <div id="device-upload-content" class="upload-tab-content">
                                        <p class="text-sm text-gray-400 mb-4">–î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ –≤ —Ä–∞–∑–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤–∞—Ö</p>
                                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                                            <div>
                                                <label for="source-480p" class="block text-sm font-medium text-gray-400 mb-1">480p</label>
                                                <input type="url" id="source-480p" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.sources ? (m.sources['480p'] || '') : ''}">
                                            </div>
                                            <div>
                                                <label for="source-720p" class="block text-sm font-medium text-gray-400 mb-1">720p</label>
                                                <input type="url" id="source-720p" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.sources ? (m.sources['720p'] || '') : ''}">
                                            </div>
                                            <div>
                                                <label for="source-1080p" class="block text-sm font-medium text-gray-400 mb-1">1080p</label>
                                                <input type="url" id="source-1080p" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.sources ? (m.sources['1080p'] || '') : ''}">
                                            </div>
                                            <div>
                                                <label for="source-4k" class="block text-sm font-medium text-gray-400 mb-1">4K</label>
                                                <input type="url" id="source-4k" class="modal-input w-full p-3 rounded-md" placeholder="https://..." value="${m.sources ? (m.sources['4K'] || '') : ''}">
                                            </div>
                                        </div>
                                        
                                        <!-- Embed Code Section -->
                                        <div class="border-t border-gray-700 pt-6">
                                            <h5 class="text-lg font-semibold mb-3 text-white">Embed –∫–æ–¥ orqali / –ò–ª–∏ —á–µ—Ä–µ–∑ Embed –∫–æ–¥</h5>
                                            <p class="text-xs text-gray-400 mb-3">Agar video xostingdan iframe kodni ko'chirsangiz, URL avtomatik ajratib olinadi</p>
                                            <div>
                                                <label for="embed-code-input" class="block text-sm font-medium text-gray-400 mb-1">Embed –∫–æ–¥ (iframe)</label>
                                                <textarea id="embed-code-input" class="modal-input w-full p-3 rounded-md font-mono text-xs" rows="4" placeholder='<iframe src="https://myvidplay.com/e/xyz123" width="600" height="480" allowfullscreen></iframe>'></textarea>
                                                <button type="button" id="parse-embed-btn" class="mt-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-medium py-2 px-4 rounded-md">
                                                    <i class="fas fa-magic mr-2"></i>URL ni ajratib olish
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- URL Upload Tab Content -->
                                    <div id="url-upload-content" class="upload-tab-content hidden">
                                        <div class="bg-gray-800 rounded-lg p-6 border-2 border-dashed border-gray-600">
                                            <!-- Quality Selector -->
                                            <div class="mb-4">
                                                <label class="block text-sm font-medium text-gray-400 mb-2">–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ / Video Quality</label>
                                                <select id="upload-quality-select" class="modal-input w-full md:w-64 p-3 rounded-md">
                                                    <option value="480p">480p - SD</option>
                                                    <option value="720p">720p - HD</option>
                                                    <option value="1080p" selected>1080p - Full HD</option>
                                                    <option value="4K">4K - Ultra HD</option>
                                                </select>
                                            </div>
                                            
                                            <!-- File Input Area -->
                                            <div class="mb-4">
                                                <label for="video-file-input" class="flex flex-col items-center justify-center w-full h-48 cursor-pointer hover:bg-gray-700 rounded-lg transition-all">
                                                    <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                                                        <i class="fas fa-cloud-upload-alt text-5xl text-blue-400 mb-4"></i>
                                                        <p class="mb-2 text-sm text-gray-300">
                                                            <span class="font-semibold">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</span> –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ
                                                        </p>
                                                        <p class="text-xs text-gray-500">MP4, AVI, MKV, MOV (MAX 2GB)</p>
                                                    </div>
                                                    <input id="video-file-input" type="file" class="hidden" accept="video/*">
                                                </label>
                                            </div>
                                            
                                            <!-- Selected File Info -->
                                            <div id="file-info-display" class="hidden mb-4 p-4 bg-gray-700 rounded-lg">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center gap-3">
                                                        <i class="fas fa-file-video text-2xl text-blue-400"></i>
                                                        <div>
                                                            <p id="file-name-display" class="text-sm font-medium text-white"></p>
                                                            <p id="file-size-display" class="text-xs text-gray-400"></p>
                                                        </div>
                                                    </div>
                                                    <button type="button" id="clear-file-btn" class="text-red-400 hover:text-red-300">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Upload Progress -->
                                            <div id="upload-progress-container" class="hidden mb-4">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-sm font-medium text-gray-300">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                                    <span id="upload-percentage" class="text-sm font-bold text-blue-400">0%</span>
                                                </div>
                                                <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                                                    <div id="upload-progress-bar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                                </div>
                                                <p id="upload-status-text" class="text-xs text-gray-400 mt-2">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</p>
                                            </div>
                                            
                                            <!-- Upload Button -->
                                            <button type="button" id="start-upload-btn" class="w-full bg-green-600 hover:bg-green-500 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition-all" disabled>
                                                <i class="fas fa-upload mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                                            </button>
                                            
                                            <!-- Upload Result -->
                                            <div id="upload-result-display" class="hidden mt-4 p-4 rounded-lg">
                                                <div class="flex items-start gap-3">
                                                    <i id="result-icon" class="fas text-xl mt-1"></i>
                                                    <div class="flex-1">
                                                        <p id="result-message" class="text-sm font-medium"></p>
                                                        <p id="result-file-id" class="text-xs mt-1 font-mono"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700/50 rounded-lg">
                                            <p class="text-xs text-blue-300">
                                                <i class="fas fa-info-circle mr-2"></i>
                                                <strong>–í–∞–∂–Ω–æ:</strong> –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001. 
                                                –í–∏–¥–µ–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ Telegram —á–µ—Ä–µ–∑ Bot API.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Episodes section (for series) -->
                                <div id="episodes-section" class="${m.type === 'series' ? '' : 'hidden'}">
                                    <p class="text-sm text-gray-400 mb-4">–°–æ–∑–¥–∞–π—Ç–µ —Å–µ–∑–æ–Ω—ã –∏ –¥–æ–±–∞–≤—å—Ç–µ —ç–ø–∏–∑–æ–¥—ã</p>
                                    <div id="seasons-container" class="space-y-6 mb-4"></div>
                                    <button type="button" id="add-season-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 px-6 rounded-md">
                                        <i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∑–æ–Ω
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Footer with navigation buttons -->
                    <div class="border-t border-gray-700 p-6 bg-gray-800 flex justify-between items-center">
                        <button type="button" id="prev-step-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hidden">
                            <i class="fas fa-arrow-left mr-2"></i>–ù–∞–∑–∞–¥
                        </button>
                        <div class="flex-1"></div>
                        <button type="button" id="next-step-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg">
                            –î–∞–ª–µ–µ <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                        <button type="button" id="save-movie-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg hidden">
                            <i class="fas fa-save mr-2"></i>${isEditing ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}
                        </button>
                    </div>
                </div>
            </div>`;
            document.getElementById('modal-overlay').innerHTML = modalHTML;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            
            // Stepper Navigation
            let currentStep = 1;
            const totalSteps = 5;
            
            function updateStepDisplay() {
                // Hide all steps
                document.querySelectorAll('.step-content').forEach(step => step.classList.add('hidden'));
                // Show current step
                document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('hidden');
                
                // Update navigation buttons
                const prevBtn = document.getElementById('prev-step-btn');
                const nextBtn = document.getElementById('next-step-btn');
                const saveBtn = document.getElementById('save-movie-btn');
                
                if (currentStep === 1) {
                    prevBtn.classList.add('hidden');
                } else {
                    prevBtn.classList.remove('hidden');
                }
                
                if (currentStep === totalSteps) {
                    nextBtn.classList.add('hidden');
                    saveBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                }
                
                // Update sidebar step indicators
                document.querySelectorAll('.step-nav-btn').forEach((btn, idx) => {
                    const step = idx + 1;
                    const indicator = btn.querySelector('.step-indicator');
                    const stepNumber = btn.querySelector('.step-number');
                    const stepCheck = btn.querySelector('.step-check');
                    
                    if (step === currentStep) {
                        btn.classList.add('bg-gray-700');
                        btn.classList.remove('opacity-50');
                    } else if (step < currentStep || window.movieFormData.completedSteps.has(step)) {
                        btn.classList.remove('bg-gray-700', 'opacity-50');
                        stepNumber.classList.add('hidden');
                        stepCheck.classList.remove('hidden');
                        indicator.classList.add('border-green-400', 'bg-green-400/20');
                    } else {
                        btn.classList.remove('bg-gray-700');
                        btn.classList.add('opacity-50');
                    }
                });
            }
            
            function validateStep(step) {
                if (step === 1) {
                    const title = document.getElementById('movie-title').value.trim();
                    const year = document.getElementById('movie-year').value.trim();
                    const genre = document.getElementById('movie-genre').value.trim();
                    const poster = document.getElementById('movie-poster').value.trim();
                    
                    if (!title || !year || !genre || !poster) {
                        showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–æ—Ç–º–µ—á–µ–Ω—ã *)', true);
                        return false;
                    }
                }
                
                if (step === 3) {
                    const selectedRegions = Array.from(document.querySelectorAll('.movie-region-checkbox:checked'));
                    if (selectedRegions.length === 0) {
                        showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–µ–≥–∏–æ–Ω!', true);
                        return false;
                    }
                }
                
                return true;
            }
            
            document.getElementById('next-step-btn').addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    window.movieFormData.completedSteps.add(currentStep);
                    currentStep++;
                    updateStepDisplay();
                }
            });
            
            document.getElementById('prev-step-btn').addEventListener('click', () => {
                currentStep--;
                updateStepDisplay();
            });
            
            document.querySelectorAll('.step-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetStep = parseInt(btn.dataset.step);
                    if (targetStep <= currentStep || window.movieFormData.completedSteps.has(targetStep - 1)) {
                        currentStep = targetStep;
                        updateStepDisplay();
                    }
                });
            });
            
            document.getElementById('save-movie-btn').addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    saveMovie();
                }
            });
            
            updateStepDisplay();

            // Cast Management
            const castContainer = document.getElementById('cast-container');
            const addCastBtn = document.getElementById('add-cast-btn');
            
            function addCastMember(castData = {}) {
                const castIndex = castContainer.children.length;
                const castBlock = document.createElement('div');
                castBlock.className = 'cast-block bg-gray-800 p-5 rounded-lg border border-gray-700';
                castBlock.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h5 class="font-bold text-white text-lg">–ê–∫—Ç—ë—Ä ${castIndex + 1}</h5>
                        <button type="button" class="remove-cast-btn text-red-500 hover:text-red-400 text-xl">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–ò–º—è –∞–∫—Ç—ë—Ä–∞ *</label>
                            <input type="text" class="cast-name modal-input w-full p-3 rounded-md" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" value="${castData.name || ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–†–æ–ª—å –≤ —Ñ–∏–ª—å–º–µ</label>
                            <input type="text" class="cast-character modal-input w-full p-3 rounded-md" placeholder="–ì–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π" value="${castData.character || ''}">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-400 mb-1">URL —Ñ–æ—Ç–æ</label>
                            <input type="url" class="cast-image modal-input w-full p-3 rounded-md" placeholder="https://..." value="${castData.image || ''}">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-400 mb-1">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</label>
                            <textarea class="cast-bio modal-input w-full p-3 rounded-md" rows="3" placeholder="–ö—Ä–∞—Ç–∫–∞—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –∞–∫—Ç—ë—Ä–∞...">${castData.bio || ''}</textarea>
                        </div>
                        <div class="md:col-span-2 bg-gray-900/60 p-4 rounded-lg">
                            <h6 class="text-sm font-semibold text-gray-300 mb-3">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</h6>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1"><i class="fab fa-instagram mr-1"></i> Instagram</label>
                                    <input type="url" class="cast-instagram modal-input w-full p-2 rounded-md text-sm" placeholder="https://instagram.com/..." value="${castData.social?.instagram || ''}">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1"><i class="fab fa-facebook mr-1"></i> Facebook</label>
                                    <input type="url" class="cast-facebook modal-input w-full p-2 rounded-md text-sm" placeholder="https://facebook.com/..." value="${castData.social?.facebook || ''}">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1"><i class="fab fa-twitter mr-1"></i> Twitter</label>
                                    <input type="url" class="cast-twitter modal-input w-full p-2 rounded-md text-sm" placeholder="https://twitter.com/..." value="${castData.social?.twitter || ''}">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1"><i class="fab fa-wikipedia-w mr-1"></i> Wikipedia</label>
                                    <input type="url" class="cast-wikipedia modal-input w-full p-2 rounded-md text-sm" placeholder="https://wikipedia.org/..." value="${castData.social?.wikipedia || ''}">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                castBlock.querySelector('.remove-cast-btn').addEventListener('click', () => {
                    castBlock.remove();
                    updateCastTitles();
                });
                
                castContainer.appendChild(castBlock);
                updateCastTitles();
            }
            
            function updateCastTitles() {
                const castBlocks = castContainer.querySelectorAll('.cast-block');
                castBlocks.forEach((block, idx) => {
                    const titleEl = block.querySelector('h5');
                    if (titleEl) {
                        titleEl.textContent = `Aktyor ${idx + 1}`;
                    }
                });
            }
            
            addCastBtn.addEventListener('click', () => addCastMember());
            
            // Load existing cast data
            if (Array.isArray(m.cast) && m.cast.length > 0) {
                m.cast.forEach(castMember => {
                    if (typeof castMember === 'object') {
                        addCastMember(castMember);
                    } else if (typeof castMember === 'string') {
                        addCastMember({ name: castMember, character: '', image: '' });
                    }
                });
            }

            // Episode management for series
            const typeSelect = document.getElementById('movie-type');
            const singleSourcesSection = document.getElementById('single-sources-section');
            const episodesSection = document.getElementById('episodes-section');
            const seasonsContainer = document.getElementById('seasons-container');
            const addSeasonBtn = document.getElementById('add-season-btn');
            const primaryCategorySelect = document.getElementById('movie-primary-category');
            const sportCategoryWrapper = document.getElementById('sport-category-wrapper');
            primaryCategorySelect?.addEventListener('change', () => {
                if (primaryCategorySelect.value === 'sports') {
                    sportCategoryWrapper?.classList.remove('hidden');
                } else {
                    sportCategoryWrapper?.classList.add('hidden');
                }
            });
            // Toggle source and episode sections based on the selected type
            function ensureAtLeastOneSeason() {
                if (!seasonsContainer) return;
                if (seasonsContainer.children.length === 0) {
                    addSeasonBlock();
                }
            }

            typeSelect.addEventListener('change', () => {
                if (typeSelect.value === 'series') {
                    singleSourcesSection?.classList.add('hidden');
                    episodesSection?.classList.remove('hidden');
                    ensureAtLeastOneSeason();
                } else {
                    singleSourcesSection?.classList.remove('hidden');
                    episodesSection?.classList.add('hidden');
                }
            });

            function updateSeasonTitles() {
                if (!seasonsContainer) return;
                const seasonBlocks = seasonsContainer.querySelectorAll('.season-block');
                seasonBlocks.forEach((block, idx) => {
                    const seasonTitleEl = block.querySelector('.season-title');
                    if (!seasonTitleEl) return;
                    const numberInput = block.querySelector('.season-number-input');
                    const nameInput = block.querySelector('.season-name-input');
                    const parsedNumber = parseInt(numberInput?.value, 10);
                    const fallbackNumber = idx + 1;
                    const labelNumber = !isNaN(parsedNumber) && parsedNumber > 0 ? parsedNumber : fallbackNumber;
                    const nameValue = nameInput?.value.trim();
                    seasonTitleEl.textContent = nameValue ? `–°–µ–∑–æ–Ω ${labelNumber} ‚Äî ${nameValue}` : `–°–µ–∑–æ–Ω ${labelNumber}`;
                });
            }

            function updateEpisodeTitles(seasonBlock) {
                const episodes = seasonBlock.querySelectorAll('.episode-block');
                episodes.forEach((block, idx) => {
                    const titleEl = block.querySelector('.episode-title');
                    if (titleEl) {
                        titleEl.textContent = `–≠–ø–∏–∑–æ–¥ ${idx + 1}`;
                    }
                });
            }

            function addEpisodeBlock(seasonBlock, initialValues = {}) {
                const episodesWrapper = seasonBlock.querySelector('.season-episodes');
                if (!episodesWrapper) return;
                const block = document.createElement('div');
                block.className = 'episode-block bg-gray-700 p-4 rounded-md relative';
                const initialTitle = initialValues.title || initialValues.name || initialValues.episodeTitle || '';
                const initialNumber = initialValues.episodeNumber || initialValues.number || initialValues.ep || '';
                const initialDuration = initialValues.durationMinutes || initialValues.duration || initialValues.length || '';
                const initialThumbnail = initialValues.thumbnail || initialValues.thumb || initialValues.image || initialValues.still || initialValues.poster || initialValues.cover || initialValues.artwork || initialValues.img || initialValues.imgUrl || initialValues.imageUrl || '';
                const sources = initialValues.sources || {};
                block.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h6 class="episode-title font-semibold">–≠–ø–∏–∑–æ–¥ ${episodesWrapper.children.length + 1}</h6>
                        <button type="button" class="remove-episode-btn text-red-400 hover:text-red-200 text-xl leading-none">&times;</button>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ø–∏–∑–æ–¥–∞</label>
                            <input type="text" class="episode-title-input modal-input w-full p-2 rounded-md" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –§–∏–Ω–∞–ª" value="${initialTitle || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–ù–æ–º–µ—Ä —ç–ø–∏–∑–æ–¥–∞</label>
                            <input type="number" min="1" class="episode-number-input modal-input w-full p-2 rounded-md" placeholder="1" value="${initialNumber || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
                            <input type="number" min="1" class="episode-duration-input modal-input w-full p-2 rounded-md" placeholder="45" value="${initialDuration || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (URL)</label>
                            <input type="url" class="episode-thumbnail-input modal-input w-full p-2 rounded-md" placeholder="https://..." value="${initialThumbnail || ''}">
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">480p</label><input type="url" class="ep-source-480p modal-input w-full p-2 rounded-md" placeholder="https://..." value="${sources['480p'] || ''}"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">720p</label><input type="url" class="ep-source-720p modal-input w-full p-2 rounded-md" placeholder="https://..." value="${sources['720p'] || ''}"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">1080p</label><input type="url" class="ep-source-1080p modal-input w-full p-2 rounded-md" placeholder="https://..." value="${sources['1080p'] || ''}"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">4K</label><input type="url" class="ep-source-4k modal-input w-full p-2 rounded-md" placeholder="https://..." value="${sources['4K'] || ''}"></div>
                    </div>
                `;
                episodesWrapper.appendChild(block);
                block.querySelector('.remove-episode-btn')?.addEventListener('click', () => {
                    block.remove();
                    updateEpisodeTitles(seasonBlock);
                });
                updateEpisodeTitles(seasonBlock);
            }

            function addSeasonBlock(initialValues = {}) {
                if (!seasonsContainer) return;
                const block = document.createElement('div');
                block.className = 'season-block bg-gray-800 border border-gray-700 rounded-lg p-4';
                const resolvedNumber = initialValues.number ?? initialValues.seasonNumber ?? null;
                const resolvedName = initialValues.name ?? initialValues.seasonName ?? initialValues.originalName ?? initialValues.seasonTitle ?? '';
                const resolvedStart = initialValues.startEpisodeNumber ?? initialValues.seasonEpisodeStart ?? initialValues.seasonEpisodeOffset ?? initialValues.seasonStartEpisode ?? '';
                block.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h5 class="season-title text-lg font-semibold">–°–µ–∑–æ–Ω ${seasonsContainer.children.length + 1}</h5>
                            <p class="text-xs text-gray-400 mt-1">–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞, –∞ —Ç–∞–∫–∂–µ —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Å–µ—Ä–∏—é, –µ—Å–ª–∏ —Å–µ–∑–æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –Ω—É–º–µ—Ä–∞—Ü–∏—é.</p>
                        </div>
                        <button type="button" class="remove-season-btn text-red-400 hover:text-red-200 text-2xl leading-none">&times;</button>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–ù–æ–º–µ—Ä —Å–µ–∑–æ–Ω–∞</label>
                            <input type="number" min="1" class="season-number-input modal-input w-full p-2 rounded-md" placeholder="1" value="${resolvedNumber ?? ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞</label>
                            <input type="text" class="season-name-input modal-input w-full p-2 rounded-md" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ù–æ–≤—ã–π –≥–æ–¥" value="${resolvedName || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">–ù—É–º–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å</label>
                            <input type="number" min="1" class="season-start-input modal-input w-full p-2 rounded-md" placeholder="1" value="${resolvedStart || ''}">
                        </div>
                    </div>
                    <div class="season-episodes space-y-4"></div>
                    <button type="button" class="add-season-episode-btn bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-4 rounded-md mt-4">–î–æ–±–∞–≤–∏—Ç—å —ç–ø–∏–∑–æ–¥</button>
                `;
                seasonsContainer.appendChild(block);

                const removeBtn = block.querySelector('.remove-season-btn');
                removeBtn?.addEventListener('click', () => {
                    block.remove();
                    updateSeasonTitles();
                    ensureAtLeastOneSeason();
                });

                const numberInput = block.querySelector('.season-number-input');
                const nameInput = block.querySelector('.season-name-input');
                [numberInput, nameInput].forEach(input => {
                    input?.addEventListener('input', () => updateSeasonTitles());
                });

                const addEpisodeBtn = block.querySelector('.add-season-episode-btn');
                addEpisodeBtn?.addEventListener('click', () => addEpisodeBlock(block));

                const resolvedEpisodes = Array.isArray(initialValues.episodes) ? initialValues.episodes : [];
                if (resolvedEpisodes.length > 0) {
                    resolvedEpisodes.forEach(ep => addEpisodeBlock(block, ep));
                } else {
                    addEpisodeBlock(block);
                }

                updateSeasonTitles();
            }

            addSeasonBtn?.addEventListener('click', () => addSeasonBlock());

            // Embed code parser
            const parseEmbedBtn = document.getElementById('parse-embed-btn');
            const embedCodeInput = document.getElementById('embed-code-input');
            
            if (parseEmbedBtn && embedCodeInput) {
                parseEmbedBtn.addEventListener('click', () => {
                    const embedCode = embedCodeInput.value.trim();
                    if (!embedCode) {
                        showToast('Embed kodni kiriting', true);
                        return;
                    }
                    
                    // Extract URL from iframe src
                    const srcMatch = embedCode.match(/src=["']([^"']+)["']/);
                    if (srcMatch && srcMatch[1]) {
                        const extractedUrl = srcMatch[1];
                        // Put URL in 720p field by default
                        const source720p = document.getElementById('source-720p');
                        if (source720p) {
                            source720p.value = extractedUrl;
                            showToast('URL ajratib olindi va 720p maydoniga joylandi!');
                            embedCodeInput.value = '';
                        }
                    } else {
                        showToast('Iframe src topilmadi. To\'g\'ri iframe kodni kiriting.', true);
                    }
                });
            }
            
            // Upload Tab Switching Logic
            const tabUrlUpload = document.getElementById('tab-url-upload');
            const tabDeviceUpload = document.getElementById('tab-device-upload');
            const urlUploadContent = document.getElementById('url-upload-content');
            const deviceUploadContent = document.getElementById('device-upload-content');
            
            function switchUploadTab(tabName) {
                if (tabName === 'url') {
                    tabUrlUpload?.classList.add('active');
                    tabDeviceUpload?.classList.remove('active');
                    urlUploadContent?.classList.remove('hidden');
                    deviceUploadContent?.classList.add('hidden');
                } else if (tabName === 'device') {
                    tabUrlUpload?.classList.remove('active');
                    tabDeviceUpload?.classList.add('active');
                    urlUploadContent?.classList.add('hidden');
                    deviceUploadContent?.classList.remove('hidden');
                }
            }
            
            tabUrlUpload?.addEventListener('click', () => switchUploadTab('url'));
            tabDeviceUpload?.addEventListener('click', () => switchUploadTab('device'));
            
            // Clear uploaded file when switching to URL tab or entering URL manually
            function clearUploadedFileData() {
                selectedVideoFile = null;
                uploadedFileData = null;
                if (videoFileInput) videoFileInput.value = '';
                fileInfoDisplay?.classList.add('hidden');
                startUploadBtn.disabled = true;
                uploadProgressContainer?.classList.add('hidden');
                uploadResultDisplay?.classList.add('hidden');
            }
            
            // Clear URL fields when file is uploaded successfully
            function clearUrlFields() {
                const urlFields = ['source-480p', 'source-720p', 'source-1080p', 'source-4k'];
                urlFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value && !field.value.includes('BAACAgIAA')) {
                        // Only clear if it's not a file_id (preserve uploaded file IDs)
                        // Actually, clear all except the one we just populated
                        if (!field.hasAttribute('data-just-uploaded')) {
                            field.value = '';
                        }
                    }
                });
            }
            
            // Listen to URL field changes
            ['source-480p', 'source-720p', 'source-1080p', 'source-4k'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field?.addEventListener('input', () => {
                    if (field.value.trim()) {
                        clearUploadedFileData();
                    }
                });
            });
            
            // Device Upload Logic
            const videoFileInput = document.getElementById('video-file-input');
            const fileInfoDisplay = document.getElementById('file-info-display');
            const fileNameDisplay = document.getElementById('file-name-display');
            const fileSizeDisplay = document.getElementById('file-size-display');
            const clearFileBtn = document.getElementById('clear-file-btn');
            const startUploadBtn = document.getElementById('start-upload-btn');
            const uploadProgressContainer = document.getElementById('upload-progress-container');
            const uploadProgressBar = document.getElementById('upload-progress-bar');
            const uploadPercentage = document.getElementById('upload-percentage');
            const uploadStatusText = document.getElementById('upload-status-text');
            const uploadResultDisplay = document.getElementById('upload-result-display');
            const uploadQualitySelect = document.getElementById('upload-quality-select');
            
            let selectedVideoFile = null;
            let uploadedFileData = null;
            
            // Handle file selection
            videoFileInput?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Clear previous upload data if exists
                    uploadedFileData = null;
                    uploadResultDisplay?.classList.add('hidden');
                    
                    selectedVideoFile = file;
                    
                    // Display file info
                    fileNameDisplay.textContent = file.name;
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                    fileSizeDisplay.textContent = `${fileSizeMB} MB`;
                    
                    fileInfoDisplay.classList.remove('hidden');
                    startUploadBtn.disabled = false;
                }
            });
            
            // Clear selected file
            clearFileBtn?.addEventListener('click', () => {
                selectedVideoFile = null;
                uploadedFileData = null;
                videoFileInput.value = '';
                fileInfoDisplay.classList.add('hidden');
                startUploadBtn.disabled = true;
                uploadProgressContainer.classList.add('hidden');
                uploadResultDisplay.classList.add('hidden');
            });
            
            // Start upload to backend
            startUploadBtn?.addEventListener('click', async () => {
                if (!selectedVideoFile) {
                    showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª', true);
                    return;
                }
                
                const movieTitle = document.getElementById('movie-title')?.value || 'Untitled';
                const selectedQuality = uploadQualitySelect?.value || '1080p';
                
                // Show progress
                uploadProgressContainer.classList.remove('hidden');
                uploadResultDisplay.classList.add('hidden');
                startUploadBtn.disabled = true;
                
                // Create FormData
                const formData = new FormData();
                formData.append('video', selectedVideoFile);
                formData.append('title', movieTitle);
                formData.append('uploadedBy', currentUserData?.uid || 'unknown');
                formData.append('userRole', currentUserRole || 'unknown');
                formData.append('quality', selectedQuality);
                
                try {
                    uploadStatusText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Telegram —Å–µ—Ä–≤–µ—Ä...';
                    
                    // Upload to backend
                    const xhr = new XMLHttpRequest();
                    
                    // Track upload progress
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = Math.round((e.loaded / e.total) * 100);
                            uploadProgressBar.style.width = percentComplete + '%';
                            uploadPercentage.textContent = percentComplete + '%';
                            
                            const uploadedMB = (e.loaded / 1024 / 1024).toFixed(2);
                            const totalMB = (e.total / 1024 / 1024).toFixed(2);
                            uploadStatusText.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${uploadedMB} MB –∏–∑ ${totalMB} MB`;
                        }
                    });
                    
                    // Handle completion
                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            
                            if (response.success) {
                                uploadedFileData = response.data;
                                
                                // Clear other URL fields before populating
                                clearUrlFields();
                                
                                // Show success
                                uploadResultDisplay.classList.remove('hidden');
                                uploadResultDisplay.className = 'mt-4 p-4 rounded-lg bg-green-900/30 border border-green-700';
                                document.getElementById('result-icon').className = 'fas fa-check-circle text-green-400 text-xl mt-1';
                                document.getElementById('result-message').textContent = '–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!';
                                document.getElementById('result-file-id').textContent = `File ID: ${response.data.file_id}`;
                                
                                // Auto-fill the video URL in the appropriate quality field
                                const qualityFieldId = `source-${selectedQuality.toLowerCase()}`;
                                const qualityField = document.getElementById(qualityFieldId);
                                if (qualityField) {
                                    qualityField.value = response.data.file_id; // Use file_id directly
                                    qualityField.setAttribute('data-just-uploaded', 'true');
                                    setTimeout(() => qualityField.removeAttribute('data-just-uploaded'), 1000);
                                }
                                
                                showToast('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! File ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
                                
                                // Reset upload button
                                setTimeout(() => {
                                    startUploadBtn.disabled = false;
                                }, 2000);
                            } else {
                                throw new Error(response.message || 'Upload failed');
                            }
                        } else {
                            throw new Error(`HTTP ${xhr.status}: ${xhr.statusText}`);
                        }
                    });
                    
                    // Handle errors
                    xhr.addEventListener('error', () => {
                        uploadResultDisplay.classList.remove('hidden');
                        uploadResultDisplay.className = 'mt-4 p-4 rounded-lg bg-red-900/30 border border-red-700';
                        document.getElementById('result-icon').className = 'fas fa-exclamation-circle text-red-400 text-xl mt-1';
                        document.getElementById('result-message').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.';
                        document.getElementById('result-file-id').textContent = '–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001';
                        
                        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä', true);
                        startUploadBtn.disabled = false;
                    });
                    
                    // Send request - Auto-detect environment
                    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    const API_URL = isLocalhost 
                        ? 'http://localhost:3001/api/upload-to-telegram'
                        : 'https://snd-0hlf.onrender.com/api/upload-to-telegram';
                    xhr.open('POST', API_URL, true);
                    xhr.send(formData);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    
                    uploadResultDisplay.classList.remove('hidden');
                    uploadResultDisplay.className = 'mt-4 p-4 rounded-lg bg-red-900/30 border border-red-700';
                    document.getElementById('result-icon').className = 'fas fa-exclamation-circle text-red-400 text-xl mt-1';
                    document.getElementById('result-message').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                    document.getElementById('result-file-id').textContent = '';
                    
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, true);
                    startUploadBtn.disabled = false;
                }
            });

            function populateExistingSeriesStructure() {
                if (!seasonsContainer) return;
                seasonsContainer.innerHTML = '';
                if (m && Array.isArray(m.episodes) && m.type === 'series' && m.episodes.length > 0) {
                    const seasonGroups = new Map();
                    m.episodes.forEach(ep => {
                        const number = ep.seasonNumber ?? ep.season ?? ep.seasonNo ?? null;
                        const name = ep.seasonName ?? ep.seasonTitle ?? ep.season_label ?? ep.seasonLabel ?? '';
                        const key = number != null ? `num:${number}` : (name ? `name:${name}` : 'default');
                        if (!seasonGroups.has(key)) {
                            seasonGroups.set(key, {
                                seasonNumber: number,
                                seasonName: name,
                                episodes: [],
                                seasonEpisodeStart: ep.seasonEpisodeStart ?? ep.seasonEpisodeOffset ?? ep.seasonStartEpisode ?? ep.startEpisodeNumber ?? null
                            });
                        }
                        const group = seasonGroups.get(key);
                        if (!group.seasonEpisodeStart) {
                            const startOverride = ep.seasonEpisodeStart ?? ep.seasonEpisodeOffset ?? ep.seasonStartEpisode ?? ep.startEpisodeNumber;
                            if (startOverride) {
                                group.seasonEpisodeStart = startOverride;
                            }
                        }
                        group.episodes.push(ep);
                    });
                    seasonGroups.forEach(group => addSeasonBlock(group));
                } else {
                    ensureAtLeastOneSeason();
                }
            }

            populateExistingSeriesStructure();
        }

        function openConfirmationModal(title, message, onConfirm, actionTextKey = "delete") {
            const modalHTML = `
            <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
                <h3 class="text-xl font-bold mb-4">${title}</h3>
                <p class="text-gray-400 mb-6">${message}</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg"><span data-lang-key="cancel"></span></button>
                    <button id="confirm-action-btn" class="action-btn text-white font-bold py-2 px-6 rounded-lg"><span data-lang-key="${actionTextKey}"></span></button>
                </div>
            </div>`;
            document.getElementById('modal-overlay').innerHTML = modalHTML;
            setDashboardLanguage(currentDashboardLanguage);
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('confirm-cancel-btn').addEventListener('click', closeModal);
            document.getElementById('confirm-action-btn').addEventListener('click', () => { onConfirm(); closeModal(); });
        }

        function openPremiumModal(user) {
            const tariffs = ["1 –ú–µ—Å—è—Ü", "3 –ú–µ—Å—è—Ü–∞", "7 –ú–µ—Å—è—Ü–µ–≤", "12 –ú–µ—Å—è—Ü–µ–≤"];
            const tariffOptions = tariffs.map(t => `<option value="${t}" ${user.tariff === t ? 'selected' : ''}>${t}</option>`).join('');

            const modalHTML = `
            <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative">
                <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
                <h3 class="text-2xl font-bold mb-6" data-lang-key="editPremium"></h3>
                <form id="premium-form">
                    <div class="mb-4 flex items-center justify-between">
                        <label for="premium-toggle-modal" class="text-lg font-medium text-gray-300" data-lang-key="premiumStatus"></label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="premium-toggle-modal" class="sr-only peer" ${user.isPremium ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    <div id="tariff-selection" class="${user.isPremium ? '' : 'hidden'}">
                        <label for="tariff-select" class="block text-sm font-medium text-gray-400 mb-2" data-lang-key="selectTariff"></label>
                        <select id="tariff-select" class="modal-input w-full p-2 rounded-md">
                            ${tariffOptions}
                        </select>
                    </div>
                    <button type="submit" class="action-btn w-full text-white font-bold py-3 px-6 rounded-lg mt-8">
                        <span data-lang-key="save"></span>
                    </button>
                </form>
            </div>`;
            document.getElementById('modal-overlay').innerHTML = modalHTML;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            
            const premiumToggle = document.getElementById('premium-toggle-modal');
            const tariffSelection = document.getElementById('tariff-selection');
            premiumToggle.addEventListener('change', () => {
                tariffSelection.classList.toggle('hidden', !premiumToggle.checked);
            });

            document.getElementById('premium-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const isPremium = premiumToggle.checked;
                const tariff = document.getElementById('tariff-select').value;
                updatePremiumAndTariff(user.uid, isPremium, tariff);
            });
            setDashboardLanguage(currentDashboardLanguage);
        }

        function openPartnerModal() {
            const selectableCategories = PARTNER_CATEGORY_OPTIONS.filter(opt => !opt.adminOnly);
            const categoryCheckboxes = selectableCategories.map(opt => `
                <label class="flex items-center gap-2 text-sm text-gray-300">
                    <input type="checkbox" class="partner-category-checkbox h-4 w-4 text-red-500" value="${opt.value}">
                    <span>${opt.label}</span>
                </label>`).join('');
            
            // Hudud tanlash uchun checkbox'lar
            const regionCheckboxes = centralAsiaRegions.map(r => `
                <label class="flex items-center gap-2 text-sm text-gray-300">
                    <input type="checkbox" class="partner-region-checkbox h-4 w-4 text-blue-500" value="${r.code}">
                    <span>${r.flag} ${r.name}</span>
                </label>`).join('');
            
            const modalHTML = `
            <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative max-h-[90vh] overflow-y-auto">
                <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
                <h3 class="text-2xl font-bold mb-6" data-lang-key="addPartner"></h3>
                <form id="partner-form">
                    <div class="space-y-4">
                        <input type="text" id="partner-name" class="modal-input w-full p-2 rounded-md" placeholder="–ò–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞" required>
                        <input type="email" id="partner-email" class="modal-input w-full p-2 rounded-md" placeholder="Email" required>
                        <input type="password" id="partner-password" class="modal-input w-full p-2 rounded-md" placeholder="–ü–∞—Ä–æ–ª—å" required>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-200" data-lang-key="partnerCategoriesLabel"></span>
                                <span class="text-xs text-gray-500" data-lang-key="partnerCategoryHint"></span>
                            </div>
                            <div class="flex flex-wrap gap-3 bg-gray-900/60 p-3 rounded-lg">
                                ${categoryCheckboxes}
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-200">Hududlar / –†–µ–≥–∏–æ–Ω—ã</span>
                                <span class="text-xs text-gray-500">Kontent qaysi hududlarda ko'rinadi</span>
                            </div>
                            <div class="flex flex-wrap gap-3 bg-gray-900/60 p-3 rounded-lg">
                                ${regionCheckboxes}
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="action-btn w-full text-white font-bold py-3 px-6 rounded-lg mt-8">
                        <span data-lang-key="addPartner"></span>
                    </button>
                </form>
            </div>`;
            document.getElementById('modal-overlay').innerHTML = modalHTML;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('partner-form').addEventListener('submit', (e) => {
                e.preventDefault();
                savePartner();
            });
            setDashboardLanguage(currentDashboardLanguage);
        }
        
        async function savePartner() {
            const name = document.getElementById('partner-name').value;
            const email = document.getElementById('partner-email').value;
            const password = document.getElementById('partner-password').value; 
            const allowedCategories = Array.from(document.querySelectorAll('.partner-category-checkbox:checked')).map(input => input.value);
            const allowedRegions = Array.from(document.querySelectorAll('.partner-region-checkbox:checked')).map(input => input.value);

            if (!name || !email || !password) {
                showToast("Iltimos, barcha maydonlarni to'ldiring.", true);
                return;
            }
            if (allowedCategories.length === 0) {
                showToast(dashboardTranslations[currentDashboardLanguage]?.partnerCategoryRequired || 'Please select at least one category.', true);
                return;
            }
            if (allowedRegions.length === 0) {
                showToast("Kamida bitta hududni tanlang / –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω —Ä–µ–≥–∏–æ–Ω", true);
                return;
            }

            loadingOverlay.classList.remove('hidden');
            
            const tempAppName = 'temp-auth-app-' + Date.now();
            const tempApp = initializeApp(firebaseConfig, tempAppName);
            const tempAuth = getAuth(tempApp);

            try {
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                const newPartnerUser = userCredential.user;

                await setDoc(doc(db, "users", newPartnerUser.uid), {
                    uid: newPartnerUser.uid,
                    displayName: name,
                    email: email,
                    password: password,
                    role: 'partner',
                    allowedCategories,
                    allowedRegions,
                    createdAt: new Date().toISOString(),
                });

                showToast(dashboardTranslations[currentDashboardLanguage].partnerCreatedSuccess);
                closeModal();

            } catch (error) {
                console.error("Hamkor yaratishda xatolik:", error);
                let errorMessage = "Hamkor yaratishda xatolik.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Bu email allaqachon ro'yxatdan o'tgan.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Parol juda oddiy. Kamida 6 ta belgidan iborat bo'lishi kerak.";
                }
                showToast(errorMessage, true);
            } finally {
                try { await signOut(tempAuth); } catch (_) {}
                try {
                    const { deleteApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                    await deleteApp(tempApp);
                } catch (_) {}
                loadingOverlay.classList.add('hidden');
            }
        }

        async function showPartnerDetails(partnerId) {
            document.getElementById('partner-list-view').classList.add('hidden');
            const detailsView = document.getElementById('partner-details-view');
            detailsView.classList.remove('hidden');
            detailsView.innerHTML = `
                <div class="flex items-center justify-center h-96">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-white text-5xl mb-4"></i>
                        <p class="text-gray-400">Yuklanmoqda...</p>
                    </div>
                </div>`;

            const partner = partners.find(p => p.uid === partnerId);
            if (!partner) {
                detailsView.innerHTML = `
                    <div class="bg-red-900/20 border border-red-500/50 rounded-xl p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
                        <p class="text-red-400 text-xl font-bold" data-lang-key="userNotFound">Hamkor topilmadi</p>
                    </div>`;
                setDashboardLanguage(currentDashboardLanguage);
                return;
            }

            const partnerMovies = movies.filter(m => m.partnerId === partnerId);
            const totalViews = partnerMovies.reduce((acc, m) => acc + (m.views || 0), 0);
            const totalRevenue = partnerMovies.reduce((acc, m) => acc + ((m.views || 0) * (settings.royaltyPerView || 0.05)), 0);
            const avgRating = partnerMovies.length > 0 
                ? (partnerMovies.reduce((acc, m) => acc + (m.rating || 0), 0) / partnerMovies.length).toFixed(1)
                : 0;
            
            const moviesHtml = partnerMovies.length > 0
                ? partnerMovies.map(m => `
                    <div class="bg-gray-700/50 p-4 rounded-lg hover:bg-gray-700 transition-all border border-gray-600/30">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="text-white font-bold text-sm">${m.title}</h4>
                                <p class="text-gray-400 text-xs mt-1">${m.year || 'N/A'} ‚Ä¢ ${m.primaryCategory || 'general'}</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center gap-1">
                                    <i class="fas fa-star text-yellow-400 text-xs"></i>
                                    <span class="text-white text-sm font-semibold">${(m.rating || 0).toFixed(1)}</span>
                                </div>
                                <p class="text-gray-400 text-xs mt-1"><i class="fas fa-eye"></i> ${(m.views || 0).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `).join('')
                : `<div class="bg-gray-700/30 border-2 border-dashed border-gray-600 rounded-xl p-8 text-center">
                    <i class="fas fa-film text-gray-500 text-4xl mb-3"></i>
                    <p class="text-gray-400">Bu hamkor tomonidan hali film yuklanmagan.</p>
                  </div>`;

            const paymentsRef = collection(db, "paymentHistory");
            const q = query(paymentsRef, where("partnerId", "==", partnerId));
            const paymentSnapshot = await getDocs(q);
            const partnerPayments = paymentSnapshot.docs.map(doc => doc.data());

            const paymentsHtml = partnerPayments.length > 0 ? partnerPayments.map(p => `
                <div class="bg-gray-700/30 p-4 rounded-lg hover:bg-gray-700/50 transition-all">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-green-400"></i>
                            </div>
                            <div>
                                <p class="text-white font-semibold">${p.amount} ${p.currency || 'USD'}</p>
                                <p class="text-gray-400 text-sm">${p.date?.toDate ? new Date(p.date.toDate()).toLocaleDateString('uz-UZ') : 'N/A'}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 bg-green-500/20 text-green-400 text-xs font-bold rounded-full capitalize">
                            ${p.status || 'Tugallangan'}
                        </span>
                    </div>
                </div>
            `).join('') : `
                <div class="bg-gray-700/30 border-2 border-dashed border-gray-600 rounded-xl p-8 text-center">
                    <i class="fas fa-wallet text-gray-500 text-4xl mb-3"></i>
                    <p class="text-gray-400" data-lang-key="noPaymentHistory">To'lov tarixi mavjud emas</p>
                </div>`;

            const registrationDate = partner.createdAt?.seconds 
                ? new Date(partner.createdAt.seconds * 1000).toLocaleDateString('uz-UZ')
                : 'N/A';
            
            const categoriesHtml = Array.isArray(partner.allowedCategories) && partner.allowedCategories.length > 0 
                ? partner.allowedCategories.map(val => {
                    const option = PARTNER_CATEGORY_OPTIONS.find(opt => opt.value === val);
                    const label = option ? option.label : val;
                    return `<span class="px-3 py-1.5 bg-blue-500/20 text-blue-300 text-sm rounded-lg border border-blue-500/30 font-semibold">${label}</span>`;
                }).join(' ')
                : '<span class="text-gray-500">-</span>';

            detailsView.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-gradient-to-r from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <div class="flex items-center gap-4">
                            <button id="back-to-partners-btn" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-lg transition-all">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div>
                                <h2 class="text-3xl font-black text-white flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                        ${(partner.displayName || 'P').charAt(0).toUpperCase()}
                                    </div>
                                    ${partner.displayName || 'N/A'}
                                </h2>
                                <p class="text-gray-400 text-sm mt-1">Hamkor profili</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            ${partner.suspended 
                                ? '<span class="px-4 py-2 bg-red-500/20 text-red-400 font-bold rounded-lg border border-red-500/50"><i class="fas fa-ban mr-2"></i>To\'xtatilgan</span>'
                                : '<span class="px-4 py-2 bg-green-500/20 text-green-400 font-bold rounded-lg border border-green-500/50"><i class="fas fa-check-circle mr-2"></i>Faol</span>'}
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-5 rounded-xl shadow-lg border border-purple-600/30">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-200 text-xs font-semibold uppercase mb-1">Kontent</p>
                                    <p class="text-3xl font-black text-white">${partnerMovies.length}</p>
                                </div>
                                <i class="fas fa-film text-3xl text-purple-300/50"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-5 rounded-xl shadow-lg border border-blue-600/30">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-200 text-xs font-semibold uppercase mb-1">Ko'rishlar</p>
                                    <p class="text-3xl font-black text-white">${totalViews.toLocaleString()}</p>
                                </div>
                                <i class="fas fa-eye text-3xl text-blue-300/50"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-5 rounded-xl shadow-lg border border-yellow-600/30">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-yellow-200 text-xs font-semibold uppercase mb-1">O'rtacha Reyting</p>
                                    <p class="text-3xl font-black text-white">${avgRating} <i class="fas fa-star text-xl"></i></p>
                                </div>
                                <i class="fas fa-star-half-alt text-3xl text-yellow-300/50"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-900 to-green-700 p-5 rounded-xl shadow-lg border border-green-600/30">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-200 text-xs font-semibold uppercase mb-1">Daromad</p>
                                    <p class="text-3xl font-black text-white">$${totalRevenue.toFixed(0)}</p>
                                </div>
                                <i class="fas fa-dollar-sign text-3xl text-green-300/50"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Partner Information -->
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fas fa-user-circle text-green-400"></i>
                                Hamkor Ma'lumotlari
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-start gap-3 pb-3 border-b border-gray-700">
                                    <i class="fas fa-user text-gray-400 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-gray-400 text-xs uppercase">Ism</p>
                                        <p class="text-white font-semibold">${partner.displayName || 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3 pb-3 border-b border-gray-700">
                                    <i class="fas fa-envelope text-gray-400 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-gray-400 text-xs uppercase">Email</p>
                                        <p class="text-white font-semibold">${partner.email}</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3 pb-3 border-b border-gray-700">
                                    <i class="fas fa-tags text-gray-400 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-gray-400 text-xs uppercase mb-2">Kategoriyalar</p>
                                        <div class="flex flex-wrap gap-2">${categoriesHtml}</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3 pb-3 border-b border-gray-700">
                                    <i class="fas fa-calendar text-gray-400 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-gray-400 text-xs uppercase">Ro'yxatdan o'tgan</p>
                                        <p class="text-white font-semibold">${registrationDate}</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3 pb-3 border-b border-gray-700">
                                    <i class="fas fa-id-card text-gray-400 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-gray-400 text-xs uppercase">Tayinlangan ID</p>
                                        <p class="text-blue-400 font-mono font-bold text-lg">${partner.customId || 'Tayinlanmagan'}</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-fingerprint text-gray-400 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-gray-400 text-xs uppercase">Firebase UID</p>
                                        <p class="text-gray-500 font-mono text-xs break-all">${partner.uid}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Uploaded Movies -->
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fas fa-film text-purple-400"></i>
                                Yuklangan Filmlar <span class="text-sm font-normal text-gray-400">(${partnerMovies.length})</span>
                            </h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                ${moviesHtml}
                            </div>
                        </div>
                    </div>

                    <!-- Payment History -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-money-bill-wave text-green-400"></i>
                            To'lov Tarixi
                        </h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${paymentsHtml}
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-red-900/10 border-2 border-red-500/30 p-6 rounded-xl">
                        <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Xavfli Zona
                        </h3>
                        <p class="text-gray-400 text-sm mb-4">Bu hamkorni o'chirish barcha bog'liq ma'lumotlarni yo'q qiladi. Bu amalni qaytarib bo'lmaydi!</p>
                        <button id="delete-partner-btn" data-id="${partner.uid}" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all transform hover:scale-105 shadow-lg">
                            <i class="fas fa-trash-alt"></i> <span data-lang-key="deletePartner">Hamkorni O'chirish</span>
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('back-to-partners-btn').addEventListener('click', () => {
                detailsView.classList.add('hidden');
                document.getElementById('partner-list-view').classList.remove('hidden');
            });
            
            document.getElementById('delete-partner-btn').addEventListener('click', (e) => {
                 const partnerIdToDelete = e.currentTarget.dataset.id;
                 const title = dashboardTranslations[currentDashboardLanguage].deletePartnerConfirmTitle;
                 const message = dashboardTranslations[currentDashboardLanguage].deletePartnerConfirmMessage;
                 openConfirmationModal(title, message, () => deletePartner(partnerIdToDelete), "delete");
            });

            setDashboardLanguage(currentDashboardLanguage);
        }

        let sidebarResizeHandler = null;

        function openMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar) return;
            sidebar.classList.remove('-translate-x-full');
            if (overlay) overlay.classList.remove('hidden');
            if (window.innerWidth < 768) {
                document.body.classList.add('sidebar-locked');
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar) return;
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
            if (overlay) overlay.classList.add('hidden');
            document.body.classList.remove('sidebar-locked');
        }

        function initializeSidebarInteractions() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleBtn = document.getElementById('menu-toggle-btn');
            if (!sidebar || !toggleBtn) return;

            toggleBtn.addEventListener('click', () => {
                if (sidebar.classList.contains('-translate-x-full')) {
                    openMobileSidebar();
                } else {
                    closeMobileSidebar();
                }
            });

            if (overlay) {
                overlay.addEventListener('click', closeMobileSidebar);
            }

            if (sidebarResizeHandler) {
                window.removeEventListener('resize', sidebarResizeHandler);
            }

            sidebarResizeHandler = () => {
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('-translate-x-full');
                    if (overlay) overlay.classList.add('hidden');
                    document.body.classList.remove('sidebar-locked');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    if (overlay) overlay.classList.add('hidden');
                    document.body.classList.remove('sidebar-locked');
                }
            };

            sidebarResizeHandler();
            window.addEventListener('resize', sidebarResizeHandler);
        }

        function renderDashboard(role) {
            const isSuperAdmin = role === 'admin';
            const permissions = currentUserData?.permissions || {};
            const appContainer = document.getElementById('app-container');
            appContainer.className = 'min-h-screen';

            const adminLinks = `
                <a href="#" id="partners-link" data-panel="partners-panel" data-title="partners" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-users-cog w-6 text-gray-400"></i><span class="ml-3" data-lang-key="partners">Hamkorlar</span></a>
                <a href="#" id="users-link" data-panel="users-panel" data-title="users" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-user-shield w-6 text-gray-400"></i><span class="ml-3" data-lang-key="users">Foydalanuvchilar</span></a>
                <a href="#" id="archive-link" data-panel="archive-panel" data-title="archive" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-archive w-6 text-gray-400"></i><span class="ml-3" data-lang-key="archive">Arxiv</span></a>
                <a href="#" id="reports-link" data-panel="reports-panel" data-title="contentReports" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-flag w-6 text-gray-400"></i><span class="ml-3">Hisobotlar</span></a>
                <a href="#" id="requests-link" data-panel="requests-panel" data-title="requests" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-inbox w-6 text-gray-400"></i><span class="ml-3" data-lang-key="requests">So'rovlar</span></a>
                <a href="#" id="support-chats-link" data-panel="support-chats-panel" data-title="supportChats" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-comments w-6 text-gray-400"></i><span class="ml-3" data-lang-key="supportChats">Qo'llab-quvvatlash</span></a>
                <a href="#" id="promocodes-link" data-panel="promocodes-panel" data-title="promoCodes" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-gift w-6 text-gray-400"></i><span class="ml-3" data-lang-key="promoCodes">Promokodlar</span></a>
                <a href="#" id="admins-link" data-panel="admins-panel" data-title="admins" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-user-tie w-6 text-gray-400"></i><span class="ml-3" data-lang-key="admins">Adminlar</span></a>
                <a href="#" id="region-link" data-panel="region-panel" data-title="regionRestrictions" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-globe w-6 text-gray-400"></i><span class="ml-3" data-lang-key="regionRestrictions">Hudud cheklovlari</span></a>
                <a href="#" id="hero-link" data-panel="hero-panel" data-title="heroManagement" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-images w-6 text-gray-400"></i><span class="ml-3">Hero Banner</span></a>
                <a href="#" id="policy-link" data-panel="policy-panel" data-title="internalPolicy" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-scroll w-6 text-gray-400"></i><span class="ml-3">Siyosat</span></a>
                <a href="#" id="ads-link" data-panel="ads-panel" data-title="ads" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-bullhorn w-6 text-gray-400"></i><span class="ml-3">Reklama</span></a>
                <a href="#" id="support-profile-link" data-panel="support-profile-panel" data-title="supportProfile" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-user-headset w-6 text-gray-400"></i><span class="ml-3">Qo'llab-quvvatlash Profili</span></a>
                <a href="#" id="alerts-link" data-panel="alerts-panel" data-title="alerts" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-bell w-6 text-gray-400"></i><span class="ml-3">Ogohlantirishlar</span></a>
            `;
            
            const partnerLinks = `
                <a href="#" id="content-link" data-panel="content-panel" data-title="content" class="sidebar-link active flex items-center py-3 px-6"><i class="fas fa-video w-6 text-gray-400"></i><span class="ml-3" data-lang-key="content"></span></a>
                <a href="#" id="royalty-link" data-panel="royalty-panel" data-title="royalty" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-hand-holding-usd w-6 text-gray-400"></i><span class="ml-3" data-lang-key="royalty"></span></a>
                <a href="#" id="stats-link" data-panel="stats-panel" data-title="statistics" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-chart-bar w-6 text-gray-400"></i><span class="ml-3" data-lang-key="statistics"></span></a>
                <a href="#" id="partner-support-link" data-panel="partner-support-panel" data-title="supportPartnersHeading" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-headset w-6 text-gray-400"></i><span class="ml-3" data-lang-key="supportPartnersTab"></span></a>
                <a href="#" id="faq-link" data-panel="faq-panel" data-title="faq" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-question-circle w-6 text-gray-400"></i><span class="ml-3" data-lang-key="faq"></span></a>
                <a href="#" id="privacy-link" data-panel="privacy-panel" data-title="privacyPolicy" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-shield-alt w-6 text-gray-400"></i><span class="ml-3" data-lang-key="privacyPolicy"></span></a>
            `;

            const dashboardHTML = `
                <div class="dashboard-shell flex min-h-screen bg-gray-900">
                    <aside id="sidebar" class="w-64 bg-gradient-to-b from-gray-900 to-black text-gray-300 flex-shrink-0 flex flex-col fixed md:relative inset-y-0 left-0 h-full md:h-auto z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-2xl border-r border-gray-800 overflow-y-auto">
                        <div class="h-16 flex items-center justify-center border-b border-gray-800 bg-gradient-to-r from-red-900 to-red-700">
                            <h1 class="text-xl font-bold text-white tracking-wider">
                                <i class="fas fa-film mr-2"></i>SOUNDORA <span class="text-yellow-400">FILMS</span>
                            </h1>
                        </div>
                        <nav class="flex-grow mt-4">
                            ${currentUserRole === 'partner' ? partnerLinks : ''}
                            ${currentUserRole !== 'partner' ? `<a href="#" id="content-link" data-panel="content-panel" data-title="content" class="sidebar-link active flex items-center py-3 px-6"><i class="fas fa-film w-6 text-gray-400"></i><span class="ml-3" data-lang-key="content">Kontent</span></a>` : ''}
                            ${currentUserRole !== 'partner' ? adminLinks : ''}
                            ${currentUserRole !== 'agent' && currentUserRole !== 'partner' ? `<a href="#" id="royalty-link" data-panel="royalty-panel" data-title="royalty" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-hand-holding-usd w-6 text-gray-400"></i><span class="ml-3" data-lang-key="royalty">Royalti</span></a>
                            <a href="#" id="stats-link" data-panel="stats-panel" data-title="statistics" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-chart-bar w-6 text-gray-400"></i><span class="ml-3" data-lang-key="statistics">Statistika</span></a>` : ''}
                            <a href="#" id="settings-link" data-panel="settings-panel" data-title="settings" class="sidebar-link flex items-center py-3 px-6"><i class="fas fa-cog w-6 text-gray-400"></i><span class="ml-3" data-lang-key="settings">Sozlamalar</span></a>
                        </nav>
                        <div class="p-4 border-t border-gray-800">
                            <button id="logout-btn" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg hover:shadow-xl flex items-center justify-center">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                <span id="logout-text">–í—ã–π—Ç–∏</span>
                            </button>
                        </div>
                    </aside>
                    <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black/60 hidden md:hidden z-20"></div>
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <header class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 shadow-xl border-b border-gray-700">
                            <div class="flex items-center justify-between h-16 px-6">
                                <button id="menu-toggle-btn" class="md:hidden text-2xl text-gray-300 hover:text-white transition-colors"><i class="fas fa-bars"></i></button>
                                <div class="flex items-center space-x-3">
                                    <div class="w-1 h-8 bg-red-600 rounded-full"></div>
                                    <div id="page-title" class="text-2xl font-bold text-white" data-lang-key="content"></div>
                                </div>
                                <div class="flex items-center gap-4">
                                    ${currentUserRole === 'partner' || currentUserRole === 'admin' ? `
                                        <div class="relative">
                                            <button id="notifications-btn" class="relative text-gray-300 hover:text-white transition-colors">
                                                <i class="fas fa-bell text-2xl"></i>
                                                <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold"></span>
                                            </button>
                                            <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-96 bg-gray-800 rounded-lg shadow-xl border border-gray-700 z-50 max-h-96 overflow-y-auto">
                                                <div class="p-4 border-b border-gray-700">
                                                    <h3 class="text-white font-bold">Notifications</h3>
                                                </div>
                                                <div id="notifications-list" class="divide-y divide-gray-700">
                                                    <p class="text-gray-400 text-center py-4">No notifications</p>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    <div id="welcome-message" class="text-lg text-gray-300 font-medium" data-lang-key="welcome"></div>
                                </div>
                            </div>
                        </header>
                        <main id="main-content" class="flex-grow p-6 overflow-y-auto bg-gradient-to-br from-gray-900 to-black">
                           <div id="content-panel"></div>
                           <div id="partners-panel" class="hidden"></div>
                           <div id="users-panel" class="hidden"></div>
                           <div id="archive-panel" class="hidden"></div>
                           <div id="requests-panel" class="hidden"></div>
                           <div id="support-chats-panel" class="hidden"></div>
                           <div id="partner-support-panel" class="hidden"></div>
                           <div id="admins-panel" class="hidden"></div>
                           <div id="promocodes-panel" class="hidden"></div>
                           <div id="royalty-panel" class="hidden"></div>
                           <div id="stats-panel" class="hidden"></div>
                           <div id="faq-panel" class="hidden"></div>
                           <div id="privacy-panel" class="hidden"></div>
                           <div id="hero-panel" class="hidden"></div>
                           <div id="policy-panel" class="hidden"></div>
                           <div id="ads-panel" class="hidden"></div>
                           <div id="reports-panel" class="hidden"></div>
                           <div id="support-profile-panel" class="hidden"></div>
                           <!-- Panel for managing region restrictions (super admin only) -->
                           <div id="region-panel" class="hidden"></div>
                           <div id="settings-panel" class="hidden"></div>
                           <!-- Panel for sending admin alerts/announcements to all users -->
                           <div id="alerts-panel" class="hidden"></div>
                        </main>
                    </div>
                </div>
            `;
            
            appContainer.innerHTML = dashboardHTML;
            
            // Update logout button text based on language
            const updateLogoutText = () => {
                const logoutText = document.getElementById('logout-text');
                if (logoutText) {
                    logoutText.textContent = currentDashboardLanguage === 'uz' ? 'Chiqish' : '–í—ã–π—Ç–∏';
                }
            };
            updateLogoutText();
            
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            initializeSidebarInteractions();
            setupMenuListeners();
            
            // Setup notification button for partners
            const notificationsBtn = document.getElementById('notifications-btn');
            const notificationsDropdown = document.getElementById('notifications-dropdown');
            if (notificationsBtn && notificationsDropdown) {
                notificationsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationsDropdown.classList.toggle('hidden');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationsBtn.contains(e.target) && !notificationsDropdown.contains(e.target)) {
                        notificationsDropdown.classList.add('hidden');
                    }
                });
            }
            
            // Restore last active panel or default panel based on role
            const lastActivePanel = localStorage.getItem('lastActivePanel');
            const lastPanelExists = lastActivePanel && document.getElementById(lastActivePanel);
            
            if (lastPanelExists) {
                // Restore the last panel user was viewing
                const lastLink = document.querySelector(`[data-panel="${lastActivePanel}"]`);
                if (lastLink) {
                    lastLink.click();
                } else {
                    // Fallback to first panel
                    const firstPanel = document.querySelector('.sidebar-link');
                    if(firstPanel) firstPanel.click();
                }
            } else {
                // Default panel based on role
                const firstPanel = document.querySelector('.sidebar-link');
                if(firstPanel) {
                    firstPanel.click();
                } else {
                     renderSettingsPanel();
                }
            }
            setDashboardLanguage(currentDashboardLanguage);
        }

        function renderContentPanel() {
            const panel = document.getElementById('content-panel');
            
            const moviesToDisplay = currentUserRole === 'partner' ? movies.filter(m => m.partnerId === currentPartnerId) : movies;
            
            // Calculate statistics
            const totalMovies = moviesToDisplay.length;
            const totalViews = moviesToDisplay.reduce((acc, m) => acc + (m.views || 0), 0);
            const avgRating = moviesToDisplay.length > 0 
                ? (moviesToDisplay.reduce((acc, m) => acc + (m.rating || 0), 0) / moviesToDisplay.length).toFixed(1)
                : 0;
            const recentMovies = moviesToDisplay.filter(m => {
                const created = m.createdAt?.seconds ? new Date(m.createdAt.seconds * 1000) : null;
                if (!created) return false;
                const daysDiff = Math.floor((Date.now() - created.getTime()) / (1000 * 60 * 60 * 24));
                return daysDiff <= 30;
            }).length;
            
            panel.innerHTML = `
            <!-- Statistics Dashboard -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-4 rounded-lg shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-200 text-sm font-medium">Total Movies</p>
                            <p class="text-3xl font-bold text-white mt-1">${totalMovies}</p>
                        </div>
                        <div class="bg-purple-800 bg-opacity-50 p-3 rounded-full">
                            <i class="fas fa-film text-2xl text-purple-200"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-4 rounded-lg shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-200 text-sm font-medium">Total Views</p>
                            <p class="text-3xl font-bold text-white mt-1">${totalViews.toLocaleString()}</p>
                        </div>
                        <div class="bg-blue-800 bg-opacity-50 p-3 rounded-full">
                            <i class="fas fa-eye text-2xl text-blue-200"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-4 rounded-lg shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-200 text-sm font-medium">Avg Rating</p>
                            <p class="text-3xl font-bold text-white mt-1">${avgRating} <i class="fas fa-star text-yellow-300 text-xl"></i></p>
                        </div>
                        <div class="bg-yellow-800 bg-opacity-50 p-3 rounded-full">
                            <i class="fas fa-star-half-alt text-2xl text-yellow-200"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-green-900 to-green-700 p-4 rounded-lg shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-200 text-sm font-medium">New (30 days)</p>
                            <p class="text-3xl font-bold text-white mt-1">${recentMovies}</p>
                        </div>
                        <div class="bg-green-800 bg-opacity-50 p-3 rounded-full">
                            <i class="fas fa-clock text-2xl text-green-200"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Header with Actions -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-video text-purple-400"></i>
                        Content Library
                    </h2>
                    <p class="text-sm text-gray-400 mt-1">Manage your movies and series</p>
                </div>
                <button id="add-movie-btn" class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                    <i class="fas fa-plus"></i>
                    <span data-lang-key="addMovie">Add Movie</span>
                </button>
            </div>
            
            <!-- Search and Filters -->
            <div class="mb-6 bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div class="relative md:col-span-2">
                        <input type="text" id="content-search-input" placeholder="Search by title, year, or category..." 
                            class="w-full px-4 py-2 pl-10 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <select id="content-category-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="all">All Categories</option>
                        ${PARTNER_CATEGORY_OPTIONS.map(cat => `<option value="${cat.value}">${cat.label}</option>`).join('')}
                    </select>
                    
                    <select id="content-sort-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="title-asc">Title (A-Z)</option>
                        <option value="title-desc">Title (Z-A)</option>
                        <option value="views-desc">Most Viewed</option>
                        <option value="views-asc">Least Viewed</option>
                        <option value="rating-desc">Highest Rated</option>
                    </select>
                </div>
                
                ${currentUserRole === 'admin' ? `
                <div class="mt-3">
                    <select id="content-status-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="all">All Status</option>
                        <option value="published">Published</option>
                        <option value="needs-review">Needs Review (Reported)</option>
                        <option value="awaiting-approval">Awaiting Approval (Fixed)</option>
                    </select>
                </div>
                ` : ''}
                
                <div class="flex items-center justify-between mt-3">
                    <button id="content-reset-filters" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center gap-2 text-sm">
                        <i class="fas fa-undo"></i>
                        Reset Filters
                    </button>
                    <div class="flex items-center gap-3">
                        <button id="content-view-grid" class="px-3 py-2 bg-purple-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-th"></i>
                        </button>
                        <button id="content-view-list" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-list"></i>
                        </button>
                        <span class="text-sm text-gray-400" id="content-filter-count"></span>
                    </div>
                </div>
            </div>
            
            <!-- Movies Grid/List -->
            <div id="movie-management" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4">
                ${renderMovieCards(currentUserRole === 'partner')}
            </div>`;
             
             attachContentActionListeners();
             attachContentFilterListeners();
             setDashboardLanguage(currentDashboardLanguage);
        }
        let contentFilterState = {
            search: '',
            category: 'all',
            sort: 'newest',
            status: 'all',
            viewMode: 'grid'
        };
        
        function renderMovieCards(isPartner) {
            let moviesToDisplay = isPartner ? movies.filter(m => m.partnerId === currentPartnerId) : movies;
            
            // Apply filters
            if (contentFilterState.search) {
                const searchLower = contentFilterState.search.toLowerCase();
                moviesToDisplay = moviesToDisplay.filter(m => 
                    (m.title || '').toLowerCase().includes(searchLower) ||
                    (m.year || '').toString().includes(searchLower) ||
                    (m.primaryCategory || '').toLowerCase().includes(searchLower)
                );
            }
            
            if (contentFilterState.category !== 'all') {
                moviesToDisplay = moviesToDisplay.filter(m => m.primaryCategory === contentFilterState.category);
            }
            
            // Apply status filter (admin only)
            if (contentFilterState.status && contentFilterState.status !== 'all') {
                switch (contentFilterState.status) {
                    case 'published':
                        moviesToDisplay = moviesToDisplay.filter(m => !m.needsReview && !m.awaitingAdminApproval && !m.hiddenFromUsers);
                        break;
                    case 'needs-review':
                        moviesToDisplay = moviesToDisplay.filter(m => m.needsReview === true);
                        break;
                    case 'awaiting-approval':
                        moviesToDisplay = moviesToDisplay.filter(m => m.awaitingAdminApproval === true);
                        break;
                }
            }
            
            // Apply sorting
            switch (contentFilterState.sort) {
                case 'newest':
                    moviesToDisplay.sort((a, b) => {
                        const dateA = a.createdAt?.seconds || 0;
                        const dateB = b.createdAt?.seconds || 0;
                        return dateB - dateA;
                    });
                    break;
                case 'oldest':
                    moviesToDisplay.sort((a, b) => {
                        const dateA = a.createdAt?.seconds || 0;
                        const dateB = b.createdAt?.seconds || 0;
                        return dateA - dateB;
                    });
                    break;
                case 'title-asc':
                    moviesToDisplay.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    break;
                case 'title-desc':
                    moviesToDisplay.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
                    break;
                case 'views-desc':
                    moviesToDisplay.sort((a, b) => (b.views || 0) - (a.views || 0));
                    break;
                case 'views-asc':
                    moviesToDisplay.sort((a, b) => (a.views || 0) - (b.views || 0));
                    break;
                case 'rating-desc':
                    moviesToDisplay.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
            }
            
            // Update count
            const countEl = document.getElementById('content-filter-count');
            const totalMovies = isPartner ? movies.filter(m => m.partnerId === currentPartnerId).length : movies.length;
            if (countEl) {
                countEl.textContent = `Showing ${moviesToDisplay.length} of ${totalMovies} movies`;
            }
            
            if (moviesToDisplay.length === 0) {
                return `<div class="col-span-full text-center py-12">
                    <i class="fas fa-film text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-500 text-lg">No movies found</p>
                    <p class="text-gray-600 text-sm mt-2">Try adjusting your filters</p>
                </div>`;
            }
            
            return moviesToDisplay.map(movie => {
                const categoryLabel = PARTNER_CATEGORY_OPTIONS.find(opt => opt.value === movie.primaryCategory)?.label || (movie.primaryCategory || 'General');
                const sportLabel = movie.primaryCategory === 'sports' && movie.sportCategory
                    ? SPORTS_SUBCATEGORY_OPTIONS.find(opt => opt.value === movie.sportCategory)?.label || movie.sportCategory
                    : '';
                
                // Get category color
                let categoryColor = 'bg-purple-900 text-purple-200';
                if (movie.primaryCategory === 'sports') categoryColor = 'bg-green-900 text-green-200';
                else if (movie.primaryCategory === 'challenge') categoryColor = 'bg-orange-900 text-orange-200';
                else if (movie.primaryCategory === 'snd') categoryColor = 'bg-red-900 text-red-200';
                
                return `
            <div class="movie-card rounded-xl overflow-hidden shadow-lg flex flex-col bg-gray-800 border border-gray-700 hover:border-purple-500 transition-all group">
                <div class="relative overflow-hidden">
                    <img src="${movie.poster}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/7c3aed/ffffff?text=${encodeURIComponent(movie.title || 'Movie')}';" alt="${movie.title}" class="w-full h-auto object-cover aspect-[2/3] group-hover:scale-110 transition-transform duration-300">
                    <div class="absolute top-2 left-2 flex flex-col gap-1">
                        <span class="px-2 py-1 ${categoryColor} rounded-lg text-xs font-semibold">${categoryLabel}</span>
                        ${movie.needsReview ? '<span class="px-2 py-1 bg-red-600 text-white rounded-lg text-xs font-semibold"><i class="fas fa-exclamation-triangle mr-1"></i>Needs Review</span>' : ''}
                        ${movie.awaitingAdminApproval ? '<span class="px-2 py-1 bg-yellow-600 text-white rounded-lg text-xs font-semibold"><i class="fas fa-clock mr-1"></i>Awaiting Approval</span>' : ''}
                    </div>
                    ${movie.views ? `
                    <div class="absolute bottom-2 right-2 bg-black bg-opacity-75 px-2 py-1 rounded-lg flex items-center gap-1 text-xs">
                        <i class="fas fa-eye text-blue-400"></i>
                        <span class="text-white font-semibold">${movie.views.toLocaleString()}</span>
                    </div>` : ''}
                </div>
                <div class="p-4 flex flex-col flex-grow">
                    <h3 class="font-bold text-lg text-white truncate group-hover:text-purple-400 transition-colors" title="${movie.title}">${movie.title}</h3>
                    <div class="flex items-center gap-2 mt-1 text-sm text-gray-400">
                        ${movie.year ? `<span><i class="fas fa-calendar mr-1"></i>${movie.year}</span>` : ''}
                        ${movie.rating ? `<span class="text-yellow-400"><i class="fas fa-star mr-1"></i>${movie.rating}</span>` : ''}
                    </div>
                    ${sportLabel ? `<p class="text-xs text-gray-500 mt-1"><i class="fas fa-trophy mr-1"></i>${sportLabel}</p>` : ''}
                    <div class="mt-auto pt-3 flex justify-end gap-2">
                        ${movie.awaitingAdminApproval && currentUserRole === 'admin' ? `
                        <button class="approve-btn w-10 h-10 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-colors shadow-lg hover:shadow-xl flex items-center justify-center" data-id="${movie.id}" title="Approve Content">
                            <i class="fas fa-check"></i>
                        </button>
                        ` : ''}
                        <button class="edit-btn w-10 h-10 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors shadow-lg hover:shadow-xl flex items-center justify-center" data-id="${movie.id}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${(currentUserRole !== 'partner' && currentUserRole !== 'agent') ? `
                        <button class="delete-btn w-10 h-10 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors shadow-lg hover:shadow-xl flex items-center justify-center" data-id="${movie.id}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </div>
                </div>
            </div>`;
            }).join('');
        }
        
        function attachContentFilterListeners() {
            const searchInput = document.getElementById('content-search-input');
            const categoryFilter = document.getElementById('content-category-filter');
            const sortFilter = document.getElementById('content-sort-filter');
            const statusFilter = document.getElementById('content-status-filter');
            const resetBtn = document.getElementById('content-reset-filters');
            const gridViewBtn = document.getElementById('content-view-grid');
            const listViewBtn = document.getElementById('content-view-list');
            
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    if (window.contentSearchTimeout) clearTimeout(window.contentSearchTimeout);
                    window.contentSearchTimeout = setTimeout(() => {
                        contentFilterState.search = searchInput.value;
                        updateContentDisplay();
                    }, 300);
                });
            }
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', () => {
                    contentFilterState.category = categoryFilter.value;
                    updateContentDisplay();
                });
            }
            
            if (sortFilter) {
                sortFilter.addEventListener('change', () => {
                    contentFilterState.sort = sortFilter.value;
                    updateContentDisplay();
                });
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', () => {
                    contentFilterState.status = statusFilter.value;
                    updateContentDisplay();
                });
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    contentFilterState = { search: '', category: 'all', sort: 'newest', status: 'all', viewMode: 'grid' };
                    if (searchInput) searchInput.value = '';
                    if (categoryFilter) categoryFilter.value = 'all';
                    if (sortFilter) sortFilter.value = 'newest';
                    if (statusFilter) statusFilter.value = 'all';
                    updateContentDisplay();
                });
            }
            
            if (gridViewBtn) {
                gridViewBtn.addEventListener('click', () => {
                    contentFilterState.viewMode = 'grid';
                    gridViewBtn.classList.add('bg-purple-600');
                    gridViewBtn.classList.remove('bg-gray-700');
                    if (listViewBtn) {
                        listViewBtn.classList.remove('bg-purple-600');
                        listViewBtn.classList.add('bg-gray-700');
                    }
                    updateContentDisplay();
                });
            }
            
            if (listViewBtn) {
                listViewBtn.addEventListener('click', () => {
                    contentFilterState.viewMode = 'list';
                    listViewBtn.classList.add('bg-purple-600');
                    listViewBtn.classList.remove('bg-gray-700');
                    if (gridViewBtn) {
                        gridViewBtn.classList.remove('bg-purple-600');
                        gridViewBtn.classList.add('bg-gray-700');
                    }
                    updateContentDisplay();
                });
            }
        }
        
        function updateContentDisplay() {
            const container = document.getElementById('movie-management');
            if (!container) return;
            
            container.innerHTML = renderMovieCards(currentUserRole === 'partner');
            attachContentActionListeners();
        }
        
        function renderRoyaltyPanel() {
            const panel = document.getElementById('royalty-panel');
            
            // Calculate partner royalty data
            const isPartner = currentUserRole === 'partner';
            const partnerMovies = isPartner 
                ? movies.filter(m => m.partnerId === currentPartnerId)
                : movies.filter(m => m.partnerId);
            
            const totalViews = partnerMovies.reduce((acc, m) => acc + (m.views || 0), 0);
            const royaltyRate = settings.royaltyPerView || 0.05;
            const totalRoyalty = totalViews * royaltyRate;
            const totalMovies = partnerMovies.length;
            const avgViewsPerMovie = totalMovies > 0 ? Math.floor(totalViews / totalMovies) : 0;
            
            // Get payment history
            const partnerPayments = isPartner 
                ? paymentHistory.filter(p => p.partnerId === currentPartnerId)
                : paymentHistory;
            
            const totalPaid = partnerPayments.reduce((acc, p) => acc + (p.amount || 0), 0);
            const pendingAmount = totalRoyalty - totalPaid;
            
            // Last payment
            const lastPayment = partnerPayments.length > 0 
                ? partnerPayments.sort((a, b) => {
                    const dateA = a.date?.seconds || 0;
                    const dateB = b.date?.seconds || 0;
                    return dateB - dateA;
                })[0]
                : null;
            
            const lastPaymentDate = lastPayment && lastPayment.date?.seconds 
                ? new Date(lastPayment.date.seconds * 1000).toLocaleDateString('uz-UZ')
                : 'Hali to\'lov yo\'q';
            
            const lastPaymentAmount = lastPayment ? `$${lastPayment.amount.toFixed(2)}` : '-';
            
            panel.innerHTML = `
                <!-- Royalty Statistics Dashboard -->
                <div class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-green-900 to-green-700 p-6 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-green-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-green-200 text-xs font-semibold uppercase tracking-wide mb-2">Jami Daromad</p>
                                <p class="text-4xl font-black text-white mb-1">$${totalRoyalty.toFixed(2)}</p>
                                <p class="text-green-300 text-xs">Ko'rishlar: ${totalViews.toLocaleString()}</p>
                            </div>
                            <div class="bg-green-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-dollar-sign text-3xl text-green-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-6 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-blue-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-blue-200 text-xs font-semibold uppercase tracking-wide mb-2">To'langan</p>
                                <p class="text-4xl font-black text-white mb-1">$${totalPaid.toFixed(2)}</p>
                                <p class="text-blue-300 text-xs">To'lovlar: ${partnerPayments.length}</p>
                            </div>
                            <div class="bg-blue-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-check-circle text-3xl text-blue-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-6 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-yellow-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-yellow-200 text-xs font-semibold uppercase tracking-wide mb-2">Kutilmoqda</p>
                                <p class="text-4xl font-black text-white mb-1">$${pendingAmount.toFixed(2)}</p>
                                <p class="text-yellow-300 text-xs">${pendingAmount > 0 ? 'Keyingi to\'lov' : 'Hamma to\'landi'}</p>
                            </div>
                            <div class="bg-yellow-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-clock text-3xl text-yellow-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-6 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-purple-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-purple-200 text-xs font-semibold uppercase tracking-wide mb-2">Oxirgi To'lov</p>
                                <p class="text-2xl font-black text-white mb-1">${lastPaymentAmount}</p>
                                <p class="text-purple-300 text-xs">${lastPaymentDate}</p>
                            </div>
                            <div class="bg-purple-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-receipt text-3xl text-purple-200"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Royalty Details Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Payment History -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl border border-gray-700 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-5">
                            <h3 class="text-xl font-bold text-white flex items-center gap-3">
                                <i class="fas fa-history"></i>
                                <span>To'lovlar Tarixi</span>
                            </h3>
                        </div>
                        <div class="p-6">
                            ${partnerPayments.length > 0 ? `
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    ${partnerPayments.sort((a, b) => {
                                        const dateA = a.date?.seconds || 0;
                                        const dateB = b.date?.seconds || 0;
                                        return dateB - dateA;
                                    }).map(payment => {
                                        const date = payment.date?.seconds 
                                            ? new Date(payment.date.seconds * 1000).toLocaleDateString('uz-UZ')
                                            : '-';
                                        const status = payment.status || 'completed';
                                        const statusBadge = status === 'completed' 
                                            ? '<span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs font-bold rounded-full border border-green-500/50">Amalga oshdi</span>'
                                            : '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs font-bold rounded-full border border-yellow-500/50">Kutilmoqda</span>';
                                        
                                        return `
                                            <div class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition-colors">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                                        <i class="fas fa-dollar-sign text-white"></i>
                                                    </div>
                                                    <div>
                                                        <p class="text-white font-bold">$${payment.amount.toFixed(2)}</p>
                                                        <p class="text-xs text-gray-400">${date}</p>
                                                    </div>
                                                </div>
                                                ${statusBadge}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <div class="inline-block p-6 bg-gray-700 rounded-full mb-4">
                                        <i class="fas fa-wallet text-5xl text-gray-500"></i>
                                    </div>
                                    <p class="text-gray-400">Hali to'lovlar yo'q</p>
                                    <p class="text-sm text-gray-500 mt-2">Daromadingiz $100 ga yetganda to'lov amalga oshiriladi</p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Movies Royalty Breakdown -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl border border-gray-700 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-purple-500 p-5">
                            <h3 class="text-xl font-bold text-white flex items-center gap-3">
                                <i class="fas fa-film"></i>
                                <span>Filmlar bo'yicha Daromad</span>
                            </h3>
                        </div>
                        <div class="p-6">
                            ${partnerMovies.length > 0 ? `
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    ${partnerMovies.sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 10).map(movie => {
                                        const views = movie.views || 0;
                                        const royalty = views * royaltyRate;
                                        
                                        return `
                                            <div class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition-colors">
                                                <div class="flex-1">
                                                    <p class="text-white font-semibold truncate">${movie.title}</p>
                                                    <div class="flex items-center gap-3 mt-1">
                                                        <span class="text-xs text-gray-400">
                                                            <i class="fas fa-eye mr-1"></i>${views.toLocaleString()}
                                                        </span>
                                                        <span class="text-xs text-green-400 font-bold">
                                                            <i class="fas fa-dollar-sign mr-1"></i>${royalty.toFixed(2)}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-700">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-400">Royalti stavkasi:</span>
                                        <span class="text-white font-bold">$${royaltyRate.toFixed(3)} / ko'rish</span>
                                    </div>
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <div class="inline-block p-6 bg-gray-700 rounded-full mb-4">
                                        <i class="fas fa-film text-5xl text-gray-500"></i>
                                    </div>
                                    <p class="text-gray-400">Hali filmlar yo'q</p>
                                    <p class="text-sm text-gray-500 mt-2">Kontent yuklang va daromad oling</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
                
                <!-- Info Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-r from-blue-900/50 to-blue-800/50 p-6 rounded-xl border border-blue-700/30">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-info-circle text-white text-xl"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-white mb-2">Daromad Hisoblash</h4>
                                <p class="text-sm text-gray-300 leading-relaxed">
                                    Har bir ko'rish uchun <strong>$${royaltyRate.toFixed(3)}</strong> to'lanadi. 
                                    Ko'rishlar soni ortgan sari daromadingiz ham oshadi. To'lovlar oylik amalga oshiriladi.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-900/50 to-green-800/50 p-6 rounded-xl border border-green-700/30">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-hand-holding-usd text-white text-xl"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-white mb-2">To'lov Shartlari</h4>
                                <p class="text-sm text-gray-300 leading-relaxed">
                                    Minimal to'lov summasi <strong>$100</strong>. 
                                    Daromadingiz bu miqdorga yetganda, keyingi oy boshida to'lov amalga oshiriladi.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            setDashboardLanguage(currentDashboardLanguage);
        }
        
        function renderStatsPanel() {
            const panel = document.getElementById('stats-panel');
            
            const isPartner = currentUserRole === 'partner';
            const partnerMovies = isPartner 
                ? movies.filter(m => m.partnerId === currentPartnerId)
                : movies;
            
            const totalMovies = partnerMovies.length;
            const totalViews = partnerMovies.reduce((acc, movie) => acc + (movie.views || 0), 0);
            const totalLikes = partnerMovies.reduce((acc, movie) => acc + ((movie.likes || []).length || 0), 0);
            const avgRating = totalMovies > 0 
                ? (partnerMovies.reduce((acc, m) => acc + (m.rating || 0), 0) / totalMovies).toFixed(1)
                : 0;
            
            const avgViewsPerMovie = totalMovies > 0 ? Math.floor(totalViews / totalMovies) : 0;
            
            // Top 10 movies by views
            const topMovies = [...partnerMovies].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 10);
            
            // Views by category
            const viewsByCategory = {};
            partnerMovies.forEach(movie => {
                const cat = movie.primaryCategory || 'general';
                if (!viewsByCategory[cat]) viewsByCategory[cat] = 0;
                viewsByCategory[cat] += (movie.views || 0);
            });
            
            // Recent activity (last 30 days)
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const recentMovies = partnerMovies.filter(m => {
                const created = m.createdAt?.seconds ? (m.createdAt.seconds * 1000) : 0;
                return created >= thirtyDaysAgo;
            });

            panel.innerHTML = `
                <!-- Statistics Overview -->
                <div class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-6 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-purple-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-purple-200 text-xs font-semibold uppercase tracking-wide mb-2">Jami Filmlar</p>
                                <p class="text-4xl font-black text-white mb-1">${totalMovies}</p>
                                <p class="text-purple-300 text-xs">+${recentMovies.length} oxirgi 30 kun</p>
                            </div>
                            <div class="bg-purple-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-film text-3xl text-purple-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-6 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-blue-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-blue-200 text-xs font-semibold uppercase tracking-wide mb-2">Jami Ko'rishlar</p>
                                <p class="text-4xl font-black text-white mb-1">${totalViews.toLocaleString()}</p>
                                <p class="text-blue-300 text-xs">O'rtacha: ${avgViewsPerMovie.toLocaleString()}</p>
                            </div>
                            <div class="bg-blue-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-eye text-3xl text-blue-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-red-900 to-red-700 p-6 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-red-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-red-200 text-xs font-semibold uppercase tracking-wide mb-2">Jami Yoqtirishlar</p>
                                <p class="text-4xl font-black text-white mb-1">${totalLikes.toLocaleString()}</p>
                                <p class="text-red-300 text-xs">${totalMovies > 0 ? Math.floor(totalLikes / totalMovies) : 0} o'rtacha</p>
                            </div>
                            <div class="bg-red-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-heart text-3xl text-red-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-6 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-yellow-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-yellow-200 text-xs font-semibold uppercase tracking-wide mb-2">O'rtacha Reyting</p>
                                <p class="text-4xl font-black text-white mb-1">${avgRating}</p>
                                <p class="text-yellow-300 text-xs">
                                    <i class="fas fa-star text-yellow-300"></i>
                                    <i class="fas fa-star text-yellow-300"></i>
                                    <i class="fas fa-star text-yellow-300"></i>
                                    <i class="fas fa-star text-yellow-300"></i>
                                    <i class="fas fa-star text-yellow-300"></i>
                                </p>
                            </div>
                            <div class="bg-yellow-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-star-half-alt text-3xl text-yellow-200"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Statistics -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Top 10 Movies -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl border border-gray-700 overflow-hidden">
                        <div class="bg-gradient-to-r from-green-600 to-green-500 p-5">
                            <h3 class="text-xl font-bold text-white flex items-center gap-3">
                                <i class="fas fa-trophy"></i>
                                <span>Top 10 Filmlar (Ko'rishlar bo'yicha)</span>
                            </h3>
                        </div>
                        <div class="p-6">
                            ${topMovies.length > 0 ? `
                                <div class="space-y-3">
                                    ${topMovies.map((movie, index) => {
                                        const medalColors = ['text-yellow-400', 'text-gray-300', 'text-orange-400'];
                                        const medalIcons = ['fa-trophy', 'fa-medal', 'fa-award'];
                                        const medalClass = index < 3 ? medalColors[index] : 'text-gray-500';
                                        const medalIcon = index < 3 ? medalIcons[index] : 'fa-film';
                                        
                                        return `
                                            <div class="flex items-center gap-4 p-3 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition-colors">
                                                <div class="flex items-center justify-center w-8 h-8 ${medalClass}">
                                                    <i class="fas ${medalIcon} text-xl"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-white font-semibold truncate">${movie.title}</p>
                                                    <p class="text-xs text-gray-400">${movie.year || '-'}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-white font-bold">${(movie.views || 0).toLocaleString()}</p>
                                                    <p class="text-xs text-gray-400">ko'rish</p>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <div class="inline-block p-6 bg-gray-700 rounded-full mb-4">
                                        <i class="fas fa-chart-bar text-5xl text-gray-500"></i>
                                    </div>
                                    <p class="text-gray-400">Ma'lumotlar yo'q</p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Views by Category -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl border border-gray-700 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-purple-500 p-5">
                            <h3 class="text-xl font-bold text-white flex items-center gap-3">
                                <i class="fas fa-chart-pie"></i>
                                <span>Kategoriyalar bo'yicha Ko'rishlar</span>
                            </h3>
                        </div>
                        <div class="p-6">
                            ${Object.keys(viewsByCategory).length > 0 ? `
                                <div class="space-y-4">
                                    ${Object.entries(viewsByCategory).sort((a, b) => b[1] - a[1]).map(([category, views]) => {
                                        const option = PARTNER_CATEGORY_OPTIONS.find(opt => opt.value === category);
                                        const label = option ? option.label : category;
                                        const percentage = totalViews > 0 ? Math.round((views / totalViews) * 100) : 0;
                                        
                                        const colors = {
                                            'general': 'bg-blue-500',
                                            'sports': 'bg-green-500',
                                            'challenge': 'bg-yellow-500',
                                            'snd': 'bg-red-500'
                                        };
                                        const barColor = colors[category] || 'bg-gray-500';
                                        
                                        return `
                                            <div>
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-sm text-gray-300 font-semibold">${label}</span>
                                                    <span class="text-sm text-white font-bold">${views.toLocaleString()} (${percentage}%)</span>
                                                </div>
                                                <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                                                    <div class="${barColor} h-full rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <div class="inline-block p-6 bg-gray-700 rounded-full mb-4">
                                        <i class="fas fa-chart-pie text-5xl text-gray-500"></i>
                                    </div>
                                    <p class="text-gray-400">Ma'lumotlar yo'q</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
                
                <!-- Performance Insights -->
                <div class="bg-gradient-to-r from-indigo-900/50 to-indigo-800/50 p-6 rounded-xl border border-indigo-700/30">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-lightbulb text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-white mb-3">Takomillashtirish Maslahatlari</h4>
                            <ul class="space-y-2 text-sm text-gray-300">
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check-circle text-green-400 mt-0.5"></i>
                                    <span>Ko'p ko'rilgan kategoriyalar bo'yicha ko'proq kontent yuklang</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check-circle text-green-400 mt-0.5"></i>
                                    <span>Sifatli tavsif va teglar qo'shing - bu qidiruv natijalarini yaxshilaydi</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check-circle text-green-400 mt-0.5"></i>
                                    <span>Muntazam ravishda yangi kontent yuklash tomoshabinlarni ushlab turadi</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            setDashboardLanguage(currentDashboardLanguage);
        }

        function renderSettingsPanel() {
            const panel = document.getElementById('settings-panel');
            const isSuperAdmin = currentUserRole === 'admin';
            const t = dashboardTranslations[currentDashboardLanguage] || {};
            
            panel.innerHTML = `
                <div class="space-y-6 max-w-5xl mx-auto">
                    <!-- Header -->
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold mb-2" data-lang-key="settings">${t.settings || 'Settings'}</h2>
                        <p class="text-gray-400">${t.name || 'Name'}: <span class="font-semibold text-white">${currentUserData?.displayName || 'N/A'}</span></p>
                        <p class="text-gray-400">Email: <span class="font-semibold text-white">${currentUserData?.email || 'N/A'}</span></p>
                    </div>

                    <!-- Profile Information Card -->
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700">
                        <div class="bg-gradient-to-r from-red-600 to-red-700 p-4">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-user-circle mr-3"></i>
                                <span data-lang-key="profileInfo">${t.profileInfo || 'Profile Information'}</span>
                            </h3>
                        </div>
                        <form id="profile-form" class="p-6 space-y-5">
                            <div class="space-y-2">
                                <label for="displayName" class="block text-sm font-semibold text-gray-300" data-lang-key="name">${t.name || 'Name'}</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <input type="text" id="displayName" class="settings-input w-full pl-10 py-3 rounded-lg text-white" value="${currentUserData?.displayName || ''}" placeholder="${t.name || 'Enter your name'}">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label for="email" class="block text-sm font-semibold text-gray-300" data-lang-key="contactEmail">${t.contactEmail || 'Email'}</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                    <input type="email" id="email" class="settings-input w-full pl-10 py-3 rounded-lg text-gray-400 bg-gray-700 cursor-not-allowed" value="${currentUserData?.email || ''}" disabled>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Email o'zgartirib bo'lmaydi / Email –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å
                                </p>
                            </div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="action-btn text-white font-bold py-3 px-6 rounded-lg flex items-center transition-all hover:shadow-lg">
                                    <i class="fas fa-save mr-2"></i>
                                    <span data-lang-key="saveSettings">${t.saveSettings || 'Save Settings'}</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Change Password Card -->
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700">
                        <div class="bg-gradient-to-r from-orange-600 to-red-600 p-4">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-key mr-3"></i>
                                <span data-lang-key="changePassword">${t.changePassword || 'Change Password'}</span>
                            </h3>
                        </div>
                        <form id="password-form" class="p-6 space-y-5">
                            <div class="space-y-2">
                                <label for="currentPassword" class="block text-sm font-semibold text-gray-300" data-lang-key="currentPassword">${t.currentPassword || 'Current Password'}</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <input type="password" id="currentPassword" class="settings-input w-full pl-10 py-3 rounded-lg text-white" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label for="newPassword" class="block text-sm font-semibold text-gray-300" data-lang-key="newPassword">${t.newPassword || 'New Password'}</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <input type="password" id="newPassword" class="settings-input w-full pl-10 py-3 rounded-lg text-white" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-shield-alt mr-1"></i>
                                    Kamida 6 ta belgi / –ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤
                                </p>
                            </div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="action-btn text-white font-bold py-3 px-6 rounded-lg flex items-center transition-all hover:shadow-lg">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span data-lang-key="changePassword">${t.changePassword || 'Change Password'}</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Language Settings Card -->
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-language mr-3"></i>
                                <span data-lang-key="languageSettings">${t.languageSettings || 'Language Settings'}</span>
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-2 gap-4">
                                <button class="lang-btn ${currentDashboardLanguage === 'ru' ? 'active' : ''} p-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition-all border-2 border-transparent hover:border-red-500 flex items-center justify-center font-semibold" data-lang="ru">
                                    <i class="fas fa-globe mr-2"></i>
                                    –†—É—Å—Å–∫–∏–π
                                </button>
                                <button class="lang-btn ${currentDashboardLanguage === 'uz' ? 'active' : ''} p-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition-all border-2 border-transparent hover:border-red-500 flex items-center justify-center font-semibold" data-lang="uz">
                                    <i class="fas fa-globe mr-2"></i>
                                    O'zbekcha
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    ${isSuperAdmin ? `
                    <!-- Royalty Settings Card (Super Admin Only) -->
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700">
                        <div class="bg-gradient-to-r from-green-600 to-teal-600 p-4">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-dollar-sign mr-3"></i>
                                <span data-lang-key="royaltySettings">${t.royaltySettings || 'Royalty Settings'}</span>
                            </h3>
                        </div>
                        <form id="royalty-settings-form" class="p-6 space-y-5">
                            <div class="space-y-2">
                                <label for="royaltyPerView" class="block text-sm font-semibold text-gray-300" data-lang-key="royaltyPerView">${t.royaltyPerView || 'Rate per View ($)'}</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                        <i class="fas fa-coins"></i>
                                    </span>
                                    <input type="number" step="0.01" id="royaltyPerView" class="settings-input w-full pl-10 py-3 rounded-lg text-white" value="${settings.royaltyPerView || 0.05}">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Har bir ko'rish uchun to'lanadigan summa / –°—É–º–º–∞ –∑–∞ –∫–∞–∂–¥—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
                                </p>
                            </div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="action-btn text-white font-bold py-3 px-6 rounded-lg flex items-center transition-all hover:shadow-lg">
                                    <i class="fas fa-save mr-2"></i>
                                    <span data-lang-key="saveSettings">${t.saveSettings || 'Save Settings'}</span>
                                </button>
                            </div>
                        </form>
                    </div>` : ''}
                    
                    <!-- Additional Info Card -->
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-shield-alt text-white text-xl"></i>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold mb-2">
                                    ${currentDashboardLanguage === 'uz' ? 'Xavfsizlik' : '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å'}
                                </h4>
                                <p class="text-gray-400 text-sm leading-relaxed">
                                    ${currentDashboardLanguage === 'uz' 
                                        ? 'Parolingizni hech kimga aytmang. Agar shubhali faoliyatni sezgan bo\'lsangiz, darhol parolni o\'zgartiring.' 
                                        : '–ù–∏–∫–æ–º—É –Ω–µ —Å–æ–æ–±—â–∞–π—Ç–µ —Å–≤–æ–π –ø–∞—Ä–æ–ª—å. –ï—Å–ª–∏ –≤—ã –∑–∞–º–µ—Ç–∏–ª–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å.'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Event Listeners
            document.getElementById('profile-form').addEventListener('submit', handleUpdateProfile);
            document.getElementById('password-form').addEventListener('submit', handleChangePassword);
            if(isSuperAdmin) {
                document.getElementById('royalty-settings-form').addEventListener('submit', handleUpdateSettings);
            }
            
            // Language button handlers
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const newLang = e.currentTarget.dataset.lang;
                    setDashboardLanguage(newLang);
                    // Update active state
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                });
            });

            setDashboardLanguage(currentDashboardLanguage);
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            if (!currentUserData?.uid) {
                showToast("Profil yangilash uchun foydalanuvchi topilmadi.", true);
                return;
            }
            const displayNameInput = document.getElementById('displayName');
            const newDisplayName = displayNameInput?.value.trim();
            if (!newDisplayName || newDisplayName === currentUserData.displayName) {
                showToast(dashboardTranslations[currentDashboardLanguage]?.idUpdated || 'No changes to save.');
                return;
            }
            loadingOverlay.classList.remove('hidden');
            try {
                await updateDoc(doc(db, "users", currentUserData.uid), { displayName: newDisplayName });
                if (auth.currentUser) {
                    try {
                        await updateProfile(auth.currentUser, { displayName: newDisplayName });
                    } catch (profileError) {
                        console.warn('Auth profile update skipped:', profileError);
                    }
                }
                currentUserData.displayName = newDisplayName;
                showToast(dashboardTranslations[currentDashboardLanguage]?.profileUpdateSuccess || 'Profile updated.');
            } catch (error) {
                console.error('handleUpdateProfile error', error);
                showToast(dashboardTranslations[currentDashboardLanguage]?.profileUpdateError || 'Failed to update profile.', true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword')?.value || '';
            const newPassword = document.getElementById('newPassword')?.value || '';
            if (!auth.currentUser?.email) {
                showToast("Email topilmadi, parolni yangilab bo'lmadi.", true);
                return;
            }
            if (!currentPassword || !newPassword) {
                showToast("Parollarni to'liq kiriting.", true);
                return;
            }
            loadingOverlay.classList.remove('hidden');
            try {
                const credential = EmailAuthProvider.credential(auth.currentUser.email, currentPassword);
                await reauthenticateWithCredential(auth.currentUser, credential);
                await updatePassword(auth.currentUser, newPassword);
                e.target.reset();
                showToast(dashboardTranslations[currentDashboardLanguage]?.passwordUpdateSuccess || 'Password updated.');
            } catch (error) {
                console.error('handleChangePassword error', error);
                const errorMsg = error.code === 'auth/wrong-password'
                    ? dashboardTranslations[currentDashboardLanguage]?.wrongSecretWord || 'Current password incorrect.'
                    : (dashboardTranslations[currentDashboardLanguage]?.passwordUpdateError || 'Failed to update password.');
                showToast(errorMsg, true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function renderPartnersPanel() {
            const panel = document.getElementById('partners-panel');
            
            // Calculate advanced statistics
            const totalPartners = partners.length;
            const activePartners = partners.filter(p => !p.suspended).length;
            const suspendedPartners = partners.filter(p => p.suspended).length;
            const totalMoviesByPartners = movies.filter(m => m.partnerId).length;
            const avgMoviesPerPartner = totalPartners > 0 ? Math.floor(totalMoviesByPartners / totalPartners) : 0;
            
            // Calculate total views from partner content
            const totalPartnerViews = movies.filter(m => m.partnerId).reduce((acc, m) => acc + (m.views || 0), 0);
            
            // Calculate revenue (estimated)
            const totalRevenue = movies.filter(m => m.partnerId).reduce((acc, m) => acc + ((m.views || 0) * (settings.royaltyPerView || 0.05)), 0);
            
            // New partners this month
            const now = Date.now();
            const oneMonthAgo = now - (30 * 24 * 60 * 60 * 1000);
            const newPartnersThisMonth = partners.filter(p => {
                const created = p.createdAt?.seconds ? (p.createdAt.seconds * 1000) : 0;
                return created >= oneMonthAgo;
            }).length;
            
            panel.innerHTML = `
                <!-- Enhanced Statistics Dashboard with Animations -->
                <div class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                    <div class="partners-stats-card bg-gradient-to-br from-green-900 to-green-700 p-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-green-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-green-200 text-xs font-semibold uppercase tracking-wide mb-1">Jami Hamkorlar</p>
                                <p class="text-4xl font-black text-white">${totalPartners}</p>
                                <p class="text-green-300 text-xs mt-2 flex items-center gap-1">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+${newPartnersThisMonth} bu oy</span>
                                </p>
                            </div>
                            <div class="bg-green-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-handshake text-3xl text-green-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="partners-stats-card bg-gradient-to-br from-blue-900 to-blue-700 p-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-blue-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-blue-200 text-xs font-semibold uppercase tracking-wide mb-1">Faol Hamkorlar</p>
                                <p class="text-4xl font-black text-white">${activePartners}</p>
                                <p class="text-blue-300 text-xs mt-2">${Math.round((activePartners / totalPartners) * 100) || 0}% barcha hamkorlar</p>
                            </div>
                            <div class="bg-blue-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-user-check text-3xl text-blue-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="partners-stats-card bg-gradient-to-br from-red-900 to-red-700 p-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-red-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-red-200 text-xs font-semibold uppercase tracking-wide mb-1">To'xtatilgan</p>
                                <p class="text-4xl font-black text-white">${suspendedPartners}</p>
                                <p class="text-red-300 text-xs mt-2">${Math.round((suspendedPartners / totalPartners) * 100) || 0}% barcha hamkorlar</p>
                            </div>
                            <div class="bg-red-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-user-slash text-3xl text-red-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="partners-stats-card bg-gradient-to-br from-purple-900 to-purple-700 p-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-purple-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-purple-200 text-xs font-semibold uppercase tracking-wide mb-1">Hamkor Kontenti</p>
                                <p class="text-4xl font-black text-white">${totalMoviesByPartners}</p>
                                <p class="text-purple-300 text-xs mt-2">Jami filmlar</p>
                            </div>
                            <div class="bg-purple-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-film text-3xl text-purple-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="partners-stats-card bg-gradient-to-br from-yellow-900 to-yellow-700 p-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-yellow-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-yellow-200 text-xs font-semibold uppercase tracking-wide mb-1">Ko'rishlar</p>
                                <p class="text-4xl font-black text-white">${totalPartnerViews.toLocaleString()}</p>
                                <p class="text-yellow-300 text-xs mt-2">Hamkor kontent</p>
                            </div>
                            <div class="bg-yellow-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-eye text-3xl text-yellow-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="partners-stats-card bg-gradient-to-br from-emerald-900 to-emerald-700 p-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300 border border-emerald-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-emerald-200 text-xs font-semibold uppercase tracking-wide mb-1">Daromad</p>
                                <p class="text-4xl font-black text-white">$${totalRevenue.toFixed(0)}</p>
                                <p class="text-emerald-300 text-xs mt-2">O'rtacha: $${(totalRevenue / totalPartners || 0).toFixed(0)}</p>
                            </div>
                            <div class="bg-emerald-800/40 backdrop-blur-sm p-4 rounded-xl">
                                <i class="fas fa-dollar-sign text-3xl text-emerald-200"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="partner-list-view">
                    <!-- Enhanced Header with Actions -->
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6 bg-gradient-to-r from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <div>
                            <h2 class="text-3xl font-black text-white flex items-center gap-3 mb-2">
                                <div class="bg-gradient-to-br from-green-500 to-green-600 p-3 rounded-xl shadow-lg">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                                <span data-lang-key="managePartners">Hamkorlarni Boshqarish</span>
                            </h2>
                            <p class="text-sm text-gray-400 flex items-center gap-2">
                                <i class="fas fa-info-circle"></i>
                                <span>Kontent hamkorlari va ularning ruxsatlarini boshqaring</span>
                            </p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button id="export-partners-btn" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                <i class="fas fa-file-export"></i>
                                <span>Eksport</span>
                            </button>
                            <button id="add-partner-btn" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                <i class="fas fa-plus-circle"></i>
                                <span data-lang-key="addPartner">Hamkor Qo'shish</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Search and Filters -->
                    <div class="mb-6 bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="relative md:col-span-2">
                                <input type="text" id="partner-search-input" onkeyup="filterPartners()" placeholder="ID, ism, email yoki kategoriya bo'yicha qidirish..." 
                                    class="w-full px-4 py-3 pl-12 bg-gray-700/50 backdrop-blur-sm border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" 
                                    data-lang-key="partnerSearchPlaceholder" />
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg"></i>
                            </div>
                            <select id="partner-status-filter" onchange="filterPartners()" class="px-4 py-3 bg-gray-700/50 backdrop-blur-sm border-2 border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition-all">
                                <option value="all">Barcha Hamkorlar</option>
                                <option value="active">Faol</option>
                                <option value="suspended">To'xtatilgan</option>
                                <option value="new">Yangi (30 kun)</option>
                            </select>
                            <select id="partner-category-filter" onchange="filterPartners()" class="px-4 py-3 bg-gray-700/50 backdrop-blur-sm border-2 border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition-all">
                                <option value="all">Barcha Kategoriyalar</option>
                                <option value="general">Filmlar & Seriallar</option>
                                <option value="sports">Sport</option>
                                <option value="challenge">Challenge</option>
                                <option value="snd">SND Originals</option>
                            </select>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="sortPartners('name')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded-lg transition-colors flex items-center gap-2">
                                <i class="fas fa-sort-alpha-down"></i> Ism bo'yicha
                            </button>
                            <button onclick="sortPartners('date')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded-lg transition-colors flex items-center gap-2">
                                <i class="fas fa-calendar"></i> Sana bo'yicha
                            </button>
                            <button onclick="sortPartners('content')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded-lg transition-colors flex items-center gap-2">
                                <i class="fas fa-film"></i> Kontent bo'yicha
                            </button>
                        </div>
                    </div>
                    
                    <div id="partners-table-container" class="bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700"></div>
                </div>
                <div id="partner-details-view" class="hidden"></div>`;
            renderPartnerTable(partners);
            document.getElementById('add-partner-btn').addEventListener('click', () => openPartnerModal());
            document.getElementById('export-partners-btn').addEventListener('click', exportPartnersToCSV);
            setDashboardLanguage(currentDashboardLanguage);
        }

        window.filterPartners = function() {
            const searchTerm = document.getElementById('partner-search-input')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('partner-status-filter')?.value || 'all';
            const categoryFilter = document.getElementById('partner-category-filter')?.value || 'all';
            
            const now = Date.now();
            const oneMonthAgo = now - (30 * 24 * 60 * 60 * 1000);
            
            const filtered = partners.filter(p => {
                // Text search
                const categories = Array.isArray(p.allowedCategories) ? p.allowedCategories.join(' ') : '';
                const matchesSearch = !searchTerm || 
                    (p.customId && p.customId.toLowerCase().includes(searchTerm)) ||
                    (p.displayName && p.displayName.toLowerCase().includes(searchTerm)) ||
                    (p.email && p.email.toLowerCase().includes(searchTerm)) ||
                    categories.toLowerCase().includes(searchTerm);
                
                // Status filter
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = !p.suspended;
                } else if (statusFilter === 'suspended') {
                    matchesStatus = p.suspended;
                } else if (statusFilter === 'new') {
                    const created = p.createdAt?.seconds ? (p.createdAt.seconds * 1000) : 0;
                    matchesStatus = created >= oneMonthAgo;
                }
                
                // Category filter
                const matchesCategory = categoryFilter === 'all' || 
                    (Array.isArray(p.allowedCategories) && p.allowedCategories.includes(categoryFilter));
                
                return matchesSearch && matchesStatus && matchesCategory;
            });
            
            renderPartnerTable(filtered);
        }
        
        let partnerSortOrder = { field: null, ascending: true };
        
        window.sortPartners = function(field) {
            const partnerSearchInput = document.getElementById('partner-search-input');
            if (!partnerSearchInput) return;
            
            // Toggle sort order if clicking same field
            if (partnerSortOrder.field === field) {
                partnerSortOrder.ascending = !partnerSortOrder.ascending;
            } else {
                partnerSortOrder.field = field;
                partnerSortOrder.ascending = true;
            }
            
            // Get current filtered list
            const searchTerm = partnerSearchInput.value.toLowerCase();
            const statusFilter = document.getElementById('partner-status-filter')?.value || 'all';
            const categoryFilter = document.getElementById('partner-category-filter')?.value || 'all';
            
            const now = Date.now();
            const oneMonthAgo = now - (30 * 24 * 60 * 60 * 1000);
            
            let filtered = partners.filter(p => {
                const categories = Array.isArray(p.allowedCategories) ? p.allowedCategories.join(' ') : '';
                const matchesSearch = !searchTerm || 
                    (p.customId && p.customId.toLowerCase().includes(searchTerm)) ||
                    (p.displayName && p.displayName.toLowerCase().includes(searchTerm)) ||
                    (p.email && p.email.toLowerCase().includes(searchTerm)) ||
                    categories.toLowerCase().includes(searchTerm);
                
                let matchesStatus = true;
                if (statusFilter === 'active') matchesStatus = !p.suspended;
                else if (statusFilter === 'suspended') matchesStatus = p.suspended;
                else if (statusFilter === 'new') {
                    const created = p.createdAt?.seconds ? (p.createdAt.seconds * 1000) : 0;
                    matchesStatus = created >= oneMonthAgo;
                }
                
                const matchesCategory = categoryFilter === 'all' || 
                    (Array.isArray(p.allowedCategories) && p.allowedCategories.includes(categoryFilter));
                
                return matchesSearch && matchesStatus && matchesCategory;
            });
            
            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;
                if (field === 'name') {
                    aVal = (a.displayName || '').toLowerCase();
                    bVal = (b.displayName || '').toLowerCase();
                } else if (field === 'date') {
                    aVal = a.createdAt?.seconds || 0;
                    bVal = b.createdAt?.seconds || 0;
                } else if (field === 'content') {
                    aVal = movies.filter(m => m.partnerId === a.uid).length;
                    bVal = movies.filter(m => m.partnerId === b.uid).length;
                }
                
                if (aVal < bVal) return partnerSortOrder.ascending ? -1 : 1;
                if (aVal > bVal) return partnerSortOrder.ascending ? 1 : -1;
                return 0;
            });
            
            renderPartnerTable(filtered);
        }

        function renderPartnerTable(partnerList) {
             const container = document.getElementById('partners-table-container');
             if (!container) return;
             
             if (partnerList.length === 0) {
                 container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="inline-block p-6 bg-gray-700 rounded-full mb-4">
                            <i class="fas fa-users text-5xl text-gray-500"></i>
                        </div>
                        <p class="text-xl text-gray-400 font-semibold">Hamkorlar topilmadi</p>
                        <p class="text-sm text-gray-500 mt-2">Filtrlash shartlarini o'zgartiring yoki yangi hamkor qo'shing</p>
                    </div>
                 `;
                 return;
             }
             
             const tableHeaders = `
            <thead class="bg-gradient-to-r from-gray-700 to-gray-800">
                <tr>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-user"></i>
                            <span data-lang-key="name">Ism</span>
                        </div>
                    </th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-envelope"></i>
                            <span>Email</span>
                        </div>
                    </th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-tags"></i>
                            <span data-lang-key="partnerCategoriesLabel">Kategoriyalar</span>
                        </div>
                    </th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-film"></i>
                            <span>Kontent</span>
                        </div>
                    </th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-signal"></i>
                            <span>Holat</span>
                        </div>
                    </th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-id-card"></i>
                            <span data-lang-key="customId">ID</span>
                        </div>
                    </th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-ellipsis-h"></i>
                            <span>Actions</span>
                        </div>
                    </th>
                </tr>
            </thead>`;
            
            const tableRows = partnerList.map(p => {
                const partnerMovies = movies.filter(m => m.partnerId === p.uid);
                const contentCount = partnerMovies.length;
                const totalViews = partnerMovies.reduce((acc, m) => acc + (m.views || 0), 0);
                const statusBadge = p.suspended 
                    ? '<span class="px-3 py-1 bg-red-500/20 text-red-400 text-xs font-bold rounded-full border border-red-500/50"><i class="fas fa-ban mr-1"></i>To\'xtatilgan</span>'
                    : '<span class="px-3 py-1 bg-green-500/20 text-green-400 text-xs font-bold rounded-full border border-green-500/50"><i class="fas fa-check-circle mr-1"></i>Faol</span>';
                
                const categoriesHtml = Array.isArray(p.allowedCategories) && p.allowedCategories.length > 0 
                    ? p.allowedCategories.map(val => {
                        const option = PARTNER_CATEGORY_OPTIONS.find(opt => opt.value === val);
                        const label = option ? option.label : val;
                        return `<span class="px-2 py-1 bg-blue-500/20 text-blue-300 text-xs rounded-md border border-blue-500/30">${label}</span>`;
                    }).join(' ')
                    : '<span class="text-gray-500 text-xs">-</span>';
                
                return `
            <tr class="table-row hover:bg-gray-700/50 border-b border-gray-700/50 transition-all" data-id="${p.uid}">
                <td class="p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-white font-bold text-sm shadow-lg">
                            ${(p.displayName || 'P').charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="text-sm font-bold text-white">${p.displayName || 'N/A'}</p>
                            <p class="text-xs text-gray-400">${new Date(p.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString('uz-UZ')}</p>
                        </div>
                    </div>
                </td>
                <td class="p-4">
                    <p class="text-sm text-gray-300">${p.email}</p>
                </td>
                <td class="p-4">
                    <div class="flex flex-wrap gap-1">
                        ${categoriesHtml}
                    </div>
                </td>
                <td class="p-4">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-white">${contentCount}</span>
                        <span class="text-xs text-gray-400">filmlar</span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <i class="fas fa-eye text-xs text-gray-500"></i>
                        <span class="text-xs text-gray-400">${totalViews.toLocaleString()}</span>
                    </div>
                </td>
                <td class="p-4">
                    ${statusBadge}
                </td>
                <td class="p-4">
                    <span class="text-sm font-mono font-semibold text-blue-400">${p.customId || '-'}</span>
                    <p class="text-xs text-gray-500 mt-1 truncate" style="max-width: 120px;" title="${p.uid}">${p.uid}</p>
                </td>
                <td class="p-4">
                    <div class="flex items-center gap-2">
                        <button class="view-partner-btn bg-gray-700 hover:bg-gray-600 text-white text-xs py-2 px-3 rounded-md" data-id="${p.uid}"><i class="fas fa-eye mr-2"></i>Ko'rish</button>
                        <button class="edit-partner-btn bg-blue-600 hover:bg-blue-500 text-white text-xs py-2 px-3 rounded-md" data-id="${p.uid}"><i class="fas fa-edit mr-2"></i>O'zgartirish</button>
                        <button class="suspend-partner-btn ${p.suspended ? 'bg-red-600 hover:bg-red-500' : 'bg-yellow-600 hover:bg-yellow-500'} text-white text-xs py-2 px-3 rounded-md" data-id="${p.uid}">
                            <i class="fas ${p.suspended ? 'fa-unlock' : 'fa-ban'} mr-2"></i>${p.suspended ? 'Qayta tiklash' : 'To\'xtatish'}
                        </button>
                    </div>
                </td>
            </tr>`;
            }).join('');
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full min-w-full">
                        ${tableHeaders}
                        <tbody class="bg-gray-800/50">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
                <div class="bg-gray-700/30 px-6 py-4 border-t border-gray-700">
                    <p class="text-sm text-gray-400">
                        <i class="fas fa-info-circle mr-2"></i>
                        Jami <span class="font-bold text-white">${partnerList.length}</span> hamkor ko'rsatilmoqda
                    </p>
                </div>
            `;
            
            // Row click shows details, but action buttons stop propagation and run their own handlers
            container.querySelectorAll('tr[data-id]').forEach(row => {
                row.addEventListener('click', (e) => showPartnerDetails(e.currentTarget.dataset.id));
            });

            // Action buttons
            container.querySelectorAll('.view-partner-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = e.currentTarget.dataset.id;
                    showPartnerDetails(id);
                });
            });
            container.querySelectorAll('.edit-partner-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditPartnerModal(e.currentTarget.dataset.id);
                });
            });
            container.querySelectorAll('.suspend-partner-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const id = e.currentTarget.dataset.id;
                    await togglePartnerSuspend(id);
                    filterPartners();
                });
            });

            setDashboardLanguage(currentDashboardLanguage);
        }
        
        // Export partners to CSV
        function exportPartnersToCSV() {
            const csvHeaders = ['ID', 'Name', 'Email', 'Categories', 'Status', 'Content Count', 'Total Views', 'Created Date', 'UID'];
            const csvRows = partners.map(p => {
                const partnerMovies = movies.filter(m => m.partnerId === p.uid);
                const contentCount = partnerMovies.length;
                const totalViews = partnerMovies.reduce((acc, m) => acc + (m.views || 0), 0);
                const status = p.suspended ? 'To\'xtatilgan' : 'Faol';
                const categories = Array.isArray(p.allowedCategories) 
                    ? p.allowedCategories.map(val => {
                        const option = PARTNER_CATEGORY_OPTIONS.find(opt => opt.value === val);
                        return option ? option.label : val;
                    }).join('; ')
                    : '-';
                const createdDate = p.createdAt?.seconds 
                    ? new Date(p.createdAt.seconds * 1000).toLocaleDateString('uz-UZ')
                    : '-';
                
                return [
                    p.customId || '-',
                    p.displayName || 'N/A',
                    p.email || '-',
                    categories,
                    status,
                    contentCount,
                    totalViews,
                    createdDate,
                    p.uid
                ];
            });
            
            const csvContent = [
                csvHeaders.join(','),
                ...csvRows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `hamkorlar_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Hamkorlar ro\'yxati eksport qilindi!', false);
        }

        // Open edit modal for existing partner
        async function openEditPartnerModal(partnerId) {
            const partner = partners.find(p => p.uid === partnerId);
            if (!partner) { showToast('Hamkor topilmadi', true); return; }

            const selectableCategories = PARTNER_CATEGORY_OPTIONS.filter(opt => !opt.adminOnly);
            const categoryCheckboxes = selectableCategories.map(opt => `
                <label class="flex items-center gap-2 text-sm text-gray-300">
                    <input type="checkbox" class="partner-category-checkbox h-4 w-4 text-red-500" value="${opt.value}" ${Array.isArray(partner.allowedCategories) && partner.allowedCategories.includes(opt.value) ? 'checked' : ''}>
                    <span>${opt.label}</span>
                </label>`).join('');

            const regionCheckboxes = centralAsiaRegions.map(r => `
                <label class="flex items-center gap-2 text-sm text-gray-300">
                    <input type="checkbox" class="partner-region-checkbox h-4 w-4 text-blue-500" value="${r.code}" ${Array.isArray(partner.allowedRegions) && partner.allowedRegions.includes(r.code) ? 'checked' : ''}>
                    <span>${r.flag} ${r.name}</span>
                </label>`).join('');

            const modalHTML = `
            <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative max-h-[90vh] overflow-y-auto">
                <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
                <h3 class="text-2xl font-bold mb-6">Hamkorni tahrirlash</h3>
                <form id="partner-edit-form">
                    <div class="space-y-4">
                        <input type="text" id="partner-name-edit" class="modal-input w-full p-2 rounded-md" placeholder="–ò–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞" required value="${partner.displayName || ''}">
                        <input type="email" id="partner-email-edit" class="modal-input w-full p-2 rounded-md" placeholder="Email" required value="${partner.email || ''}">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-200">Kategoriyalar</span>
                                <span class="text-xs text-gray-500">Tanlang</span>
                            </div>
                            <div class="flex flex-wrap gap-3 bg-gray-900/60 p-3 rounded-lg">
                                ${categoryCheckboxes}
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-200">Hududlar / –†–µ–≥–∏–æ–Ω—ã</span>
                                <span class="text-xs text-gray-500">Ko'rinish hududlari</span>
                            </div>
                            <div class="flex flex-wrap gap-3 bg-gray-900/60 p-3 rounded-lg">
                                ${regionCheckboxes}
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex gap-3">
                        <button type="submit" class="action-btn w-full text-white font-bold py-2 px-4 rounded-lg">Saqlash</button>
                        <button type="button" id="delete-partner-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">O'chirish</button>
                    </div>
                </form>
            </div>`;

            document.getElementById('modal-overlay').innerHTML = modalHTML;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);

            document.getElementById('partner-edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const displayName = document.getElementById('partner-name-edit').value.trim();
                const email = document.getElementById('partner-email-edit').value.trim();
                const allowedCategories = Array.from(document.querySelectorAll('.partner-category-checkbox:checked')).map(i => i.value);
                const allowedRegions = Array.from(document.querySelectorAll('.partner-region-checkbox:checked')).map(i => i.value);

                try {
                    await updateDoc(doc(db, 'users', partnerId), {
                        displayName,
                        email,
                        allowedCategories,
                        allowedRegions
                    });
                    showToast('Hamkor yangilandi');
                    closeModal();
                    // refresh local list (simple approach)
                    const pIndex = partners.findIndex(p => p.uid === partnerId);
                    if (pIndex > -1) {
                        partners[pIndex] = { ...partners[pIndex], displayName, email, allowedCategories, allowedRegions };
                    }
                    filterPartners();
                } catch (err) {
                    console.error('Error updating partner', err);
                    showToast('Xatolik: yangilash amalga oshmadi', true);
                }
            });

            document.getElementById('delete-partner-btn').addEventListener('click', async () => {
                if (!confirm('Hamkorni o\'chirmoqchimisiz? Bu qaytarilmaydi.')) return;
                try {
                    await deleteDoc(doc(db, 'users', partnerId));
                    showToast('Hamkor o\'chirildi');
                    closeModal();
                    partners = partners.filter(p => p.uid !== partnerId);
                    filterPartners();
                } catch (err) {
                    console.error('Error deleting partner', err);
                    showToast('Xatolik: o\'chirish amalga oshmadi', true);
                }
            });
        }

        // Toggle suspend state
        async function togglePartnerSuspend(partnerId) {
            const partner = partners.find(p => p.uid === partnerId);
            if (!partner) { showToast('Hamkor topilmadi', true); return; }
            const newState = !partner.suspended;
            try {
                await updateDoc(doc(db, 'users', partnerId), { suspended: newState });
                partner.suspended = newState;
                showToast(newState ? 'Hamkor to\'xtatildi' : 'Hamkor qayta tiklandi');
            } catch (err) {
                console.error('Error toggling suspend', err);
                showToast('Xatolik: amal bajarilmadi', true);
            }
        }
        
        // --- FOYDALANUVCHILAR PANELI UCHUN YANGI FUNKSIYALAR ---
        
        function renderUsersPanel() {
            const panel = document.getElementById('users-panel');
            
            // Calculate statistics
            const totalUsers = users.length;
            const activeToday = users.filter(u => {
                const lastActive = u.lastActive?.seconds ? new Date(u.lastActive.seconds * 1000) : null;
                if (!lastActive) return false;
                const today = new Date();
                return lastActive.toDateString() === today.toDateString();
            }).length;
            const premiumUsers = users.filter(u => u.isPremium || u.subscriptionStatus === 'active').length;
            const totalRevenue = users.reduce((acc, u) => acc + (u.totalSpent || 0), 0);
            
            panel.innerHTML = `
                <!-- Statistics Dashboard -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-200 text-sm font-medium">Total Users</p>
                                <p class="text-3xl font-bold text-white mt-1">${totalUsers}</p>
                            </div>
                            <div class="bg-blue-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-users text-2xl text-blue-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-900 to-green-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-200 text-sm font-medium">Active Today</p>
                                <p class="text-3xl font-bold text-white mt-1">${activeToday}</p>
                            </div>
                            <div class="bg-green-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-user-check text-2xl text-green-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-200 text-sm font-medium">Premium Users</p>
                                <p class="text-3xl font-bold text-white mt-1">${premiumUsers}</p>
                            </div>
                            <div class="bg-yellow-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-crown text-2xl text-yellow-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-200 text-sm font-medium">Total Revenue</p>
                                <p class="text-3xl font-bold text-white mt-1">$${totalRevenue.toFixed(0)}</p>
                            </div>
                            <div class="bg-purple-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-dollar-sign text-2xl text-purple-200"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="user-list-view">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                                <i class="fas fa-users-cog text-blue-400"></i>
                                Users Management
                            </h2>
                            <p class="text-sm text-gray-400 mt-1">Monitor and manage platform users</p>
                        </div>
                        <button id="export-users-csv" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            <i class="fas fa-file-export"></i>
                            <span>Export CSV</span>
                        </button>
                    </div>
                    
                    <!-- Search and Filters -->
                    <div class="mb-6 bg-gray-800 p-4 rounded-lg shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div class="relative md:col-span-2">
                                <input type="text" id="user-search-input" onkeyup="filterUsers()" placeholder="Search by name, email, or ID..." 
                                    class="w-full px-4 py-2 pl-10 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    data-lang-key="userSearchPlaceholder" />
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <select id="user-status-filter" onchange="filterUsers()" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Users</option>
                                <option value="premium">Premium Only</option>
                                <option value="active">Active Today</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="users-table-container" class="bg-gray-800 rounded-lg shadow-xl overflow-hidden"></div>
                </div>
                <div id="user-details-view" class="hidden"></div>
            `;
            renderUserTable(users);
            
            // Export CSV functionality
            document.getElementById('export-users-csv')?.addEventListener('click', () => {
                const headers = ['Name', 'Email', 'Custom ID', 'Firebase UID', 'Premium', 'Created At'];
                const rows = users.map(u => {
                    const createdAt = u.createdAt?.toDate ? new Date(u.createdAt.toDate()).toISOString() : '';
                    return [
                        u.displayName || 'N/A',
                        u.email || '',
                        u.customId || '',
                        u.uid || '',
                        u.isPremium ? 'Yes' : 'No',
                        createdAt
                    ].map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
                });
                
                const csv = [headers.join(','), ...rows].join('\\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                showToast('Users exported successfully');
            });
            
            setDashboardLanguage(currentDashboardLanguage);
        }

        window.filterUsers = function() {
            const searchTerm = document.getElementById('user-search-input')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('user-status-filter')?.value || 'all';
            
            let filteredUsers = [...users];
            
            // Apply search filter
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u =>
                    (u.customId && u.customId.toLowerCase().includes(searchTerm)) ||
                    (u.displayName && u.displayName.toLowerCase().includes(searchTerm)) ||
                    (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                    (u.uid && u.uid.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply status filter
            if (statusFilter === 'premium') {
                filteredUsers = filteredUsers.filter(u => u.isPremium || u.subscriptionStatus === 'active');
            } else if (statusFilter === 'active') {
                filteredUsers = filteredUsers.filter(u => {
                    const lastActive = u.lastActive?.seconds ? new Date(u.lastActive.seconds * 1000) : null;
                    if (!lastActive) return false;
                    const today = new Date();
                    return lastActive.toDateString() === today.toDateString();
                });
            } else if (statusFilter === 'inactive') {
                filteredUsers = filteredUsers.filter(u => {
                    const lastActive = u.lastActive?.seconds ? new Date(u.lastActive.seconds * 1000) : null;
                    if (!lastActive) return true;
                    const daysSinceActive = Math.floor((Date.now() - lastActive.getTime()) / (1000 * 60 * 60 * 24));
                    return daysSinceActive > 30;
                });
            }
            
            renderUserTable(filteredUsers);
        }

        function renderUserTable(userList) {
            const container = document.getElementById('users-table-container');
            if (!container) return;

            if (userList.length === 0) {
                container.innerHTML = `<div class="text-center py-12">
                    <i class="fas fa-user-slash text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-500 text-lg">No users found</p>
                </div>`;
                return;
            }

            const tableHeaders = `
            <thead class="bg-gray-800">
                <tr class="border-b border-gray-700">
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="name">Name</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">Email</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="customId">ID</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">Status</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">Last Active</th>
                    <th class="p-4 text-center text-xs font-bold uppercase tracking-wider text-gray-400">Actions</th>
                </tr>
            </thead>`;
            const tableRows = userList.map(u => {
                // Status badge
                const isPremium = u.isPremium || u.subscriptionStatus === 'active';
                const statusBadge = isPremium 
                    ? '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-900 text-yellow-200 border border-yellow-700"><i class="fas fa-crown"></i> Premium</span>'
                    : '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-300 border border-gray-600"><i class="fas fa-user"></i> Free</span>';
                
                // Last active
                let lastActiveText = 'Never';
                let lastActiveClass = 'text-gray-500';
                if (u.lastActive?.seconds) {
                    const lastActiveDate = new Date(u.lastActive.seconds * 1000);
                    const daysSince = Math.floor((Date.now() - lastActiveDate.getTime()) / (1000 * 60 * 60 * 24));
                    if (daysSince === 0) {
                        lastActiveText = 'Today';
                        lastActiveClass = 'text-green-400 font-semibold';
                    } else if (daysSince === 1) {
                        lastActiveText = 'Yesterday';
                        lastActiveClass = 'text-blue-400';
                    } else if (daysSince < 7) {
                        lastActiveText = `${daysSince} days ago`;
                        lastActiveClass = 'text-yellow-400';
                    } else if (daysSince < 30) {
                        lastActiveText = `${Math.floor(daysSince / 7)} weeks ago`;
                        lastActiveClass = 'text-orange-400';
                    } else {
                        lastActiveText = `${Math.floor(daysSince / 30)} months ago`;
                        lastActiveClass = 'text-red-400';
                    }
                }
                
                return `
            <tr class="border-b border-gray-700 hover:bg-gray-750 transition-colors cursor-pointer" data-id="${u.uid}">
                <td class="p-4 text-sm text-white font-medium">${u.displayName || 'Anonymous'}</td>
                <td class="p-4 text-sm text-gray-300">${u.email || 'N/A'}</td>
                <td class="p-4 text-sm font-mono text-blue-400">${u.customId || '-'}</td>
                <td class="p-4">${statusBadge}</td>
                <td class="p-4 text-sm ${lastActiveClass}">${lastActiveText}</td>
                <td class="p-4 text-center">
                    <button class="view-user-btn w-10 h-10 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors shadow-lg hover:shadow-xl" data-id="${u.uid}" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>`;
            }).join('');
            
            container.innerHTML = `<div class="overflow-x-auto"><table class="w-full min-w-full">${tableHeaders}<tbody class="divide-y divide-gray-700">${tableRows}</tbody></table></div>`;
            
            container.querySelectorAll('tr[data-id]').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        showUserDetails(row.dataset.id);
                    }
                });
            });
            
            container.querySelectorAll('.view-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showUserDetails(btn.dataset.id);
                });
            });
            
            setDashboardLanguage(currentDashboardLanguage);
        }

        async function showUserDetails(userId) {
            document.getElementById('user-list-view').classList.add('hidden');
            const detailsView = document.getElementById('user-details-view');
            detailsView.classList.remove('hidden');
            detailsView.innerHTML = `<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin text-white text-3xl"></i></div>`;

            // Ma'lumotlar bazasidan eng so'nggi ma'lumotni olish
            const userRef = doc(db, "users", userId);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                detailsView.innerHTML = `<p data-lang-key="userNotFound"></p>`;
                setDashboardLanguage(currentDashboardLanguage);
                return;
            }
            const user = userDoc.data();

            const registrationDate = user.createdAt?.toDate ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'Noma\'lum';
            
            detailsView.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold" data-lang-key="userDetails"></h2>
                        <button id="back-to-users-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" data-lang-key="back"></button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-900 p-4 rounded-lg space-y-3">
                            <div><strong class="text-gray-400 w-40 inline-block" data-lang-key="name"></strong> <span class="font-semibold">${user.displayName || 'N/A'}</span></div>
                            <div><strong class="text-gray-400 w-40 inline-block">Email:</strong> <span>${user.email}</span></div>
                            <div><strong class="text-gray-400 w-40 inline-block" data-lang-key="registrationDate"></strong> <span>${registrationDate}</span></div>
                        </div>
                        <div class="bg-gray-900 p-4 rounded-lg space-y-3">
                            <div><strong class="text-gray-400 w-40 inline-block">Firebase UID:</strong> <code class="text-sm text-gray-400 break-all">${user.uid}</code></div>
                            <div class="flex items-center">
                                <strong class="text-gray-400 w-40 inline-block" data-lang-key="assignedId"></strong>
                                <code class="text-lg text-green-400">${user.customId || 'Mavjud emas'}</code>
                            </div>
                        </div>
                    </div>

                    <!-- Account Recovery Section -->
                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <h3 class="text-xl font-bold mb-4" data-lang-key="accountRecovery"></h3>
                        <div id="recovery-section" class="bg-gray-900 p-4 rounded-lg">
                            <div id="secret-word-prompt">
                                <p class="text-gray-400 mb-2" data-lang-key="enterSecretWord"></p>
                                <div class="flex gap-2">
                                    <input type="password" id="secret-word-input" class="modal-input w-full p-2 rounded-md" data-lang-key="secretWord" placeholder="Maxfiy so'z">
                                    <button id="confirm-secret-word-btn" class="action-btn text-white font-bold py-2 px-4 rounded-lg"><span data-lang-key="confirm"></span></button>
                                </div>
                                <p id="secret-word-error" class="text-red-500 text-sm mt-2 h-4"></p>
                            </div>
                            <div id="recovery-code-display" class="hidden text-center">
                                <h4 class="text-lg font-semibold" data-lang-key="tempCodeForLogin"></h4>
                                <p id="temp-code" class="text-2xl font-mono tracking-widest bg-black p-3 rounded-lg my-3 break-all cursor-pointer" title="Nusxalash"></p>
                                <p class="text-gray-400 text-sm">
                                    <span data-lang-key="codeWillUpdateIn"></span>
                                    <span id="countdown-timer" class="font-bold text-white">30</span>
                                    <span data-lang-key="seconds"></span>
                                </p>
                                <h4 class="text-lg font-semibold mt-6" data-lang-key="qrCodeForLogin"></h4>
                                <div id="qrcode-container"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <button id="archive-user-btn" data-id="${user.uid}" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                            <i class="fas fa-archive"></i> <span data-lang-key="archiveUser"></span>
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('back-to-users-btn').addEventListener('click', () => {
                if (tempCodeInterval) clearInterval(tempCodeInterval);
                detailsView.classList.add('hidden');
                document.getElementById('user-list-view').classList.remove('hidden');
            });
            document.getElementById('archive-user-btn').addEventListener('click', (e) => {
                const userIdToArchive = e.currentTarget.dataset.id;
                const title = dashboardTranslations[currentDashboardLanguage].archiveUserConfirmTitle;
                const message = dashboardTranslations[currentDashboardLanguage].archiveUserConfirmMessage;
                openConfirmationModal(title, message, () => archiveUser(userIdToArchive), "archive");
            });
            document.getElementById('confirm-secret-word-btn').addEventListener('click', () => {
                const input = document.getElementById('secret-word-input').value;
                const errorEl = document.getElementById('secret-word-error');
                if (input === user.secretWord) {
                    errorEl.textContent = '';
                    document.getElementById('secret-word-prompt').classList.add('hidden');
                    document.getElementById('recovery-code-display').classList.remove('hidden');
                    startTempCodeGeneration(user.uid, user.email);
                } else {
                    errorEl.textContent = dashboardTranslations[currentDashboardLanguage].wrongSecretWord;
                }
            });
            document.getElementById('temp-code')?.addEventListener('click', (e) => {
                navigator.clipboard.writeText(e.target.textContent);
                showToast("Kod nusxalandi!");
            });

            setDashboardLanguage(currentDashboardLanguage);
        }

        let userFeedbackReports = [];
        let unsubFeedback = null;
        
        function renderRequestsPanel() {
            const panel = document.getElementById('requests-panel');
            
            // Calculate statistics - include both termination requests AND user feedback
            const totalRequests = terminationRequests.length + userFeedbackReports.length;
            const pendingRequests = terminationRequests.filter(r => r.status === 'pending' || !r.status).length + 
                                    userFeedbackReports.filter(r => r.status === 'pending' || !r.status).length;
            const thisWeekRequests = [...terminationRequests, ...userFeedbackReports].filter(r => {
                if (!r.timestamp && !r.createdAt) return false;
                const reqDate = new Date(r.timestamp || r.createdAt);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return reqDate >= weekAgo;
            }).length;
            
            panel.innerHTML = `
                <!-- Statistics Dashboard -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-red-900 to-red-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-200 text-sm font-medium">Total Requests</p>
                                <p class="text-3xl font-bold text-white mt-1">${totalRequests}</p>
                            </div>
                            <div class="bg-red-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-file-alt text-2xl text-red-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-200 text-sm font-medium">Pending</p>
                                <p class="text-3xl font-bold text-white mt-1">${pendingRequests}</p>
                            </div>
                            <div class="bg-yellow-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-hourglass-half text-2xl text-yellow-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-200 text-sm font-medium">This Week</p>
                                <p class="text-3xl font-bold text-white mt-1">${thisWeekRequests}</p>
                            </div>
                            <div class="bg-blue-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-calendar-week text-2xl text-blue-200"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Header with Tabs -->
                <div class="flex flex-col gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                            <i class="fas fa-clipboard-list text-red-400"></i>
                            Requests & Feedback
                        </h2>
                        <p class="text-sm text-gray-400 mt-1">Manage partner terminations and user feedback reports</p>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="flex gap-2 bg-gray-800 p-1 rounded-lg w-fit">
                        <button id="tab-terminations" class="px-4 py-2 rounded-lg font-medium transition-all bg-red-600 text-white">
                            <i class="fas fa-user-times mr-2"></i>
                            Terminations (${terminationRequests.length})
                        </button>
                        <button id="tab-feedback" class="px-4 py-2 rounded-lg font-medium transition-all text-gray-400 hover:text-white">
                            <i class="fas fa-bug mr-2"></i>
                            User Feedback (${userFeedbackReports.length})
                        </button>
                    </div>
                </div>
                
                <!-- Actions Bar -->
                <div id="requests-actions-bar"></div>
                
                <!-- Search Bar -->
                <div id="requests-search-bar" class="mb-6 bg-gray-800 p-4 rounded-lg shadow-lg hidden">
                    <div class="relative">
                        <input type="text" id="requests-search-input" placeholder="Search..." 
                            class="w-full px-4 py-2 pl-10 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500" />
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <div id="requests-table-container"></div>
            `;
            
            // Track current view
            let currentRequestView = 'terminations';
            
            // Function to render terminations
            function showTerminations() {
                currentRequestView = 'terminations';
                document.getElementById('tab-terminations').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-red-600 text-white';
                document.getElementById('tab-feedback').className = 'px-4 py-2 rounded-lg font-medium transition-all text-gray-400 hover:text-white';
                
                const actionsBar = document.getElementById('requests-actions-bar');
                if (!actionsBar) {
                    console.error('requests-actions-bar element not found');
                    return;
                }
                if (terminationRequests.length > 0) {
                    actionsBar.innerHTML = `
                        <div class="flex gap-2 mb-6">
                            <button id="bulk-approve-btn" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-check-double"></i>
                                <span>Approve All</span>
                            </button>
                            <button id="bulk-decline-btn" class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-times"></i>
                                <span>Decline All</span>
                            </button>
                        </div>
                    `;
                    document.getElementById('requests-search-bar').classList.remove('hidden');
                    document.getElementById('requests-search-input').placeholder = 'Search by partner name or ID...';
                    
                    document.getElementById('bulk-approve-btn').addEventListener('click', () => {
                        if (confirm(`Approve all ${terminationRequests.length} termination requests?`)) {
                            terminationRequests.forEach(req => acceptTerminationRequest(req.id, req.partnerId));
                            showToast('Processing all approvals...');
                        }
                    });
                    document.getElementById('bulk-decline-btn').addEventListener('click', () => {
                        if (confirm(`Decline all ${terminationRequests.length} termination requests?`)) {
                            terminationRequests.forEach(req => declineTerminationRequest(req.id));
                            showToast('Processing all declines...');
                        }
                    });
                } else {
                    actionsBar.innerHTML = '';
                    document.getElementById('requests-search-bar').classList.add('hidden');
                }
                
                renderRequestsTable(terminationRequests);
            }
            
            // Function to render feedback
            function showFeedback() {
                console.log('showFeedback called');
                console.log('userFeedbackReports:', userFeedbackReports);
                currentRequestView = 'feedback';
                document.getElementById('tab-terminations').className = 'px-4 py-2 rounded-lg font-medium transition-all text-gray-400 hover:text-white';
                document.getElementById('tab-feedback').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-red-600 text-white';
                
                const actionsBar = document.getElementById('requests-actions-bar');
                if (!actionsBar) {
                    console.error('requests-actions-bar element not found!');
                    return;
                }
                if (userFeedbackReports.length > 0) {
                    actionsBar.innerHTML = `
                        <div class="flex gap-2 mb-6">
                            <button id="bulk-mark-resolved-btn" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-check-circle"></i>
                                <span>Mark All Resolved</span>
                            </button>
                            <button id="bulk-delete-feedback-btn" class="bg-gradient-to-r from-gray-600 to-gray-500 hover:from-gray-500 hover:to-gray-400 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-trash"></i>
                                <span>Delete All</span>
                            </button>
                        </div>
                    `;
                    document.getElementById('requests-search-bar').classList.remove('hidden');
                    document.getElementById('requests-search-input').placeholder = 'Search by user name, type, or description...';
                    
                    document.getElementById('bulk-mark-resolved-btn').addEventListener('click', () => {
                        if (confirm(`Mark all ${userFeedbackReports.length} feedback reports as resolved?`)) {
                            userFeedbackReports.forEach(fb => markFeedbackResolved(fb.id));
                            showToast('Marking all as resolved...');
                        }
                    });
                    document.getElementById('bulk-delete-feedback-btn').addEventListener('click', () => {
                        if (confirm(`Delete all ${userFeedbackReports.length} feedback reports?`)) {
                            userFeedbackReports.forEach(fb => deleteFeedback(fb.id));
                            showToast('Deleting all feedback...');
                        }
                    });
                } else {
                    actionsBar.innerHTML = '';
                    document.getElementById('requests-search-bar').classList.add('hidden');
                }
                
                renderFeedbackTable(userFeedbackReports);
            }
            
            // Tab click handlers
            document.getElementById('tab-terminations').addEventListener('click', showTerminations);
            document.getElementById('tab-feedback').addEventListener('click', showFeedback);
            
            // Show terminations by default (wait for DOM to update)
            setTimeout(() => showTerminations(), 0);
            
            // Search functionality
            const searchInput = document.getElementById('requests-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    if (currentRequestView === 'terminations') {
                        const filtered = terminationRequests.filter(req => {
                            const partnerInfo = partners.find(p => p.uid === req.partnerId);
                            return (partnerInfo?.displayName && partnerInfo.displayName.toLowerCase().includes(searchTerm)) ||
                                   (partnerInfo?.customId && partnerInfo.customId.toLowerCase().includes(searchTerm)) ||
                                   (req.partnerId && req.partnerId.toLowerCase().includes(searchTerm));
                        });
                        renderRequestsTable(filtered);
                    } else {
                        const filtered = userFeedbackReports.filter(fb => {
                            const user = allUsers.find(u => u.uid === fb.userId);
                            return (user?.displayName && user.displayName.toLowerCase().includes(searchTerm)) ||
                                   (fb.type && fb.type.toLowerCase().includes(searchTerm)) ||
                                   (fb.description && fb.description.toLowerCase().includes(searchTerm)) ||
                                   (fb.userId && fb.userId.toLowerCase().includes(searchTerm));
                        });
                        renderFeedbackTable(filtered);
                    }
                });
            }

            setDashboardLanguage(currentDashboardLanguage);
        }
        
        // Render feedback reports table
        function renderFeedbackTable(feedbackList) {
            console.log('renderFeedbackTable called with', feedbackList?.length || 0, 'items');
            const container = document.getElementById('requests-table-container');
            if (!container) {
                console.error('requests-table-container not found');
                return;
            }
            
            if (feedbackList.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-gray-800 rounded-lg">
                        <i class="fas fa-comments text-5xl text-gray-600 mb-3"></i>
                        <p class="text-gray-400 text-lg">No user feedback reports yet</p>
                        <p class="text-gray-500 text-sm mt-1">User feedback will appear here when submitted</p>
                    </div>
                `;
                return;
            }
            
            const tableHeaders = `
                <thead class="table-header">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">User</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Type</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Description</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Date</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Status</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-300">Actions</th>
                    </tr>
                </thead>
            `;
            
            const tableRows = feedbackList.map(fb => {
                const user = allUsers.find(u => u.uid === fb.userId);
                const userName = user?.displayName || 'Unknown User';
                const userEmail = user?.email || fb.userId;
                const date = fb.createdAt ? new Date(fb.createdAt).toLocaleDateString('en-US', { 
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                }) : 'N/A';
                
                const typeColors = {
                    'bug': 'bg-red-500/20 text-red-400 border-red-500/30',
                    'error': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
                    'feature': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
                    'improvement': 'bg-green-500/20 text-green-400 border-green-500/30',
                    'other': 'bg-gray-500/20 text-gray-400 border-gray-500/30'
                };
                
                const typeIcons = {
                    'bug': 'fa-bug',
                    'error': 'fa-exclamation-triangle',
                    'feature': 'fa-lightbulb',
                    'improvement': 'fa-tools',
                    'other': 'fa-comment'
                };
                
                const typeClass = typeColors[fb.type] || typeColors['other'];
                const typeIcon = typeIcons[fb.type] || typeIcons['other'];
                const statusBadge = fb.status === 'resolved' 
                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-400 border border-green-500/30">Resolved</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">Pending</span>';
                
                return `
                    <tr class="table-row hover:bg-gray-700 transition-colors cursor-pointer" onclick="viewFeedbackDetails('${fb.id}')">
                        <td class="px-4 py-3">
                            <div class="flex flex-col">
                                <span class="font-medium text-white">${userName}</span>
                                <span class="text-xs text-gray-400">${userEmail}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full border ${typeClass} inline-flex items-center gap-1">
                                <i class="fas ${typeIcon}"></i>
                                ${fb.type.charAt(0).toUpperCase() + fb.type.slice(1)}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <p class="text-sm text-gray-300 line-clamp-2 max-w-md">${fb.description || 'No description provided'}</p>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-400">${date}</td>
                        <td class="px-4 py-3">${statusBadge}</td>
                        <td class="px-4 py-3" onclick="event.stopPropagation()">
                            <div class="flex items-center justify-center gap-2">
                                ${fb.status !== 'resolved' ? `
                                <button onclick="markFeedbackResolved('${fb.id}')" class="text-green-400 hover:text-green-300 transition-colors" title="Mark Resolved">
                                    <i class="fas fa-check-circle"></i>
                                </button>` : ''}
                                <button onclick="deleteFeedback('${fb.id}')" class="text-red-400 hover:text-red-300 transition-colors" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            container.innerHTML = `<table class="w-full min-w-full rounded-lg overflow-hidden">${tableHeaders}<tbody>${tableRows}</tbody></table>`;
        }
        
        // Feedback management functions
        async function markFeedbackResolved(feedbackId) {
            try {
                await updateDoc(doc(db, 'userFeedback', feedbackId), {
                    status: 'resolved',
                    resolvedAt: serverTimestamp()
                });
                showToast('Feedback marked as resolved');
            } catch (error) {
                console.error('Error marking feedback as resolved:', error);
                showToast('Failed to update feedback status', true);
            }
        }
        
        async function deleteFeedback(feedbackId) {
            if (!confirm('Are you sure you want to delete this feedback?')) return;
            try {
                await deleteDoc(doc(db, 'userFeedback', feedbackId));
                showToast('Feedback deleted successfully');
            } catch (error) {
                console.error('Error deleting feedback:', error);
                showToast('Failed to delete feedback', true);
            }
        }
        
        // AI Analysis Generator
        function generateAIAnalysis(feedback) {
            let problem = 'Unknown issue';
            let location = 'Not specified';
            let solution = 'Please investigate further';
            
            // Analyze console errors
            if (feedback.consoleErrors && feedback.consoleErrors.length > 0) {
                const firstError = feedback.consoleErrors[0];
                
                // Extract problem
                problem = firstError.message || firstError.type;
                
                // Extract location from stack trace
                if (firstError.stack) {
                    const stackMatch = firstError.stack.match(/at\s+(.+?)\s+\((.+?):(\d+):(\d+)\)/);
                    if (stackMatch) {
                        location = `${stackMatch[2]} (Line ${stackMatch[3]})`;
                    } else {
                        const simpleMatch = firstError.stack.match(/(\S+\.html):(\d+):(\d+)/);
                        if (simpleMatch) {
                            location = `${simpleMatch[1]} (Line ${simpleMatch[2]}:${simpleMatch[3]})`;
                        }
                    }
                }
                
                // Generate solution based on error type
                if (problem.includes('permission-denied')) {
                    solution = 'Check Firestore security rules. The user may not have permission to access this data. Review the rules in firestore.rules and ensure proper authentication checks.';
                } else if (problem.includes('undefined') || problem.includes('null')) {
                    solution = 'Add null/undefined checks before accessing the property. Use optional chaining (?.) or check if the object exists before accessing its properties.';
                } else if (problem.includes('fetch') || problem.includes('network')) {
                    solution = 'Check network connectivity and API endpoints. Verify that the requested resource exists and is accessible. Check CORS settings if making cross-origin requests.';
                } else if (problem.includes('Firebase') || problem.includes('Firestore')) {
                    solution = 'Review Firebase configuration and initialization. Check that Firebase services are properly configured and that the user has necessary permissions.';
                } else if (problem.includes('Cannot set properties')) {
                    solution = 'The element may not exist in the DOM yet. Use setTimeout or ensure the element exists before trying to modify it. Check that the element ID is correct.';
                } else {
                    solution = 'Review the stack trace to locate the exact error. Check the console for additional context. Ensure all dependencies are loaded and initialized properly.';
                }
            }
            
            return { problem, location, solution };
        }
        
        // VS Code Agent Prompt Generator
        function generateVSCodePrompt(feedback, aiAnalysis) {
            const errorContext = feedback.consoleErrors ? 
                feedback.consoleErrors.map(err => `${err.type}: ${err.message}\n${err.stack || ''}`).join('\n\n') : 
                'No console errors';
            
            return `Fix the following error in my web application:

**Error Description:**
${feedback.description || 'User reported an issue'}

**Error Type:** ${feedback.type}

**Console Errors:**
\`\`\`
${errorContext}
\`\`\`

**AI Analysis:**
- Problem: ${aiAnalysis.problem}
- Location: ${aiAnalysis.location}
- Suggested Solution: ${aiAnalysis.solution}

**Additional Context:**
${feedback.errorDetails || 'No additional details'}

Please analyze this error and provide a fix. Check the file location mentioned above, identify the root cause, and implement the necessary changes to resolve this issue.`;
        }
        
        // Copy to clipboard helper
        function copyToClipboard(text, successMsg = 'Copied!') {
            navigator.clipboard.writeText(text).then(() => {
                showToast(successMsg);
            }).catch(() => {
                showToast('Failed to copy', true);
            });
        }
        
        // Make copy function global
        window.copyToClipboard = copyToClipboard;
        
        async function viewFeedbackDetails(feedbackId) {
            const feedback = userFeedbackReports.find(fb => fb.id === feedbackId);
            if (!feedback) return;
            
            console.log('Feedback data:', feedback);
            console.log('Has consoleErrors:', !!feedback.consoleErrors);
            console.log('Has errorDetails:', !!feedback.errorDetails);
            
            const user = allUsers.find(u => u.uid === feedback.userId);
            const userName = user?.displayName || 'Unknown User';
            const userEmail = user?.email || feedback.userId;
            
            // Parse createdAt properly (Firestore Timestamp)
            let date = 'N/A';
            if (feedback.createdAt) {
                try {
                    // Check if it's a Firestore Timestamp
                    if (feedback.createdAt.toDate) {
                        date = feedback.createdAt.toDate().toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                        });
                    } else {
                        date = new Date(feedback.createdAt).toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                        });
                    }
                } catch (e) {
                    console.error('Date parse error:', e);
                    date = String(feedback.createdAt);
                }
            }
            
            const closeModalLocal = () => {
                const modal = document.getElementById('modal-overlay');
                modal.classList.add('hidden');
                modal.innerHTML = '';
            };
            
            // Parse error details and console errors from feedback
            let errorDetailsHtml = '';
            let consoleErrorsHtml = '';
            let aiAnalysisHtml = '';
            let vsCodePromptHtml = '';
            
            console.log('Checking errorDetails:', feedback.errorDetails);
            if (feedback.errorDetails) {
                errorDetailsHtml = `
                    <div class="bg-red-900/20 border border-red-700/50 rounded-lg p-4 mb-4">
                        <h3 class="text-sm font-semibold text-red-400 flex items-center gap-2 mb-3">
                            <i class="fas fa-exclamation-circle"></i>
                            Error Details
                        </h3>
                        <pre class="text-xs text-gray-300 whitespace-pre-wrap overflow-auto max-h-48 bg-black/30 p-3 rounded font-mono">${feedback.errorDetails}</pre>
                    </div>
                `;
            }
            
            console.log('Checking consoleErrors:', feedback.consoleErrors);
            if (feedback.consoleErrors && feedback.consoleErrors.length > 0) {
                console.log('Console errors found:', feedback.consoleErrors.length);
                const consoleText = feedback.consoleErrors.map(err => 
                    `[${err.timestamp || 'N/A'}] ${err.type}: ${err.message}${err.stack ? '\n' + err.stack : ''}`
                ).join('\n\n');
                
                consoleErrorsHtml = `
                    <div class="bg-orange-900/20 border border-orange-700/50 rounded-lg p-4 mb-4">
                        <h3 class="text-sm font-semibold text-orange-400 flex items-center gap-2 mb-3">
                            <i class="fas fa-terminal"></i>
                            Console Errors (${feedback.consoleErrors.length})
                        </h3>
                        <pre class="text-xs text-gray-300 whitespace-pre-wrap overflow-auto max-h-48 bg-black/30 p-3 rounded font-mono">${consoleText}</pre>
                    </div>
                `;
                
                // Generate AI Analysis
                console.log('Generating AI analysis...');
                const aiAnalysis = generateAIAnalysis(feedback);
                console.log('AI Analysis result:', aiAnalysis);
                aiAnalysisHtml = `
                    <div class="bg-blue-900/20 border border-blue-700/50 rounded-lg p-4 mb-4">
                        <h3 class="text-sm font-semibold text-blue-400 flex items-center gap-2 mb-3">
                            <i class="fas fa-robot"></i>
                            AI Analysis
                        </h3>
                        <div class="text-sm text-gray-300 space-y-2">
                            <div><strong class="text-blue-300">Problem:</strong> ${aiAnalysis.problem}</div>
                            <div><strong class="text-blue-300">Location:</strong> ${aiAnalysis.location}</div>
                            <div><strong class="text-blue-300">Solution:</strong> ${aiAnalysis.solution}</div>
                        </div>
                    </div>
                `;
                
                // Generate VS Code Agent Prompt
                console.log('Generating VS Code prompt...');
                const vsPrompt = generateVSCodePrompt(feedback, aiAnalysis);
                vsCodePromptHtml = `
                    <div class="bg-purple-900/20 border border-purple-700/50 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-purple-400 flex items-center gap-2">
                                <i class="fas fa-code"></i>
                                VS Code Agent Prompt
                            </h3>
                            <button onclick="copyToClipboard(\`${vsPrompt.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, 'Prompt copied!')" class="text-xs bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded transition-colors">
                                <i class="fas fa-copy mr-1"></i>Copy Prompt
                            </button>
                        </div>
                        <pre class="text-xs text-gray-300 whitespace-pre-wrap overflow-auto max-h-40 bg-black/30 p-3 rounded font-mono">${vsPrompt}</pre>
                    </div>
                `;
            }
            
            const modalHTML = `
                <div class="fixed inset-0 z-[60] bg-gray-900 overflow-y-auto">
                    <div class="min-h-screen p-6">
                        <button id="close-feedback-modal" class="fixed top-6 right-6 text-gray-400 hover:text-white transition-colors z-10 bg-gray-800 hover:bg-gray-700 rounded-full w-10 h-10 flex items-center justify-center">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                        
                        <div class="max-w-6xl mx-auto">
                            <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3">
                                <i class="fas fa-bug text-red-400"></i>
                                Feedback Details
                            </h2>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Left Column: User Info & Basic Details -->
                                <div class="lg:col-span-1 space-y-4">
                                    <!-- User Info -->
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                        <h3 class="text-sm font-semibold text-gray-400 mb-3 flex items-center gap-2">
                                            <i class="fas fa-user"></i>
                                            User Information
                                        </h3>
                                        <div class="space-y-2">
                                            <p class="text-white"><span class="text-gray-400">Name:</span> <strong>${userName}</strong></p>
                                            <p class="text-white"><span class="text-gray-400">Email:</span> ${userEmail}</p>
                                            <p class="text-white"><span class="text-gray-400">User ID:</span> <span class="font-mono text-xs">${feedback.userId}</span></p>
                                        </div>
                                    </div>
                                    
                                    <!-- Feedback Info -->
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                        <h3 class="text-sm font-semibold text-gray-400 mb-3 flex items-center gap-2">
                                            <i class="fas fa-info-circle"></i>
                                            Feedback Information
                                        </h3>
                                        <div class="space-y-2">
                                            <p class="text-white"><span class="text-gray-400">Type:</span> <span class="capitalize font-semibold">${feedback.type}</span></p>
                                            <p class="text-white"><span class="text-gray-400">Status:</span> <span class="capitalize">${feedback.status || 'pending'}</span></p>
                                            <p class="text-white"><span class="text-gray-400">Date:</span> ${date}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Description -->
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                        <h3 class="text-sm font-semibold text-gray-400 mb-3">Description</h3>
                                        <p class="text-white whitespace-pre-wrap text-sm">${feedback.description || 'No description provided'}</p>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="flex flex-col gap-2">
                                        ${feedback.status !== 'resolved' ? `
                                        <button id="modal-mark-resolved-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition-all">
                                            <i class="fas fa-check-circle mr-2"></i>
                                            Mark as Resolved
                                        </button>` : ''}
                                        <button id="modal-delete-feedback-btn" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-lg transition-all">
                                            <i class="fas fa-trash mr-2"></i>
                                            Delete Feedback
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Right Column: Technical Details -->
                                <div class="lg:col-span-2 space-y-4">
                                    ${errorDetailsHtml}
                                    ${consoleErrorsHtml}
                                    ${aiAnalysisHtml}
                                    ${vsCodePromptHtml}
                                    
                                    ${!errorDetailsHtml && !consoleErrorsHtml ? `
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-8 text-center">
                                        <i class="fas fa-info-circle text-4xl text-gray-600 mb-3"></i>
                                        <p class="text-gray-400">No technical details available for this feedback.</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalOverlay = document.getElementById('modal-overlay');
            modalOverlay.innerHTML = modalHTML;
            modalOverlay.classList.remove('hidden');
            
            document.getElementById('close-feedback-modal').addEventListener('click', closeModalLocal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModalLocal();
            });
            
            // Add event listeners for action buttons
            const markResolvedBtn = document.getElementById('modal-mark-resolved-btn');
            if (markResolvedBtn) {
                markResolvedBtn.addEventListener('click', () => {
                    markFeedbackResolved(feedback.id);
                    closeModalLocal();
                });
            }
            
            const deleteBtn = document.getElementById('modal-delete-feedback-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    deleteFeedback(feedback.id);
                    closeModalLocal();
                });
            }
        }
        
        // Make functions global
        window.markFeedbackResolved = markFeedbackResolved;
        window.deleteFeedback = deleteFeedback;
        window.viewFeedbackDetails = viewFeedbackDetails;
        
        function renderRequestsTable(requestList) {
            const container = document.getElementById('requests-table-container');
            if (!container) return;
            
            if (requestList.length === 0) {
                container.innerHTML = `<div class="bg-gray-800 rounded-lg p-12 text-center">
                    <i class="fas fa-inbox text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-400 text-lg" data-lang-key="noNewRequests">No pending requests</p>
                    <p class="text-gray-600 text-sm mt-2">All termination requests have been processed</p>
                </div>`;
                setDashboardLanguage(currentDashboardLanguage);
                return;
            }

            const tableHeaders = `
            <thead class="bg-gray-800">
                <tr class="border-b border-gray-700">
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="partnerId">Partner ID</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="name">Name</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">Email</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="requestDate">Request Date</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">Status</th>
                    <th class="p-4 text-center text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="actions">Actions</th>
                </tr>
            </thead>`;
            
            const tableRows = requestList.map(req => {
                const partnerInfo = partners.find(p => p.uid === req.partnerId);
                const requestDate = req.timestamp ? new Date(req.timestamp).toLocaleDateString('en-GB', {
                    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                }) : 'N/A';
                
                const statusBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-900 text-yellow-200 border border-yellow-700"><i class="fas fa-hourglass-half"></i> Pending</span>';
                
                return `
                <tr class="border-b border-gray-700 hover:bg-gray-750 transition-colors">
                    <td class="p-4 text-sm font-mono text-blue-400">${partnerInfo?.customId || req.partnerId.substring(0, 12)}</td>
                    <td class="p-4 text-sm text-white font-medium">${partnerInfo?.displayName || 'Unknown Partner'}</td>
                    <td class="p-4 text-sm text-gray-300">${partnerInfo?.email || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-400">${requestDate}</td>
                    <td class="p-4">${statusBadge}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-2">
                            <button class="accept-request-btn w-10 h-10 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-colors shadow-lg hover:shadow-xl" data-id="${req.id}" data-partner-id="${req.partnerId}" title="Accept Request">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="decline-request-btn w-10 h-10 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors shadow-lg hover:shadow-xl" data-id="${req.id}" title="Decline Request">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            
            container.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-full">${tableHeaders}<tbody class="divide-y divide-gray-700">${tableRows}</tbody></table>
                </div>
            </div>`;
            
            container.querySelectorAll('.accept-request-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const requestId = e.currentTarget.dataset.id;
                    const partnerId = e.currentTarget.dataset.partnerId;
                    const title = dashboardTranslations[currentDashboardLanguage].acceptRequestTitle || 'Accept Request?';
                    const message = dashboardTranslations[currentDashboardLanguage].acceptRequestMessage || 'Are you sure you want to accept this termination request?';
                    openConfirmationModal(title, message, () => acceptTerminationRequest(requestId, partnerId), "accept");
                });
            });
            container.querySelectorAll('.decline-request-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const requestId = e.currentTarget.dataset.id;
                    const title = dashboardTranslations[currentDashboardLanguage].declineRequestTitle || 'Decline Request?';
                    const message = dashboardTranslations[currentDashboardLanguage].declineRequestMessage || 'Are you sure you want to decline this termination request?';
                    openConfirmationModal(title, message, () => declineTerminationRequest(requestId), "decline");
                });
            });

            setDashboardLanguage(currentDashboardLanguage);
        }

        async function deleteSupportChat(chatId) {
            try {
                await deleteDoc(doc(db, "supportChats", chatId));
                showToast(dashboardTranslations[currentDashboardLanguage].chatDeletedSuccess);
            } catch (error) {
                console.error("Error deleting chat:", error);
                showToast("Error deleting chat.", true);
            }
        }

        async function restoreSupportChat(chatId) {
            try {
                const chatRef = doc(db, "supportChats", chatId);
                await updateDoc(chatRef, {
                    deletedByUser: false,
                    deletedAt: null
                });
                showToast("Chat history restored successfully");
            } catch (error) {
                console.error("Error restoring chat:", error);
                showToast("Error restoring chat.", true);
            }
        }
        
        function applyFiltersToSupportList() {
            const panel = document.getElementById('support-chats-panel');
            if (!panel) return;
            
            const searchInput = panel.querySelector('#support-search-input');
            const statusFilter = panel.querySelector('#support-status-filter');
            const dateFrom = panel.querySelector('#support-date-from');
            const dateTo = panel.querySelector('#support-date-to');
            const filterCount = panel.querySelector('#support-filter-count');
            
            const searchTerm = searchInput?.value.toLowerCase().trim() || '';
            const statusValue = statusFilter?.value || 'all';
            const dateFromValue = dateFrom?.value || '';
            const dateToValue = dateTo?.value || '';
            
            // Get base chats (already filtered by audience)
            const decoratedChats = supportChats;
            let displayChats = decoratedChats.filter(chat => 
                activeSupportAudience === 'partners' ? chat.audience === 'partners' : chat.audience !== 'partners'
            );
            
            // Apply search filter
            if (searchTerm) {
                displayChats = displayChats.filter(chat => {
                    const userName = (chat.userName || '').toLowerCase();
                    const chatId = (chat.id || '').toLowerCase();
                    return userName.includes(searchTerm) || chatId.includes(searchTerm);
                });
            }
            
            // Apply status filter
            if (statusValue !== 'all') {
                displayChats = displayChats.filter(chat => chat.status === statusValue);
            }
            
            // Apply date range filter
            if (dateFromValue || dateToValue) {
                displayChats = displayChats.filter(chat => {
                    if (!chat.createdAt?.seconds) return false;
                    const chatDate = new Date(chat.createdAt.seconds * 1000);
                    const chatDateStr = chatDate.toISOString().split('T')[0];
                    
                    if (dateFromValue && chatDateStr < dateFromValue) return false;
                    if (dateToValue && chatDateStr > dateToValue) return false;
                    return true;
                });
            }
            
            filteredSupportChats = displayChats;
            
            // Update filter count display
            if (filterCount) {
                const totalCount = supportChats.filter(chat => 
                    activeSupportAudience === 'partners' ? chat.audience === 'partners' : chat.audience !== 'partners'
                ).length;
                filterCount.textContent = `Showing ${displayChats.length} of ${totalCount} chats`;
            }
            
            // Re-render the table with filtered data
            renderSupportChatsTable(displayChats);
        }
        
        // ==================== CONTENT REPORTS PANEL ====================
        let contentReports = [];
        let unsubReports = null;
        
        function renderReportsPanel() {
            const panel = document.getElementById('reports-panel');
            if (!panel) return;
            
            // Load reports from Firestore
            if (unsubReports) unsubReports();
            unsubReports = onSnapshot(collection(db, 'reports'), snapshot => {
                contentReports = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updateReportsDisplay();
            });
            
            function updateReportsDisplay() {
                const totalReports = contentReports.length;
                const pendingReports = contentReports.filter(r => r.status === 'pending' || !r.status).length;
                const thisWeekReports = contentReports.filter(r => {
                    if (!r.timestamp) return false;
                    const reportDate = r.timestamp.toDate ? r.timestamp.toDate() : new Date(r.timestamp);
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return reportDate >= weekAgo;
                }).length;
                
                panel.innerHTML = `
                    <!-- Statistics Dashboard -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-br from-orange-900 to-orange-700 p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-200 text-sm font-medium">Total Reports</p>
                                    <p class="text-3xl font-bold text-white mt-1">${totalReports}</p>
                                </div>
                                <div class="bg-orange-800 bg-opacity-50 p-3 rounded-full">
                                    <i class="fas fa-flag text-2xl text-orange-200"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-yellow-200 text-sm font-medium">Pending Review</p>
                                    <p class="text-3xl font-bold text-white mt-1">${pendingReports}</p>
                                </div>
                                <div class="bg-yellow-800 bg-opacity-50 p-3 rounded-full">
                                    <i class="fas fa-hourglass-half text-2xl text-yellow-200"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-200 text-sm font-medium">This Week</p>
                                    <p class="text-3xl font-bold text-white mt-1">${thisWeekReports}</p>
                                </div>
                                <div class="bg-blue-800 bg-opacity-50 p-3 rounded-full">
                                    <i class="fas fa-calendar-week text-2xl text-blue-200"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Header -->
                    <div class="flex flex-col gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                                <i class="fas fa-flag text-orange-400"></i>
                                Content Reports
                            </h2>
                            <p class="text-sm text-gray-400 mt-1">Review and manage user-submitted content reports</p>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Bar -->
                    <div class="mb-6 bg-gray-800 p-4 rounded-lg shadow-lg">
                        <div class="flex gap-4 items-center">
                            <div class="relative flex-1">
                                <input type="text" id="reports-search-input" placeholder="Search by movie title, user email, or reason..." 
                                    class="w-full px-4 py-2 pl-10 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500" />
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <select id="reports-status-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="all">All Status</option>
                                <option value="pending" selected>Pending</option>
                                <option value="resolved">Resolved</option>
                            </select>
                            <select id="reports-reason-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="all">All Reasons</option>
                                <option value="copyright">Copyright</option>
                                <option value="incorrect18">Incorrect 18+</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="reports-table-container"></div>
                `;
                
                // Initial render
                filterAndRenderReports();
                
                // Search and filter handlers
                document.getElementById('reports-search-input')?.addEventListener('input', filterAndRenderReports);
                document.getElementById('reports-status-filter')?.addEventListener('change', filterAndRenderReports);
                document.getElementById('reports-reason-filter')?.addEventListener('change', filterAndRenderReports);
            }
            
            function filterAndRenderReports() {
                const searchTerm = document.getElementById('reports-search-input')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('reports-status-filter')?.value || 'all';
                const reasonFilter = document.getElementById('reports-reason-filter')?.value || 'all';
                
                let filtered = contentReports.filter(report => {
                    // Status filter
                    if (statusFilter !== 'all') {
                        const reportStatus = report.status || 'pending';
                        if (reportStatus !== statusFilter) return false;
                    }
                    
                    // Reason filter
                    if (reasonFilter !== 'all' && report.reason !== reasonFilter) return false;
                    
                    // Search filter
                    if (searchTerm) {
                        const matchesTitle = report.movieTitle?.toLowerCase().includes(searchTerm);
                        const matchesEmail = report.userEmail?.toLowerCase().includes(searchTerm);
                        const matchesReason = report.reason?.toLowerCase().includes(searchTerm);
                        const matchesDescription = report.description?.toLowerCase().includes(searchTerm);
                        return matchesTitle || matchesEmail || matchesReason || matchesDescription;
                    }
                    
                    return true;
                });
                
                renderReportsTable(filtered);
            }
            
            function renderReportsTable(reportsList) {
                const container = document.getElementById('reports-table-container');
                if (!container) return;
                
                if (reportsList.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 bg-gray-800 rounded-lg">
                            <i class="fas fa-flag text-5xl text-gray-600 mb-3"></i>
                            <p class="text-gray-400 text-lg">No content reports found</p>
                            <p class="text-gray-500 text-sm mt-1">User reports will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                const reasonLabels = {
                    'copyright': 'Copyright Violation',
                    'incorrect18': 'Incorrect 18+ Rating',
                    'other': 'Other Issue'
                };
                
                const reasonColors = {
                    'copyright': 'bg-red-500/20 text-red-400 border-red-500/30',
                    'incorrect18': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
                    'other': 'bg-gray-500/20 text-gray-400 border-gray-500/30'
                };
                
                const tableRows = reportsList.map(report => {
                    const date = report.timestamp ? 
                        (report.timestamp.toDate ? report.timestamp.toDate() : new Date(report.timestamp)).toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                        }) : 'N/A';
                    
                    const reasonLabel = reasonLabels[report.reason] || report.reason;
                    const reasonColor = reasonColors[report.reason] || reasonColors['other'];
                    const statusBadge = (report.status === 'resolved') 
                        ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-400 border border-green-500/30">Resolved</span>'
                        : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">Pending</span>';
                    
                    return `
                        <tr class="table-row hover:bg-gray-700 transition-colors border-b border-gray-700">
                            <td class="px-4 py-3">
                                <div class="flex flex-col">
                                    <span class="font-medium text-white">${report.movieTitle || 'Unknown Movie'}</span>
                                    <span class="text-xs text-gray-400">${report.movieId || 'N/A'}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex flex-col">
                                    <span class="text-white">${report.userEmail || 'Unknown'}</span>
                                    <span class="text-xs text-gray-400">${report.userId || 'N/A'}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full border ${reasonColor}">
                                    ${reasonLabel}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="text-sm text-gray-300">${report.description || 'No description provided'}</span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-300">${date}</td>
                            <td class="px-4 py-3">${statusBadge}</td>
                            <td class="px-4 py-3">
                                <div class="flex gap-2 justify-center">
                                    ${report.status !== 'resolved' ? `
                                        <button onclick="markReportResolved('${report.id}')" 
                                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors" 
                                            title="Mark as Resolved">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                    <button onclick="viewReportDetails('${report.id}')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors" 
                                        title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="deleteReport('${report.id}')" 
                                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors" 
                                        title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-900">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Movie</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Reporter</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Reason</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Description</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Date</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300">Status</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-300">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }
        
        async function markReportResolved(reportId) {
            try {
                const report = contentReports.find(r => r.id === reportId);
                if (!report) {
                    showToast('Report not found', true);
                    return;
                }
                
                // 1. Update report status to resolved
                await updateDoc(doc(db, 'reports', reportId), {
                    status: 'resolved',
                    resolvedAt: new Date().toISOString(),
                    resolvedBy: auth.currentUser?.uid
                });
                
                // 2. Hide content from user interface (set needsReview flag)
                if (report.movieId) {
                    const movieRef = doc(db, 'movies', report.movieId);
                    await updateDoc(movieRef, {
                        needsReview: true,
                        reportedIssue: report.reason,
                        hiddenFromUsers: true,
                        lastReportedAt: new Date().toISOString()
                    });
                }
                
                // 3. Get movie details to find partner
                const movieDoc = await getDoc(doc(db, 'movies', report.movieId));
                if (movieDoc.exists()) {
                    const movieData = movieDoc.data();
                    const partnerId = movieData.partnerId || movieData.uploadedBy;
                    
                    if (partnerId) {
                        // 4. Send notification to partner
                        await addDoc(collection(db, 'notifications'), {
                            userId: partnerId,
                            type: 'content_report',
                            title: 'Content Reported',
                            message: `Your content "${report.movieTitle}" has been reported for: ${report.reason}. Please review and fix the issue.`,
                            movieId: report.movieId,
                            movieTitle: report.movieTitle,
                            reportId: reportId,
                            reportReason: report.reason,
                            reportDescription: report.description,
                            actionRequired: 'fix_content',
                            timestamp: serverTimestamp(),
                            read: false,
                            link: `/edit-movie/${report.movieId}` // Partner will be redirected here
                        });
                        
                        showToast('Report resolved. Content hidden and partner notified.');
                    } else {
                        showToast('Report resolved. Content hidden (no partner found).');
                    }
                } else {
                    showToast('Report resolved but movie not found.');
                }
                
            } catch (error) {
                console.error('Error resolving report:', error);
                showToast('Failed to resolve report: ' + error.message, true);
            }
        }
        
        async function deleteReport(reportId) {
            if (!confirm('Are you sure you want to delete this report?')) return;
            try {
                await deleteDoc(doc(db, 'reports', reportId));
                showToast('Report deleted successfully');
            } catch (error) {
                console.error('Error deleting report:', error);
                showToast('Failed to delete report', true);
            }
        }
        
        function viewReportDetails(reportId) {
            const report = contentReports.find(r => r.id === reportId);
            if (!report) return;
            
            const date = report.timestamp ? 
                (report.timestamp.toDate ? report.timestamp.toDate() : new Date(report.timestamp)).toLocaleDateString('en-US', { 
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                }) : 'N/A';
            
            const reasonLabels = {
                'copyright': 'Copyright Violation',
                'incorrect18': 'Incorrect 18+ Rating',
                'other': 'Other Issue'
            };
            
            const modalHTML = `
                <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
                    <button id="close-report-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                        <i class="fas fa-flag text-orange-400"></i>
                        Report Details
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Movie Info -->
                        <div class="bg-gray-700/50 p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-400 mb-2">Movie Information</h3>
                            <div class="space-y-1">
                                <p class="text-white"><span class="text-gray-400">Title:</span> ${report.movieTitle || 'Unknown'}</p>
                                <p class="text-white"><span class="text-gray-400">Movie ID:</span> <span class="font-mono text-sm">${report.movieId || 'N/A'}</span></p>
                            </div>
                        </div>
                        
                        <!-- Reporter Info -->
                        <div class="bg-gray-700/50 p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-400 mb-2">Reporter Information</h3>
                            <div class="space-y-1">
                                <p class="text-white"><span class="text-gray-400">Email:</span> ${report.userEmail || 'Unknown'}</p>
                                <p class="text-white"><span class="text-gray-400">User ID:</span> <span class="font-mono text-sm">${report.userId || 'N/A'}</span></p>
                            </div>
                        </div>
                        
                        <!-- Report Info -->
                        <div class="bg-gray-700/50 p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-400 mb-2">Report Information</h3>
                            <div class="space-y-2">
                                <p class="text-white"><span class="text-gray-400">Reason:</span> ${reasonLabels[report.reason] || report.reason}</p>
                                <p class="text-white"><span class="text-gray-400">Status:</span> <span class="capitalize">${report.status || 'pending'}</span></p>
                                <p class="text-white"><span class="text-gray-400">Date:</span> ${date}</p>
                                ${report.description ? `
                                    <div class="mt-3">
                                        <p class="text-gray-400 text-sm mb-1">Description:</p>
                                        <div class="bg-gray-800 p-3 rounded text-white text-sm">${report.description}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        ${report.status !== 'resolved' ? `
                            <button id="mark-resolved-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                <i class="fas fa-check mr-2"></i>Mark as Resolved
                            </button>
                        ` : ''}
                        <button id="delete-report-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            <i class="fas fa-trash mr-2"></i>Delete Report
                        </button>
                        <button id="close-modal-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML, () => {
                document.getElementById('close-report-modal')?.addEventListener('click', closeModal);
                document.getElementById('close-modal-btn')?.addEventListener('click', closeModal);
                
                if (report.status !== 'resolved') {
                    document.getElementById('mark-resolved-btn')?.addEventListener('click', async () => {
                        await markReportResolved(reportId);
                        closeModal();
                    });
                }
                
                document.getElementById('delete-report-btn')?.addEventListener('click', async () => {
                    closeModal();
                    await deleteReport(reportId);
                });
            });
        }
        // ==================== END CONTENT REPORTS PANEL ====================
        
        // Make report functions globally accessible for onclick handlers
        window.markReportResolved = markReportResolved;
        window.deleteReport = deleteReport;
        window.viewReportDetails = viewReportDetails;
        
        function renderSupportChatsPanel() {
            const panel = document.getElementById('support-chats-panel');
            if (!panel) return;
            // Load colours from localStorage on first render
            loadSupportChatColors();
            // Initialise settings UI only once
            if (!panel.dataset.initialized) {
                panel.dataset.initialized = 'true';
                const settingsHTML = `
                    <!-- Statistics Dashboard -->
                    <div id="support-statistics" class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4"></div>
                    
                    <!-- Color Settings (Collapsible) -->
                    <div class="mb-4">
                        <button id="toggle-color-settings" class="text-sm text-gray-400 hover:text-white flex items-center gap-2">
                            <i class="fas fa-palette"></i>
                            <span>Color Settings</span>
                            <i class="fas fa-chevron-down transition-transform" id="color-settings-icon"></i>
                        </button>
                        <div id="support-chat-color-settings" class="hidden mt-2 p-4 bg-gray-700 rounded-lg flex flex-col gap-2 text-sm">
                            <div class="flex items-center gap-2">
                                <label for="support-color-pending" class="flex-1">New chat colour:</label>
                                <input type="color" id="support-color-pending" value="${supportChatColors.pending}" class="h-8 w-16 border border-gray-500 rounded" />
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="support-color-long" class="flex-1">Long wait colour:</label>
                                <input type="color" id="support-color-long" value="${supportChatColors.longWait}" class="h-8 w-16 border border-gray-500 rounded" />
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="support-color-solved" class="flex-1">Solved chat colour:</label>
                                <input type="color" id="support-color-solved" value="${supportChatColors.solved}" class="h-8 w-16 border border-gray-500 rounded" />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Buttons -->
                    <div id="support-tab-buttons" class="flex items-center gap-2 mb-4">
                        <button class="support-tab-btn px-4 py-2 rounded-lg font-semibold transition-colors" data-audience="users" data-lang-key="supportUsersTab"></button>
                        <button class="support-tab-btn px-4 py-2 rounded-lg font-semibold transition-colors" data-audience="partners" data-lang-key="supportPartnersTab"></button>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="mb-4 bg-gray-800 p-4 rounded-lg shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div class="relative">
                                <input type="text" id="support-search-input" placeholder="Search by name or ID..." 
                                    class="w-full px-4 py-2 pl-10 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            
                            <select id="support-status-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="active">Active</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                            
                            <div class="flex gap-2">
                                <input type="date" id="support-date-from" 
                                    class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    title="From Date" />
                                <input type="date" id="support-date-to" 
                                    class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    title="To Date" />
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mt-3">
                            <button id="support-reset-filters" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center gap-2">
                                <i class="fas fa-undo"></i>
                                <span>Reset Filters</span>
                            </button>
                            <div class="text-sm text-gray-400">
                                <span id="support-filter-count"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="support-chats-list"></div>`;
                panel.innerHTML = settingsHTML;
                // Attach listeners to colour pickers
                panel.querySelector('#support-color-pending').addEventListener('change', (e) => {
                    supportChatColors.pending = e.target.value;
                    saveSupportChatColors();
                    // Re-render list with updated colours
                    renderSupportChatsPanel();
                });
                panel.querySelector('#support-color-long').addEventListener('change', (e) => {
                    supportChatColors.longWait = e.target.value;
                    saveSupportChatColors();
                    renderSupportChatsPanel();
                });
                panel.querySelector('#support-color-solved').addEventListener('change', (e) => {
                    supportChatColors.solved = e.target.value;
                    saveSupportChatColors();
                    renderSupportChatsPanel();
                });
                panel.querySelectorAll('.support-tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        activeSupportAudience = e.currentTarget.dataset.audience || 'users';
                        renderSupportChatsPanel();
                    });
                });
                // Toggle color settings visibility
                panel.querySelector('#toggle-color-settings').addEventListener('click', () => {
                    const settingsDiv = panel.querySelector('#support-chat-color-settings');
                    const icon = panel.querySelector('#color-settings-icon');
                    settingsDiv.classList.toggle('hidden');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                });
                
                // Search and filter event listeners
                const searchInput = panel.querySelector('#support-search-input');
                const statusFilter = panel.querySelector('#support-status-filter');
                const dateFrom = panel.querySelector('#support-date-from');
                const dateTo = panel.querySelector('#support-date-to');
                const resetBtn = panel.querySelector('#support-reset-filters');
                
                if (searchInput) {
                    searchInput.addEventListener('input', () => {
                        if (window.supportFilterTimeout) clearTimeout(window.supportFilterTimeout);
                        window.supportFilterTimeout = setTimeout(() => applyFiltersToSupportList(), 300);
                    });
                }
                if (statusFilter) statusFilter.addEventListener('change', () => applyFiltersToSupportList());
                if (dateFrom) dateFrom.addEventListener('change', () => applyFiltersToSupportList());
                if (dateTo) dateTo.addEventListener('change', () => applyFiltersToSupportList());
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        if (searchInput) searchInput.value = '';
                        if (statusFilter) statusFilter.value = 'all';
                        if (dateFrom) dateFrom.value = '';
                        if (dateTo) dateTo.value = '';
                        applyFiltersToSupportList();
                    });
                }
            }
            // Reference list container and update colour pickers to reflect current values
            const listContainer = document.getElementById('support-chats-list');
            const pendingInput = panel.querySelector('#support-color-pending');
            const longInput = panel.querySelector('#support-color-long');
            const solvedInput = panel.querySelector('#support-color-solved');
            if (pendingInput) pendingInput.value = supportChatColors.pending;
            if (longInput) longInput.value = supportChatColors.longWait;
            if (solvedInput) solvedInput.value = supportChatColors.solved;
            panel.querySelectorAll('.support-tab-btn').forEach(btn => {
                const isActive = btn.dataset.audience === activeSupportAudience;
                btn.classList.toggle('bg-red-600', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('bg-gray-800', !isActive);
                btn.classList.toggle('text-gray-300', !isActive);
            });
            if (unsubSupportChatsList) unsubSupportChatsList();
            unsubSupportChatsList = onSnapshot(query(collection(db, 'supportChats')), (snapshot) => {
                supportChats = snapshot.docs.map(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    return { ...data, audience: classifySupportAudience(data) };
                });
                const decoratedChats = supportChats;
                const displayChats = decoratedChats.filter(chat => activeSupportAudience === 'partners' ? chat.audience === 'partners' : chat.audience !== 'partners');
                
                // Calculate statistics for all chats
                const now = Date.now();
                const totalChats = displayChats.length;
                const pendingCount = displayChats.filter(c => c.status === 'pending').length;
                const activeCount = displayChats.filter(c => c.status === 'active' || c.status === 'in-progress').length;
                const resolvedCount = displayChats.filter(c => c.status === 'closed' || c.status === 'resolved').length;
                
                // Calculate average response time (from createdAt to first operator message)
                let totalResponseTime = 0;
                let respondedChatsCount = 0;
                displayChats.forEach(chat => {
                    if (chat.createdAt && chat.firstResponseAt) {
                        const responseTime = chat.firstResponseAt.seconds - chat.createdAt.seconds;
                        totalResponseTime += responseTime;
                        respondedChatsCount++;
                    }
                });
                const avgResponseTime = respondedChatsCount > 0 ? Math.floor(totalResponseTime / respondedChatsCount / 60) : 0; // in minutes
                
                // Find longest waiting chat
                let longestWaitTime = 0;
                displayChats.filter(c => c.status === 'pending').forEach(chat => {
                    if (chat.createdAt?.seconds) {
                        const waitTime = Math.floor((now - chat.createdAt.seconds * 1000) / 1000 / 60);
                        if (waitTime > longestWaitTime) longestWaitTime = waitTime;
                    }
                });
                
                // Render statistics dashboard
                const statsContainer = document.getElementById('support-statistics');
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-200 text-sm font-medium">Total Chats</p>
                                    <p class="text-3xl font-bold text-white mt-1">${totalChats}</p>
                                </div>
                                <div class="bg-blue-800 bg-opacity-50 p-3 rounded-full">
                                    <i class="fas fa-comments text-2xl text-blue-200"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-yellow-200 text-sm font-medium">Pending</p>
                                    <p class="text-3xl font-bold text-white mt-1">${pendingCount}</p>
                                </div>
                                <div class="bg-yellow-800 bg-opacity-50 p-3 rounded-full">
                                    <i class="fas fa-clock text-2xl text-yellow-200"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-900 to-green-700 p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-200 text-sm font-medium">Active</p>
                                    <p class="text-3xl font-bold text-white mt-1">${activeCount}</p>
                                </div>
                                <div class="bg-green-800 bg-opacity-50 p-3 rounded-full">
                                    <i class="fas fa-headset text-2xl text-green-200"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-900 to-purple-700 p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-200 text-sm font-medium">Resolved</p>
                                    <p class="text-3xl font-bold text-white mt-1">${resolvedCount}</p>
                                </div>
                                <div class="bg-purple-800 bg-opacity-50 p-3 rounded-full">
                                    <i class="fas fa-check-circle text-2xl text-purple-200"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-red-900 to-red-700 p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-red-200 text-sm font-medium">Longest Wait</p>
                                    <p class="text-3xl font-bold text-white mt-1">${longestWaitTime}<span class="text-lg">m</span></p>
                                </div>
                                <div class="bg-red-800 bg-opacity-50 p-3 rounded-full">
                                    <i class="fas fa-hourglass-half text-2xl text-red-200"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (currentUserRole === 'partner' || document.getElementById('partner-support-panel')?.offsetParent) {
                    renderPartnerSupportPanel();
                }
                
                // Apply filters and render table
                applyFiltersToSupportList();
            });

        }
        
        function renderSupportChatsTable(displayChats) {
            const panel = document.getElementById('support-chats-panel');
            if (!panel) return;
            const listContainer = document.getElementById('support-chats-list');
            if (!listContainer) return;
            
            if (displayChats.length === 0) {
                const emptyKey = activeSupportAudience === 'partners' ? 'supportEmptyPartners' : 'supportEmptyUsers';
                const emptyText = dashboardTranslations[currentDashboardLanguage]?.[emptyKey] || 'No support chats.';
                listContainer.innerHTML = `<p class="text-center text-gray-500">${emptyText}</p>`;
                return;
            }
            
            const now = Date.now();
                const pendingChats = displayChats.filter(c => c.status === 'pending').sort((a, b) => {
                    const tA = a.createdAt?.seconds || 0;
                    const tB = b.createdAt?.seconds || 0;
                    return tA - tB;
                });
                const queuePositions = new Map();
                pendingChats.forEach((chat, index) => queuePositions.set(chat.id, index + 1));
                const sortedChats = [...displayChats].sort((a, b) => {
                    const tA = a.createdAt?.seconds || 0;
                    const tB = b.createdAt?.seconds || 0;
                    return tB - tA;
                });
                const tableHeaders = `
                <thead class="bg-gray-800">
                    <tr class="border-b border-gray-700">
                        <th class="p-4 text-center">
                            <input type="checkbox" id="select-all-chats" class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-2 focus:ring-blue-500" />
                        </th>
                        <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">ID</th>
                        <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">${dashboardTranslations[currentDashboardLanguage].position || 'Pos'}</th>
                        <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="name">Name</th>
                        <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="status">Status</th>
                        <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">Wait Time</th>
                        <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="date">Created</th>
                        <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">${dashboardTranslations[currentDashboardLanguage].supportPartnersTab || 'Audience'}</th>
                        <th class="p-4 text-center text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="actions">Actions</th>
                    </tr>
                </thead>`;
                const thresholdMs = 60 * 60 * 1000;
                const rows = sortedChats.map(chat => {
                    const createdAt = chat.createdAt?.seconds ? new Date(chat.createdAt.seconds * 1000) : null;
                    const createdStr = createdAt ? createdAt.toLocaleString('en-GB', { 
                        day: '2-digit', month: 'short', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    }) : 'N/A';
                    
                    // Calculate wait time
                    let waitTimeStr = '-';
                    let waitTimeClass = 'text-gray-400';
                    if (createdAt && (chat.status === 'pending' || chat.status === 'active' || chat.status === 'in-progress')) {
                        const waitMinutes = Math.floor((now - createdAt.getTime()) / 1000 / 60);
                        if (waitMinutes < 60) {
                            waitTimeStr = `${waitMinutes}m`;
                            waitTimeClass = waitMinutes > 30 ? 'text-yellow-400 font-semibold' : 'text-green-400';
                        } else {
                            const waitHours = Math.floor(waitMinutes / 60);
                            waitTimeStr = `${waitHours}h ${waitMinutes % 60}m`;
                            waitTimeClass = waitHours >= 1 ? 'text-red-400 font-bold' : 'text-yellow-400 font-semibold';
                        }
                    }
                    
                    // Status badge with icons
                    let statusBadge = '';
                    switch (chat.status) {
                        case 'pending':
                            statusBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-900 text-yellow-200 border border-yellow-700"><i class="fas fa-clock"></i> Pending</span>';
                            break;
                        case 'active':
                        case 'in-progress':
                            statusBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-green-900 text-green-200 border border-green-700"><i class="fas fa-headset"></i> Active</span>';
                            break;
                        case 'resolved':
                            statusBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-purple-900 text-purple-200 border border-purple-700"><i class="fas fa-check-circle"></i> Resolved</span>';
                            break;
                        case 'closed':
                            statusBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-300 border border-gray-600"><i class="fas fa-times-circle"></i> Closed</span>';
                            break;
                        default:
                            statusBadge = `<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-300 border border-gray-600">${chat.status}</span>`;
                    }
                    
                    let rowColor;
                    if (chat.status === 'closed' || chat.status === 'resolved') {
                        rowColor = supportChatColors.solved;
                    } else if (chat.status === 'pending') {
                        if (createdAt && (now - createdAt.getTime()) > thresholdMs) {
                            rowColor = supportChatColors.longWait;
                        } else {
                            rowColor = supportChatColors.pending;
                        }
                    } else {
                        rowColor = supportChatColors.pending;
                    }
                    const queuePos = queuePositions.get(chat.id) || '-';
                    const audienceLabel = chat.audience === 'partners'
                        ? (dashboardTranslations[currentDashboardLanguage].supportPartnersTab || 'Partners')
                        : (dashboardTranslations[currentDashboardLanguage].supportUsersTab || 'Users');
                    
                    // Truncate ID for display
                    const shortId = chat.id.length > 12 ? chat.id.substring(0, 12) + '...' : chat.id;
                    
                    // Check if chat is deleted by user
                    const isDeleted = chat.deletedByUser === true;
                    const deletedBadge = isDeleted ? '<span class="ml-2 inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-semibold bg-orange-900 text-orange-200 border border-orange-700"><i class="fas fa-trash-restore"></i> Deleted</span>' : '';
                    
                    return `
                    <tr class="border-b border-gray-700 hover:bg-gray-800 transition-colors chat-row" style="background-color: ${rowColor}1A;" data-chat-id="${chat.id}">
                        <td class="p-4 text-center">
                            <input type="checkbox" class="chat-checkbox w-4 h-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-2 focus:ring-blue-500" data-chat-id="${chat.id}" />
                        </td>
                        <td class="p-4 text-xs font-mono text-gray-400" title="${chat.id}">${shortId}</td>
                        <td class="p-4 text-sm font-semibold ${queuePos !== '-' ? 'text-yellow-300' : 'text-gray-500'}">${queuePos}</td>
                        <td class="p-4 text-sm text-white font-medium">${chat.userName || 'Anonymous'}${deletedBadge}</td>
                        <td class="p-4">${statusBadge}</td>
                        <td class="p-4 text-sm ${waitTimeClass}">${waitTimeStr}</td>
                        <td class="p-4 text-xs text-gray-400">${createdStr}</td>
                        <td class="p-4 text-sm"><span class="inline-flex items-center px-2 py-1 rounded-md text-xs ${chat.audience === 'partners' ? 'bg-purple-900 text-purple-200' : 'bg-blue-900 text-blue-200'}">${audienceLabel}</span></td>
                        <td class="p-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button class="open-support-chat-btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-3 rounded-lg transition-colors shadow-lg hover:shadow-xl" data-chat-id="${chat.id}" title="Open Chat">
                                    <i class="fas fa-comments"></i>
                                </button>
                                ${isDeleted ? `
                                <button class="restore-support-chat-btn bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-3 rounded-lg transition-colors shadow-lg hover:shadow-xl" data-chat-id="${chat.id}" title="Restore Chat">
                                    <i class="fas fa-trash-restore"></i>
                                </button>
                                ` : ''}
                                <button class="delete-support-chat-btn bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition-colors shadow-lg hover:shadow-xl" data-chat-id="${chat.id}" title="Delete Chat">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
                const headingKey = activeSupportAudience === 'partners' ? 'supportPartnersHeading' : 'supportUsersHeading';
                const headingText = dashboardTranslations[currentDashboardLanguage]?.[headingKey] || 'Support';
                listContainer.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2" data-lang-key="${headingKey}">
                            <i class="fas fa-headset text-blue-400"></i>
                            ${headingText}
                        </h3>
                    </div>
                    
                    <!-- Bulk Actions Toolbar -->
                    <div id="bulk-actions-toolbar" class="hidden mb-4 p-4 bg-gradient-to-r from-blue-900 to-blue-800 rounded-lg shadow-lg border border-blue-700">
                        <div class="flex flex-wrap items-center gap-3">
                            <div class="flex items-center gap-2 text-white font-semibold">
                                <i class="fas fa-check-square"></i>
                                <span id="selected-count">0</span> selected
                            </div>
                            <div class="h-6 w-px bg-blue-600"></div>
                            <select id="bulk-status-change" class="px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Change Status...</option>
                                <option value="pending">‚Üí Pending</option>
                                <option value="active">‚Üí Active</option>
                                <option value="resolved">‚Üí Resolved</option>
                                <option value="closed">‚Üí Closed</option>
                            </select>
                            <button id="bulk-delete-btn" class="px-4 py-2 bg-red-700 hover:bg-red-600 text-white rounded-lg transition-colors flex items-center gap-2 text-sm font-semibold">
                                <i class="fas fa-trash"></i>
                                Delete Selected
                            </button>
                            <button id="export-csv-btn" class="px-4 py-2 bg-green-700 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center gap-2 text-sm font-semibold">
                                <i class="fas fa-file-export"></i>
                                Export to CSV
                            </button>
                            <button id="deselect-all-btn" class="ml-auto px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm">
                                Clear Selection
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-full">${tableHeaders}<tbody class="divide-y divide-gray-700">${rows}</tbody></table>
                        </div>
                    </div>
                `;
                listContainer.querySelectorAll('.open-support-chat-btn').forEach(btn => {
                    btn.addEventListener('click', () => openSupportChatAdmin(btn.dataset.chatId));
                });
                listContainer.querySelectorAll('.restore-support-chat-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const chatId = btn.dataset.chatId;
                        if (confirm('Restore chat history for this user?')) {
                            restoreSupportChat(chatId);
                        }
                    });
                });
                listContainer.querySelectorAll('.delete-support-chat-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const chatId = btn.dataset.chatId;
                        const title = dashboardTranslations[currentDashboardLanguage].deleteChatConfirmTitle;
                        const message = dashboardTranslations[currentDashboardLanguage].deleteChatConfirmMessage;
                        openConfirmationModal(title, message, () => deleteSupportChat(chatId), "delete");
                    });
                });
                
                // Bulk selection event listeners
                const toolbar = listContainer.querySelector('#bulk-actions-toolbar');
                const selectedCountEl = listContainer.querySelector('#selected-count');
                const selectAllCheckbox = listContainer.querySelector('#select-all-chats');
                const chatCheckboxes = listContainer.querySelectorAll('.chat-checkbox');
                
                function updateBulkToolbar() {
                    const selectedChats = Array.from(chatCheckboxes).filter(cb => cb.checked);
                    const count = selectedChats.length;
                    if (selectedCountEl) selectedCountEl.textContent = count;
                    if (toolbar) {
                        toolbar.classList.toggle('hidden', count === 0);
                    }
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = count === chatCheckboxes.length && count > 0;
                        selectAllCheckbox.indeterminate = count > 0 && count < chatCheckboxes.length;
                    }
                }
                
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', (e) => {
                        chatCheckboxes.forEach(cb => cb.checked = e.target.checked);
                        updateBulkToolbar();
                    });
                }
                
                chatCheckboxes.forEach(cb => {
                    cb.addEventListener('change', updateBulkToolbar);
                });
                
                // Bulk status change
                const bulkStatusSelect = listContainer.querySelector('#bulk-status-change');
                if (bulkStatusSelect) {
                    bulkStatusSelect.addEventListener('change', async (e) => {
                        const newStatus = e.target.value;
                        if (!newStatus) return;
                        
                        const selectedChats = Array.from(chatCheckboxes).filter(cb => cb.checked);
                        const chatIds = selectedChats.map(cb => cb.dataset.chatId);
                        
                        if (chatIds.length === 0) return;
                        
                        const confirmMsg = `Change status of ${chatIds.length} chat(s) to "${newStatus}"?`;
                        if (!confirm(confirmMsg)) {
                            e.target.value = '';
                            return;
                        }
                        
                        try {
                            const batch = writeBatch(db);
                            chatIds.forEach(chatId => {
                                const chatRef = doc(db, 'supportChats', chatId);
                                batch.update(chatRef, { status: newStatus, updatedAt: serverTimestamp() });
                            });
                            await batch.commit();
                            showToast(`Successfully updated ${chatIds.length} chat(s)`);
                            e.target.value = '';
                            chatCheckboxes.forEach(cb => cb.checked = false);
                            updateBulkToolbar();
                        } catch (error) {
                            console.error('Error updating chats:', error);
                            showToast('Error updating chats', true);
                        }
                    });
                }
                
                // Bulk delete
                const bulkDeleteBtn = listContainer.querySelector('#bulk-delete-btn');
                if (bulkDeleteBtn) {
                    bulkDeleteBtn.addEventListener('click', async () => {
                        const selectedChats = Array.from(chatCheckboxes).filter(cb => cb.checked);
                        const chatIds = selectedChats.map(cb => cb.dataset.chatId);
                        
                        if (chatIds.length === 0) return;
                        
                        const confirmMsg = `Delete ${chatIds.length} chat(s)? This action cannot be undone.`;
                        if (!confirm(confirmMsg)) return;
                        
                        try {
                            const batch = writeBatch(db);
                            chatIds.forEach(chatId => {
                                const chatRef = doc(db, 'supportChats', chatId);
                                batch.delete(chatRef);
                            });
                            await batch.commit();
                            showToast(`Successfully deleted ${chatIds.length} chat(s)`);
                            chatCheckboxes.forEach(cb => cb.checked = false);
                            updateBulkToolbar();
                        } catch (error) {
                            console.error('Error deleting chats:', error);
                            showToast('Error deleting chats', true);
                        }
                    });
                }
                
                // Export to CSV
                const exportCsvBtn = listContainer.querySelector('#export-csv-btn');
                if (exportCsvBtn) {
                    exportCsvBtn.addEventListener('click', () => {
                        const chatsToExport = displayChats;
                        if (chatsToExport.length === 0) {
                            showToast('No chats to export', true);
                            return;
                        }
                        
                        // CSV headers
                        const headers = ['ID', 'Name', 'Status', 'Created At', 'Audience', 'User ID'];
                        const rows = chatsToExport.map(chat => {
                            const createdAt = chat.createdAt?.seconds ? new Date(chat.createdAt.seconds * 1000).toISOString() : '';
                            return [
                                chat.id,
                                chat.userName || 'Anonymous',
                                chat.status || 'unknown',
                                createdAt,
                                chat.audience || 'users',
                                chat.userId || ''
                            ].map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
                        });
                        
                        const csv = [headers.join(','), ...rows].join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `support-chats-${new Date().toISOString().split('T')[0]}.csv`;
                        link.click();
                        showToast('CSV exported successfully');
                    });
                }
                
                // Deselect all
                const deselectAllBtn = listContainer.querySelector('#deselect-all-btn');
                if (deselectAllBtn) {
                    deselectAllBtn.addEventListener('click', () => {
                        chatCheckboxes.forEach(cb => cb.checked = false);
                        updateBulkToolbar();
                    });
                }
                
                setDashboardLanguage(currentDashboardLanguage);
        }
        
        function renderPartnerSupportPanel() {
            const panel = document.getElementById('partner-support-panel');
            if (!panel) return;
            
            const partnerChat = supportChats.find(chat => chat.userId === currentPartnerId);
            const partnerChatId = partnerChat ? partnerChat.id : '';
            
            panel.innerHTML = `
                <div class="space-y-6 max-w-5xl mx-auto">
                    <!-- Header Card -->
                    <div class="bg-gradient-to-r from-blue-900 to-blue-800 p-6 rounded-xl shadow-xl border border-blue-700">
                        <div class="flex items-start justify-between">
                            <div>
                                <h2 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                                    <i class="fas fa-headset"></i>
                                    <span data-lang-key="supportPartnersHeading">Hamkorlar yordami</span>
                                </h2>
                                <p class="text-blue-200 text-sm leading-relaxed" data-lang-key="partnerSupportDescription">
                                    Soundora hamkorlari uchun qo'llab-quvvatlash. Operatorlarga savol bering yoki chatni oching.
                                </p>
                            </div>
                            <div class="w-16 h-16 bg-blue-700/50 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                <i class="fas fa-life-ring text-3xl text-blue-200"></i>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3 mt-6">
                            <button id="open-partner-support-chat" class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold px-6 py-3 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                <i class="fas fa-comments"></i>
                                <span data-lang-key="contactOperator">Operator bilan bog'lanish</span>
                            </button>
                            <button id="open-support-portal" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold px-6 py-3 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                <i class="fas fa-external-link-alt"></i>
                                <span data-lang-key="openSupportPortal">Yordam Portalini ochish</span>
                            </button>
                        </div>
                        ${partnerChatId ? `<p class="text-xs text-blue-300 mt-4 bg-blue-800/30 backdrop-blur-sm px-3 py-2 rounded-lg inline-block">
                            <i class="fas fa-info-circle mr-1"></i> Chat ID: <span class="font-mono font-bold">${partnerChatId}</span>
                        </p>` : ''}
                    </div>
                    
                    <!-- Help Topics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Account Help -->
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700 hover:border-blue-500 transition-all transform hover:scale-105">
                            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-user-circle text-2xl text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">Hisob Boshqaruvi</h3>
                            <p class="text-sm text-gray-400 mb-4">Profilingiz, sozlamalar va xavfsizlik bo'yicha yordam</p>
                            <ul class="space-y-2 text-sm text-gray-300">
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>Parolni tiklash</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>Profil ma'lumotlarini yangilash</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>Xavfsizlik sozlamalari</span>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Content Upload Help -->
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700 hover:border-purple-500 transition-all transform hover:scale-105">
                            <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-upload text-2xl text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">Kontent Yuklash</h3>
                            <p class="text-sm text-gray-400 mb-4">Film va video yuklash bo'yicha ko'rsatmalar</p>
                            <ul class="space-y-2 text-sm text-gray-300">
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>Qo'llab-quvvatlanadigan formatlar</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>Metadata va tavsiflar</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>Sifat talablari</span>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Payment Help -->
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700 hover:border-green-500 transition-all transform hover:scale-105">
                            <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-dollar-sign text-2xl text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">To'lovlar va Daromad</h3>
                            <p class="text-sm text-gray-400 mb-4">Royalti va to'lovlar haqida ma'lumot</p>
                            <ul class="space-y-2 text-sm text-gray-300">
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>To'lov shartlari</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>Daromadni hisoblash</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-green-400 mt-0.5"></i>
                                    <span>Bank ma'lumotlarini sozlash</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- FAQ Quick Access -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-question-circle text-yellow-400"></i>
                            Ko'p So'raladigan Savollar
                        </h3>
                        <div class="space-y-3">
                            <details class="bg-gray-700/50 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors">
                                <summary class="font-semibold text-white flex items-center justify-between">
                                    Qanday qilib film yuklash mumkin?
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </summary>
                                <p class="mt-3 text-sm text-gray-300 leading-relaxed">
                                    "Kontent" bo'limiga o'ting va "Film Qo'shish" tugmasini bosing. Keyin barcha kerakli ma'lumotlarni kiriting va video faylni yuklang.
                                </p>
                            </details>
                            
                            <details class="bg-gray-700/50 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors">
                                <summary class="font-semibold text-white flex items-center justify-between">
                                    To'lovlar qachon amalga oshiriladi?
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </summary>
                                <p class="mt-3 text-sm text-gray-300 leading-relaxed">
                                    To'lovlar har oy boshida amalga oshiriladi. Minimal to'lov summasi $100. Daromadingiz bu miqdorga yetganda, keyingi oy boshida to'lov qilinadi.
                                </p>
                            </details>
                            
                            <details class="bg-gray-700/50 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors">
                                <summary class="font-semibold text-white flex items-center justify-between">
                                    Mening kontentim nima uchun ko'rsatilmayapti?
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </summary>
                                <p class="mt-3 text-sm text-gray-300 leading-relaxed">
                                    Yangi yuklangan kontent administratorlar tomonidan tekshiriladi. Bu jarayon odatda 24-48 soat davom etadi. Agar muammo bo'lsa, sizga xabar yuboriladi.
                                </p>
                            </details>
                        </div>
                    </div>
                    
                    <!-- Contact Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-r from-indigo-900/50 to-indigo-800/50 p-6 rounded-xl border border-indigo-700/30">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-clock text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-2">Ish Vaqti</h4>
                                    <p class="text-sm text-gray-300">
                                        Dushanba - Juma: 09:00 - 18:00<br>
                                        Shanba: 10:00 - 14:00<br>
                                        Yakshanba: Dam olish
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-pink-900/50 to-pink-800/50 p-6 rounded-xl border border-pink-700/30">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-pink-600 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-envelope text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-2">Elektron Pochta</h4>
                                    <p class="text-sm text-gray-300">
                                        Umumiy savollar: support@soundora.com<br>
                                        Hamkorlik: partners@soundora.com<br>
                                        Texnik yordam: tech@soundora.com
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            panel.querySelector('#open-partner-support-chat')?.addEventListener('click', () => {
                window.open('support.html', '_blank', 'noopener');
            });
            panel.querySelector('#open-support-portal')?.addEventListener('click', () => {
                window.open('support.html', '_blank', 'noopener');
            });
            
            setDashboardLanguage(currentDashboardLanguage);
        }

        function openSupportChatAdmin(chatId) {
            activeAdminChatId = chatId;
            const chatRef = doc(db, 'supportChats', chatId);
            
            // Mark chat as opened by admin
            updateDoc(chatRef, {
                adminOpened: true,
                adminOpenedAt: serverTimestamp()
            }).catch(err => console.error('Error marking chat as opened:', err));
            
            // Setup snapshot listener immediately for real-time updates
            if (adminChatUnsub) adminChatUnsub();
            
            // Listen to chat document (not subcollection)
            adminChatUnsub = onSnapshot(chatRef, (docSnapshot) => {
                console.log('Snapshot triggered!');
                const messagesEl = document.getElementById('admin-chat-messages');
                if (!messagesEl) {
                    console.log('Messages element not found yet, will retry...');
                    return;
                }
                
                if (!docSnapshot.exists()) {
                    if (messagesEl) {
                        messagesEl.innerHTML = '<div class="text-center text-gray-400 py-8">Chat not found</div>';
                    }
                    return;
                }
                
                const chatData = docSnapshot.data();
                console.log('Admin received chat data:', chatData);
                console.log('Messages array:', chatData.messages);
                
                const messages = (chatData.messages || []).map(msg => {
                    console.log('Processing message:', msg);
                    return {
                        ...msg,
                        timestamp: msg.timestamp || { seconds: Date.now() / 1000 }
                    };
                });
                
                // Sort by timestamp (oldest first)
                messages.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeA - timeB;
                });
                
                // Group messages by date
                const messagesByDate = {};
                messages.forEach(msg => {
                    let msgDate = null;
                    if (msg.timestamp?.seconds) {
                        msgDate = new Date(msg.timestamp.seconds * 1000);
                    } else if (typeof msg.timestamp?.toDate === 'function') {
                        msgDate = msg.timestamp.toDate();
                    } else if (msg.timestamp instanceof Date) {
                        msgDate = msg.timestamp;
                    }
                    
                    if (msgDate) {
                        const dateKey = msgDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                        if (!messagesByDate[dateKey]) {
                            messagesByDate[dateKey] = [];
                        }
                        messagesByDate[dateKey].push({ ...msg, parsedDate: msgDate });
                    }
                });
                
                // Determine if it's a partner or user chat
                const isPartnerChat = chatData.audience === 'partners' || chatData.partnerId;
                
                messagesEl.innerHTML = '';
                
                // Render messages grouped by date
                Object.keys(messagesByDate).forEach(dateKey => {
                    // Date separator
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'flex items-center justify-center my-4';
                    dateSeparator.innerHTML = `
                        <div class="px-4 py-1 bg-gray-700 rounded-full text-xs font-semibold text-gray-300 border border-gray-600">
                            ${dateKey}
                        </div>
                    `;
                    messagesEl.appendChild(dateSeparator);
                    
                    // Messages for this date
                    messagesByDate[dateKey].forEach(msg => {
                        console.log('Admin rendering message:', {
                            message: msg.message,
                            senderRole: msg.senderRole,
                            isAdminMessage: msg.senderRole === 'admin',
                            isPartnerMessage: msg.senderRole === 'partner'
                        });
                        
                        const msgWrapper = document.createElement('div');
                        msgWrapper.classList.add('flex', 'flex-col', 'animate-fadeIn');
                        
                        const bubble = document.createElement('div');
                        bubble.classList.add('px-4', 'py-3', 'rounded-2xl', 'max-w-[75%]', 'shadow-lg', 'relative');
                        
                        let senderName = '';
                        let isReadByUser = false;
                        
                        // Determine if this is admin or partner/user message
                        const isAdminMessage = msg.senderRole === 'admin';
                        const isPartnerMessage = msg.senderRole === 'partner';
                        
                        // Reply preview HTML (if needed in future)
                        let replyPreviewHTML = '';
                        
                        // Determine styling and sender name
                        if (isPartnerMessage || (!isAdminMessage && !msg.senderRole)) {
                            bubble.classList.add('bg-gradient-to-br', 'from-gray-700', 'to-gray-800', 'text-white', 'self-start', 'border', 'border-gray-600');
                            senderName = msg.senderName || (isPartnerChat ? 'Partner' : 'User');
                            
                            // Check marks for partner/user messages (sent/read)
                            const timeStr = msg.parsedDate ? msg.parsedDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
                            let checkMarks = '';
                            if (msg.isRead) {
                                // Double check (read by admin)
                                checkMarks = `<svg class="inline w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M1 12l4 4L15 6M9 12l4 4L23 6" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>`;
                            } else {
                                // Single check (sent)
                                checkMarks = `<svg class="inline w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M5 12l5 5L20 7" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>`;
                            }
                            
                            msgWrapper.innerHTML = `
                                <div class="flex items-center gap-2 mb-1 ml-2">
                                    <div class="w-6 h-6 rounded-full ${isPartnerChat ? 'bg-purple-600' : 'bg-gray-600'} flex items-center justify-center text-white text-xs font-bold">
                                        ${senderName.charAt(0).toUpperCase()}
                                    </div>
                                    <span class="text-xs font-semibold text-gray-400">${senderName}</span>
                                </div>
                            `;
                            
                            bubble.innerHTML = `
                                ${replyPreviewHTML}
                                <div class="break-words whitespace-pre-wrap leading-relaxed">${msg.message || msg.content || msg.text || ''}</div>
                                <div class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-600 border-opacity-30">
                                    ${timeStr}${checkMarks}
                                </div>
                            `;
                        } else if (isAdminMessage) {
                            bubble.classList.add('bg-gradient-to-br', 'from-blue-600', 'to-blue-700', 'text-white', 'self-end', 'border', 'border-blue-500');
                            senderName = msg.senderName || msg.adminName || 'Admin';
                            
                            // Compute read status for admin messages
                            if (chatData.userLastRead && msg.timestamp) {
                                let userReadDate;
                                if (typeof chatData.userLastRead.toDate === 'function') {
                                    userReadDate = chatData.userLastRead.toDate();
                                } else if (chatData.userLastRead instanceof Date) {
                                    userReadDate = chatData.userLastRead;
                                } else if (chatData.userLastRead.seconds) {
                                    userReadDate = new Date(chatData.userLastRead.seconds * 1000);
                                }
                                
                                if (userReadDate && msg.parsedDate && userReadDate >= msg.parsedDate) {
                                    isReadByUser = true;
                                }
                            }
                            
                            const timeStr = msg.parsedDate ? msg.parsedDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
                            const iconClass = isReadByUser ? 'fa-check-double text-blue-200' : 'fa-check text-blue-300';
                            const readText = isReadByUser ? 'Read' : 'Sent';
                            
                            msgWrapper.innerHTML = `
                                <div class="flex items-center gap-2 mb-1 mr-2 justify-end">
                                    <span class="text-xs font-semibold text-gray-400">${senderName}</span>
                                    <div class="w-6 h-6 rounded-full bg-blue-700 flex items-center justify-center text-white text-xs font-bold">
                                        ${senderName.charAt(0).toUpperCase()}
                                    </div>
                                </div>
                            `;
                            
                            bubble.innerHTML = `
                                ${replyPreviewHTML}
                                <div class="break-words whitespace-pre-wrap leading-relaxed">${msg.message || msg.content || msg.text || ''}</div>
                                <div class="flex items-center justify-end gap-2 mt-2 pt-2 border-t border-blue-500 border-opacity-30">
                                    <span class="text-xs text-blue-200 opacity-80">${timeStr}</span>
                                    <i class="fas ${iconClass} text-xs" title="${readText}"></i>
                                </div>
                            `;
                        } else {
                            bubble.classList.add('bg-gray-700', 'text-gray-300', 'self-center', 'text-xs', 'italic', 'border', 'border-gray-600');
                            bubble.innerHTML = `<div class="break-words whitespace-pre-wrap leading-relaxed">${msg.message || msg.content || msg.text || ''}</div>`;
                        }
                        
                        msgWrapper.appendChild(bubble);
                        messagesEl.appendChild(msgWrapper);
                    });
                });
                
                // Scroll to bottom (pastga)
                messagesEl.scrollTop = messagesEl.scrollHeight;
                
                // Mark partner's unread messages as read by admin
                markPartnerMessagesAsReadByAdmin(chatId, chatData);
            });

            async function markPartnerMessagesAsReadByAdmin(chatId, chatData) {
                try {
                    // Find unread partner messages
                    const messages = chatData.messages || [];
                    const unreadPartnerMessages = messages.filter(msg => 
                        msg.senderRole === 'partner' && msg.isRead === false
                    );
                    
                    if (unreadPartnerMessages.length === 0) return;
                    
                    console.log('Marking', unreadPartnerMessages.length, 'partner messages as read');
                    
                    // Update messages array - mark partner messages as read
                    const updatedMessages = messages.map(msg => {
                        if (msg.senderRole === 'partner' && msg.isRead === false) {
                            return { ...msg, isRead: true };
                        }
                        return msg;
                    });
                    
                    // Update chat document
                    await updateDoc(chatRef, {
                        messages: updatedMessages,
                        adminLastRead: serverTimestamp()
                    });
                    
                } catch (error) {
                    console.error('Failed to mark messages as read:', error);
                }
            }
            
            // Get chat data first to display user info
            getDoc(chatRef).then(docSnap => {
                const chatData = docSnap.data() || {};
                
                // Determine if it's a partner or user chat
                const isPartnerChat = chatData.audience === 'partners' || chatData.partnerId;
                
                const userName = isPartnerChat 
                    ? (chatData.partnerName || 'Partner')
                    : (chatData.userName || 'Anonymous User');
                    
                const userId = isPartnerChat
                    ? (chatData.partnerId || 'N/A')
                    : (chatData.userId || 'N/A');
                    
                const userEmail = isPartnerChat
                    ? (chatData.partnerEmail || '')
                    : (chatData.userEmail || '');
                    
                const createdAt = chatData.createdAt?.seconds ? new Date(chatData.createdAt.seconds * 1000).toLocaleString('en-GB', { 
                    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                }) : 'N/A';
                const status = chatData.status || 'unknown';
                
                // Subject for partners
                const subject = chatData.subject || '';

                
                // Status badge HTML
                let statusBadgeHTML = '';
                switch (status) {
                    case 'pending':
                        statusBadgeHTML = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-900 text-yellow-200 border border-yellow-700"><i class="fas fa-clock"></i> Pending</span>';
                        break;
                    case 'active':
                    case 'in-progress':
                        statusBadgeHTML = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-green-900 text-green-200 border border-green-700"><i class="fas fa-headset"></i> Active</span>';
                        break;
                    case 'resolved':
                        statusBadgeHTML = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-purple-900 text-purple-200 border border-purple-700"><i class="fas fa-check-circle"></i> Resolved</span>';
                        break;
                    case 'closed':
                        statusBadgeHTML = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-300 border border-gray-600"><i class="fas fa-times-circle"></i> Closed</span>';
                        break;
                    default:
                        statusBadgeHTML = `<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-300">${status}</span>`;
                }

                const modalHTML = `
                    <div class="relative bg-gray-900 rounded-2xl shadow-2xl flex flex-col w-11/12 max-w-4xl h-[85vh] overflow-hidden border border-gray-700">
                        <!-- Header with User Info -->
                        <div class="bg-gradient-to-r from-blue-900 to-blue-800 p-4 border-b border-blue-700 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-blue-700 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                    ${userName.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white">${userName}</h3>
                                    <div class="flex items-center gap-3 text-xs text-blue-200">
                                        ${isPartnerChat ? '<i class="fas fa-handshake"></i>' : '<i class="fas fa-user"></i>'}
                                        <span class="font-mono">${userId.substring(0, 12)}...</span>
                                        ${userEmail ? `<span>‚Ä¢ ${userEmail}</span>` : ''}
                                    </div>
                                    ${subject ? `<div class="text-xs text-blue-300 mt-1"><i class="fas fa-comment-dots mr-1"></i>${subject}</div>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                ${isPartnerChat ? '<span class="bg-purple-600 text-white text-xs px-3 py-1 rounded-full font-semibold"><i class="fas fa-handshake mr-1"></i>PARTNER</span>' : ''}
                                ${statusBadgeHTML}
                                <button id="close-modal-btn" class="w-8 h-8 rounded-full bg-red-600 hover:bg-red-500 text-white flex items-center justify-center transition-colors shadow-lg">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Chat Info Bar -->
                        <div class="bg-gray-800 px-4 py-2 border-b border-gray-700 flex items-center justify-between text-xs text-gray-400">
                            <div class="flex items-center gap-4">
                                <span><i class="fas fa-calendar-alt mr-1"></i> Created: ${createdAt}</span>
                                <span><i class="fas fa-hashtag mr-1"></i> ID: ${chatId.substring(0, 8)}...</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="chat-info-toggle" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-white transition-colors">
                                    <i class="fas fa-info-circle mr-1"></i> Info
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Actions Toolbar -->
                        <div class="bg-gray-800 px-4 py-2 border-b border-gray-700 flex gap-2">
                            <button id="quick-status-pending" class="px-3 py-1 bg-yellow-900 hover:bg-yellow-800 text-yellow-200 rounded-lg text-xs font-semibold transition-colors" title="Set to Pending">
                                <i class="fas fa-clock"></i> Pending
                            </button>
                            <button id="quick-status-resolved" class="px-3 py-1 bg-purple-900 hover:bg-purple-800 text-purple-200 rounded-lg text-xs font-semibold transition-colors" title="Mark as Resolved">
                                <i class="fas fa-check-circle"></i> Resolved
                            </button>
                            <button id="quick-status-closed" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg text-xs font-semibold transition-colors" title="Close Chat">
                                <i class="fas fa-times-circle"></i> Close
                            </button>
                            <div class="flex-1"></div>
                            <button id="copy-transcript-btn" class="px-3 py-1 bg-blue-900 hover:bg-blue-800 text-blue-200 rounded-lg text-xs font-semibold transition-colors" title="Copy Transcript">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        
                        <!-- Chat Layout with Info Sidebar -->
                        <div class="flex-1 flex overflow-hidden">
                            <!-- Messages Container -->
                            <div id="admin-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-850" style="background: linear-gradient(to bottom, #1a1f2e, #111827);"></div>
                            
                            <!-- Info Sidebar (Hidden by default) -->
                            <div id="chat-info-sidebar" class="hidden w-80 bg-gray-800 border-l border-gray-700 overflow-y-auto p-4">
                                <div class="space-y-4">
                                    <div>
                                        <h4 class="text-sm font-bold text-gray-400 uppercase mb-2">User Information</h4>
                                        <div class="bg-gray-750 rounded-lg p-3 space-y-2 text-sm">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-user text-gray-400 w-4"></i>
                                                <span class="text-white">${userName}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-id-card text-gray-400 w-4"></i>
                                                <span class="text-gray-300 font-mono text-xs">${userId}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-envelope text-gray-400 w-4"></i>
                                                <span class="text-gray-300">${chatData.email || 'N/A'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 class="text-sm font-bold text-gray-400 uppercase mb-2">Chat Details</h4>
                                        <div class="bg-gray-750 rounded-lg p-3 space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">Status:</span>
                                                ${statusBadgeHTML}
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">Created:</span>
                                                <span class="text-white text-xs">${createdAt}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">Chat ID:</span>
                                                <span class="text-white font-mono text-xs">${chatId.substring(0, 12)}...</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">Assigned:</span>
                                                <span class="text-white text-xs">${chatData.assignedAdminName || 'Unassigned'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 class="text-sm font-bold text-gray-400 uppercase mb-2">Quick Actions</h4>
                                        <div class="space-y-2">
                                            <button class="w-full px-3 py-2 bg-blue-900 hover:bg-blue-800 text-blue-200 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2" onclick="navigator.clipboard.writeText('${chatId}').then(() => showToast('Chat ID copied'))">
                                                <i class="fas fa-copy"></i> Copy Chat ID
                                            </button>
                                            <button class="w-full px-3 py-2 bg-purple-900 hover:bg-purple-800 text-purple-200 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2" onclick="navigator.clipboard.writeText('${userId}').then(() => showToast('User ID copied'))">
                                                <i class="fas fa-copy"></i> Copy User ID
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 class="text-sm font-bold text-gray-400 uppercase mb-2">Statistics</h4>
                                        <div class="bg-gray-750 rounded-lg p-3 space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">Messages:</span>
                                                <span class="text-white font-semibold">${(chatData.messages || []).length}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-400">Audience:</span>
                                                <span class="text-white">${chatData.audience || 'users'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Typing Indicator -->
                        <div id="typing-indicator" class="hidden px-4 py-2 bg-gray-800 border-t border-gray-700">
                            <div class="flex items-center gap-2 text-gray-400 text-sm">
                                <div class="flex gap-1">
                                    <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                                    <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                                    <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                                </div>
                                <span>${userName} is typing...</span>
                            </div>
                        </div>
                        
                        <!-- Message Input Area -->
                        <div class="bg-gray-800 p-4 border-t border-gray-700">
                            <form id="admin-chat-form" class="flex gap-2">
                                <button type="button" id="emoji-picker-btn" class="w-10 h-10 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg transition-colors flex items-center justify-center" title="Add Emoji">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <button type="button" id="quick-reply-btn" class="w-10 h-10 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg transition-colors flex items-center justify-center" title="Quick Replies">
                                    <i class="fas fa-bolt"></i>
                                </button>
                                <div class="flex-1 relative">
                                    <textarea id="admin-chat-input" rows="1" class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="Type your message..." style="max-height: 120px;"></textarea>
                                    <div id="char-counter" class="absolute bottom-1 right-2 text-xs text-gray-500"></div>
                                </div>
                                <button type="submit" class="w-12 h-12 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white rounded-lg transition-all shadow-lg hover:shadow-xl transform hover:scale-105" title="Send Message">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                            <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                                <span><i class="fas fa-keyboard mr-1"></i> Press Enter to send, Shift+Enter for new line</span>
                            </div>
                        </div>
                    </div>`;
            
                const modalOverlay = document.getElementById('modal-overlay');
                modalOverlay.innerHTML = modalHTML;
                modalOverlay.classList.remove('hidden');
                setDashboardLanguage(currentDashboardLanguage);

                // When opening a support chat, mark it as active and record that the admin
                // has read all existing user messages by setting adminLastRead to the
                // current server time. This ensures the user sees read receipts.
                updateDoc(chatRef, {
                    status: 'active',
                    assignedAdminId: auth.currentUser.uid,
                    assignedAdminName: currentUserData?.displayName || 'Admin',
                    adminLastRead: serverTimestamp()
                });
                
                // Setup snapshot listener immediately (don't wait for timeout)
                if (adminChatUnsub) adminChatUnsub();
                
                // Listen to chat document (not subcollection)
                adminChatUnsub = onSnapshot(chatRef, (docSnapshot) => {
                    console.log('Snapshot triggered!');
                    const messagesEl = document.getElementById('admin-chat-messages');
                    if (!messagesEl) {
                        console.log('Messages element not found yet, will retry...');
                        return;
                    }
                    
                    if (!docSnapshot.exists()) {
                        messagesEl.innerHTML = '<div class="text-center text-gray-400 py-8">Chat not found</div>';
                        return;
                    }
                    
                    const chatData = docSnapshot.data();
                    console.log('Admin received chat data:', chatData);
                    console.log('Messages array:', chatData.messages);
                    
                    const messages = (chatData.messages || []).map(msg => {
                        console.log('Processing message:', msg);
                        return {
                            ...msg,
                            timestamp: msg.timestamp || { seconds: Date.now() / 1000 }
                        };
                    });
                    
                    // Sort by timestamp
                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.seconds || 0;
                        const timeB = b.timestamp?.seconds || 0;
                        return timeA - timeB;
                    });
                    
                    // Group messages by date
                    const messagesByDate = {};
                    messages.forEach(msg => {
                        let msgDate = null;
                        if (msg.timestamp?.seconds) {
                            msgDate = new Date(msg.timestamp.seconds * 1000);
                        } else if (typeof msg.timestamp?.toDate === 'function') {
                            msgDate = msg.timestamp.toDate();
                        } else if (msg.timestamp instanceof Date) {
                            msgDate = msg.timestamp;
                        }
                        
                        if (msgDate) {
                            const dateKey = msgDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                            if (!messagesByDate[dateKey]) {
                                messagesByDate[dateKey] = [];
                            }
                            messagesByDate[dateKey].push({ ...msg, parsedDate: msgDate });
                        }
                    });
                    
                    messagesEl.innerHTML = '';
                    
                    // Render messages grouped by date
                    Object.keys(messagesByDate).forEach(dateKey => {
                        // Date separator
                        const dateSeparator = document.createElement('div');
                        dateSeparator.className = 'flex items-center justify-center my-4';
                        dateSeparator.innerHTML = `
                            <div class="px-4 py-1 bg-gray-700 rounded-full text-xs font-semibold text-gray-300 border border-gray-600">
                                ${dateKey}
                            </div>
                        `;
                        messagesEl.appendChild(dateSeparator);
                        
                        // Messages for this date
                        messagesByDate[dateKey].forEach(msg => {
                            console.log('Admin rendering message:', {
                                message: msg.message,
                                senderRole: msg.senderRole,
                                isAdminMessage: msg.senderRole === 'admin',
                                isPartnerMessage: msg.senderRole === 'partner'
                            });
                            
                            const msgWrapper = document.createElement('div');
                            msgWrapper.classList.add('flex', 'flex-col', 'animate-fadeIn');
                            
                            const bubble = document.createElement('div');
                            bubble.classList.add('px-4', 'py-3', 'rounded-2xl', 'max-w-[75%]', 'shadow-lg', 'relative');
                            
                            let senderName = '';
                            let isReadByUser = false;
                            
                            // Determine if this is admin or partner/user message
                            const isAdminMessage = msg.senderRole === 'admin';
                            const isPartnerMessage = msg.senderRole === 'partner';
                            
                            // Reply preview HTML (if needed in future)
                            let replyPreviewHTML = '';
                            
                            // Determine styling and sender name
                            if (isPartnerMessage || (!isAdminMessage && !msg.senderRole)) {
                                bubble.classList.add('bg-gradient-to-br', 'from-gray-700', 'to-gray-800', 'text-white', 'self-start', 'border', 'border-gray-600');
                                senderName = msg.senderName || (isPartnerChat ? 'Partner' : 'User');
                                
                                // Check marks for partner/user messages (sent/read)
                                const timeStr = msg.parsedDate ? msg.parsedDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
                                let checkMarks = '';
                                if (msg.isRead) {
                                    // Double check (read by admin)
                                    checkMarks = `<svg class="inline w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <path d="M1 12l4 4L15 6M9 12l4 4L23 6" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>`;
                                } else {
                                    // Single check (sent)
                                    checkMarks = `<svg class="inline w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <path d="M5 12l5 5L20 7" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>`;
                                }
                                
                                msgWrapper.innerHTML = `
                                    <div class="flex items-center gap-2 mb-1 ml-2">
                                        <div class="w-6 h-6 rounded-full ${isPartnerChat ? 'bg-purple-600' : 'bg-gray-600'} flex items-center justify-center text-white text-xs font-bold">
                                            ${senderName.charAt(0).toUpperCase()}
                                        </div>
                                        <span class="text-xs font-semibold text-gray-400">${senderName}</span>
                                    </div>
                                `;
                                
                                bubble.innerHTML = `
                                    ${replyPreviewHTML}
                                    <div class="break-words whitespace-pre-wrap leading-relaxed">${msg.message || msg.content || msg.text || ''}</div>
                                    <div class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-600 border-opacity-30">
                                        ${timeStr}${checkMarks}
                                    </div>
                                `;
                            } else if (isAdminMessage) {
                                bubble.classList.add('bg-gradient-to-br', 'from-blue-600', 'to-blue-700', 'text-white', 'self-end', 'border', 'border-blue-500');
                                senderName = msg.senderName || msg.adminName || 'Admin';
                                
                                // Compute read status for admin messages
                                if (chatData.userLastRead && msg.timestamp) {
                                    let userReadDate;
                                    if (typeof chatData.userLastRead.toDate === 'function') {
                                        userReadDate = chatData.userLastRead.toDate();
                                    } else if (chatData.userLastRead instanceof Date) {
                                        userReadDate = chatData.userLastRead;
                                    } else if (chatData.userLastRead.seconds) {
                                        userReadDate = new Date(chatData.userLastRead.seconds * 1000);
                                    }
                                    
                                    if (userReadDate && msg.parsedDate && userReadDate >= msg.parsedDate) {
                                        isReadByUser = true;
                                    }
                                }
                                
                                const timeStr = msg.parsedDate ? msg.parsedDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
                                const iconClass = isReadByUser ? 'fa-check-double text-blue-200' : 'fa-check text-blue-300';
                                const readText = isReadByUser ? 'Read' : 'Sent';
                                
                                msgWrapper.innerHTML = `
                                    <div class="flex items-center gap-2 mb-1 mr-2 justify-end">
                                        <span class="text-xs font-semibold text-gray-400">${senderName}</span>
                                        <div class="w-6 h-6 rounded-full bg-blue-700 flex items-center justify-center text-white text-xs font-bold">
                                            ${senderName.charAt(0).toUpperCase()}
                                        </div>
                                    </div>
                                `;
                                
                                bubble.innerHTML = `
                                    ${replyPreviewHTML}
                                    <div class="break-words whitespace-pre-wrap leading-relaxed">${msg.message || msg.content || msg.text || ''}</div>
                                    <div class="flex items-center justify-end gap-2 mt-2 pt-2 border-t border-blue-500 border-opacity-30">
                                        <span class="text-xs text-blue-200 opacity-80">${timeStr}</span>
                                        <i class="fas ${iconClass} text-xs" title="${readText}"></i>
                                    </div>
                                `;
                            } else {
                                bubble.classList.add('bg-gray-700', 'text-gray-300', 'self-center', 'text-xs', 'italic', 'border', 'border-gray-600');
                                bubble.innerHTML = `<div class="break-words whitespace-pre-wrap leading-relaxed">${msg.message || msg.content || msg.text || ''}</div>`;
                            }
                            
                            msgWrapper.appendChild(bubble);
                            messagesEl.appendChild(msgWrapper);
                        });
                    });
                    
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                    
                    // Mark partner's unread messages as read by admin
                    markPartnerMessagesAsReadByAdmin(chatId, chatData);
                });

                async function markPartnerMessagesAsReadByAdmin(chatId, chatData) {
                    try {
                        // Find unread partner messages
                        const messages = chatData.messages || [];
                        const unreadPartnerMessages = messages.filter(msg => 
                            msg.senderRole === 'partner' && msg.isRead === false
                        );
                        
                        if (unreadPartnerMessages.length === 0) return;
                        
                        console.log('Marking', unreadPartnerMessages.length, 'partner messages as read');
                        
                        // Update messages array - mark partner messages as read
                        const updatedMessages = messages.map(msg => {
                            if (msg.senderRole === 'partner' && msg.isRead === false) {
                                return { ...msg, isRead: true };
                            }
                            return msg;
                        });
                        
                        // Update chat document
                        await updateDoc(chatRef, {
                            messages: updatedMessages,
                            adminLastRead: serverTimestamp()
                        });
                        
                    } catch (error) {
                        console.error('Failed to mark messages as read:', error);
                    }
                }
                
                // Wait for DOM to be ready before setting up textarea listeners
                setTimeout(() => {
                    // Auto-resize textarea
                    const textarea = document.getElementById('admin-chat-input');
                    if (textarea) {
                        textarea.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                            
                            // Character counter
                            const charCounter = document.getElementById('char-counter');
                            if (charCounter) {
                                const length = this.value.length;
                                if (length > 0) {
                                    charCounter.textContent = `${length}`;
                                } else {
                                    charCounter.textContent = '';
                                }
                            }
                        });
                        
                        // Enter to send, Shift+Enter for new line
                        textarea.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                document.getElementById('admin-chat-form').dispatchEvent(new Event('submit'));
                            }
                        });
                    }
                }, 100);

                // Cleanup function
                const cleanup = () => {
                    if (adminChatUnsub) adminChatUnsub();
                    adminChatUnsub = null;
                    activeAdminChatId = null;
                    closeModal();
                };

                document.getElementById('close-modal-btn').addEventListener('click', cleanup);
                
                // Toggle info sidebar
                document.getElementById('chat-info-toggle')?.addEventListener('click', () => {
                    const sidebar = document.getElementById('chat-info-sidebar');
                    const btn = document.getElementById('chat-info-toggle');
                    if (sidebar) {
                        sidebar.classList.toggle('hidden');
                        if (sidebar.classList.contains('hidden')) {
                            btn.innerHTML = '<i class="fas fa-info-circle mr-1"></i> Info';
                        } else {
                            btn.innerHTML = '<i class="fas fa-times mr-1"></i> Close Info';
                        }
                    }
                });
                
                // Quick status change buttons
                document.getElementById('quick-status-pending')?.addEventListener('click', async () => {
                    await updateDoc(chatRef, { status: 'pending' });
                    showToast('Status changed to Pending');
                });
                
                document.getElementById('quick-status-resolved')?.addEventListener('click', async () => {
                    await updateDoc(chatRef, { status: 'resolved' });
                    showToast('Chat marked as Resolved');
                });
                
                document.getElementById('quick-status-closed')?.addEventListener('click', async () => {
                    if (confirm('Close this chat?')) {
                        await updateDoc(chatRef, { status: 'closed' });
                        showToast('Chat closed');
                        cleanup();
                    }
                });
                
                // Copy transcript button
                document.getElementById('copy-transcript-btn')?.addEventListener('click', async () => {
                    const docSnap = await getDoc(chatRef);
                    const data = docSnap.data();
                    if (!data) return;
                    
                    const messages = data.messages || [];
                    let transcript = `Chat Transcript - ${data.userName || 'User'}\n`;
                    transcript += `Date: ${new Date().toLocaleString()}\n`;
                    transcript += `Chat ID: ${chatId}\n`;
                    transcript += '='.repeat(50) + '\n\n';
                    
                    messages.forEach(msg => {
                        const sender = msg.sender === 'admin' ? (msg.adminName || 'Admin') : (data.userName || 'User');
                        const time = msg.timestamp?.seconds ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString() : '';
                        transcript += `[${time}] ${sender}: ${msg.content}\n`;
                    });
                    
                    try {
                        await navigator.clipboard.writeText(transcript);
                        showToast('Transcript copied to clipboard');
                    } catch (err) {
                        showToast('Failed to copy transcript', true);
                    }
                });
                
                // Quick reply button with predefined messages
                document.getElementById('quick-reply-btn')?.addEventListener('click', () => {
                    const quickReplies = [
                        'Hello! How can I help you today?',
                        'Thank you for contacting us. We\'re looking into your issue.',
                        'Your request has been processed successfully.',
                        'Please provide more details so we can assist you better.',
                        'We appreciate your patience. We\'ll get back to you shortly.',
                        'Is there anything else I can help you with?'
                    ];
                    
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl border border-gray-700">
                            <h3 class="text-lg font-bold mb-4 text-white">Quick Replies</h3>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                ${quickReplies.map((reply, idx) => `
                                    <button class="quick-reply-option w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors" data-reply="${reply}">
                                        ${reply}
                                    </button>
                                `).join('')}
                            </div>
                            <button class="close-quick-replies mt-4 w-full px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors">
                                Close
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    modal.querySelectorAll('.quick-reply-option').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const textarea = document.getElementById('admin-chat-input');
                            if (textarea) {
                                textarea.value = btn.dataset.reply;
                                textarea.focus();
                                textarea.dispatchEvent(new Event('input'));
                            }
                            modal.remove();
                        });
                    });
                    
                    modal.querySelector('.close-quick-replies')?.addEventListener('click', () => {
                        modal.remove();
                    });
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                });
                
                // Emoji picker (simple version)
                document.getElementById('emoji-picker-btn')?.addEventListener('click', () => {
                    const emojis = ['üòä', 'üëç', '‚ù§Ô∏è', 'üéâ', '‚úÖ', 'üëã', 'üôè', 'üíØ', '‚ö°', 'üî•', '‚ú®', 'üéØ', 'üìù', '‚è∞', 'üí°', 'üöÄ'];
                    
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4 shadow-2xl border border-gray-700">
                            <h3 class="text-lg font-bold mb-4 text-white">Select Emoji</h3>
                            <div class="grid grid-cols-4 gap-2">
                                ${emojis.map(emoji => `
                                    <button class="emoji-option text-3xl hover:bg-gray-700 rounded-lg p-2 transition-colors" data-emoji="${emoji}">
                                        ${emoji}
                                    </button>
                                `).join('')}
                            </div>
                            <button class="close-emoji-picker mt-4 w-full px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors">
                                Close
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    modal.querySelectorAll('.emoji-option').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const textarea = document.getElementById('admin-chat-input');
                            if (textarea) {
                                textarea.value += btn.dataset.emoji;
                                textarea.focus();
                                textarea.dispatchEvent(new Event('input'));
                            }
                            modal.remove();
                        });
                    });
                    
                    modal.querySelector('.close-emoji-picker')?.addEventListener('click', () => {
                        modal.remove();
                    });
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                });
                
                // Send message
                document.getElementById('admin-chat-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const inputEl = document.getElementById('admin-chat-input');
                    const text = inputEl.value.trim();
                    if (!text) return;
                    
                    console.log('Admin sending message:', text, 'to chat:', chatId);
                    
                    // Disable input while sending
                    inputEl.disabled = true;
                    
                    try {
                        // Create message object with client timestamp
                        const now = new Date();
                        const newMessage = {
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                            senderId: auth.currentUser.uid,
                            senderName: currentUserData?.displayName || 'Admin',
                            senderRole: 'admin',
                            message: text,
                            timestamp: { seconds: Math.floor(now.getTime() / 1000) },
                            isRead: false
                        };
                        
                        console.log('Admin sending message to chat:', chatId);
                        console.log('Message object:', newMessage);
                        console.log('Chat ref:', chatRef);
                        
                        // Update chat document with new message in array
                        const updateResult = await updateDoc(chatRef, {
                            messages: arrayUnion(newMessage),
                            lastMessage: text,
                            lastMessageAt: serverTimestamp(),
                            status: 'active',
                            adminOpened: true,
                            adminLastRead: serverTimestamp(),
                            adminId: auth.currentUser.uid,
                            adminName: currentUserData?.displayName || 'Admin'
                        });
                        
                        console.log('Chat document updated successfully', updateResult);
                        
                        inputEl.value = '';
                        inputEl.style.height = 'auto';
                        document.getElementById('char-counter').textContent = '';
                    } catch (error) {
                        console.error('Error sending message:', error);
                        console.error('Error code:', error.code);
                        console.error('Error message:', error.message);
                        showToast('Failed to send message: ' + error.message, true);
                    } finally {
                        inputEl.disabled = false;
                        inputEl.focus();
                    }
                });
            }); // End getDoc().then()
        } // End function openSupportChatAdmin
        
        function renderFaqPanel() {
            const panel = document.getElementById('faq-panel');
            
            const faqData = [
                {
                    category: "Umumiy Savollar",
                    icon: "fa-question-circle",
                    color: "blue",
                    questions: [
                        {
                            q: "Soundora Films platformasi nima?",
                            a: "Soundora Films - bu kontent yaratuvchilar va hamkorlar uchun video hosting va monetizatsiya platformasi. Siz o'z kontentingizni yuklashingiz va undan daromad olishingiz mumkin."
                        },
                        {
                            q: "Hamkor bo'lish uchun nima qilish kerak?",
                            a: "Hamkor bo'lish uchun platformaga ro'yxatdan o'ting va administrator bilan bog'laning. Sizning ariza ko'rib chiqiladi va tasdiqlanadi."
                        },
                        {
                            q: "Qanday turdagi kontent yuklash mumkin?",
                            a: "Filmlar, seriallar, sport tadbir lari, challenge videolar va boshqa ko'ngilochar kontentlarni yuklashingiz mumkin. Barcha kontent platforma qoidalariga mos bo'lishi kerak."
                        }
                    ]
                },
                {
                    category: "Kontent Yuklash",
                    icon: "fa-upload",
                    color: "purple",
                    questions: [
                        {
                            q: "Qanday qilib film yuklash mumkin?",
                            a: "Kontent bo'limiga o'ting va 'Film Qo'shish' tugmasini bosing. Keyin film haqida barcha ma'lumotlarni kiriting (nomi, yili, janr, va boshqalar) va video faylni yuklang."
                        },
                        {
                            q: "Qo'llab-quvvatlanadigan video formatlar qaysilar?",
                            a: "MP4, MKV, AVI, MOV formatlarini qo'llab-quvvatlaymiz. Video sifati kamida 720p (HD) bo'lishi tavsiya etiladi."
                        },
                        {
                            q: "Video hajmi cheklangan mi?",
                            a: "Bir video uchun maksimal hajm 10GB. Katta hajmli fayllar uchun administrator bilan bog'laning."
                        },
                        {
                            q: "Yuklangan kontent qachon ko'rsatila boshlaydi?",
                            a: "Barcha kontent administrator tomonidan tekshiriladi. Bu jarayon odatda 24-48 soat davom etadi. Tasdiqlangandan so'ng sizning kontentingiz platformada ko'rsatiladi."
                        }
                    ]
                },
                {
                    category: "Daromad va To'lovlar",
                    icon: "fa-dollar-sign",
                    color: "green",
                    questions: [
                        {
                            q: "Qanday qilib daromad olaman?",
                            a: "Har bir ko'rish uchun belgilangan stavka bo'yicha to'lov olasiz. Ko'rishlar soni ko'paygan sari daromadingiz ham oshadi."
                        },
                        {
                            q: "To'lovlar qachon amalga oshiriladi?",
                            a: "To'lovlar har oy boshida amalga oshiriladi. Minimal to'lov summasi $100. Daromadingiz bu miqdorga yetganda, keyingi oy boshida to'lov qilinadi."
                        },
                        {
                            q: "Daromadimni qayerdan ko'raman?",
                            a: "Barcha daromad va to'lovlar ma'lumotlarini 'Royalti' bo'limida ko'rishingiz mumkin. U yerda film bo'yicha batafsil statistika ham mavjud."
                        },
                        {
                            q: "Qaysi to'lov usullarini qo'llab-quvvatlaysiz?",
                            a: "Bank o'tkazmasi, PayPal va boshqa xalqaro to'lov tizimlari orqali to'lov qilishimiz mumkin. To'lov ma'lumotlarini sozlamalarda sozlang."
                        }
                    ]
                },
                {
                    category: "Statistika va Tahlil",
                    icon: "fa-chart-line",
                    color: "yellow",
                    questions: [
                        {
                            q: "Qayerdan statistikani ko'raman?",
                            a: "'Statistika' bo'limida barcha ko'rishlar, yoqtirishlar va boshqa ko'rsatkichlarni ko'rishingiz mumkin."
                        },
                        {
                            q: "Statistika qancha tez-tez yangilanadi?",
                            a: "Statistika real vaqt rejimida yangilanadi. Ko'rishlar va boshqa ma'lumotlar bir necha daqiqada tizimga tushadi."
                        },
                        {
                            q: "Top filmlarimni qanday bilaman?",
                            a: "Statistika bo'limida eng ko'p ko'rilgan filmlar ro'yxati mavjud. Shuningdek, har bir film uchun alohida statistika ham ko'rsatiladi."
                        }
                    ]
                },
                {
                    category: "Yordam va Qo'llab-quvvatlash",
                    icon: "fa-life-ring",
                    color: "red",
                    questions: [
                        {
                            q: "Muammo bo'lsa qayerga murojaat qilaman?",
                            a: "'Yordam' bo'limida operator bilan bog'lanishingiz yoki support@soundora.com elektron pochtasiga xat yozishingiz mumkin."
                        },
                        {
                            q: "Yordam xizmati qachon ishlaydi?",
                            a: "Yordam xizmati Dushanba-Juma 09:00-18:00 va Shanba 10:00-14:00 gacha ishlaydi. Yakshanba dam olish kuni."
                        },
                        {
                            q: "Texnik muammo yuzaga keldi, nima qilaman?",
                            a: "Texnik muammolar uchun tech@soundora.com ga xat yozing yoki 'Yordam' bo'limida operator bilan chatda muloqot qiling."
                        }
                    ]
                }
            ];
            
            const colorClasses = {
                blue: { from: 'from-blue-600', to: 'to-blue-500', bg: 'bg-blue-600', text: 'text-blue-400' },
                purple: { from: 'from-purple-600', to: 'to-purple-500', bg: 'bg-purple-600', text: 'text-purple-400' },
                green: { from: 'from-green-600', to: 'to-green-500', bg: 'bg-green-600', text: 'text-green-400' },
                yellow: { from: 'from-yellow-600', to: 'to-yellow-500', bg: 'bg-yellow-600', text: 'text-yellow-400' },
                red: { from: 'from-red-600', to: 'to-red-500', bg: 'bg-red-600', text: 'text-red-400' }
            };
            
            panel.innerHTML = `
                <div class="max-w-6xl mx-auto space-y-8">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-900 to-indigo-800 p-8 rounded-xl shadow-xl border border-indigo-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-4xl font-black text-white mb-3 flex items-center gap-3">
                                    <i class="fas fa-question-circle"></i>
                                    Ko'p So'raladigan Savollar (FAQ)
                                </h1>
                                <p class="text-indigo-200 text-lg">
                                    Platformamiz haqida eng muhim savollarga javoblar
                                </p>
                            </div>
                            <div class="hidden md:block w-20 h-20 bg-indigo-700/50 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                <i class="fas fa-book-open text-4xl text-indigo-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FAQ Categories -->
                    ${faqData.map((category, catIndex) => {
                        const colors = colorClasses[category.color];
                        return `
                            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl border border-gray-700 overflow-hidden">
                                <div class="bg-gradient-to-r ${colors.from} ${colors.to} p-5">
                                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                                        <i class="fas ${category.icon}"></i>
                                        ${category.category}
                                    </h2>
                                </div>
                                <div class="p-6 space-y-3">
                                    ${category.questions.map((item, qIndex) => `
                                        <details class="bg-gray-700/50 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-all group">
                                            <summary class="font-semibold text-white flex items-center justify-between list-none">
                                                <span class="flex items-start gap-3">
                                                    <i class="fas fa-chevron-right ${colors.text} mt-1 group-open:rotate-90 transition-transform"></i>
                                                    <span>${item.q}</span>
                                                </span>
                                            </summary>
                                            <div class="mt-3 ml-8 text-sm text-gray-300 leading-relaxed border-l-4 ${colors.text.replace('text-', 'border-')} pl-4">
                                                ${item.a}
                                            </div>
                                        </details>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- Still Have Questions -->
                    <div class="bg-gradient-to-r from-orange-900/50 to-orange-800/50 p-8 rounded-xl border border-orange-700/30 text-center">
                        <i class="fas fa-comments text-5xl text-orange-400 mb-4"></i>
                        <h3 class="text-2xl font-bold text-white mb-3">Hali ham savolingiz bormi?</h3>
                        <p class="text-gray-300 mb-6">Bizning yordam jamoamiz sizga yordam berishga tayyor!</p>
                        <div class="flex flex-wrap gap-4 justify-center">
                            <a href="#" onclick="document.getElementById('partner-support-link')?.click(); return false;" class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold px-6 py-3 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                <i class="fas fa-headset"></i>
                                Yordam Xizmatiga Murojaat
                            </a>
                            <a href="mailto:support@soundora.com" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold px-6 py-3 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                <i class="fas fa-envelope"></i>
                                Email Yuborish
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPrivacyPanel() {
             const panel = document.getElementById('privacy-panel');
             panel.innerHTML = `
                <div class="max-w-5xl mx-auto space-y-6">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-purple-900 to-purple-800 p-8 rounded-xl shadow-xl border border-purple-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-4xl font-black text-white mb-3 flex items-center gap-3">
                                    <i class="fas fa-shield-alt"></i>
                                    Maxfiylik Siyosati
                                </h1>
                                <p class="text-purple-200 text-lg">
                                    Sizning shaxsiy ma'lumotlaringiz xavfsizligi bizning ustuvor vazifamiz
                                </p>
                            </div>
                            <div class="hidden md:block w-20 h-20 bg-purple-700/50 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                <i class="fas fa-user-shield text-4xl text-purple-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Privacy Sections -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-400"></i>
                            Kirish
                        </h2>
                        <p class="text-gray-300 leading-relaxed">
                            Soundora Films platformasida biz sizning shaxsiy ma'lumotlaringizni himoya qilishga jiddiy e'tibor beramiz. 
                            Ushbu maxfiylik siyosati qanday ma'lumotlar to'planishi, ulardan qanday foydalanilishi va qanday himoya qilinishini tushuntiradi.
                        </p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-database text-green-400"></i>
                            To'planadigan Ma'lumotlar
                        </h2>
                        <ul class="space-y-3 text-gray-300">
                            <li class="flex items-start gap-3">
                                <i class="fas fa-check-circle text-green-400 mt-1"></i>
                                <span><strong>Shaxsiy ma'lumotlar:</strong> Ism, email manzil, telefon raqam</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <i class="fas fa-check-circle text-green-400 mt-1"></i>
                                <span><strong>Hisob ma'lumotlari:</strong> Foydalanuvchi nomi, parol (shifrlangan holda)</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <i class="fas fa-check-circle text-green-400 mt-1"></i>
                                <span><strong>To'lov ma'lumotlari:</strong> Bank hisob raqami (xavfsiz tarzda)</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <i class="fas fa-check-circle text-green-400 mt-1"></i>
                                <span><strong>Foydalanish statistikasi:</strong> Platformadan foydalanish ma'lumotlari</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-user-lock text-purple-400"></i>
                            Ma'lumotlardan Foydalanish
                        </h2>
                        <p class="text-gray-300 leading-relaxed mb-4">
                            To'plangan ma'lumotlardan quyidagi maqsadlar uchun foydalanamiz:
                        </p>
                        <ul class="space-y-3 text-gray-300">
                            <li class="flex items-start gap-3">
                                <i class="fas fa-arrow-right text-purple-400 mt-1"></i>
                                <span>Platformani to'g'ri ishlashi va xizmatlar ko'rsatish</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <i class="fas fa-arrow-right text-purple-400 mt-1"></i>
                                <span>Royalti hisoblash va to'lovlar amalga oshirish</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <i class="fas fa-arrow-right text-purple-400 mt-1"></i>
                                <span>Sizning hisobingizni va ma'lumotlaringizni himoya qilish</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <i class="fas fa-arrow-right text-purple-400 mt-1"></i>
                                <span>Yangiliklar va muhim xabarlarni yuborish</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-lock text-yellow-400"></i>
                            Xavfsizlik
                        </h2>
                        <p class="text-gray-300 leading-relaxed mb-4">
                            Biz ma'lumotlaringiz xavfsizligini ta'minlash uchun zamonaviy texnologiyalardan foydalanamiz:
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <i class="fas fa-shield-alt text-2xl text-yellow-400 mb-2"></i>
                                <h3 class="font-bold text-white mb-1">SSL Shifrlash</h3>
                                <p class="text-sm text-gray-400">Barcha ma'lumotlar shifrlangan holda uzatiladi</p>
                            </div>
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <i class="fas fa-database text-2xl text-yellow-400 mb-2"></i>
                                <h3 class="font-bold text-white mb-1">Xavfsiz Saqlash</h3>
                                <p class="text-sm text-gray-400">Ma'lumotlar shifrlangan serverda saqlanadi</p>
                            </div>
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <i class="fas fa-user-check text-2xl text-yellow-400 mb-2"></i>
                                <h3 class="font-bold text-white mb-1">Kirish Nazorati</h3>
                                <p class="text-sm text-gray-400">Faqat ruxsat etilgan xodimlar ma'lumotlarga kiradi</p>
                            </div>
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <i class="fas fa-clock text-2xl text-yellow-400 mb-2"></i>
                                <h3 class="font-bold text-white mb-1">Doimiy Monitoring</h3>
                                <p class="text-sm text-gray-400">24/7 xavfsizlik nazorati</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-handshake text-red-400"></i>
                            Uchinchi Tomonlar
                        </h2>
                        <p class="text-gray-300 leading-relaxed">
                            Biz sizning shaxsiy ma'lumotlaringizni uchinchi tomonlarga sotmaymiz yoki ulashmirmiz. 
                            Faqat quyidagi holatlarda ma'lumotlar ulashilishi mumkin:
                        </p>
                        <ul class="mt-4 space-y-2 text-gray-300">
                            <li class="flex items-start gap-3">
                                <i class="fas fa-gavel text-red-400 mt-1"></i>
                                <span>Qonuniy talablar bo'yicha (sud qarorlari)</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <i class="fas fa-credit-card text-red-400 mt-1"></i>
                                <span>To'lovlarni amalga oshirish uchun (to'lov tizimlar bilan)</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-900/50 to-blue-800/50 p-6 rounded-xl border border-blue-700/30">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-envelope text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-2">Savol va Takliflar</h3>
                                <p class="text-blue-200 mb-3">
                                    Maxfiylik siyosati haqida savollaringiz bo'lsa, biz bilan bog'laning:
                                </p>
                                <a href="mailto:privacy@soundora.com" class="text-blue-300 hover:text-blue-200 font-semibold">
                                    <i class="fas fa-at mr-1"></i>privacy@soundora.com
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
             `;
        }

        function renderArchivePanel() {
            const panel = document.getElementById('archive-panel');
            
            // Calculate statistics
            const totalArchived = archivedUsers.length;
            const archivedThisMonth = archivedUsers.filter(u => {
                if (!u.archivedAt) return false;
                const archivedDate = new Date(u.archivedAt);
                const now = new Date();
                return archivedDate.getMonth() === now.getMonth() && archivedDate.getFullYear() === now.getFullYear();
            }).length;
            const archivedThisYear = archivedUsers.filter(u => {
                if (!u.archivedAt) return false;
                const archivedDate = new Date(u.archivedAt);
                return archivedDate.getFullYear() === new Date().getFullYear();
            }).length;
            
            panel.innerHTML = `
                <!-- Statistics Dashboard -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-red-900 to-red-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-200 text-sm font-medium">Total Archived</p>
                                <p class="text-3xl font-bold text-white mt-1">${totalArchived}</p>
                            </div>
                            <div class="bg-red-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-archive text-2xl text-red-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-orange-900 to-orange-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-200 text-sm font-medium">This Month</p>
                                <p class="text-3xl font-bold text-white mt-1">${archivedThisMonth}</p>
                            </div>
                            <div class="bg-orange-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-calendar-alt text-2xl text-orange-200"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 p-4 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-200 text-sm font-medium">This Year</p>
                                <p class="text-3xl font-bold text-white mt-1">${archivedThisYear}</p>
                            </div>
                            <div class="bg-yellow-800 bg-opacity-50 p-3 rounded-full">
                                <i class="fas fa-chart-line text-2xl text-yellow-200"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                            <i class="fas fa-box-archive text-red-400"></i>
                            Archived Users
                        </h2>
                        <p class="text-sm text-gray-400 mt-1">View and restore archived user accounts</p>
                    </div>
                    ${archivedUsers.length > 0 ? `
                    <button id="bulk-restore-btn" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fas fa-undo-alt"></i>
                        <span>Bulk Restore</span>
                    </button>` : ''}
                </div>
                
                <!-- Search Bar -->
                ${archivedUsers.length > 0 ? `
                <div class="mb-6 bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="relative">
                        <input type="text" id="archive-search-input" placeholder="Search archived users by name, email, or ID..." 
                            class="w-full px-4 py-2 pl-10 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500" />
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>` : ''}
                
                <div id="archive-table-container"></div>
            `;
            
            renderArchiveTable(archivedUsers);
            
            // Search functionality
            const searchInput = document.getElementById('archive-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const filtered = archivedUsers.filter(u =>
                        (u.displayName && u.displayName.toLowerCase().includes(searchTerm)) ||
                        (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                        (u.customId && u.customId.toLowerCase().includes(searchTerm))
                    );
                    renderArchiveTable(filtered);
                });
            }
            
            // Bulk restore
            const bulkRestoreBtn = document.getElementById('bulk-restore-btn');
            if (bulkRestoreBtn) {
                bulkRestoreBtn.addEventListener('click', () => {
                    const confirmMsg = `Restore all ${archivedUsers.length} archived users?`;
                    if (confirm(confirmMsg)) {
                        archivedUsers.forEach(u => restoreUser(u.uid));
                        showToast(`Restoring ${archivedUsers.length} users...`);
                    }
                });
            }
            
            setDashboardLanguage(currentDashboardLanguage);
        }
        
        function renderArchiveTable(userList) {
            const container = document.getElementById('archive-table-container');
            if (!container) return;
            
            if (userList.length === 0) {
                container.innerHTML = `<div class="bg-gray-800 rounded-lg p-12 text-center">
                    <i class="fas fa-box-open text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-400 text-lg" data-lang-key="archiveEmpty">Archive is empty</p>
                    <p class="text-gray-600 text-sm mt-2">No archived users found</p>
                </div>`;
                setDashboardLanguage(currentDashboardLanguage);
                return;
            }

            const tableHeaders = `
            <thead class="bg-gray-800">
                <tr class="border-b border-gray-700">
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="name">Name</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">Email</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="customId">ID</th>
                    <th class="p-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="archivedDate">Archived Date</th>
                    <th class="p-4 text-center text-xs font-bold uppercase tracking-wider text-gray-400" data-lang-key="actions">Actions</th>
                </tr>
            </thead>`;
            
            const tableRows = userList.map(u => {
                const archivedDate = u.archivedAt ? new Date(u.archivedAt).toLocaleDateString('en-GB', {
                    day: '2-digit', month: 'short', year: 'numeric'
                }) : 'N/A';
                
                return `
            <tr class="border-b border-gray-700 hover:bg-gray-750 transition-colors">
                <td class="p-4 text-sm text-white font-medium">${u.displayName || 'Anonymous'}</td>
                <td class="p-4 text-sm text-gray-300">${u.email || 'N/A'}</td>
                <td class="p-4 text-sm font-mono text-red-400">${u.customId || '-'}</td>
                <td class="p-4 text-sm text-gray-400">${archivedDate}</td>
                <td class="p-4 text-center">
                    <button class="restore-user-btn w-10 h-10 bg-green-600 hover:bg-green-500 text-white rounded-lg transition-colors shadow-lg hover:shadow-xl" data-id="${u.uid}" title="Restore User">
                        <i class="fas fa-undo-alt"></i>
                    </button>
                </td>
            </tr>`;
            }).join('');
            
            container.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-full">${tableHeaders}<tbody class="divide-y divide-gray-700">${tableRows}</tbody></table>
                </div>
            </div>`;
            
            container.querySelectorAll('.restore-user-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.id;
                    const title = dashboardTranslations[currentDashboardLanguage].restoreUserConfirmTitle || 'Restore User?';
                    const message = dashboardTranslations[currentDashboardLanguage].restoreUserConfirmMessage || 'Are you sure you want to restore this user?';
                    openConfirmationModal(title, message, () => restoreUser(userId), "restoreUser");
                });
            });
            
            setDashboardLanguage(currentDashboardLanguage);
        }

        // --- Event tinglovchilari va harakatlar ---
        function attachContentActionListeners() {
            document.getElementById('add-movie-btn')?.addEventListener('click', () => openMovieModal());
            document.querySelectorAll('.edit-btn').forEach(button => button.addEventListener('click', (e) => { 
                const id = e.currentTarget.dataset.id; 
                const movie = movies.find(m => m.id === id); 
                if(movie) openMovieModal(movie); 
            }));
            
            // Approve button for admins
            document.querySelectorAll('.approve-btn').forEach(button => button.addEventListener('click', async (e) => {
                const id = e.currentTarget.dataset.id;
                const movie = movies.find(m => m.id === id);
                if (!movie) return;
                
                if (confirm(`Approve fixed content: "${movie.title}"?`)) {
                    try {
                        await updateDoc(doc(db, 'movies', id), {
                            awaitingAdminApproval: false,
                            hiddenFromUsers: false,
                            needsReview: false,
                            approvedAt: new Date().toISOString(),
                            approvedBy: auth.currentUser?.uid
                        });
                        
                        // Notify partner
                        if (movie.partnerId) {
                            await addDoc(collection(db, 'notifications'), {
                                userId: movie.partnerId,
                                type: 'content_approved',
                                title: 'Content Approved',
                                message: `Your content "${movie.title}" has been reviewed and approved.`,
                                movieId: id,
                                movieTitle: movie.title,
                                timestamp: serverTimestamp(),
                                read: false
                            });
                        }
                        
                        showToast('Content approved and published!');
                    } catch (error) {
                        console.error('Error approving content:', error);
                        showToast('Failed to approve content', true);
                    }
                }
            }));
            
             if(currentUserRole === 'admin') {
                document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', (e) => { 
                    const id = e.currentTarget.dataset.id; 
                    openConfirmationModal('–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º?', dashboardTranslations[currentDashboardLanguage].messageDelete, async () => {
                        await deleteDoc(doc(db, "movies", id));
                        showToast('–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.');
                    }, "delete");
                }));
            }
        }

        function attachUserActionListeners() {
            document.querySelectorAll('#users-table-container tr[data-id]').forEach(row => {
                row.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.id;
                    if (userId) showUserDetails(userId);
                });
            });
        }

        function setupMenuListeners() {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    const panelId = e.currentTarget.dataset.panel;
                    const titleKey = e.currentTarget.dataset.title;

                    // Save current panel to localStorage
                    localStorage.setItem('lastActivePanel', panelId);

                    document.querySelectorAll('#main-content > div').forEach(panel => panel.classList.add('hidden'));
                    
                    const panelToShow = document.getElementById(panelId);
                    panelToShow.classList.remove('hidden');
                    
                    document.getElementById('page-title').setAttribute('data-lang-key', titleKey);
                    
                    switch(panelId) {
                        case 'content-panel': renderContentPanel(); break;
                        case 'royalty-panel': renderRoyaltyPanel(); break;
                        case 'stats-panel': renderStatsPanel(); break;
                        case 'settings-panel': renderSettingsPanel(); break;
                        case 'partners-panel': renderPartnersPanel(); break;
                        case 'users-panel': renderUsersPanel(); break;
                        case 'archive-panel': renderArchivePanel(); break;
                        case 'requests-panel': renderRequestsPanel(); break;
                        case 'reports-panel': renderReportsPanel(); break;
                        case 'support-chats-panel': renderSupportChatsPanel(); break;
                        case 'admins-panel': renderAdminsPanel(); break;
                        case 'faq-panel': renderFaqPanel(); break;
                        case 'privacy-panel': renderPrivacyPanel(); break;
                        case 'promocodes-panel': renderPromoCodesPanel(); break;
                        case 'ads-panel': renderAdsPanel(); break;
                        case 'support-profile-panel': renderSupportProfilePanel(); break;
                        case 'region-panel': renderRegionPanel(); break;
                        case 'hero-panel': renderHeroPanel(); break;
                        case 'policy-panel': renderPolicyPanel(); break;
                        case 'partner-support-panel': renderPartnerSupportPanel(); break;
                case 'alerts-panel': renderAlertsPanel(); break;
                    }
                    
                    setDashboardLanguage(currentDashboardLanguage);
                    if (window.innerWidth < 768) { closeMobileSidebar(); }
                });
            });
        }

        // --- FIREBASE MA'LUMOTLARINI ISHLASH ---

        async function generateAndAssignCustomIds(usersToUpdate, prefix, counterName) {
            if (usersToUpdate.length === 0) return;
            console.log(`Found ${usersToUpdate.length} ${counterName} without a custom ID. Assigning now...`);
            loadingOverlay.classList.remove('hidden');
            const counterRef = doc(db, "counters", counterName);
            try {
                const newLastCount = await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let currentCount = 0;
                    if (counterDoc.exists()) {
                        currentCount = counterDoc.data().count || 0;
                    }
                    const newCount = currentCount + usersToUpdate.length;
                    transaction.set(counterRef, { count: newCount }, { merge: true });
                    return newCount;
                });
                const batch = writeBatch(db);
                let countForId = newLastCount - usersToUpdate.length;
                usersToUpdate.forEach(user => {
                    countForId++;
                    const newCustomId = `${prefix}-${String(countForId).padStart(4, '0')}`;
                    const userRef = doc(db, "users", user.uid);
                    batch.update(userRef, { customId: newCustomId });
                });
                await batch.commit();
                showToast(`${usersToUpdate.length} ta foydalanuvchiga ID muvaffaqiyatli biriktirildi.`);
            } catch (e) {
                console.error("ID biriktirishda xatolik:", e);
                showToast("ID biriktirishda xatolik yuz berdi.", true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        async function deletePartner(partnerId) {
            loadingOverlay.classList.remove('hidden');
            try {
                await deleteDoc(doc(db, "users", partnerId));
                
                showToast(dashboardTranslations[currentDashboardLanguage].partnerDeletedSuccess);
                document.getElementById('partner-details-view').classList.add('hidden');
                document.getElementById('partner-list-view').classList.remove('hidden');
            } catch (error) {
                console.error("Error deleting partner: ", error);
                showToast("Error deleting partner.", true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function archiveUser(userId) {
            loadingOverlay.classList.remove('hidden');
            try {
                const userRef = doc(db, "users", userId);
                const archivedUserRef = doc(db, "archived_users", userId);
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw "User document does not exist!";
                    const userData = userDoc.data();
                    transaction.set(archivedUserRef, { ...userData, archivedAt: new Date().toISOString() });
                    transaction.delete(userRef);
                });
                showToast(dashboardTranslations[currentDashboardLanguage].userArchivedSuccess);
                document.getElementById('user-details-view').classList.add('hidden');
                document.getElementById('user-list-view').classList.remove('hidden');
            } catch (error) {
                console.error("Error archiving user: ", error);
                showToast("Error archiving user.", true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function restoreUser(userId) {
            loadingOverlay.classList.remove('hidden');
            try {
                const archivedUserRef = doc(db, "archived_users", userId);
                const userRef = doc(db, "users", userId);
                await runTransaction(db, async (transaction) => {
                    const archivedDoc = await transaction.get(archivedUserRef);
                    if (!archivedDoc.exists()) throw "Archived user not found!";
                    const userData = archivedDoc.data();
                    delete userData.archivedAt;
                    transaction.set(userRef, userData);
                    transaction.delete(archivedUserRef);
                });
                showToast(dashboardTranslations[currentDashboardLanguage].userRestoredSuccess);
            } catch (error) {
                console.error("Error restoring user: ", error);
                showToast("Error restoring user.", true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function updatePremiumAndTariff(userId, isPremium, tariff) {
            const userRef = doc(db, "users", userId);
            try {
                const dataToUpdate = {
                    isPremium: isPremium,
                    tariff: isPremium ? tariff : null 
                };
                await updateDoc(userRef, dataToUpdate);
                const message = isPremium ? dashboardTranslations[currentDashboardLanguage].premiumEnabled : dashboardTranslations[currentDashboardLanguage].premiumDisabled;
                showToast(message);
                
                const userIndex = users.findIndex(u => u.uid === userId);
                if (userIndex > -1) {
                    users[userIndex].isPremium = isPremium;
                    users[userIndex].tariff = isPremium ? tariff : null;
                }
                
                closeModal();
                showUserDetails(userId);
            } catch (error) {
                console.error("Error updating premium status:", error);
                showToast("Error updating premium status.", true);
            }
        }
        
        async function acceptTerminationRequest(requestId, partnerId) {
            loadingOverlay.classList.remove('hidden');
            try {
                await deleteDoc(doc(db, "users", partnerId));
                await deleteDoc(doc(db, "terminationRequests", requestId));
                showToast(dashboardTranslations[currentDashboardLanguage].requestAccepted);
            } catch (error) {
                console.error("Error accepting request: ", error);
                showToast("Error accepting request.", true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function declineTerminationRequest(requestId) {
            loadingOverlay.classList.remove('hidden');
            try {
                await deleteDoc(doc(db, "terminationRequests", requestId));
                showToast(dashboardTranslations[currentDashboardLanguage].requestDeclined);
            } catch (error) {
                console.error("Error declining request: ", error);
                showToast("Error declining request.", true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function updateCustomId(userId, newId) {
            if (!newId || newId.trim() === "") {
                showToast("ID cannot be empty.", true);
                return;
            }
            const userRef = doc(db, "users", userId);
            try {
                await updateDoc(userRef, { customId: newId.trim() });
                showToast(dashboardTranslations[currentDashboardLanguage].idUpdated);
                const userIndex = users.findIndex(u => u.uid === userId);
                if (userIndex > -1) {
                    users[userIndex].customId = newId.trim();
                }
                document.querySelector('#custom-id-view code').textContent = newId.trim();
                document.getElementById('custom-id-edit').classList.add('hidden');
                document.getElementById('custom-id-view').classList.remove('hidden');

            } catch (error) {
                console.error("Error updating custom ID:", error);
                showToast("Error updating custom ID.", true);
            }
        }

        function setupFirestoreListeners(userId, role) {
            currentUserRole = role;
            currentPartnerId = role === 'partner' ? userId : null;
            
            unsubSettings = onSnapshot(doc(db, "settings", "main"), (docSnap) => {
                if (docSnap.exists()) settings = docSnap.data();
            });

            const moviesQuery = (role === 'admin' || currentUserData?.permissions?.manageContent)
                ? collection(db, "movies") 
                : query(collection(db, "movies"), where("partnerId", "==", userId));

            unsubMovies = onSnapshot(moviesQuery, (snapshot) => {
                movies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(document.getElementById('content-panel')?.offsetParent) renderContentPanel();
            });

            if (role === 'admin' || role === 'agent') {
                unsubAllUsers = onSnapshot(collection(db, "users"), async (snapshot) => {
                    allUsers = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                    
                    users = allUsers.filter(u => u.role === 'user');
                    partners = allUsers.filter(u => u.role === 'partner');
                    
                    currentUserData = allUsers.find(u => u.uid === userId);
                    
                    if(role === 'admin') {
                        const usersWithoutId = users.filter(u => !u.customId);
                        if (usersWithoutId.length > 0) await generateAndAssignCustomIds(usersWithoutId, 'A', 'userCounter');
                        
                        const partnersWithoutId = partners.filter(p => !p.customId);
                        if (partnersWithoutId.length > 0) await generateAndAssignCustomIds(partnersWithoutId, 'P', 'partnerCounter');
                        const partnersMissingCategories = partners.filter(p => !Array.isArray(p.allowedCategories) || p.allowedCategories.length === 0);
                        if (partnersMissingCategories.length > 0) {
                            partnersMissingCategories.forEach(async (partner) => {
                                try {
                                    await updateDoc(doc(db, "users", partner.uid), { allowedCategories: ['general'] });
                                } catch (error) {
                                    console.warn('Failed to backfill categories for partner', partner.uid, error);
                                }
                            });
                        }
                    }

                    if(document.getElementById('users-panel')?.offsetParent) filterUsers();
                    if(document.getElementById('partners-panel')?.offsetParent) filterPartners();
                    if(document.getElementById('requests-panel')?.offsetParent) renderRequestsPanel();
                });

                unsubArchivedUsers = onSnapshot(collection(db, "archived_users"), (snapshot) => {
                    archivedUsers = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                    if(document.getElementById('archive-panel')?.offsetParent) renderArchivePanel();
                });
                unsubRequests = onSnapshot(collection(db, "terminationRequests"), (snapshot) => {
                    terminationRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(document.getElementById('requests-panel')?.offsetParent) renderRequestsPanel();
                });
                
                // Listen to user feedback reports
                unsubFeedback = onSnapshot(collection(db, "userFeedback"), (snapshot) => {
                    userFeedbackReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log('User Feedback loaded:', userFeedbackReports.length, 'reports');
                    console.log('Feedback data:', userFeedbackReports);
                    if(document.getElementById('requests-panel')?.offsetParent) renderRequestsPanel();
                }, (error) => {
                    console.error('Error loading user feedback:', error);
                });
            } else {
                 unsubAllUsers = onSnapshot(doc(db, "users", userId), (docSnap) => {
                    if (docSnap.exists()) currentUserData = { uid: docSnap.id, ...docSnap.data() };
                });
            }

            unsubPayments = onSnapshot(collection(db, "paymentHistory"), (snapshot) => {
                paymentHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if(document.getElementById('royalty-panel')?.offsetParent) renderRoyaltyPanel();
            });
            
            // Load notifications for partners and admins
            if (role === 'partner' || role === 'admin') {
                unsubNotifications = onSnapshot(
                    query(collection(db, 'notifications'), where('userId', '==', userId), orderBy('timestamp', 'desc')),
                    (snapshot) => {
                        partnerNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateNotificationUI();
                    }
                );
            }
        }

        function unsubscribeListeners() {
            if (unsubMovies) unsubMovies();
            if (unsubAllUsers) unsubAllUsers();
            if (unsubArchivedUsers) unsubArchivedUsers();
            if (unsubRequests) unsubRequests();
            if (unsubPayments) unsubPayments();
            if (unsubSettings) unsubSettings();
            if (unsubFeedback) unsubFeedback();
            if (unsubNotifications) unsubNotifications();
            if (tempCodeInterval) clearInterval(tempCodeInterval);
        }
        
        // ==================== NOTIFICATION FUNCTIONS ====================
        function updateNotificationUI() {
            const badge = document.getElementById('notification-badge');
            const notificationsList = document.getElementById('notifications-list');
            
            if (!badge || !notificationsList) return;
            
            const unreadCount = partnerNotifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            // Render notifications
            if (partnerNotifications.length === 0) {
                notificationsList.innerHTML = '<p class="text-gray-400 text-center py-4">No notifications</p>';
            } else {
                notificationsList.innerHTML = partnerNotifications.map(notif => {
                    const date = notif.timestamp ? 
                        (notif.timestamp.toDate ? notif.timestamp.toDate() : new Date(notif.timestamp)).toLocaleDateString('en-US', { 
                            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                        }) : '';
                    
                    const bgClass = notif.read ? 'bg-gray-700' : 'bg-gray-600';
                    const typeIcon = notif.type === 'content_report' ? 'fa-flag' : 
                                   notif.type === 'content_approved' ? 'fa-check-circle' : 'fa-bell';
                    const typeColor = notif.type === 'content_report' ? 'text-orange-400' : 
                                    notif.type === 'content_approved' ? 'text-green-400' : 'text-blue-400';
                    
                    return `
                        <div class="p-4 hover:bg-gray-700 cursor-pointer transition-colors ${bgClass}" onclick="handleNotificationClick('${notif.id}')">
                            <div class="flex items-start gap-3">
                                <i class="fas ${typeIcon} ${typeColor} mt-1"></i>
                                <div class="flex-1">
                                    <p class="text-white font-semibold text-sm">${notif.title}</p>
                                    <p class="text-gray-300 text-xs mt-1">${notif.message}</p>
                                    <p class="text-gray-500 text-xs mt-1">${date}</p>
                                </div>
                                ${!notif.read ? '<div class="w-2 h-2 bg-red-500 rounded-full mt-2"></div>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        async function handleNotificationClick(notificationId) {
            const notif = partnerNotifications.find(n => n.id === notificationId);
            if (!notif) return;
            
            // Mark as read
            if (!notif.read) {
                try {
                    await updateDoc(doc(db, 'notifications', notificationId), { read: true });
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }
            
            // Handle action based on type
            if (notif.type === 'content_report' && notif.movieId) {
                // Partner: Open edit movie modal for the reported content
                const movie = movies.find(m => m.id === notif.movieId);
                if (movie) {
                    openMovieModal(movie);
                    closeNotificationsDropdown();
                    
                    // Show report details in a toast
                    setTimeout(() => {
                        showToast(`Report: ${notif.reportReason}. ${notif.reportDescription || ''}`, false, 5000);
                    }, 500);
                } else {
                    showToast('Movie not found', true);
                }
            } else if (notif.type === 'content_approval_needed' && notif.movieId) {
                // Admin: Navigate to content panel with awaiting approval filter
                const contentLink = document.querySelector('#content-link');
                if (contentLink) {
                    contentLink.click();
                    
                    // Set filter to awaiting approval after panel loads
                    setTimeout(() => {
                        const statusFilter = document.getElementById('content-status-filter');
                        if (statusFilter) {
                            statusFilter.value = 'awaiting-approval';
                            contentFilterState.status = 'awaiting-approval';
                            updateContentDisplay();
                        }
                    }, 300);
                }
                closeNotificationsDropdown();
                showToast('Content awaiting your approval');
            } else if (notif.type === 'content_approved') {
                showToast('Your content has been approved and is now visible to users!');
                closeNotificationsDropdown();
            }
        }
        
        function closeNotificationsDropdown() {
            const dropdown = document.getElementById('notifications-dropdown');
            if (dropdown) dropdown.classList.add('hidden');
        }
        
        // Make notification function globally accessible for onclick handlers
        window.handleNotificationClick = handleNotificationClick;
        // ==================== END NOTIFICATION FUNCTIONS ====================
        
        // Movie selection modal for notifications
        function openMovieSelectionModal() {
            const modalOverlay = document.getElementById('modal-overlay');
            if (!modalOverlay) return;
            
            // Filter and sort movies
            const sortedMovies = [...movies].sort((a, b) => {
                const dateA = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                const dateB = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                return dateB - dateA;
            });
            
            modalOverlay.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Select Content for Promotion</h3>
                        <button id="close-movie-selector" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    
                    <!-- Search -->
                    <div class="mb-4">
                        <input type="text" id="movie-search-input" 
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-sm text-gray-100" 
                            placeholder="Search by title, ID, or keywords..." />
                    </div>
                    
                    <!-- Movie grid -->
                    <div id="movie-selection-grid" class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        ${sortedMovies.map(m => `
                            <div class="movie-select-card bg-gray-700 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-purple-500 transition" 
                                data-movie-id="${m.id}" 
                                data-movie-title="${m.title || 'Untitled'}" 
                                data-movie-poster="${m.poster || ''}">
                                <img src="${m.poster || 'https://placehold.co/300x450/333/fff?text=No+Image'}" 
                                    class="w-full h-48 object-cover" 
                                    onerror="this.src='https://placehold.co/300x450/333/fff?text=Error'" />
                                <div class="p-2">
                                    <p class="text-sm font-semibold truncate">${m.title || 'Untitled'}</p>
                                    <p class="text-xs text-gray-400">ID: ${m.id}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            modalOverlay.classList.remove('hidden');
            
            // Search functionality
            const searchInput = modalOverlay.querySelector('#movie-search-input');
            const movieGrid = modalOverlay.querySelector('#movie-selection-grid');
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const cards = movieGrid.querySelectorAll('.movie-select-card');
                
                cards.forEach(card => {
                    const title = card.dataset.movieTitle.toLowerCase();
                    const id = card.dataset.movieId.toLowerCase();
                    
                    if (title.includes(searchTerm) || id.includes(searchTerm)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            });
            
            // Movie selection
            movieGrid.querySelectorAll('.movie-select-card').forEach(card => {
                card.addEventListener('click', () => {
                    const movieId = card.dataset.movieId;
                    const movieTitle = card.dataset.movieTitle;
                    const moviePoster = card.dataset.moviePoster;
                    
                    // Update alerts panel with selected movie
                    const alertsPanel = document.getElementById('alerts-panel');
                    if (alertsPanel) {
                        alertsPanel.querySelector('#selected-movie-id').value = movieId;
                        alertsPanel.querySelector('#selected-movie-title').value = movieTitle;
                        alertsPanel.querySelector('#selected-movie-poster').value = moviePoster;
                        
                        const preview = alertsPanel.querySelector('#selected-movie-preview');
                        preview.classList.remove('hidden');
                        preview.querySelector('#preview-poster').src = moviePoster || 'https://placehold.co/150x225/8b5cf6/fff?text=Movie';
                        preview.querySelector('#preview-title').textContent = movieTitle;
                        preview.querySelector('#preview-id').textContent = `ID: ${movieId}`;
                    }
                    
                    modalOverlay.classList.add('hidden');
                    showToast(`Selected: ${movieTitle}`);
                });
            });
            
            // Close button
            modalOverlay.querySelector('#close-movie-selector').addEventListener('click', () => {
                modalOverlay.classList.add('hidden');
            });
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.add('hidden');
                }
            });
        }
        
        async function saveMovie() {
            const movieId = document.getElementById('movie-id').value;
            // Determine movie type and gather sources/episodes accordingly
            const type = document.getElementById('movie-type').value;
            const rawPrimaryCategory = document.getElementById('movie-primary-category')?.value || 'general';
            const allowedForPartner = (currentUserRole === 'partner' && Array.isArray(currentUserData?.allowedCategories) && currentUserData.allowedCategories.length > 0)
                ? currentUserData.allowedCategories
                : null;
            const primaryCategory = (allowedForPartner && !allowedForPartner.includes(rawPrimaryCategory))
                ? allowedForPartner[0]
                : rawPrimaryCategory;
            const sportCategory = primaryCategory === 'sports'
                ? (document.getElementById('movie-sport-category')?.value || 'all')
                : '';
            const derivedCategories = (() => {
                switch (primaryCategory) {
                    case 'sports':
                        return sportCategory && sportCategory !== 'all'
                            ? ['sports', `sports-${sportCategory}`]
                            : ['sports'];
                    case 'challenge':
                        return ['challenge'];
                    case 'snd':
                        return ['snd'];
                    default:
                        return ['general'];
                }
            })();
            let sources = {};
            let episodes = null;
            if (type === 'series') {
                episodes = [];
                const seasonBlocks = document.querySelectorAll('#seasons-container .season-block');
                if (seasonBlocks.length === 0) {
                    showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–µ–∑–æ–Ω –∏ —ç–ø–∏–∑–æ–¥—ã.', true);
                    return;
                }
                let hasEmptySeason = false;
                seasonBlocks.forEach((seasonBlock, seasonIdx) => {
                    const seasonNumberInput = seasonBlock.querySelector('.season-number-input');
                    const seasonNameInput = seasonBlock.querySelector('.season-name-input');
                    const seasonStartInput = seasonBlock.querySelector('.season-start-input');
                    const episodeBlocks = seasonBlock.querySelectorAll('.episode-block');
                    if (episodeBlocks.length === 0) {
                        hasEmptySeason = true;
                        return;
                    }
                    const parsedSeasonNumber = parseInt(seasonNumberInput?.value, 10);
                    const seasonNumber = !isNaN(parsedSeasonNumber) && parsedSeasonNumber > 0 ? parsedSeasonNumber : (seasonIdx + 1);
                    const seasonName = seasonNameInput?.value.trim() || '';
                    const startFromRaw = seasonStartInput?.value || '';
                    const startFrom = startFromRaw ? parseInt(startFromRaw, 10) : null;

                    episodeBlocks.forEach((block, idx) => {
                        const epTitle = block.querySelector('.episode-title-input')?.value.trim();
                        const epNumberRaw = block.querySelector('.episode-number-input')?.value;
                        const epNumber = epNumberRaw ? parseInt(epNumberRaw, 10) : null;
                        const durationRaw = block.querySelector('.episode-duration-input')?.value;
                        const durationMinutes = durationRaw ? parseFloat(durationRaw) : null;
                        const thumbnail = block.querySelector('.episode-thumbnail-input')?.value.trim();
                        const epSources = {
                            '480p': block.querySelector('.ep-source-480p')?.value || '',
                            '720p': block.querySelector('.ep-source-720p')?.value || '',
                            '1080p': block.querySelector('.ep-source-1080p')?.value || '',
                            '4K': block.querySelector('.ep-source-4k')?.value || '',
                        };

                        const episodePayload = {
                            seasonNumber,
                            seasonName: seasonName || undefined,
                            seasonTitle: seasonName || undefined,
                            episodeNumber: !isNaN(epNumber) && epNumber > 0 ? epNumber : undefined,
                            title: epTitle || undefined,
                            durationMinutes: !isNaN(durationMinutes) && durationMinutes > 0 ? durationMinutes : undefined,
                            thumbnail: thumbnail || undefined,
                            sources: epSources,
                        };

                        if (idx === 0 && startFrom && !isNaN(startFrom) && startFrom > 0) {
                            episodePayload.seasonEpisodeStart = startFrom;
                        }

                        Object.keys(episodePayload).forEach(key => {
                            if (episodePayload[key] === undefined || episodePayload[key] === '') {
                                delete episodePayload[key];
                            }
                        });

                        episodes.push(episodePayload);
                    });
                });

                if (hasEmptySeason || episodes.length === 0) {
                    showToast('–ö–∞–∂–¥—ã–π —Å–µ–∑–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç–ø–∏–∑–æ–¥.', true);
                    return;
                }

                sources = episodes[0]?.sources || {};
            } else {
                sources = {
                    '480p': document.getElementById('source-480p').value,
                    '720p': document.getElementById('source-720p').value,
                    '1080p': document.getElementById('source-1080p').value,
                    '4K': document.getElementById('source-4k').value,
                };
            }
            // Extract selected regions
            const availableRegions = Array.from(document.querySelectorAll('.movie-region-checkbox:checked')).map(input => input.value);
            
            // Validate at least one region is selected
            if (availableRegions.length === 0) {
                showToast('Kamida bitta hudud tanlang! / –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–µ–≥–∏–æ–Ω!', true);
                return;
            }
            
            // Collect cast data
            const castBlocks = document.querySelectorAll('.cast-block');
            const castData = [];
            castBlocks.forEach(block => {
                const name = block.querySelector('.cast-name')?.value.trim();
                const character = block.querySelector('.cast-character')?.value.trim();
                const image = block.querySelector('.cast-image')?.value.trim();
                const bio = block.querySelector('.cast-bio')?.value.trim();
                const instagram = block.querySelector('.cast-instagram')?.value.trim();
                const facebook = block.querySelector('.cast-facebook')?.value.trim();
                const twitter = block.querySelector('.cast-twitter')?.value.trim();
                const wikipedia = block.querySelector('.cast-wikipedia')?.value.trim();
                
                if (name) {
                    castData.push({
                        name: name,
                        character: character || '',
                        image: image || '',
                        bio: bio || '',
                        social: {
                            instagram: instagram || '',
                            facebook: facebook || '',
                            twitter: twitter || '',
                            wikipedia: wikipedia || ''
                        }
                    });
                }
            });
            
            // Collect producer data
            const producerName = document.getElementById('movie-producer')?.value.trim();
            const producerImage = document.getElementById('producer-image')?.value.trim();
            const producerBio = document.getElementById('producer-bio')?.value.trim();
            const producerInstagram = document.getElementById('producer-instagram')?.value.trim();
            const producerFacebook = document.getElementById('producer-facebook')?.value.trim();
            const producerTwitter = document.getElementById('producer-twitter')?.value.trim();
            const producerWikipedia = document.getElementById('producer-wikipedia')?.value.trim();
            
            const producerSocial = {
                instagram: producerInstagram || '',
                facebook: producerFacebook || '',
                twitter: producerTwitter || '',
                wikipedia: producerWikipedia || ''
            };

            const movieData = {
                title: document.getElementById('movie-title').value,
                originalTitle: document.getElementById('movie-original-title').value,
                year: parseInt(document.getElementById('movie-year').value, 10),
                genre: document.getElementById('movie-genre').value,
                country: document.getElementById('movie-country').value,
                duration: document.getElementById('movie-duration').value,
                rating: document.getElementById('movie-rating').value,
                poster: document.getElementById('movie-poster').value,
                studio: document.getElementById('movie-studio').value,
                type: type,
                primaryCategory,
                sportCategory: sportCategory || null,
                categories: derivedCategories,
                isPremium: document.getElementById('movie-premium').checked,
                producer: producerName || '',
                producerImage: producerImage || '',
                producerBio: producerBio || '',
                producerSocial: producerSocial,
                cast: castData,
                description: document.getElementById('movie-description').value,
                availableRegions: availableRegions,
                // Screenshots
                screenshots: [
                    document.getElementById('screenshot-1')?.value.trim(),
                    document.getElementById('screenshot-2')?.value.trim(),
                    document.getElementById('screenshot-3')?.value.trim(),
                    document.getElementById('screenshot-4')?.value.trim(),
                    document.getElementById('screenshot-5')?.value.trim()
                ].filter(url => url !== ''),
                // Hero settings are now managed via the Hero panel, not the movie modal
                partnerId: currentUserRole === 'partner' ? currentPartnerId : null,
                createdAt: serverTimestamp(),
                views: movieId ? (movies.find(m => m.id === movieId)?.views || 0) : Math.floor(Math.random() * 10000)
            };
            // Attach the collected sources and episodes if present
            movieData.sources = sources;
            if (episodes !== null) {
                movieData.episodes = episodes;
            }

            try {
                if (movieId) {
                    const movieRef = doc(db, "movies", movieId);
                    const existingMovie = movies.find(m => m.id === movieId);
                    
                    // If movie was previously reported and partner is fixing it
                    if (currentUserRole === 'partner' && existingMovie?.needsReview) {
                        movieData.needsReview = false; // Partner fixed it
                        movieData.awaitingAdminApproval = true; // Now needs admin approval
                        movieData.hiddenFromUsers = true; // Still hidden until admin approves
                        movieData.fixedAt = new Date().toISOString();
                        movieData.fixedBy = currentPartnerId;
                        
                        // Notify admins that content has been fixed and needs approval
                        const adminsSnapshot = await getDocs(query(collection(db, 'users'), where('role', '==', 'admin')));
                        adminsSnapshot.forEach(async (adminDoc) => {
                            await addDoc(collection(db, 'notifications'), {
                                userId: adminDoc.id,
                                type: 'content_approval_needed',
                                title: 'Content Fixed - Needs Approval',
                                message: `Partner has fixed reported content: "${movieData.title}". Please review and approve.`,
                                movieId: movieId,
                                movieTitle: movieData.title,
                                partnerId: currentPartnerId,
                                actionRequired: 'approve_content',
                                timestamp: serverTimestamp(),
                                read: false
                            });
                        });
                    } else if (currentUserRole === 'admin' && existingMovie?.awaitingAdminApproval) {
                        // Admin is approving the fixed content
                        movieData.awaitingAdminApproval = false;
                        movieData.hiddenFromUsers = false; // Show to users again
                        movieData.approvedAt = new Date().toISOString();
                        movieData.approvedBy = currentUser?.uid;
                        
                        // Notify partner that content is approved
                        if (existingMovie.partnerId) {
                            await addDoc(collection(db, 'notifications'), {
                                userId: existingMovie.partnerId,
                                type: 'content_approved',
                                title: 'Content Approved',
                                message: `Your content "${movieData.title}" has been reviewed and approved by admin.`,
                                movieId: movieId,
                                movieTitle: movieData.title,
                                timestamp: serverTimestamp(),
                                read: false
                            });
                        }
                    }
                    
                    await updateDoc(movieRef, movieData);
                    showToast('–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                } else {
                    await addDoc(collection(db, "movies"), movieData);
                    showToast('–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving movie: ", error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞.', true);
            }
        }

        // --- ACCOUNT RECOVERY FUNCTIONS ---

        function generateTemporaryCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
            let code = '';
            for (let i = 0; i < 30; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function startTempCodeGeneration(userId, userEmail) {
            if (tempCodeInterval) clearInterval(tempCodeInterval);

            const tempCodeEl = document.getElementById('temp-code');
            const countdownEl = document.getElementById('countdown-timer');
            const qrcodeContainer = document.getElementById('qrcode-container');
            const userRef = doc(db, "users", userId);

            let countdown = 30;

            const updateCode = async () => {
                countdown = 30;
                const newCode = generateTemporaryCode();
                const expiresAt = new Date(Date.now() + 30000);

                try {
                    await updateDoc(userRef, {
                        temporaryLogin: {
                            code: newCode,
                            expiresAt: expiresAt
                        }
                    });

                    tempCodeEl.textContent = newCode;
                    
                    // Generate QR Code
                    qrcodeContainer.innerHTML = '';
                    const qrCodeData = JSON.stringify({
                        login: userEmail,
                        tempCode: newCode
                    });
                    new QRCode(qrcodeContainer, {
                        text: qrCodeData,
                        width: 160,
                        height: 160,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });

                } catch (error) {
                    console.error("Vaqtinchalik kodni yangilashda xatolik:", error);
                    showToast("Vaqtinchalik kodni yangilashda xatolik yuz berdi.", true);
                }
            };

            tempCodeInterval = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                if (countdown <= 0) {
                    updateCode();
                }
            }, 1000);

            updateCode(); // Initial call
        }

        // --- AUTENTIFIKATSIYA ---
        onAuthStateChanged(auth, async (user) => {
            const appContainer = document.getElementById('app-container');
            if (user) {
                loadingOverlay.classList.remove('hidden');
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        currentUserData = userDocSnap.data();
                        const { role } = currentUserData;
                        
                        // Redirect partner to partner.html
                        if (role === 'partner') {
                            window.location.href = 'partner.html';
                            return;
                        }
                        
                        if (role === 'admin' || role === 'agent') {
                           renderDashboard(role);
                           setupFirestoreListeners(user.uid, role);
                        } else {
                            throw new Error("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –ø–∞–Ω–µ–ª–∏.");
                        }
                    } else {
                        const archivedUserDocRef = doc(db, "archived_users", user.uid);
                        const archivedUserDocSnap = await getDoc(archivedUserDocRef);
                        if(archivedUserDocSnap.exists()){
                            throw new Error("–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.");
                        } else {
                            throw new Error("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í–∞—à–∞ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ.");
                        }
                    }
                } catch (error) {
                    showToast(error.message, true);
                    await signOut(auth);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            } else {
                unsubscribeListeners();
                currentUserData = null;
                appContainer.innerHTML = renderLoginPage();
                attachLoginListeners();
            }
        });

        async function handleLogin(email, password, errorEl) {
            errorEl.textContent = '';
            loadingOverlay.classList.remove('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.";
                console.error("Login Error:", error.code, error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            loadingOverlay.classList.remove('hidden');
            try {
                await signInWithPopup(auth, provider);
                showToast('–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google...');
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showToast(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google: ${error.message}`, true);
                loadingOverlay.classList.add('hidden');
            }
        }

        function attachLoginListeners() {
            const partnerForm = document.getElementById('partner-login-form');
            const adminForm = document.getElementById('admin-login-form');
            const partnerTab = document.getElementById('partner-tab');
            const adminTab = document.getElementById('admin-tab');
            const partnerFormContainer = document.getElementById('partner-form-container');
            const adminFormContainer = document.getElementById('admin-form-container');
            
            partnerTab.addEventListener('click', () => {
                partnerTab.classList.add('active');
                adminTab.classList.remove('active');
                partnerFormContainer.classList.remove('hidden');
                adminFormContainer.classList.add('hidden');
            });

            adminTab.addEventListener('click', () => {
                adminTab.classList.add('active');
                partnerTab.classList.remove('active');
                adminFormContainer.classList.remove('hidden');
                partnerFormContainer.classList.add('hidden');
            });

            if (partnerForm) {
                partnerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = document.getElementById('partner-email').value;
                    const password = document.getElementById('partner-password').value;
                    const errorEl = document.getElementById('partner-error');
                    handleLogin(email, password, errorEl);
                });
            }
            if(adminForm) {
                adminForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = document.getElementById('admin-email').value;
                    const password = document.getElementById('admin-password').value;
                    const errorEl = document.getElementById('admin-error');
                    handleLogin(email, password, errorEl);
                });
            }
            
            document.querySelectorAll('.google-login-btn').forEach(btn => {
                btn.addEventListener('click', handleGoogleLogin);
            });
        }
        
        function renderLoginPage() {
            const loginFormHTML = (type) => `
                <h2 class="text-2xl font-bold text-center mb-6">–í—Ö–æ–¥ –¥–ª—è ${type === 'partner' ? '–ü–∞—Ä—Ç–Ω–µ—Ä–∞' : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞'}</h2>
                <form id="${type}-login-form">
                    <div class="space-y-4">
                        <input type="email" id="${type}-email" class="form-input w-full p-3 rounded-md text-white" placeholder="Email ${type === 'partner' ? '–ü–∞—Ä—Ç–Ω–µ—Ä–∞' : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞'}" required>
                        <input type="password" id="${type}-password" class="form-input w-full p-3 rounded-md text-white" placeholder="–ü–∞—Ä–æ–ª—å" required>
                    </div>
                    <p id="${type}-error" class="text-red-500 text-center text-sm h-4 mt-4"></p>
                    <button type="submit" class="submit-btn w-full text-white font-bold py-3 px-6 rounded-lg mt-6">–í–æ–π—Ç–∏ –∫–∞–∫ ${type === 'partner' ? '–ü–∞—Ä—Ç–Ω–µ—Ä' : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}</button>
                </form>
                <div class="my-4 flex items-center before:flex-1 before:border-t before:border-gray-600 before:mt-0.5 after:flex-1 after:border-t after:border-gray-600 after:mt-0.5">
                    <p class="text-center font-semibold mx-4 mb-0 text-gray-400">–∏–ª–∏</p>
                </div>
                <button class="google-login-btn w-full bg-white text-gray-800 font-bold py-3 px-4 rounded-lg flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i class="fab fa-google mr-3"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                </button>
            `;

            return `
            <div class="login-container flex items-center justify-center min-h-screen p-4">
                <div class="w-full max-w-md">
                    <div class="text-center mb-10">
                        <h1 class="text-3xl md:text-4xl font-bold text-white tracking-wider">SOUNDORA <span class="text-red-500">FILMS</span></h1>
                        <p class="text-gray-400 mt-2">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
                    </div>
                    <div class="form-panel rounded-lg shadow-lg overflow-hidden">
                        <div class="flex">
                            <button id="partner-tab" class="login-tab active">–ü–∞—Ä—Ç–Ω–µ—Ä</button>
                            <button id="admin-tab" class="login-tab">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
                        </div>
                        <div class="p-8">
                            <div id="partner-form-container">
                                ${loginFormHTML('partner')}
                            </div>
                            <div id="admin-form-container" class="hidden">
                                ${loginFormHTML('admin')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        // --- Promo code management functions ---
        function generateRandomPromoCode() {
            // Promokod endi faqat katta harflar va raqamlardan iborat bo'ladi, o'qish oson bo'lishi uchun
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 10; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function renderPromoCodesPanel() {
            const panel = document.getElementById('promocodes-panel');
            const lang = currentDashboardLanguage;
            const t = dashboardTranslations[lang] || {};
            panel.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4" data-lang-key="promoCodes">${t.promoCodes || 'Promo Codes'}</h2>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <label for="promo-duration" class="block mb-2" data-lang-key="duration">${t.duration || 'Duration'}</label>
                        <select id="promo-duration" class="form-input p-2 rounded-md w-full text-black">
                            <option value="3d">3 ${t.durationDays || 'days'}</option>
                            <option value="1m">1 ${t.durationMonths || 'month'}</option>
                            <option value="3m">3 ${t.durationMonths || 'months'}</option>
                            <option value="7m">7 ${t.durationMonths || 'months'}</option>
                            <option value="12m">12 ${t.durationMonths || 'months'}</option>
                        </select>
                        <button id="generate-promo-btn" class="action-btn text-white font-bold py-2 px-4 rounded-lg mt-4 flex items-center">
                            <i class="fas fa-magic mr-2"></i><span data-lang-key="generateCode">${t.generateCode || 'Generate Code'}</span>
                        </button>
                        <div id="generated-code-section" class="mt-4 hidden">
                            <p class="text-green-500 font-mono break-all cursor-pointer" title="Nusxalash" id="generated-code-text"></p>
                        </div>
                    </div>
                </div>
                <div id="promocodes-list"></div>
            `;
            document.getElementById('generate-promo-btn').addEventListener('click', async () => {
                const duration = document.getElementById('promo-duration').value;
                const code = generateRandomPromoCode();
                try {
                    // O'ZGARISH: Promokodni hujjat ID'si sifatida ishlatamiz
                    const promoRef = doc(db, 'promo_codes', code);
                    await setDoc(promoRef, {
                        duration: duration,
                        used: false,
                        createdAt: serverTimestamp()
                    });

                    const generatedCodeText = document.getElementById('generated-code-text');
                    generatedCodeText.innerHTML = `<span data-lang-key="codeGenerated">${t.codeGenerated || 'Code generated!'}</span> <span class="font-bold">${code}</span>`;
                    generatedCodeText.onclick = () => {
                        navigator.clipboard.writeText(code);
                        showToast("Kod nusxalandi!");
                    };

                    document.getElementById('generated-code-section').classList.remove('hidden');
                    showToast(dashboardTranslations[currentDashboardLanguage].codeGenerated || 'Code generated!');
                    await renderPromoCodesList();
                } catch (error) {
                    console.error('Error creating promo code', error);
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–¥–∞', true);
                }
            });
            await renderPromoCodesList();
            setDashboardLanguage(currentDashboardLanguage);
        }

        async function renderPromoCodesList() {
            const container = document.getElementById('promocodes-list');
            if (!container) return;
            try {
                const snapshot = await getDocs(collection(db, 'promo_codes'));
                const codes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (codes.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.</p>';
                    return;
                }
                let html = '<div class="overflow-x-auto"><table class="w-full text-left"><thead><tr><th class="p-2">–ö–æ–¥</th><th class="p-2">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th><th class="p-2">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th><th class="p-2">–ö–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (UID)</th></tr></thead><tbody>';
                // O'ZGARISH: `item.code` o'rniga `item.id` ishlatiladi
                codes.forEach(item => {
                    html += `<tr class="table-row"><td class="p-2 font-mono">${item.id}</td><td class="p-2">${item.duration}</td><td class="p-2">${item.used ? '–î–∞' : '–ù–µ—Ç'}</td><td class="p-2 text-xs">${item.usedBy || '-'}</td></tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (e) {
                console.error('Error fetching promo codes', e);
                container.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</p>';
            }
        }

        // --- Ads management panel ---
        async function renderAdsPanel() {
            const panel = document.getElementById('ads-panel');
            if (!panel) return;
            panel.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Advertisements</h2>
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <p class="text-gray-400 mb-3">Manage video ads shown during playback. Each ad contains a video URL, thumbnail, link and optional duration.</p>
                            <button id="add-ad-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Ad</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="ads-settings-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded">Settings</button>
                        <button id="ads-export-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 rounded">Export All Stats</button>
                        <button id="ads-reset-all-btn" class="bg-red-700 hover:bg-red-600 text-white font-medium py-2 px-3 rounded">Reset All Stats</button>
                    </div>
                </div>
                <div id="ads-list" class="mt-4"></div>
            `;

            // Attach a real-time listener so stats and ads update live
            function attachAdsRealtime() {
                const container = document.getElementById('ads-list');
                container.innerHTML = `<div class="py-6 text-center text-gray-400">Loading ads...</div>`;
                // unsubscribe previous if any
                try { if (window._adsUnsub) window._adsUnsub(); } catch(_) {}
                window._adsUnsub = onSnapshot(collection(db, 'ads'), snapshot => {
                    const ads = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (!ads || ads.length === 0) {
                        container.innerHTML = `
                            <div class="bg-gray-800 p-6 rounded text-gray-300">
                                <div class="mb-2">No ads configured.</div>
                                <div class="flex gap-2 justify-end">
                                    <button id="add-ad-inline-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded">Add Ad</button>
                                </div>
                            </div>
                        `;
                        document.getElementById('add-ad-inline-btn').addEventListener('click', () => openAdModal());
                        return;
                    }
                    container.innerHTML = ads.map(a => `
                        <div class="bg-gray-800 rounded p-3 mb-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <img src="${a.thumbUrl || ''}" style="width:120px;height:70px;object-fit:cover;border-radius:6px;" />
                                    <div>
                                        <div class="font-semibold">${a.title || '(Untitled)'}</div>
                                        <div class="text-xs text-gray-400">${a.videoUrl || ''}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="text-sm text-gray-400 mr-4">Impr: <strong class="text-white">${a.impressions||0}</strong> &nbsp; Clicks: <strong class="text-white">${a.clicks||0}</strong></div>
                                    <button data-id="${a.id}" class="stats-ad-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded">Stats</button>
                                    <button data-id="${a.id}" class="edit-ad-btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded">Edit</button>
                                    <button data-id="${a.id}" class="delete-ad-btn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">Delete</button>
                                    <button data-id="${a.id}" class="reset-ad-stats-btn bg-red-500 hover:bg-red-400 text-white font-bold py-1 px-3 rounded">Reset Stats</button>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // wire buttons
                    container.querySelectorAll('.stats-ad-btn').forEach(btn => btn.addEventListener('click', (e) => openAdStatsModal(e.currentTarget.dataset.id)));
                    container.querySelectorAll('.edit-ad-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        const docRef = doc(db, 'ads', id);
                        const snap = await getDoc(docRef);
                        const data = snap.exists() ? snap.data() : {};
                        openAdModal(id, data);
                    }));
                    container.querySelectorAll('.delete-ad-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        if (!confirm('Delete this ad?')) return;
                        try { await deleteDoc(doc(db, 'ads', id)); showToast('Ad deleted.'); } catch (err) { console.error('Failed to delete ad', err); showToast('Failed to delete ad.', true); }
                    }));
                    container.querySelectorAll('.reset-ad-stats-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        if (!confirm('Reset stats for this ad?')) return;
                        try { await resetStatsForAd(id); showToast('Ad stats reset'); } catch (err) { showToast('Reset failed', true); }
                    }));
                }, err => {
                    console.error('ads onSnapshot failed', err);
                    container.innerHTML = `<div class="p-4 text-red-400">Failed to load ads: ${err.message || err}</div>`;
                });
            }
            attachAdsRealtime();

            function openAdModal(adId = null, data = {}) {
                const modalHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 relative">
                        <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
                        <h3 class="text-2xl font-bold mb-6">${adId ? 'Edit Ad' : 'Add Ad'}</h3>
                        <form id="ad-form">
                            <input type="hidden" id="ad-id" value="${adId || ''}" />
                            <label class="block mb-2">Title</label>
                            <input id="ad-title" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mb-3" value="${(data.title||'').replace(/"/g,'&quot;')}" />
                            <label class="block mb-2">Video URL</label>
                            <input id="ad-video-url" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mb-3" value="${(data.videoUrl||'')}" />
                            <label class="block mb-2">Thumbnail URL</label>
                            <input id="ad-thumb-url" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mb-3" value="${(data.thumbUrl||'')}" />
                            <label class="block mb-2">Link URL</label>
                            <input id="ad-link-url" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mb-3" value="${(data.linkUrl||'')}" />
                            <label class="block mb-2">Duration (seconds)</label>
                            <input id="ad-duration" type="number" min="1" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mb-3" value="${(data.durationSeconds||30)}" />
                            <label class="block mb-2">Skip delay (seconds)</label>
                            <input id="ad-skip-delay" type="number" min="0" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mb-3" value="${(data.skipDelaySeconds!=null?data.skipDelaySeconds:5)}" />
                            <div class="flex justify-end gap-2">
                                <button id="save-ad-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Save</button>
                            </div>
                        </form>
                    </div>
                `;
                const modalOverlay = document.getElementById('modal-overlay');
                modalOverlay.innerHTML = modalHTML;
                modalOverlay.classList.remove('hidden');
                document.getElementById('close-modal-btn').addEventListener('click', () => { modalOverlay.classList.add('hidden'); modalOverlay.innerHTML = ''; });
                document.getElementById('ad-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('ad-id').value;
                    const payload = {
                        title: document.getElementById('ad-title').value.trim(),
                        videoUrl: document.getElementById('ad-video-url').value.trim(),
                        thumbUrl: document.getElementById('ad-thumb-url').value.trim(),
                        linkUrl: document.getElementById('ad-link-url').value.trim(),
                        durationSeconds: parseInt(document.getElementById('ad-duration').value, 10) || 30,
                        skipDelaySeconds: parseInt(document.getElementById('ad-skip-delay').value, 10) || 5
                    };
                    try {
                        if (id) {
                            await setDoc(doc(db, 'ads', id), payload, { merge: true });
                            showToast('Ad updated.');
                        } else {
                            const newRef = doc(collection(db, 'ads'));
                            // initialize counters
                            payload.impressions = 0;
                            payload.clicks = 0;
                            await setDoc(newRef, payload);
                            showToast('Ad added.');
                        }
                        modalOverlay.classList.add('hidden');
                        modalOverlay.innerHTML = '';
                        renderList();
                    } catch (err) {
                        console.error('Failed to save ad', err);
                        showToast('Failed to save ad.', true);
                    }
                });
            }

            document.getElementById('add-ad-btn').addEventListener('click', () => openAdModal());
            // Header controls wiring
            document.getElementById('ads-settings-btn')?.addEventListener('click', () => openAdsSettingsModal());
            document.getElementById('ads-export-all-btn')?.addEventListener('click', async () => {
                try {
                    const snapshot = await getDocs(collection(db, 'ads'));
                    const all = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const rows = ['id,title,impressions,clicks'];
                    all.forEach(a => rows.push(`${a.id},"${(a.title||'').replace(/"/g,'""')}",${a.impressions||0},${a.clicks||0}`));
                    const csv = rows.join('\n');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = 'ads_summary.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                } catch (err) { console.error('export all ads stats failed', err); showToast('Export failed', true); }
            });
            document.getElementById('ads-reset-all-btn')?.addEventListener('click', async () => {
                if (!confirm('Reset stats for ALL ads? This will delete impression and click records and set counters to 0.')) return;
                try {
                    const snapshot = await getDocs(collection(db, 'ads'));
                    const adsAll = snapshot.docs.map(d => ({ id: d.id }));
                    for (const a of adsAll) {
                        await resetStatsForAd(a.id);
                    }
                    showToast('All ad stats reset.');
                    renderList();
                } catch (err) { console.error('reset all failed', err); showToast('Reset all failed', true); }
            });
            // helper: reset stats for a single ad
            async function resetStatsForAd(adId) {
                try {
                    // delete impression/click event docs referencing this ad
                    const impQ = query(collection(db, 'ad_impressions'), where('adId', '==', adId));
                    const impSnap = await getDocs(impQ);
                    for (const d of impSnap.docs) await deleteDoc(doc(db, 'ad_impressions', d.id));
                    const clickQ = query(collection(db, 'ad_clicks'), where('adId', '==', adId));
                    const clickSnap = await getDocs(clickQ);
                    for (const d of clickSnap.docs) await deleteDoc(doc(db, 'ad_clicks', d.id));
                    // reset aggregated counters on ad doc
                    await setDoc(doc(db, 'ads', adId), { impressions: 0, clicks: 0 }, { merge: true });
                } catch (err) { console.error('resetStatsForAd failed', err); throw err; }
            }

            // settings modal for default skip delay
            function openAdsSettingsModal() {
                const modalOverlay = document.getElementById('modal-overlay');
                modalOverlay.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative">
                        <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
                        <h3 class="text-2xl font-bold mb-4">Ads Settings</h3>
                        <label class="block mb-2">Default skip delay (seconds)</label>
                        <input id="default-skip-delay" type="number" min="0" class="w-full bg-gray-900 border border-gray-700 rounded p-2 mb-4" value="5" />
                        <div class="flex justify-end"><button id="save-ads-settings" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Save</button></div>
                    </div>
                `;
                modalOverlay.classList.remove('hidden');
                document.getElementById('close-modal-btn').addEventListener('click', () => { modalOverlay.classList.add('hidden'); modalOverlay.innerHTML = ''; });
                document.getElementById('save-ads-settings').addEventListener('click', () => {
                    const v = parseInt(document.getElementById('default-skip-delay').value, 10) || 5;
                    window._adsDefaultSkip = v;
                    modalOverlay.classList.add('hidden'); modalOverlay.innerHTML = '';
                    showToast('Ads settings saved (local).');
                });
            }

            // ad stats modal
            async function openAdStatsModal(adId) {
                const modalOverlay = document.getElementById('modal-overlay');
                modalOverlay.innerHTML = `<div class="p-6 text-gray-400">Loading stats...</div>`;
                modalOverlay.classList.remove('hidden');
                try {
                    const adDoc = await getDoc(doc(db, 'ads', adId));
                    const adData = adDoc.exists() ? adDoc.data() : {};
                    const impSnap = await getDocs(query(collection(db, 'ad_impressions'), where('adId','==',adId)));
                    const clickSnap = await getDocs(query(collection(db, 'ad_clicks'), where('adId','==',adId)));
                    const uniqueVisitors = new Set();
                    impSnap.docs.forEach(d => { if (d.data().visitorId) uniqueVisitors.add(d.data().visitorId); });
                    const rows = impSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    const html = `
                        <div class="bg-gray-800 rounded-lg p-4 max-h-80 overflow-auto">
                            <button id="close-stats-btn" class="float-right text-gray-400">&times;</button>
                            <h3 class="text-xl font-bold mb-2">Stats for ${adData.title||adId}</h3>
                            <div class="mb-2">Impressions: <strong>${adData.impressions||0}</strong> &nbsp; Clicks: <strong>${adData.clicks||0}</strong> &nbsp; Unique viewers: <strong>${uniqueVisitors.size}</strong></div>
                            <div class="mb-3"><button id="export-ad-imps" class="bg-blue-600 text-white px-3 py-1 rounded mr-2">Export Impressions CSV</button><button id="reset-ad-imps" class="bg-red-600 text-white px-3 py-1 rounded">Reset Impressions</button></div>
                            <table class="w-full text-sm text-left"><thead><tr><th>ID</th><th>visitorId</th><th>ts</th></tr></thead><tbody>${rows.map(r=>`<tr><td>${r.id}</td><td>${r.visitorId||'-'}</td><td>${new Date(r.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>
                        </div>
                    `;
                    modalOverlay.innerHTML = html;
                    document.getElementById('close-stats-btn').addEventListener('click', () => { modalOverlay.classList.add('hidden'); modalOverlay.innerHTML = ''; });
                    document.getElementById('export-ad-imps').addEventListener('click', () => {
                        const csv = ['id,visitorId,timestamp'].concat(rows.map(r=>`${r.id},${r.visitorId||''},${r.timestamp}`)).join('\n');
                        const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `ad_${adId}_impressions.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                    });
                    document.getElementById('reset-ad-imps').addEventListener('click', async () => { if (!confirm('Reset impressions for this ad?')) return; await resetStatsForAd(adId); showToast('Ad stats reset'); modalOverlay.classList.add('hidden'); modalOverlay.innerHTML = ''; renderList(); });
                } catch (err) { console.error('openAdStatsModal failed', err); modalOverlay.innerHTML = '<div class="p-4 text-red-400">Failed to load stats</div>'; }
            }

            await renderList();
            setDashboardLanguage(currentDashboardLanguage);
        }

        /**
         * Render the region restrictions panel. This panel allows super
         * administrators to configure which countries are blocked from
         * accessing the frontend. Administrators can choose to block
         * everything by default and then allow a select list of countries,
         * or specify only the countries to block. The block message and
         * code are fully customizable and saved to Firestore.
         */
        // HERO MANAGEMENT HELPERS (moved to global scope so renderHeroPanel is callable from menu)
        function persistHeroLocally(slides, heroCount, maxHeroCount) {
            try {
                localStorage.setItem('heroSlides', JSON.stringify(slides));
                localStorage.setItem('heroCount', String(heroCount));
                localStorage.setItem('maxHeroCount', String(maxHeroCount));
            } catch (err) {
                console.warn('persistHeroLocally failed', err);
            }
        }

        // Support Profile Image Management Panel
        async function renderSupportProfilePanel() {
            const panel = document.getElementById('support-profile-panel');
            if (!panel) return;

            // Fetch current support profile image from Firestore
            let supportImageUrl = '';
            try {
                const supportDoc = await getDoc(doc(db, 'settings', 'supportProfile'));
                if (supportDoc.exists()) {
                    supportImageUrl = supportDoc.data().imageUrl || '';
                }
            } catch (err) {
                console.error('Failed to fetch support profile image:', err);
            }

            panel.innerHTML = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-6 text-white">Support Profile Image Management</h2>
                    
                    <div class="bg-gray-800 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">Current Support Profile Image</h3>
                        
                        ${supportImageUrl ? `
                            <div class="mb-4 flex justify-center">
                                <img src="${supportImageUrl}" alt="Support Profile" class="w-64 h-64 object-contain rounded-lg border border-gray-700">
                            </div>
                        ` : `
                            <div class="mb-4 flex justify-center">
                                <div class="w-64 h-64 bg-gray-700 rounded-lg flex items-center justify-center">
                                    <p class="text-gray-400">No image uploaded</p>
                                </div>
                            </div>
                        `}
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Upload New Image (URL)</label>
                                <input 
                                    type="url" 
                                    id="support-image-url" 
                                    value="${supportImageUrl}"
                                    placeholder="https://example.com/image.png" 
                                    class="settings-input w-full px-4 py-2 rounded-lg text-white"
                                >
                                <p class="text-xs text-gray-400 mt-1">Enter a direct URL to an image (PNG, JPG, GIF, WebP)</p>
                            </div>
                            
                            <div class="flex gap-3">
                                <button 
                                    id="save-support-image-btn"
                                    class="action-btn px-6 py-2 rounded-lg font-semibold text-white">
                                    <i class="fas fa-save mr-2"></i>Save Image
                                </button>
                                <button 
                                    id="remove-support-image-btn"
                                    class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold text-white transition">
                                    <i class="fas fa-trash mr-2"></i>Remove Image
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-400 text-xl mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-blue-300 mb-2">Image Guidelines:</h4>
                                <ul class="text-sm text-gray-300 space-y-1">
                                    <li>‚Ä¢ Recommended size: 400x400px or larger</li>
                                    <li>‚Ä¢ Supported formats: PNG, JPG, GIF, WebP</li>
                                    <li>‚Ä¢ Image should be centered and clear</li>
                                    <li>‚Ä¢ Use transparent background (PNG) for best results</li>
                                    <li>‚Ä¢ Image will be displayed in the Support Profile page</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Event listeners
            const saveBtn = document.getElementById('save-support-image-btn');
            const removeBtn = document.getElementById('remove-support-image-btn');
            const urlInput = document.getElementById('support-image-url');

            saveBtn?.addEventListener('click', async () => {
                const newUrl = urlInput?.value.trim() || '';
                
                if (!newUrl) {
                    showToast('Please enter a valid image URL', true);
                    return;
                }

                try {
                    loadingOverlay?.classList.remove('hidden');
                    await setDoc(doc(db, 'settings', 'supportProfile'), {
                        imageUrl: newUrl,
                        updatedAt: serverTimestamp()
                    });
                    showToast('Support profile image updated successfully!');
                    renderSupportProfilePanel(); // Refresh panel
                } catch (err) {
                    console.error('Failed to save support profile image:', err);
                    showToast('Failed to save image. Please try again.', true);
                } finally {
                    loadingOverlay?.classList.add('hidden');
                }
            });

            removeBtn?.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to remove the support profile image?')) {
                    return;
                }

                try {
                    loadingOverlay?.classList.remove('hidden');
                    await setDoc(doc(db, 'settings', 'supportProfile'), {
                        imageUrl: '',
                        updatedAt: serverTimestamp()
                    });
                    showToast('Support profile image removed successfully!');
                    renderSupportProfilePanel(); // Refresh panel
                } catch (err) {
                    console.error('Failed to remove support profile image:', err);
                    showToast('Failed to remove image. Please try again.', true);
                } finally {
                    loadingOverlay?.classList.add('hidden');
                }
            });
        }

        function renderHeroPanel() {
            const panel = document.getElementById('hero-panel');
            if (!panel) return;
            console.debug('renderHeroPanel called');
            const heroDocRef = doc(db, 'config', 'hero');
            if (!heroConfigFetched) {
                heroConfigFetched = true;
                getDoc(heroDocRef).then((snap) => {
                    if (snap.exists()) {
                        const data = snap.data() || {};
                        if (Array.isArray(data.slides)) {
                            try { localStorage.setItem('heroSlides', JSON.stringify(data.slides)); } catch (_) {}
                        }
                        if (Number.isFinite(data.heroCount)) {
                            localStorage.setItem('heroCount', String(data.heroCount));
                        }
                        if (Number.isFinite(data.maxHeroCount)) {
                            localStorage.setItem('maxHeroCount', String(data.maxHeroCount));
                        }
                    }
                    renderHeroPanel();
                }).catch((err) => {
                    console.warn('Failed to sync hero config from Firestore', err);
                });
            }
            // Retrieve stored hero data
            let maxHeroCount = parseInt(localStorage.getItem('maxHeroCount')) || 5;
            maxHeroCount = Math.min(Math.max(maxHeroCount, 1), 10);
            let heroCount = parseInt(localStorage.getItem('heroCount')) || 5;
            heroCount = Math.min(Math.max(heroCount, 1), maxHeroCount);
            let heroSlides = [];
            try {
                const stored = JSON.parse(localStorage.getItem('heroSlides') || '[]');
                if (Array.isArray(stored)) {
                    heroSlides = stored.slice(0, maxHeroCount);
                }
            } catch (e) {
                console.warn('Failed to parse heroSlides', e);
            }
            // Ensure array length matches heroCount
            while (heroSlides.length < heroCount) {
                heroSlides.push({ imageUrl: '', movieId: '', duration: 3600000, expiry: 0 });
            }
            if (heroSlides.length > heroCount) heroSlides = heroSlides.slice(0, heroCount);
            // Build hero count selection buttons
            let countButtonsHtml = '';
            for (let i = 1; i <= maxHeroCount; i++) {
                countButtonsHtml += `<button data-count="${i}" class="hero-count-btn px-3 py-1 mx-1 rounded ${i === heroCount ? 'bg-red-600 text-white' : 'bg-gray-700 text-gray-300'}">${i}</button>`;
            }
            // Duration choices (ms and label). A zero duration indicates one month.
            const durations = [
                { ms: 3600000, label: '1 hour' },
                { ms: 18000000, label: '5 hours' },
                { ms: 36000000, label: '10 hours' },
                { ms: 86400000, label: '24 hours' },
                { ms: 172800000, label: '2 days' },
                { ms: 432000000, label: '5 days' },
                { ms: 864000000, label: '10 days' },
                { ms: 1728000000, label: '20 days' },
                { ms: 0, label: '1 month' }
            ];
            // Build hero cards
            let cardsHtml = '';
            const hasActiveSlides = heroSlides.some(slide => (slide.imageUrl && slide.imageUrl.trim()) || (slide.movieId && String(slide.movieId).trim()));
            if (!hasActiveSlides) {
                cardsHtml += `<div class="bg-gray-800 rounded-lg p-4 mb-4 text-gray-300" data-lang-key="heroEmptyState"></div>`;
            }
            heroSlides.forEach((slide, idx) => {
                let selectedMovieTitle = '';
                if (slide.movieId) {
                    const m = movies.find(m => String(m.id) === String(slide.movieId));
                    if (m) selectedMovieTitle = m.title;
                }
                let durationOptions = '';
                durations.forEach(d => {
                    const selected = (slide.duration === d.ms) || (d.ms === 0 && slide.duration === 0);
                    durationOptions += `<option value="${d.ms}" ${selected ? 'selected' : ''}>${d.label}</option>`;
                });
                cardsHtml += `
                    <div class="hero-card bg-gray-800 rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-bold">Slide ${idx + 1}</h3>
                            <div class="flex items-center space-x-2">
                                ${idx > 0 ? `<button class="move-up-btn text-gray-400 hover:text-gray-200" data-index="${idx}" title="Move up"><i class="fas fa-arrow-up"></i></button>` : ''}
                                ${idx < heroCount - 1 ? `<button class="move-down-btn text-gray-400 hover:text-gray-200" data-index="${idx}" title="Move down"><i class="fas fa-arrow-down"></i></button>` : ''}
                                <button class="delete-hero-btn text-red-500 hover:text-red-400" data-index="${idx}" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Image URL</label>
                            <input type="text" class="w-full form-input bg-gray-700 border border-gray-600 rounded py-2 px-3" value="${slide.imageUrl || ''}" data-index="${idx}" data-field="imageUrl">
                        </div>
                        <div class="mb-4 relative">
                            <label class="block text-sm font-medium mb-1">Select Movie</label>
                            <input type="text" class="w-full form-input bg-gray-700 border border-gray-600 rounded py-2 px-3 movie-search-input" placeholder="Search movies" value="${selectedMovieTitle}" data-index="${idx}">
                            <div class="movie-options absolute left-0 right-0 mt-1 bg-gray-900 border border-gray-700 rounded shadow-lg max-h-40 overflow-y-auto hidden z-10"></div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Display Duration</label>
                            <select class="w-full form-input bg-gray-700 border border-gray-600 rounded py-2 px-3 duration-select" data-index="${idx}">
                                ${durationOptions}
                            </select>
                        </div>
                    </div>
                `;
            });
            panel.innerHTML = `
                <div class="flex justify-between items-center mb-6 flex-wrap">
                    <h2 class="text-2xl font-bold">Hero Management</h2>
                    <div id="hero-count-container" class="flex flex-wrap">${countButtonsHtml}</div>
                </div>
                <div id="hero-cards-container">${cardsHtml}</div>
                <div class="flex justify-between items-center mt-4 flex-wrap">
                    <div>${heroCount < maxHeroCount ? `<button id="add-hero-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mb-2">Add Hero</button>` : ''}</div>
                    <button id="save-hero-config-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mb-2">Save</button>
                </div>
            `;
            // debug banner so the panel is visually obvious in the UI
            panel.insertAdjacentHTML('afterbegin', `<div id="hero-debug-banner" style="background:#ff5252;color:#fff;padding:6px 12px;border-radius:6px;margin-bottom:10px;font-weight:700;">DEBUG: renderHeroPanel mounted</div>`);
            try {
                attachHeroPanelListeners(heroSlides, heroCount, maxHeroCount, durations, heroDocRef);
            } catch (err) {
                console.error('attachHeroPanelListeners failed', err);
            }
        }

        function attachHeroPanelListeners(slides, heroCount, maxHeroCount, durations, heroDocRef) {
            console.debug('attachHeroPanelListeners start', { slidesLength: slides.length, heroCount, maxHeroCount });
            function rerender(newSlides, newCount) {
                persistHeroLocally(newSlides, newCount, maxHeroCount);
                renderHeroPanel();
            }
            // Change hero count
            document.querySelectorAll('.hero-count-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const count = parseInt(e.currentTarget.dataset.count);
                    let newSlides = JSON.parse(JSON.stringify(slides));
                    let newCount = count;
                    if (newSlides.length < newCount) {
                        while (newSlides.length < newCount) newSlides.push({ imageUrl: '', movieId: '', duration: 3600000, expiry: 0 });
                    } else if (newSlides.length > newCount) {
                        newSlides = newSlides.slice(0, newCount);
                    }
                    rerender(newSlides, newCount);
                });
            });
            // Add new slide
            const addBtn = document.getElementById('add-hero-btn');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    const newSlides = JSON.parse(JSON.stringify(slides));
                    newSlides.push({ imageUrl: '', movieId: '', duration: 3600000, expiry: 0 });
                    const newCount = slides.length + 1;
                    rerender(newSlides, newCount);
                });
            }
            // Delete slide
            document.querySelectorAll('.delete-hero-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.currentTarget.dataset.index);
                    const newSlides = slides.filter((_, i) => i !== idx);
                    const newCount = heroCount - 1;
                    rerender(newSlides, newCount);
                });
            });
            // Move up
            document.querySelectorAll('.move-up-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.currentTarget.dataset.index);
                    const newSlides = JSON.parse(JSON.stringify(slides));
                    if (idx > 0) {
                        const temp = newSlides[idx - 1];
                        newSlides[idx - 1] = newSlides[idx];
                        newSlides[idx] = temp;
                        rerender(newSlides, heroCount);
                    }
                });
            });
            // Move down
            document.querySelectorAll('.move-down-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.currentTarget.dataset.index);
                    const newSlides = JSON.parse(JSON.stringify(slides));
                    if (idx < slides.length - 1) {
                        const temp = newSlides[idx + 1];
                        newSlides[idx + 1] = newSlides[idx];
                        newSlides[idx] = temp;
                        rerender(newSlides, heroCount);
                    }
                });
            });
            // Image URL fields
            document.querySelectorAll('input[data-field="imageUrl"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = parseInt(e.currentTarget.dataset.index);
                    slides[idx].imageUrl = e.currentTarget.value;
                });
            });
            // Duration selects
            document.querySelectorAll('.duration-select').forEach(sel => {
                sel.addEventListener('change', (e) => {
                    const idx = parseInt(e.currentTarget.dataset.index);
                    const val = parseInt(e.currentTarget.value);
                    slides[idx].duration = val;
                });
            });
            // Movie search interactions
            document.querySelectorAll('.movie-search-input').forEach(input => {
                const idx = parseInt(input.dataset.index);
                const optionsContainer = input.nextElementSibling;
                input.addEventListener('input', () => {
                    const query = input.value.toLowerCase();
                    const filtered = movies.filter(m => m.title.toLowerCase().includes(query) || (m.originalTitle && m.originalTitle.toLowerCase().includes(query)));
                    if (filtered.length === 0) {
                        optionsContainer.innerHTML = `<div class="p-2 text-sm text-gray-400">No results</div>`;
                    } else {
                        optionsContainer.innerHTML = filtered.slice(0, 20).map(m => `<div class="option-item px-3 py-2 hover:bg-gray-700 cursor-pointer" data-id="${m.id}">${m.title}</div>`).join('');
                    }
                    optionsContainer.classList.remove('hidden');
                });
                // Hide options when clicking outside
                document.addEventListener('click', (e) => {
                    if (!input.parentElement.contains(e.target)) {
                        optionsContainer.classList.add('hidden');
                    }
                });
                optionsContainer.addEventListener('click', (e) => {
                    const option = e.target.closest('.option-item');
                    if (option) {
                        const movieId = option.dataset.id;
                        const m = movies.find(m => String(m.id) === String(movieId));
                        if (m) {
                            input.value = m.title;
                            slides[idx].movieId = m.id;
                        }
                        optionsContainer.classList.add('hidden');
                    }
                });
            });
            // Save configuration
            const saveBtn = document.getElementById('save-hero-config-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                const payloadSlides = slides.map(slide => {
                    let expiryTs;
                    if (slide.duration === 0) {
                        const now = new Date();
                        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                        expiryTs = now.getTime() + daysInMonth * 24 * 60 * 60 * 1000;
                    } else {
                        expiryTs = Date.now() + slide.duration;
                    }
                    return {
                        imageUrl: slide.imageUrl || '',
                        movieId: slide.movieId || '',
                        duration: slide.duration,
                        expiry: expiryTs
                    };
                });
                persistHeroLocally(payloadSlides, slides.length, maxHeroCount);
                const success = heroDocRef ? await persistHeroConfig(heroDocRef, { slides: payloadSlides, heroCount: slides.length, maxHeroCount }) : true;
                const toastKey = success ? 'heroSaveSuccess' : 'heroSaveError';
                showToast(dashboardTranslations[currentDashboardLanguage]?.[toastKey] || (success ? 'Hero saved.' : 'Failed to save hero.'), !success);
                if (success) {
                    renderHeroPanel();
                }
                });
            } else {
                console.warn('save-hero-config-btn not found; skipping save handler attach');
            }
        }

        /**
         * Render the Internal Policy panel. Admins can adjust organisational
         * settings that affect how many hero slides are permitted. For now
         * this panel allows toggling between a maximum of 5 and 10 slides.
         */
        async function renderPolicyPanel() {
            const panel = document.getElementById('policy-panel');
            if (!panel) return;
            
            const policyDocRef = doc(db, 'config', 'policy');
            let docSnap = null;
            
            try {
                docSnap = await getDoc(policyDocRef);
            } catch (err) {
                console.warn('Failed to fetch policy doc', err);
            }
            
            const data = docSnap && docSnap.exists() ? (docSnap.data() || {}) : {};
            const chapters = Array.isArray(data.chapters) ? data.chapters : [];
            const changeLimitMs = Number.isFinite(data.changeLimitMs) ? data.changeLimitMs : (parseInt(localStorage.getItem('policyChangeLimitMs')) || POLICY_CHANGE_LIMIT_OPTIONS.find(o=>o.key==='1d').ms);
            
            // Separate Real and Test chapters
            const realChapters = chapters.filter(ch => !ch.test);
            const testChapters = chapters.filter(ch => ch.test);
            
            const t = dashboardTranslations[currentDashboardLanguage] || {};
            
            // Main Layout with Tabs
            panel.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">Policy Management</h2>
                        <button id="change-limit-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-clock mr-2"></i>
                            Change Limit: ${humanizeMs(changeLimitMs)}
                        </button>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="flex space-x-2 mb-6">
                        <button id="tab-real" class="policy-tab active px-6 py-3 rounded-t-lg font-semibold transition-all bg-red-600 text-white">
                            <i class="fas fa-shield-alt mr-2"></i>Real Policies (${realChapters.length})
                        </button>
                        <button id="tab-test" class="policy-tab px-6 py-3 rounded-t-lg font-semibold transition-all bg-gray-700 text-gray-300 hover:bg-gray-600">
                            <i class="fas fa-flask mr-2"></i>Test Policies (${testChapters.length})
                        </button>
                    </div>
                    
                    <!-- Content Area -->
                    <div id="policy-content-area" class="bg-gray-800 rounded-lg p-6 min-h-[600px]">
                        <!-- Content will be rendered here -->
                    </div>
                </div>
                
                <!-- Change Limit Modal -->
                <div id="change-limit-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
                    <div class="bg-gray-800 p-6 rounded-xl w-96 border border-gray-700">
                        <h4 class="text-xl font-bold mb-4">Set Change Limit</h4>
                        <div id="change-limit-options" class="space-y-3 mb-6">
                            ${POLICY_CHANGE_LIMIT_OPTIONS.map(opt => `
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-700 p-2 rounded">
                                    <input type="radio" name="policy-change-limit" value="${opt.ms}" ${opt.ms === changeLimitMs ? 'checked' : ''} class="w-4 h-4" /> 
                                    <span class="text-white">${opt.label}</span>
                                </label>
                            `).join('')}
                        </div>
                        <div class="flex justify-end gap-3">
                            <button id="change-limit-cancel" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-white">Cancel</button>
                            <button id="change-limit-save" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Helper functions
            const chaptersMap = {};
            chapters.forEach(c => { chaptersMap[c.id] = c; });
            
            function sanitizeChaptersForSave(chaps) {
                return chaps.map(c => {
                    const copy = { ...c };
                    ['acceptedAt', 'updatedAt', 'lastModifiedAt'].forEach(k => {
                        const v = copy[k];
                        if (v === null || v === undefined) {
                            copy[k] = null;
                        } else if (typeof v === 'number') {
                            copy[k] = v;
                        } else if (v && typeof v.toMillis === 'function') {
                            try { copy[k] = v.toMillis(); } catch (e) { copy[k] = Date.now(); }
                        } else if (v && typeof v.toDate === 'function') {
                            try { copy[k] = v.toDate().getTime(); } catch (e) { copy[k] = Date.now(); }
                        } else if (typeof v === 'object') {
                            copy[k] = Date.now();
                        } else {
                            const parsed = Number(v);
                            copy[k] = Number.isFinite(parsed) ? parsed : Date.now();
                        }
                    });
                    return copy;
                });
            }
            
            function renderChaptersList(isTest) {
                const contentArea = document.getElementById('policy-content-area');
                const chaptersList = isTest ? testChapters : realChapters;
                const typeLabel = isTest ? 'Test' : 'Real';
                const typeColor = isTest ? 'yellow' : 'green';
                
                contentArea.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">${typeLabel} Policy Chapters</h3>
                        <div class="flex gap-3">
                            ${!isTest ? `
                                <button id="download-policies-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                    <i class="fas fa-download mr-2"></i>
                                    Download All Real Policies
                                </button>
                            ` : ''}
                            <button id="add-chapter-btn" class="bg-${typeColor}-600 hover:bg-${typeColor}-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-plus mr-2"></i>
                                Add ${typeLabel} Chapter
                            </button>
                        </div>
                    </div>
                    
                    ${chaptersList.length === 0 ? `
                        <div class="text-center py-20">
                            <i class="fas fa-folder-open text-6xl text-gray-600 mb-4"></i>
                            <p class="text-gray-400 text-lg">No ${typeLabel.toLowerCase()} chapters yet.</p>
                            <p class="text-gray-500 text-sm">Click the button above to create one.</p>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${chaptersList.map(ch => {
                                const acceptedStr = ch.acceptedAt ? (ch.acceptedAt.toDate ? ch.acceptedAt.toDate().toLocaleDateString() : new Date(ch.acceptedAt).toLocaleDateString()) : 'Not accepted';
                                const updatedStr = ch.updatedAt ? (ch.updatedAt.toDate ? ch.updatedAt.toDate().toLocaleDateString() : new Date(ch.updatedAt).toLocaleDateString()) : '-';
                                
                                return `
                                    <div class="policy-card bg-gray-700 rounded-xl overflow-hidden border-2 border-transparent hover:border-${typeColor}-500 transition-all" data-chapter-id="${ch.id}">
                                        <div class="p-5">
                                            <div class="flex justify-between items-start mb-3">
                                                <h4 class="text-lg font-bold text-white truncate flex-1">${ch.title || '(Untitled)'}</h4>
                                                <button class="edit-chapter-btn text-gray-400 hover:text-white ml-2" data-chapter-id="${ch.id}" title="Edit Chapter">
                                                    <i class="fas fa-edit text-xl"></i>
                                                </button>
                                            </div>
                                            <div class="policy-preview cursor-pointer" data-chapter-id="${ch.id}">
                                                <div class="text-gray-300 text-sm mb-4 line-clamp-3" style="max-height: 4.5em; overflow: hidden;">
                                                    ${ch.body || 'No content'}
                                                </div>
                                                <div class="text-${typeColor}-400 text-xs font-semibold hover:underline">
                                                    <i class="fas fa-eye mr-1"></i>Click to view full content
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center text-xs text-gray-400 mt-3">
                                                <span><i class="fas fa-calendar mr-1"></i>${updatedStr}</span>
                                                <span class="px-2 py-1 rounded ${ch.acceptedAt ? 'bg-green-900 text-green-300' : 'bg-gray-600 text-gray-300'}">
                                                    ${ch.acceptedAt ? 'Accepted' : 'Draft'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                `;
                
                // Add chapter button
                const addBtn = document.getElementById('add-chapter-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', async () => {
                        const newCh = { 
                            id: generateChapterId(), 
                            title: `New ${typeLabel} Chapter`, 
                            body: '', 
                            acceptedAt: null, 
                            updatedAt: null, 
                            lastModifiedAt: null, 
                            test: isTest 
                        };
                        chapters.unshift(newCh);
                        const sanitized = sanitizeChaptersForSave(chapters);
                        const success = await persistPolicyConfig(policyDocRef, { chapters: sanitized, changeLimitMs, updatedAt: serverTimestamp() });
                        if (success) {
                            showToast(`${typeLabel} chapter added.`);
                            renderPolicyPanel();
                        } else {
                            showToast(`Failed to add ${typeLabel.toLowerCase()} chapter.`, true);
                        }
                    });
                }
                
                // Download All Real Policies button
                const downloadBtn = document.getElementById('download-policies-btn');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => {
                        downloadAllRealPolicies();
                    });
                }
                
                // Preview click handlers - show full content in modal
                document.querySelectorAll('.policy-preview').forEach(preview => {
                    preview.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const chapterId = preview.dataset.chapterId;
                        const chapter = chaptersMap[chapterId];
                        if (chapter) {
                            showChapterPreview(chapter, isTest);
                        }
                    });
                });
                
                // Edit button handlers
                document.querySelectorAll('.edit-chapter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const chapterId = btn.dataset.chapterId;
                        const chapter = chaptersMap[chapterId];
                        if (chapter) {
                            renderChapterEditor(chapter, isTest);
                        }
                    });
                });
            }
            
            function renderChapterEditor(ch, isTest) {
                const contentArea = document.getElementById('policy-content-area');
                const typeLabel = isTest ? 'Test' : 'Real';
                const typeColor = isTest ? 'yellow' : 'green';
                const acceptedStr = ch.acceptedAt ? (ch.acceptedAt.toDate ? ch.acceptedAt.toDate().toLocaleString() : new Date(ch.acceptedAt).toLocaleString()) : 'Not accepted';
                const updatedStr = ch.updatedAt ? (ch.updatedAt.toDate ? ch.updatedAt.toDate().toLocaleString() : new Date(ch.updatedAt).toLocaleString()) : '-';
                
                contentArea.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-6">
                            <button id="back-to-list-btn" class="text-gray-400 hover:text-white flex items-center">
                                <i class="fas fa-arrow-left mr-2"></i>
                                Back to ${typeLabel} Chapters
                            </button>
                            <span class="px-3 py-1 rounded bg-${typeColor}-900 text-${typeColor}-300 font-semibold">
                                ${typeLabel} Chapter
                            </span>
                        </div>
                        
                        <!-- Editor Card -->
                        <div class="bg-gray-700 rounded-xl p-6 border border-gray-600">
                            <div class="mb-6">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-2xl font-bold">${ch.title || '(Untitled)'}</h3>
                                </div>
                                <div class="text-xs text-gray-400 space-y-1">
                                    <div><i class="fas fa-check-circle mr-2"></i>Accepted: ${acceptedStr}</div>
                                    <div><i class="fas fa-clock mr-2"></i>Updated: ${updatedStr}</div>
                                    <div><i class="fas fa-hourglass-half mr-2"></i>Change Limit: ${humanizeMs(changeLimitMs)}</div>
                                </div>
                            </div>
                            
                            <!-- Title Input -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-300 mb-2">
                                    <i class="fas fa-heading mr-2"></i>Chapter Title
                                </label>
                                <input 
                                    id="chapter-title" 
                                    type="text"
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:border-${typeColor}-500 focus:outline-none" 
                                    value="${(ch.title||'').replace(/"/g,'&quot;')}" 
                                    placeholder="Enter chapter title..."
                                />
                            </div>
                            
                            <!-- Body Textarea -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-300 mb-2">
                                    <i class="fas fa-align-left mr-2"></i>Policy Content
                                </label>
                                <textarea 
                                    id="chapter-body" 
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:border-${typeColor}-500 focus:outline-none" 
                                    rows="15"
                                    placeholder="Enter policy content..."
                                >${(ch.body||'').replace(/</g,'&lt;')}</textarea>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-wrap gap-3">
                                <button id="save-chapter-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg flex items-center transition-all">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                                ${!ch.acceptedAt ? `
                                    <button id="accept-chapter-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg flex items-center transition-all">
                                        <i class="fas fa-check mr-2"></i>Accept Chapter
                                    </button>
                                ` : ''}
                                <button id="delete-chapter-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg flex items-center transition-all">
                                    <i class="fas fa-trash mr-2"></i>Delete Chapter
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Back button
                document.getElementById('back-to-list-btn').addEventListener('click', () => {
                    renderChaptersList(isTest);
                });
                
                // Save button
                document.getElementById('save-chapter-btn').addEventListener('click', async () => {
                    const updatedTitle = document.getElementById('chapter-title').value.trim();
                    const updatedBody = document.getElementById('chapter-body').value.trim();
                    const permission = canModifyChapter(ch, changeLimitMs);
                    
                    if (!permission.allowed) {
                        const retry = new Date(permission.retryAt);
                        showToast(`Cannot modify yet. Next allowed: ${retry.toLocaleString()}`, true);
                        return;
                    }
                    
                    ch.title = updatedTitle;
                    ch.body = updatedBody;
                    ch.updatedAt = Date.now();
                    ch.lastModifiedAt = Date.now();
                    
                    const newChapters = chapters.map(c => c.id === ch.id ? ch : c);
                    const sanitized = sanitizeChaptersForSave(newChapters);
                    const success = await persistPolicyConfig(policyDocRef, { chapters: sanitized, changeLimitMs, updatedAt: serverTimestamp() });
                    
                    if (success) {
                        showToast('Chapter saved successfully!');
                        const idx = chapters.findIndex(x=>x.id===ch.id);
                        if (idx > -1) chapters[idx] = ch;
                        renderChapterEditor(ch, isTest);
                    } else {
                        showToast('Failed to save chapter.', true);
                    }
                });
                
                // Accept button
                const acceptBtn = document.getElementById('accept-chapter-btn');
                if (acceptBtn) {
                    acceptBtn.addEventListener('click', async () => {
                        ch.acceptedAt = Date.now();
                        const newChapters = chapters.map(c => c.id === ch.id ? ch : c);
                        const sanitized = sanitizeChaptersForSave(newChapters);
                        const success = await persistPolicyConfig(policyDocRef, { chapters: sanitized, changeLimitMs, updatedAt: serverTimestamp() });
                        
                        if (success) {
                            showToast('Chapter accepted!');
                            renderPolicyPanel();
                        } else {
                            showToast('Failed to accept chapter.', true);
                        }
                    });
                }
                
                // Delete button
                document.getElementById('delete-chapter-btn').addEventListener('click', async () => {
                    const permission = canModifyChapter(ch, changeLimitMs);
                    
                    if (!permission.allowed && !ch.test) {
                        const retry = new Date(permission.retryAt);
                        showToast(`Cannot delete yet. Next allowed: ${retry.toLocaleString()}`, true);
                        return;
                    }
                    
                    const confirmed = confirm(`Delete "${ch.title}"? This action cannot be undone.`);
                    if (!confirmed) return;
                    
                    const newChapters = chapters.filter(c => c.id !== ch.id);
                    const sanitized = sanitizeChaptersForSave(newChapters);
                    const success = await persistPolicyConfig(policyDocRef, { chapters: sanitized, changeLimitMs, updatedAt: serverTimestamp() });
                    
                    if (success) {
                        showToast('Chapter deleted successfully!');
                        renderPolicyPanel();
                    } else {
                        showToast('Failed to delete chapter.', true);
                    }
                });
            }
            
            // Function to show chapter preview (read-only view)
            function showChapterPreview(ch, isTest) {
                const typeLabel = isTest ? 'Test' : 'Real';
                const typeColor = isTest ? 'yellow' : 'green';
                const acceptedStr = ch.acceptedAt ? (ch.acceptedAt.toDate ? ch.acceptedAt.toDate().toLocaleString() : new Date(ch.acceptedAt).toLocaleString()) : 'Not accepted';
                const updatedStr = ch.updatedAt ? (ch.updatedAt.toDate ? ch.updatedAt.toDate().toLocaleString() : new Date(ch.updatedAt).toLocaleString()) : '-';
                
                const modalOverlay = document.getElementById('modal-overlay');
                modalOverlay.innerHTML = `
                    <div class="bg-gray-800 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border-2 border-${typeColor}-500" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div class="sticky top-0 bg-gradient-to-r from-${typeColor}-900 to-${typeColor}-700 p-6 border-b border-${typeColor}-600 flex justify-between items-start">
                            <div class="flex-1">
                                <h2 class="text-2xl font-bold text-white mb-2">${ch.title || '(Untitled)'}</h2>
                                <div class="text-sm text-${typeColor}-200 space-y-1">
                                    <div><i class="fas fa-tag mr-2"></i>${typeLabel} Policy</div>
                                    <div><i class="fas fa-check-circle mr-2"></i>Accepted: ${acceptedStr}</div>
                                    <div><i class="fas fa-clock mr-2"></i>Updated: ${updatedStr}</div>
                                </div>
                            </div>
                            <button onclick="closeModal()" class="text-white hover:text-gray-300 text-2xl ml-4">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6">
                            <div class="bg-gray-700 rounded-lg p-6 border border-gray-600">
                                <div class="prose prose-invert max-w-none">
                                    <div class="text-gray-200 whitespace-pre-wrap leading-relaxed" style="font-size: 15px;">
                                        ${ch.body || 'No content available.'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="sticky bottom-0 bg-gray-800 p-4 border-t border-gray-700 flex justify-end gap-3">
                            <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">
                                Close
                            </button>
                            <button onclick="closeModal(); document.querySelector('[data-chapter-id=\\"${ch.id}\\"] .edit-chapter-btn').click();" class="bg-${typeColor}-600 hover:bg-${typeColor}-700 text-white font-bold py-2 px-6 rounded-lg flex items-center">
                                <i class="fas fa-edit mr-2"></i>
                                Edit Chapter
                            </button>
                        </div>
                    </div>
                `;
                modalOverlay.classList.remove('hidden');
            }
            
            // Function to download all real policies
            function downloadAllRealPolicies() {
                if (realChapters.length === 0) {
                    showToast('No real policies to download.', true);
                    return;
                }
                
                let content = '='.repeat(80) + '\\n';
                content += '               SOUNDORA FILMS - REAL POLICY DOCUMENTS\\n';
                content += '='.repeat(80) + '\\n\\n';
                content += 'Generated: ' + new Date().toLocaleString() + '\\n';
                content += 'Total Chapters: ' + realChapters.length + '\\n';
                content += '='.repeat(80) + '\\n\\n\\n';
                
                realChapters.forEach((ch, index) => {
                    const acceptedStr = ch.acceptedAt ? (ch.acceptedAt.toDate ? ch.acceptedAt.toDate().toLocaleString() : new Date(ch.acceptedAt).toLocaleString()) : 'Not accepted';
                    const updatedStr = ch.updatedAt ? (ch.updatedAt.toDate ? ch.updatedAt.toDate().toLocaleString() : new Date(ch.updatedAt).toLocaleString()) : '-';
                    
                    content += '\\n' + '-'.repeat(80) + '\\n';
                    content += 'CHAPTER ' + (index + 1) + ': ' + (ch.title || '(Untitled)').toUpperCase() + '\\n';
                    content += '-'.repeat(80) + '\\n\\n';
                    content += 'Status: ' + (ch.acceptedAt ? 'ACCEPTED' : 'DRAFT') + '\\n';
                    content += 'Accepted Date: ' + acceptedStr + '\\n';
                    content += 'Last Updated: ' + updatedStr + '\\n';
                    content += 'Chapter ID: ' + ch.id + '\\n\\n';
                    content += 'CONTENT:\\n';
                    content += '-'.repeat(80) + '\\n';
                    content += (ch.body || 'No content available.') + '\\n';
                    content += '-'.repeat(80) + '\\n\\n\\n';
                });
                
                content += '\\n' + '='.repeat(80) + '\\n';
                content += '                         END OF DOCUMENT\\n';
                content += '='.repeat(80) + '\\n';
                
                // Create blob and download
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'soundora-real-policies-' + new Date().toISOString().split('T')[0] + '.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('All real policies downloaded successfully!');
            }
            
            // Tab switching
            document.getElementById('tab-real').addEventListener('click', function() {
                document.querySelectorAll('.policy-tab').forEach(tab => {
                    tab.classList.remove('active', 'bg-red-600', 'text-white');
                    tab.classList.add('bg-gray-700', 'text-gray-300');
                });
                this.classList.add('active', 'bg-red-600', 'text-white');
                this.classList.remove('bg-gray-700', 'text-gray-300');
                renderChaptersList(false);
            });
            
            document.getElementById('tab-test').addEventListener('click', function() {
                document.querySelectorAll('.policy-tab').forEach(tab => {
                    tab.classList.remove('active', 'bg-red-600', 'text-white');
                    tab.classList.add('bg-gray-700', 'text-gray-300');
                });
                this.classList.add('active', 'bg-red-600', 'text-white');
                this.classList.remove('bg-gray-700', 'text-gray-300');
                renderChaptersList(true);
            });
            
            // Change limit modal
            document.getElementById('change-limit-btn').addEventListener('click', () => {
                const modal = document.getElementById('change-limit-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
            
            document.getElementById('change-limit-cancel').addEventListener('click', () => {
                const modal = document.getElementById('change-limit-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            
            document.getElementById('change-limit-save').addEventListener('click', async () => {
                const sel = document.querySelector('input[name="policy-change-limit"]:checked');
                const valMs = parseInt(sel?.value || '0');
                const success = await persistPolicyConfig(policyDocRef, { changeLimitMs: valMs, updatedAt: serverTimestamp() });
                
                if (success) {
                    localStorage.setItem('policyChangeLimitMs', String(valMs));
                    showToast('Change limit updated!');
                    renderPolicyPanel();
                } else {
                    showToast('Failed to update change limit.', true);
                }
            });
            
            // Initial render - show Real chapters by default
            renderChaptersList(false);
            
            setDashboardLanguage(currentDashboardLanguage);
        }

        /**
         * Render the Alerts panel.  This panel allows a super admin to send a
         * notification to all users via a persistent message stored in
         * Firestore.  Messages added here will appear in the users'
         * notification panel under the "Admin" category on the client side.  The
         * panel also lists existing announcements, sorted by most recent.
         */
        function renderAlertsPanel() {
            const panel = document.getElementById('alerts-panel');
            if (!panel) return;
            const t = dashboardTranslations[currentDashboardLanguage] || {};
            const alertsRef = doc(db, 'config', 'adminAlerts');
            if (unsubAlerts) {
                unsubAlerts();
                unsubAlerts = null;
            }
            panel.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-2" data-lang-key="alertsHeading">${t.alertsHeading || 'Send Announcement'}</h2>
                    <p class="mb-4 text-gray-400" data-lang-key="alertsSubheading">${t.alertsSubheading || 'Message will appear for all users.'}</p>
                    
                    <!-- Target Audience Selector -->
                    <div class="mb-4">
                        <label class="text-sm text-gray-400 mb-2 block" data-lang-key="audienceTargetLabel">${t.audienceTargetLabel || 'Target Audience:'}</label>
                        <div class="flex gap-2 flex-wrap">
                            <button id="audience-registered" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition active">
                                <i class="fas fa-users"></i> <span data-lang-key="audienceRegistered">${t.audienceRegistered || 'Registered Users'}</span>
                            </button>
                            <button id="audience-unregistered" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition">
                                <i class="fas fa-user-plus"></i> <span data-lang-key="audienceUnregistered">${t.audienceUnregistered || 'Unregistered Visitors'}</span>
                            </button>
                            <button id="audience-all" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition">
                                <i class="fas fa-globe"></i> <span data-lang-key="audienceAll">${t.audienceAll || 'All Users'}</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1" id="audience-description" data-lang-key="audienceDescRegistered">
                            ${t.audienceDescRegistered || 'Message will be sent to registered users with accounts'}
                        </p>
                    </div>
                    
                    <!-- Notification Type Selector -->
                    <div class="mb-4">
                        <label class="text-sm text-gray-400 mb-2 block">Notification Type:</label>
                        <div class="flex gap-2">
                            <button id="type-text" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition active">
                                <i class="fas fa-comment"></i> Text Message
                            </button>
                            <button id="type-movie" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition">
                                <i class="fas fa-film"></i> Movie Promotion
                            </button>
                        </div>
                    </div>
                    
                    <!-- Text Message Input (default) -->
                    <div id="text-input-section">
                        <textarea id="admin-alert-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 mb-4 text-sm text-gray-100" rows="4" placeholder="Enter announcement..."></textarea>
                    </div>
                    
                    <!-- Movie Promotion Input (hidden by default) -->
                    <div id="movie-input-section" class="hidden space-y-3 mb-4">
                        <div class="bg-gray-700/50 border border-gray-600 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <label class="text-sm font-semibold text-gray-300">Select Movie/Content:</label>
                                <button id="browse-movies-btn" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition flex items-center gap-2">
                                    <i class="fas fa-search"></i> Browse Content
                                </button>
                            </div>
                            
                            <!-- Selected movie preview -->
                            <div id="selected-movie-preview" class="hidden bg-gray-800 rounded-lg p-3 flex items-center gap-3">
                                <img id="preview-poster" class="w-16 h-24 object-cover rounded" />
                                <div class="flex-1">
                                    <p id="preview-title" class="font-semibold text-white"></p>
                                    <p id="preview-id" class="text-xs text-gray-400"></p>
                                </div>
                                <button id="clear-selection-btn" class="text-red-400 hover:text-red-300">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Hidden fields to store selected movie data -->
                            <input type="hidden" id="selected-movie-id" />
                            <input type="hidden" id="selected-movie-title" />
                            <input type="hidden" id="selected-movie-poster" />
                        </div>
                        
                        <textarea id="movie-desc-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-sm text-gray-100" rows="3" placeholder="Add a message about this content (optional)"></textarea>
                    </div>
                    
                    <!-- Auto-delete timer -->
                    <div class="mb-4">
                        <label class="text-sm text-gray-400 mb-2 block">Auto-delete after:</label>
                        <select id="auto-delete-time" class="bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm text-gray-100">
                            <option value="0">Never (permanent)</option>
                            <option value="3600000">1 hour</option>
                            <option value="21600000">6 hours</option>
                            <option value="86400000">24 hours</option>
                            <option value="259200000">3 days</option>
                            <option value="604800000">7 days</option>
                        </select>
                    </div>
                    
                    <button id="send-admin-alert-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mb-6 flex items-center gap-2">
                        <i class="fas fa-paper-plane"></i><span>Send Notification</span>
                    </button>
                    
                    <h3 class="text-xl font-semibold mb-2">Sent Notifications</h3>
                    <div id="admin-alerts-list" class="space-y-2 text-gray-300"></div>
                </div>
            `;
            
            // Audience selector logic
            const audienceRegisteredBtn = panel.querySelector('#audience-registered');
            const audienceUnregisteredBtn = panel.querySelector('#audience-unregistered');
            const audienceAllBtn = panel.querySelector('#audience-all');
            const audienceDescription = panel.querySelector('#audience-description');
            
            let currentAudience = 'registered';
            
            audienceRegisteredBtn.addEventListener('click', () => {
                currentAudience = 'registered';
                console.log('üéØ Audience changed to:', currentAudience);
                updateAudienceButtons();
                audienceDescription.textContent = t.audienceDescRegistered || 'Message will be sent to registered users with accounts';
                audienceDescription.setAttribute('data-lang-key', 'audienceDescRegistered');
            });
            
            audienceUnregisteredBtn.addEventListener('click', () => {
                currentAudience = 'unregistered';
                console.log('üéØ Audience changed to:', currentAudience);
                updateAudienceButtons();
                audienceDescription.textContent = t.audienceDescUnregistered || 'Message will be sent to unregistered visitors (no account required)';
                audienceDescription.setAttribute('data-lang-key', 'audienceDescUnregistered');
            });
            
            audienceAllBtn.addEventListener('click', () => {
                currentAudience = 'all';
                console.log('üéØ Audience changed to:', currentAudience);
                updateAudienceButtons();
                audienceDescription.textContent = t.audienceDescAll || 'Message will be sent to all users (both registered and unregistered)';
                audienceDescription.setAttribute('data-lang-key', 'audienceDescAll');
            });
            
            function updateAudienceButtons() {
                [audienceRegisteredBtn, audienceUnregisteredBtn, audienceAllBtn].forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-600');
                    btn.classList.add('bg-gray-700');
                });
                
                const activeBtn = currentAudience === 'registered' ? audienceRegisteredBtn :
                                 currentAudience === 'unregistered' ? audienceUnregisteredBtn : audienceAllBtn;
                
                activeBtn.classList.add('active', 'bg-blue-600');
                activeBtn.classList.remove('bg-gray-700');
            }
            
            // Type selector logic
            const typeTextBtn = panel.querySelector('#type-text');
            const typeMovieBtn = panel.querySelector('#type-movie');
            const textSection = panel.querySelector('#text-input-section');
            const movieSection = panel.querySelector('#movie-input-section');
            
            let currentType = 'text';
            
            typeTextBtn.addEventListener('click', () => {
                currentType = 'text';
                typeTextBtn.classList.add('active', 'bg-blue-600');
                typeTextBtn.classList.remove('bg-gray-700');
                typeMovieBtn.classList.remove('active', 'bg-blue-600');
                typeMovieBtn.classList.add('bg-gray-700');
                textSection.classList.remove('hidden');
                movieSection.classList.add('hidden');
            });
            
            typeMovieBtn.addEventListener('click', () => {
                currentType = 'movie';
                typeMovieBtn.classList.add('active', 'bg-blue-600');
                typeMovieBtn.classList.remove('bg-gray-700');
                typeTextBtn.classList.remove('active', 'bg-blue-600');
                typeTextBtn.classList.add('bg-gray-700');
                textSection.classList.add('hidden');
                movieSection.classList.remove('hidden');
            });
            
            // Browse movies button
            panel.querySelector('#browse-movies-btn')?.addEventListener('click', () => {
                openMovieSelectionModal();
            });
            
            // Clear selection button
            panel.querySelector('#clear-selection-btn')?.addEventListener('click', () => {
                panel.querySelector('#selected-movie-preview').classList.add('hidden');
                panel.querySelector('#selected-movie-id').value = '';
                panel.querySelector('#selected-movie-title').value = '';
                panel.querySelector('#selected-movie-poster').value = '';
            });
            
            const listEl = panel.querySelector('#admin-alerts-list');
            const renderList = (alerts) => {
                if (!listEl) return;
                if (!alerts || alerts.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500" data-lang-key="alertsEmpty">${t.alertsEmpty || 'No announcements yet.'}</p>`;
                    return;
                }
                listEl.innerHTML = alerts.map((alert, idx) => {
                    const ts = alert.timestamp ? new Date(alert.timestamp).toLocaleString() : '';
                    const isMovie = alert.type === 'movie';
                    const expiresAt = alert.expiresAt ? new Date(alert.expiresAt).toLocaleString() : 'Never';
                    const alertId = alert.id; // Store alert ID for deletion
                    
                    // Get audience info
                    const audience = alert.audience || 'registered';
                    const audienceLabel = audience === 'registered' ? 'Registered Users' :
                                        audience === 'unregistered' ? 'Unregistered Visitors' :
                                        audience === 'all' ? 'All Users' : audience;
                    const audienceColor = audience === 'registered' ? 'text-green-400' :
                                        audience === 'unregistered' ? 'text-yellow-400' :
                                        audience === 'all' ? 'text-blue-400' : 'text-gray-400';
                    
                    if (isMovie) {
                        return `<div class="border border-gray-700 rounded-lg p-3 bg-gradient-to-r from-purple-900/20 to-pink-900/20 relative">
                            <button class="delete-notif-btn absolute top-2 right-2 text-red-400 hover:text-red-300 text-sm" data-alert-id="${alertId}" title="Delete notification">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="flex gap-3 pr-6">
                                ${alert.poster ? `<img src="${alert.poster}" class="w-16 h-24 object-cover rounded" />` : '<div class="w-16 h-24 bg-gray-700 rounded flex items-center justify-center"><i class="fas fa-film text-gray-500"></i></div>'}
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i class="fas fa-film text-purple-400"></i>
                                        <span class="font-semibold">${alert.title || 'Movie'}</span>
                                    </div>
                                    ${alert.description ? `<p class="text-sm text-gray-400 mb-1">${alert.description}</p>` : ''}
                                    <p class="text-xs text-gray-500">ID: ${alert.movieId || 'N/A'}</p>
                                    <div class="flex items-center gap-2 mt-1">
                                        <i class="fas fa-users ${audienceColor}"></i>
                                        <span class="text-xs ${audienceColor}">${audienceLabel}</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Sent: ${ts}</p>
                                    <p class="text-xs text-gray-500">Expires: ${expiresAt}</p>
                                </div>
                            </div>
                        </div>`;
                    }
                    
                    return `<div class="border border-gray-700 rounded-lg p-3 flex flex-col gap-1 relative">
                        <button class="delete-notif-btn absolute top-2 right-2 text-red-400 hover:text-red-300 text-sm" data-alert-id="${alertId}" title="Delete notification">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="flex items-start gap-2 pr-6">
                            <i class="fas fa-comment text-blue-400 mt-1"></i>
                            <div class="flex-1">
                                <span class="text-sm">${alert.message || alert.content}</span>
                                <div class="flex items-center gap-3 mt-1">
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-users ${audienceColor}"></i>
                                        <span class="text-xs ${audienceColor}">${audienceLabel}</span>
                                    </div>
                                    <span class="text-xs text-gray-500">Sent: ${ts}</span>
                                    <span class="text-xs text-gray-500">Expires: ${expiresAt}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                
                // Attach delete listeners
                listEl.querySelectorAll('.delete-notif-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const alertId = btn.dataset.alertId;
                        if (!alertId) return;
                        
                        if (confirm('Delete this notification?')) {
                            try {
                                console.log('üóëÔ∏è Deleting notification with ID:', alertId);
                                
                                // Delete from adminAlerts by ID
                                const updatedAlerts = alerts.filter(a => a.id !== alertId);
                                await setDoc(alertsRef, { alerts: updatedAlerts }, { merge: false });
                                
                                // Also delete from adminMessages by ID
                                const messagesRef = doc(db, 'config', 'adminMessages');
                                const msgSnap = await getDoc(messagesRef);
                                if (msgSnap.exists()) {
                                    const messages = msgSnap.data().messages || [];
                                    const updatedMessages = messages.filter(m => m.id !== alertId);
                                    console.log('üìù Before delete:', messages.length, 'After delete:', updatedMessages.length);
                                    await setDoc(messagesRef, { messages: updatedMessages }, { merge: false });
                                }
                                
                                showToast('Notification deleted!');
                            } catch (err) {
                                console.error('Failed to delete notification', err);
                                showToast('Failed to delete!', true);
                            }
                        }
                    });
                });
            };
            unsubAlerts = onSnapshot(alertsRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                const alerts = Array.isArray(data?.alerts) ? [...data.alerts] : [];
                alerts.sort((a, b) => {
                    const ta = a.timestamp?.toMillis ? a.timestamp.toMillis() : 0;
                    const tb = b.timestamp?.toMillis ? b.timestamp.toMillis() : 0;
                    return tb - ta;
                });
                renderList(alerts);
                setDashboardLanguage(currentDashboardLanguage);
            }, (err) => {
                console.error('Alerts snapshot error', err);
                renderList([]);
            });
            const sendBtn = document.getElementById('send-admin-alert-btn');
            const textarea = document.getElementById('admin-alert-input');
            sendBtn.addEventListener('click', async () => {
                loadingOverlay?.classList.remove('hidden');
                try {
                    const now = new Date().toISOString();
                    const autoDeleteTime = parseInt(panel.querySelector('#auto-delete-time').value);
                    const expiresAt = autoDeleteTime > 0 ? new Date(Date.now() + autoDeleteTime).toISOString() : null;
                    
                    let newMessage;
                    
                    if (currentType === 'movie') {
                        // Movie promotion - get from selected movie
                        const movieId = panel.querySelector('#selected-movie-id').value;
                        const title = panel.querySelector('#selected-movie-title').value;
                        const poster = panel.querySelector('#selected-movie-poster').value;
                        const description = panel.querySelector('#movie-desc-input').value.trim();
                        
                        if (!movieId || !title) {
                            showToast('Please select a movie from the list!', true);
                            loadingOverlay?.classList.add('hidden');
                            return;
                        }
                        
                        newMessage = {
                            id: 'movie_' + Date.now(),
                            type: 'movie',
                            title: title,
                            movieId: movieId,
                            description: description || null,
                            poster: poster || null,
                            timestamp: now,
                            expiresAt: expiresAt,
                            audience: currentAudience // Audience ma'lumotini qo'shamiz
                        };
                        
                        console.log('üì§ Sending movie message with audience:', currentAudience);
                        console.log('üì§ Full movie message object:', JSON.stringify(newMessage, null, 2));
                        
                        // Clear inputs
                        panel.querySelector('#selected-movie-preview').classList.add('hidden');
                        panel.querySelector('#selected-movie-id').value = '';
                        panel.querySelector('#selected-movie-title').value = '';
                        panel.querySelector('#selected-movie-poster').value = '';
                        panel.querySelector('#movie-desc-input').value = '';
                    } else {
                        // Text message
                        const msg = textarea.value.trim();
                        if (!msg) {
                            showToast('Message cannot be empty!', true);
                            loadingOverlay?.classList.add('hidden');
                            return;
                        }
                        
                        newMessage = {
                            id: 'broadcast_' + Date.now(),
                            type: 'text',
                            content: msg,
                            timestamp: now,
                            expiresAt: expiresAt,
                            audience: currentAudience // Audience ma'lumotini qo'shamiz
                        };
                        
                        console.log('üì§ Sending text message with audience:', currentAudience);
                        console.log('üì§ Full message object:', JSON.stringify(newMessage, null, 2));
                        
                        textarea.value = '';
                    }
                    
                    // Save to adminAlerts (old system - for compatibility)
                    const alertsRef = doc(db, 'config', 'adminAlerts');
                    const snap = await getDoc(alertsRef);
                    const alerts = snap.exists() && Array.isArray(snap.data()?.alerts) ? [...snap.data().alerts] : [];
                    
                    const newAlert = { 
                        id: newMessage.id,
                        message: newMessage.content || newMessage.title,
                        timestamp: now,
                        type: newMessage.type,
                        expiresAt: expiresAt,
                        audience: currentAudience // Audience ma'lumotini adminAlerts'ga ham qo'shamiz
                    };
                    alerts.unshift(newAlert);
                    await setDoc(alertsRef, { alerts }, { merge: false });
                    
                    // ALSO save to adminMessages (new broadcast system for all users)
                    const messagesRef = doc(db, 'config', 'adminMessages');
                    const msgSnap = await getDoc(messagesRef);
                    const messages = msgSnap.exists() && Array.isArray(msgSnap.data()?.messages) ? [...msgSnap.data().messages] : [];
                    messages.unshift(newMessage);
                    
                    console.log('üíæ Saving to Firebase with audience:', newMessage.audience);
                    console.log('üíæ All messages being saved:', messages.map(m => ({ id: m.id, audience: m.audience, type: m.type })));
                    
                    await setDoc(messagesRef, { messages }, { merge: false });
                    
                    showToast('Notification sent successfully!');
                } catch (err) {
                    console.error('Failed to send notification', err);
                    showToast('Failed to send notification!', true);
                } finally {
                    loadingOverlay?.classList.add('hidden');
                }
            });
            setDashboardLanguage(currentDashboardLanguage);
        }

        async function renderRegionPanel() {
            // Render a region management panel that blocks all countries by default and lets the admin uncheck countries to allow them.
            const panel = document.getElementById('region-panel');
            const lang = currentDashboardLanguage;
            const t = dashboardTranslations[lang] || {};
            const cfgRef = doc(db, 'config', 'regionRestrictions');
            let allowedRegions = [];
            let message = '';
            let code = '444';
            try {
                const snap = await getDoc(cfgRef);
                if (snap.exists()) {
                    const data = snap.data() || {};
                    // Always treat blockAll as true; allowedRegions will hold the list of unblocked countries.
                    allowedRegions = Array.isArray(data.allowedRegions) ? data.allowedRegions.map(r => r.toLowerCase()) : [];
                    message = data.message || '';
                    code = data.code || '444';
                }
            } catch (err) {
                console.error('Failed to load region restrictions config', err);
            }

            // Build a sorted list of all countries (A‚ÄìZ) with checkboxes.
            const sortedCountries = worldCountries.slice().sort((a, b) => a.name.localeCompare(b.name));
            const countriesHtml = sortedCountries.map(c => {
                const val = c.code.toLowerCase();
                // Checked means the country is blocked (not in allowedRegions), unchecked means unblocked.
                const checkedAttr = allowedRegions.includes(val) ? '' : 'checked';
                return `
                    <label class="flex items-center mb-1">
                        <input type="checkbox" class="mr-2 country-checkbox" data-code="${val}" ${checkedAttr}>
                        <span>${c.name} (${c.code})</span>
                    </label>`;
            }).join('');
            panel.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4" data-lang-key="regionRestrictions">${t.regionRestrictions || 'Region Restrictions'}</h2>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <p data-lang-key="blockInstruction">${t.blockInstruction || 'Uncheck countries to unblock them:'}</p>
                            <button id="toggle-all-regions-btn" class="submit-btn text-white font-bold py-2 px-4 rounded-lg flex items-center" data-blocked="true">
                                <i class="fas fa-toggle-on mr-2"></i><span data-lang-key="toggleAllRegions">${t.toggleAllRegions || 'All'}</span>
                            </button>
                        </div>
                        <div class="h-64 overflow-y-auto p-2 border border-gray-600 rounded bg-gray-700 text-white">
                            ${countriesHtml}
                        </div>
                        <label for="region-message" class="block mt-4 mb-2" data-lang-key="blockedMessage">${t.blockedMessage || 'Block message'}</label>
                        <textarea id="region-message" class="form-input p-2 rounded-md w-full text-black" rows="3">${message}</textarea>
                        <label for="region-code" class="block mt-4 mb-2" data-lang-key="blockedCode">${t.blockedCode || 'Block code'}</label>
                        <input id="region-code" type="text" class="form-input p-2 rounded-md w-full text-black" value="${code}">
                        <button id="save-region-btn" class="action-btn text-white font-bold py-2 px-4 rounded-lg mt-4 flex items-center">
                            <i class="fas fa-save mr-2"></i><span data-lang-key="save">${t.save || 'Save'}</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Toggle all regions button handler
            const toggleBtn = document.getElementById('toggle-all-regions-btn');
            const checkboxes = panel.querySelectorAll('.country-checkbox');
            
            // Determine initial state based on current checkboxes
            const allBlocked = Array.from(checkboxes).every(cb => cb.checked);
            toggleBtn.dataset.blocked = allBlocked ? 'true' : 'false';
            
            toggleBtn.addEventListener('click', () => {
                const isCurrentlyBlocked = toggleBtn.dataset.blocked === 'true';
                
                // Toggle all checkboxes
                checkboxes.forEach(cb => {
                    cb.checked = !isCurrentlyBlocked; // If currently blocked (all checked), uncheck all
                });
                
                // Update button state
                toggleBtn.dataset.blocked = isCurrentlyBlocked ? 'false' : 'true';
                
                // Optional: Update button appearance
                const icon = toggleBtn.querySelector('i');
                if (isCurrentlyBlocked) {
                    // Now unblocked (all unchecked)
                    icon.classList.remove('fa-toggle-on');
                    icon.classList.add('fa-toggle-off');
                } else {
                    // Now blocked (all checked)
                    icon.classList.remove('fa-toggle-off');
                    icon.classList.add('fa-toggle-on');
                }
            });
            
            // Save handler for the region restrictions
            document.getElementById('save-region-btn').addEventListener('click', async () => {
                const messageVal = document.getElementById('region-message').value.trim();
                const codeVal = document.getElementById('region-code').value.trim() || '444';
                const checkboxes = panel.querySelectorAll('.country-checkbox');
                const unblocked = [];
                checkboxes.forEach(cb => {
                    if (!cb.checked) {
                        // If checkbox is unchecked, the country is unblocked (allowed)
                        unblocked.push(cb.dataset.code.toLowerCase());
                    }
                });
                const payload = { blockAll: true, allowedRegions: unblocked, message: messageVal, code: codeVal };
                try {
                    await setDoc(cfgRef, payload, { merge: true });
                    showToast(dashboardTranslations[currentDashboardLanguage].regionSettingsSaved || 'Region settings saved!');
                } catch (err) {
                    console.error('Failed to save region restrictions', err);
                    showToast('Error saving region settings', true);
                }
            });
            // Apply the current dashboard language to newly added elements
            setDashboardLanguage(currentDashboardLanguage);
        }
        
        // --- ADMIN MANAGEMENT FUNCTIONS ---
        function renderAdminsPanel() {
            const panel = document.getElementById('admins-panel');
            const adminsAndAgents = allUsers.filter(u => u.role === 'admin' || u.role === 'agent');
            
            const tableHeaders = `
            <thead class="table-header">
                <tr>
                    <th class="p-3 text-left text-sm font-semibold tracking-wide" data-lang-key="name"></th>
                    <th class="p-3 text-left text-sm font-semibold tracking-wide">Email</th>
                    <th class="p-3 text-left text-sm font-semibold tracking-wide" data-lang-key="role"></th>
                    <th class="p-3 text-left text-sm font-semibold tracking-wide" data-lang-key="actions"></th>
                </tr>
            </thead>`;
            const tableRows = adminsAndAgents.map(admin => `
            <tr class="table-row">
                <td class="p-3 text-sm font-bold">${admin.displayName || 'N/A'}</td>
                <td class="p-3 text-sm">${admin.email}</td>
                <td class="p-3 text-sm capitalize">${admin.role}</td>
                <td class="p-3 text-sm">
                    <button class="edit-admin-btn text-blue-400 hover:text-blue-300" data-id="${admin.uid}"><i class="fas fa-edit"></i></button>
                </td>
            </tr>`).join('');

            panel.innerHTML = `
                <div class="flex justify-end items-center mb-6">
                    <button id="add-admin-btn" class="action-btn text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i><span data-lang-key="addAdmin"></span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-full rounded-lg overflow-hidden">${tableHeaders}<tbody>${tableRows}</tbody></table>
                </div>
            `;
            
            document.getElementById('add-admin-btn').addEventListener('click', () => openAdminModal());
            panel.querySelectorAll('.edit-admin-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const adminId = e.currentTarget.dataset.id;
                    const adminData = allUsers.find(u => u.uid === adminId);
                    openAdminModal(adminData);
                });
            });
            setDashboardLanguage(currentDashboardLanguage);
        }

        function openAdminModal(admin = null) {
            const isEditing = admin !== null;
            const modalTitleKey = isEditing ? "editAdmin" : "addAdmin";
            const a = admin || { permissions: { accessSupport: true }, role: 'agent' }; // Default for new agent

            const modalHTML = `
            <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 relative">
                 <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
                 <h3 class="text-2xl font-bold mb-6" data-lang-key="${modalTitleKey}"></h3>
                 <form id="admin-form">
                    <input type="hidden" id="admin-id" value="${a.uid || ''}">
                    <div class="space-y-4">
                        <input type="text" id="admin-name" class="modal-input w-full p-2 rounded-md" placeholder="–ò–º—è" value="${a.displayName || ''}" required>
                        <input type="email" id="admin-email" class="modal-input w-full p-2 rounded-md" placeholder="Email" value="${a.email || ''}" ${isEditing ? 'disabled' : ''} required>
                        ${!isEditing ? '<input type="password" id="admin-password" class="modal-input w-full p-2 rounded-md" placeholder="–ü–∞—Ä–æ–ª—å" required>' : ''}
                         <div>
                            <label for="admin-role" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="role"></label>
                            <select id="admin-role" class="modal-input w-full p-2 rounded-md mt-1">
                                <option value="agent" ${a.role === 'agent' ? 'selected' : ''} data-lang-key="agent"></option>
                                <option value="admin" ${a.role === 'admin' ? 'selected' : ''} data-lang-key="admin"></option>
                            </select>
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold mt-6 mb-2 border-b border-gray-700 pb-1" data-lang-key="permissions"></h4>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex items-center"><input type="checkbox" id="perm-content" class="h-4 w-4 text-red-600" ${a.permissions?.manageContent ? 'checked' : ''}> <span class="ml-2" data-lang-key="manageContent"></span></label>
                        <label class="flex items-center"><input type="checkbox" id="perm-users" class="h-4 w-4 text-red-600" ${a.permissions?.manageUsers ? 'checked' : ''}> <span class="ml-2" data-lang-key="manageUsers"></span></label>
                        <label class="flex items-center"><input type="checkbox" id="perm-partners" class="h-4 w-4 text-red-600" ${a.permissions?.managePartners ? 'checked' : ''}> <span class="ml-2" data-lang-key="managePartners"></span></label>
                        <label class="flex items-center"><input type="checkbox" id="perm-support" class="h-4 w-4 text-red-600" ${a.permissions?.accessSupport ? 'checked' : ''}> <span class="ml-2" data-lang-key="accessSupport"></span></label>
                    </div>
                     <button type="submit" class="action-btn w-full text-white font-bold py-3 px-6 rounded-lg mt-8"><span data-lang-key="save"></span></button>
                 </form>
            </div>`;
            document.getElementById('modal-overlay').innerHTML = modalHTML;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('admin-form').addEventListener('submit', (e) => { e.preventDefault(); saveAdmin(); });
            setDashboardLanguage(currentDashboardLanguage);
        }

        async function saveAdmin() {
            const adminId = document.getElementById('admin-id').value;
            const isEditing = !!adminId;

            const name = document.getElementById('admin-name').value;
            const email = document.getElementById('admin-email').value;
            const password = !isEditing ? document.getElementById('admin-password').value : null;
            const role = document.getElementById('admin-role').value;

            const permissions = {
                manageContent: document.getElementById('perm-content').checked,
                manageUsers: document.getElementById('perm-users').checked,
                managePartners: document.getElementById('perm-partners').checked,
                accessSupport: document.getElementById('perm-support').checked
            };

            if (!name || !email || (!isEditing && !password)) {
                showToast("Iltimos, barcha maydonlarni to'ldiring.", true);
                return;
            }
            loadingOverlay.classList.remove('hidden');
            
            try {
                if (isEditing) {
                    const adminRef = doc(db, "users", adminId);
                    await updateDoc(adminRef, {
                        displayName: name,
                        role: role,
                        permissions: permissions
                    });
                    showToast(dashboardTranslations[currentDashboardLanguage].adminUpdatedSuccess);
                } else {
                    const tempAppName = 'temp-admin-auth-app-' + Date.now();
                    const tempApp = initializeApp(firebaseConfig, tempAppName);
                    const tempAuth = getAuth(tempApp);
                    const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                    const newAdminUser = userCredential.user;

                    await setDoc(doc(db, "users", newAdminUser.uid), {
                        uid: newAdminUser.uid,
                        displayName: name,
                        email: email,
                        role: role,
                        permissions: permissions,
                        createdAt: serverTimestamp(),
                    });
                    await signOut(tempAuth);
                    showToast(dashboardTranslations[currentDashboardLanguage].adminCreatedSuccess);
                }
                closeModal();
            } catch (error) {
                 console.error("Error saving admin:", error);
                let errorMessage = "Adminni saqlashda xatolik.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Bu email allaqachon ro'yxatdan o'tgan.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Parol juda oddiy (kamida 6 belgi).";
                }
                showToast(errorMessage, true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
    </script>


<!-- === SND: Policies (Sections) Panel Script === -->
<script>
(function(){
  // Utility to show only the requested panel
  function showOnly(panelId) {
    document.querySelectorAll('#main-content > div').forEach(p => p.classList.add('hidden'));
    const el = document.getElementById(panelId);
    if (el) el.classList.remove('hidden');
  }
  function nowStamp() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function loadPolicies(){
    try { return JSON.parse(localStorage.getItem('sndPolicies') || '[]'); } catch(e){ return []; }
  }
  function savePolicies(arr){
    localStorage.setItem('sndPolicies', JSON.stringify(arr));
  }
  function renderPoliciesPanel(){
    const panel = document.getElementById('policies-panel');
    if (!panel) return;
    let items = loadPolicies();
    // Ensure numbering 1..n
    items = items.map((it, idx) => ({...it, number: idx+1}));
    savePolicies(items);
    const rows = items.map((it, idx) => `
      <div class="bg-gray-800 rounded-lg p-4 mb-3">
        <div class="flex justify-between items-center">
          <div class="font-semibold">#${it.number} ‚Äî ${it.title || 'No title'}</div>
          <div class="text-xs text-gray-400">Qabul qilingan: ${it.acceptedAt || '-'} ${it.modifiedAt ? ' ‚Ä¢ O‚Äòzg.: '+it.modifiedAt : ''}</div>
        </div>
        <div class="text-gray-300 mt-2 whitespace-pre-wrap">${(it.body || '').replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded edit-btn" data-idx="${idx}"><i class="fas fa-edit mr-1"></i>Tahrirlash</button>
          <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded up-btn" data-idx="${idx}">‚Üë</button>
          <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded down-btn" data-idx="${idx}">‚Üì</button>
          <button class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded del-btn" data-idx="${idx}"><i class="fas fa-trash mr-1"></i>O‚Äòchirish</button>
          <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded dl-one-btn" data-idx="${idx}"><i class="fas fa-download mr-1"></i>Yuklab olish</button>
        </div>
      </div>
    `).join('');

    panel.innerHTML = `
      <div class="flex justify-between items-center mb-6 flex-wrap">
        <h2 class="text-2xl font-bold">SND Policy (bo‚Äòlimlar)</h2>
        <div class="flex flex-wrap gap-2">
          <button id="add-policy-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Policy</button>
          <button id="download-all-policy-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Barchasini yuklab olish</button>
        </div>
      </div>
      ${rows || ''}
      ${items.length===0?'<p class="text-gray-400">Hali bo‚Äòlim qo‚Äòshilmagan.</p>':''}
    `;

    // Event bindings
    panel.querySelector('#add-policy-btn')?.addEventListener('click', ()=> openEditModal());
    panel.querySelector('#download-all-policy-btn')?.addEventListener('click', ()=> downloadAll(items));

    panel.querySelectorAll('.edit-btn').forEach(b=> b.addEventListener('click', ()=> {
      const idx = parseInt(b.dataset.idx);
      openEditModal(items[idx], idx);
    }));
    panel.querySelectorAll('.del-btn').forEach(b=> b.addEventListener('click', ()=>{
      const idx = parseInt(b.dataset.idx);
      const arr = loadPolicies();
      arr.splice(idx,1);
      savePolicies(arr);
      renderPoliciesPanel();
    }));
    panel.querySelectorAll('.up-btn').forEach(b=> b.addEventListener('click', ()=>{
      const idx = parseInt(b.dataset.idx);
      const arr = loadPolicies();
      if (idx>0) { const tmp = arr[idx-1]; arr[idx-1]=arr[idx]; arr[idx]=tmp; savePolicies(arr); renderPoliciesPanel(); }
    }));
    panel.querySelectorAll('.down-btn').forEach(b=> b.addEventListener('click', ()=>{
      const idx = parseInt(b.dataset.idx);
      const arr = loadPolicies();
      if (idx<arr.length-1) { const tmp = arr[idx+1]; arr[idx+1]=arr[idx]; arr[idx]=tmp; savePolicies(arr); renderPoliciesPanel(); }
    }));
    panel.querySelectorAll('.dl-one-btn').forEach(b=> b.addEventListener('click', ()=>{
      const idx = parseInt(b.dataset.idx);
      const it = loadPolicies()[idx];
      if (!it) return;
      const content = buildDoc([it]);
      downloadFile(`SND_Policy_${it.number}-policy.txt`, content);
    }));
  }

  function openEditModal(item=null, index=null) {
    const modalOverlay = document.getElementById('modal-overlay') || (function(){ const m=document.createElement('div'); m.id='modal-overlay'; m.className='fixed inset-0 bg-black/60 hidden z-[100] flex items-center justify-center'; document.body.appendChild(m); return m; })();
    const isEdit = !!item;
    modalOverlay.innerHTML = `
      <div class="bg-gray-900 rounded-lg w-11/12 max-w-2xl p-6 relative">
        <button id="policy-edit-close" class="absolute top-3 right-3 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        <h3 class="text-lg font-bold mb-4">${isEdit? 'Bo‚Äòlimni tahrirlash' : 'Yangi bo‚Äòlim'}</h3>
        <div class="space-y-3">
          <input id="pl-title" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="Sarlavha" value="${(item && (item.title||'').replace(/"/g,'&quot;')) || ''}" />
          <textarea id="pl-body" rows="8" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="Matn">${(item && (item.body||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')) || ''}</textarea>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="pl-save" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Saqlash</button>
        </div>
      </div>`;
    modalOverlay.classList.remove('hidden');
    modalOverlay.querySelector('#policy-edit-close').addEventListener('click', ()=> modalOverlay.classList.add('hidden'));
    modalOverlay.addEventListener('click', (e)=> { if(e.target===modalOverlay) modalOverlay.classList.add('hidden'); });

    modalOverlay.querySelector('#pl-save').addEventListener('click', ()=>{
      const title = document.getElementById('pl-title').value.trim();
      const body = document.getElementById('pl-body').value;
      if (!title || !body) { alert("Sarlavha va matn shart."); return; }
      const arr = loadPolicies();
      if (isEdit) {
        const obj = arr[index];
        obj.title = title;
        obj.body = body;
        obj.modifiedAt = nowStamp();
      } else {
        arr.push({ title, body, acceptedAt: nowStamp(), modifiedAt: null });
      }
      savePolicies(arr);
      modalOverlay.classList.add('hidden');
      renderPoliciesPanel();
    });
  }

  function buildDoc(items) {
    const lines = [];
    lines.push("SND Policy");
    lines.push("=".repeat(40));
    items.forEach((it, i) => {
      const num = it.number || (i+1);
      lines.push(`\n${num}-policy ‚Äî ${it.title}`);
      lines.push("-".repeat(30));
      lines.push(it.body);
      lines.push(`Qabul qilingan: ${it.acceptedAt || '-'}${it.modifiedAt ? " | O‚Äòzgartirilgan: " + it.modifiedAt : ""}`);
    });
    return lines.join("\n");
  }

  function downloadAll(items) {
    const content = buildDoc(items);
    downloadFile('SND_Policy_ALL.txt', content);
  }

  function downloadFile(filename, content) {
    const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // Add a new sidebar link for the Policies panel (without touching existing code)
  document.addEventListener('DOMContentLoaded', function(){
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    if (!sidebar || !mainContent) return;
    // Insert link only once
    if (!document.getElementById('sidebar-link-policies')) {
      const link = document.createElement('a');
      link.href = '#';
      link.id = 'sidebar-link-policies';
      link.className = 'sidebar-link block py-2 px-4 hover:bg-gray-800 rounded';
      link.dataset.panel = 'policies-panel';
      link.dataset.title = 'Policy';
      link.innerHTML = '<i class="fas fa-balance-scale mr-2"></i> Policies';
      // place after existing policy panel link if any
      sidebar.appendChild(link);
      // add click listener independent of setupMenuListeners
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        // de-activate others
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        showOnly('policies-panel');
        renderPoliciesPanel();
        const title = document.getElementById('page-title');
        if (title) title.textContent = 'Policies';
      });
    }
  });
})();
</script>

</body>
</html>
